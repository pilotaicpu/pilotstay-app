<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>PilotStay - Partner Dashboard</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ù</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#09090b;color:#fafafa;min-height:100vh}
.loading-screen{position:fixed;inset:0;background:#09090b;display:flex;align-items:center;justify-content:center;z-index:9999}
.spinner{width:40px;height:40px;border:3px solid #27272a;border-top-color:#22c55e;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.sidebar{width:240px;background:#131316;border-right:1px solid #27272a;position:fixed;height:100vh;display:flex;flex-direction:column}
.sidebar-header{padding:20px;border-bottom:1px solid #27272a;display:flex;align-items:center;gap:12px}
.sidebar-logo{width:40px;height:40px;background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
.sidebar-title{font-weight:700;font-size:16px}
.sidebar-sub{font-size:11px;color:#22c55e}
.nav{flex:1;padding:12px;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:10px;cursor:pointer;color:#a1a1aa;margin-bottom:4px;transition:all .2s;font-size:13px}
.nav-item:hover,.nav-item.active{background:#1f1f23;color:#fafafa}
.nav-item.active{background:#22c55e20;color:#22c55e}
.nav-icon{font-size:18px}
.user-section{padding:16px;border-top:1px solid #27272a}
.user-info{display:flex;align-items:center;gap:10px;padding:10px;background:#18181b;border-radius:10px}
.user-avatar{width:36px;height:36px;background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px}
.user-name{font-size:13px;font-weight:600}
.user-email{font-size:10px;color:#71717a}
.logout-btn{width:100%;margin-top:10px;padding:10px;background:#27272a;border:none;border-radius:8px;color:#a1a1aa;font-size:12px;cursor:pointer;transition:all .2s}
.logout-btn:hover{background:#3f3f46;color:#fafafa}
.main{margin-left:240px;padding:24px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.header h1{font-size:24px;font-weight:700}
.header p{color:#71717a;font-size:13px;margin-top:4px}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.stat-card{background:#131316;border:1px solid #27272a;border-radius:12px;padding:20px}
.stat-icon{font-size:24px;margin-bottom:12px}
.stat-value{font-size:28px;font-weight:700}
.stat-label{font-size:12px;color:#71717a;margin-top:4px}
.card{background:#131316;border:1px solid #27272a;border-radius:12px;padding:20px;margin-bottom:16px}
.card-title{font-size:14px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
.empty-state{text-align:center;padding:40px;color:#71717a}
.empty-icon{font-size:48px;margin-bottom:12px}
.btn{padding:12px 20px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.btn-primary{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff}
.btn:hover{transform:scale(1.02)}
.cert-banner{padding:20px;border-radius:12px;margin-bottom:24px;display:flex;align-items:center;gap:16px}
.cert-banner.pending{background:#f9731620;border:1px solid #f97316}
.cert-banner.certified{background:#22c55e20;border:1px solid #22c55e}
.cert-banner.none{background:#8b5cf620;border:1px solid #8b5cf6}
.cert-icon{font-size:40px}
.cert-info{flex:1}
.cert-title{font-weight:700;font-size:16px}
.cert-desc{font-size:12px;color:#a1a1aa;margin-top:4px}
.job-item{display:flex;align-items:center;gap:16px;padding:16px;background:#18181b;border-radius:10px;margin-bottom:10px}
.job-icon{font-size:32px}
.job-info{flex:1}
.job-title{font-weight:600;font-size:14px}
.job-details{font-size:12px;color:#71717a;margin-top:4px}
.job-price{font-weight:700;font-size:16px;color:#22c55e}
.tag{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600}
.tag-new{background:#3b82f620;color:#3b82f6}
.tag-done{background:#22c55e20;color:#22c55e}
</style>
</head>
<body>
<div class="loading-screen" id="loading">
  <div class="spinner"></div>
</div>

<div id="app" style="display:none">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">ü§ù</div>
      <div>
        <div class="sidebar-title">PilotStay</div>
        <div class="sidebar-sub">Partner Dashboard</div>
      </div>
    </div>
    <nav class="nav">
      <div class="nav-item active"><span class="nav-icon">üìä</span>Dashboard</div>
      <div class="nav-item"><span class="nav-icon">üìã</span>Auftr√§ge</div>
      <div class="nav-item"><span class="nav-icon">üë•</span>Meine Hosts</div>
      <div class="nav-item"><span class="nav-icon">üí∞</span>Verdienst</div>
      <div class="nav-item"><span class="nav-icon">üìÖ</span>Kalender</div>
      <div class="nav-item"><span class="nav-icon">‚öôÔ∏è</span>Einstellungen</div>
    </nav>
    <div class="user-section">
      <div class="user-info">
        <div class="user-avatar" id="user-avatar">?</div>
        <div>
          <div class="user-name" id="user-name">Laden...</div>
          <div class="user-email" id="user-email">...</div>
        </div>
      </div>
      <button class="logout-btn" id="logout-btn">üö™ Abmelden</button>
    </div>
  </aside>
  
  <main class="main">
    <div class="header">
      <div>
        <h1 id="greeting">Willkommen! üëã</h1>
        <p id="date"></p>
      </div>
    </div>
    
    <div class="cert-banner none" id="cert-banner">
      <div class="cert-icon">üèÖ</div>
      <div class="cert-info">
        <div class="cert-title">Pilot Zertifizierung</div>
        <div class="cert-desc">Werde zertifiziert und erhalte mehr Auftr√§ge!</div>
      </div>
      <button class="btn btn-primary" id="cert-btn">Jetzt beantragen</button>
    </div>
    
    <div class="stats">
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-value" id="stat-earnings">‚Ç¨0</div>
        <div class="stat-label">Verdienst diesen Monat</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìã</div>
        <div class="stat-value" id="stat-jobs">0</div>
        <div class="stat-label">Offene Auftr√§ge</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-value" id="stat-completed">0</div>
        <div class="stat-label">Erledigte Jobs</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚≠ê</div>
        <div class="stat-value" id="stat-rating">-</div>
        <div class="stat-label">Bewertung</div>
      </div>
    </div>
    
    <div class="grid-2">
      <div class="card">
        <div class="card-title">üìã Offene Auftr√§ge</div>
        <div id="jobs-list">
          <div class="empty-state">
            <div class="empty-icon">‚úÖ</div>
            <p>Keine offenen Auftr√§ge</p>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-title">üë• Verbundene Hosts</div>
        <div id="hosts-list">
          <div class="empty-state">
            <div class="empty-icon">üîç</div>
            <p>Noch keine Hosts verbunden</p>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
const SUPABASE_URL = 'https://uamlcodalgibboftvhqp.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhbWxjb2RhbGdpYmJvZnR2aHFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTUyNDIsImV4cCI6MjA4Mzg5MTI0Mn0.t7OwT2MjL1CVdQTQAOaA1HwowFpaZsVZcqjTFHuTL1w';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let user = null;
let profile = null;
let partner = null;
let jobs = [];

async function init() {
  const { data: { session } } = await db.auth.getSession();
  
  if (!session) {
    window.location.href = 'auth.html';
    return;
  }
  
  user = session.user;
  
  const { data: profileData } = await db.from('profiles').select('*').eq('id', user.id).single();
  profile = profileData;
  
  if (profile?.role !== 'partner' && profile?.role !== 'admin') {
    window.location.href = 'host-dashboard.html';
    return;
  }
  
  const { data: partnerData } = await db.from('partners').select('*').eq('id', user.id).single();
  partner = partnerData;
  
  const { data: jobsData } = await db.from('jobs').select('*, properties(name, address)').eq('partner_id', user.id).in('status', ['assigned', 'accepted', 'on_way', 'in_progress']).order('scheduled_date', { ascending: true });
  jobs = jobsData || [];
  
  const { data: certRequest } = await db.from('cert_requests').select('*').eq('partner_id', user.id).eq('status', 'pending').maybeSingle();
  
  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  
  renderUI(certRequest);
}

function renderUI(certRequest) {
  const firstName = profile?.first_name || user?.email?.split('@')[0] || 'User';
  document.getElementById('user-avatar').textContent = firstName[0].toUpperCase();
  document.getElementById('user-name').textContent = firstName + (profile?.last_name ? ' ' + profile.last_name : '');
  document.getElementById('user-email').textContent = user.email;
  document.getElementById('greeting').textContent = `Hallo, ${firstName}! üëã`;
  
  document.getElementById('date').textContent = new Date().toLocaleDateString('de-DE', {
    weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
  });
  
  const certBanner = document.getElementById('cert-banner');
  
  if (partner?.certified) {
    certBanner.className = 'cert-banner certified';
    certBanner.innerHTML = `
      <div class="cert-icon">üèÖ</div>
      <div class="cert-info">
        <div class="cert-title" style="color:#22c55e">Pilot Zertifiziert!</div>
        <div class="cert-desc">Du bist offiziell zertifizierter Pilot Partner</div>
      </div>
    `;
  } else if (certRequest) {
    certBanner.className = 'cert-banner pending';
    certBanner.innerHTML = `
      <div class="cert-icon">‚è≥</div>
      <div class="cert-info">
        <div class="cert-title" style="color:#f97316">Zertifizierung in Pr√ºfung</div>
        <div class="cert-desc">Dein Antrag wird vom Admin-Team gepr√ºft</div>
      </div>
      <span class="tag tag-new">Ausstehend</span>
    `;
  }
  
  document.getElementById('stat-earnings').textContent = '‚Ç¨' + (partner?.total_revenue || 0).toLocaleString('de-DE');
  document.getElementById('stat-jobs').textContent = jobs.length;
  document.getElementById('stat-completed').textContent = partner?.total_jobs || 0;
  document.getElementById('stat-rating').textContent = partner?.rating ? partner.rating.toFixed(1) : '-';
  
  const jobsList = document.getElementById('jobs-list');
  if (jobs.length > 0) {
    jobsList.innerHTML = jobs.map(j => `
      <div class="job-item">
        <div class="job-icon">üßπ</div>
        <div class="job-info">
          <div class="job-title">${j.properties?.name || 'Objekt'}</div>
          <div class="job-details">${j.scheduled_date ? new Date(j.scheduled_date).toLocaleDateString('de-DE') : ''} ¬∑ ${j.properties?.address || ''}</div>
        </div>
        <div class="job-price">‚Ç¨${j.price || 0}</div>
      </div>
    `).join('');
  }
}

document.getElementById('cert-btn')?.addEventListener('click', async () => {
  const { error } = await db.from('cert_requests').insert({
    partner_id: user.id,
    status: 'pending',
    message: 'Zertifizierungsantrag'
  });
  
  if (error) {
    alert('Fehler: ' + error.message);
  } else {
    alert('Zertifizierungsantrag gesendet!');
    init();
  }
});

document.getElementById('logout-btn').addEventListener('click', async () => {
  await db.auth.signOut();
  window.location.href = 'auth.html';
});

init();
</script>
</body>
</html>
