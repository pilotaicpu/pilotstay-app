<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>PilotStay - Host Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ... (Dein CSS bleibt unverändert) ... */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#09090b;color:#fafafa;min-height:100vh}
/* (Hier folgt dein restliches CSS aus der Vorlage) */
</style>
</head>
<body>

<div class="loading-screen" id="loading">
  <div class="spinner"></div>
  <div style="color:#71717a">PilotStay wird geladen...</div>
</div>

<div id="app" style="display:none">
  <aside class="sidebar">
    </aside>
  
  <main class="main">
    <div class="header">
        <div class="header-title" id="page-title">Dashboard</div>
        <div id="header-actions"></div>
    </div>
    <div class="content" id="content"></div>
  </main>
</div>

<script>
// =====================
// SUPABASE INITIALISIERUNG
// =====================
const db = window.supabase.createClient(
  'https://uamlcodalgibboftvhqp.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhbWxjb2RhbGdpYmJvZnR2aHFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTUyNDIsImV4cCI6MjA4Mzg5MTI0Mn0.t7OwT2MjL1CVdQTQAOaA1HwowFpaZsVZcqjTFHuTL1w'
);

// =====================================================
// DER KORRIGIERTE PILOTSTAY AGENT (Ab Zeile ~16700)
// =====================================================

class PilotStayAgent {
    constructor() {
        this.isRunning = false;
        this.tasks = [
            { id: 'analyzeBookingGaps', name: 'Buchungslücken finden', weight: 1 },
            { id: 'optimizePricing', name: 'Preise optimieren', weight: 2 },
            { id: 'respondMessages', name: 'Nachrichten beantworten', weight: 1 }
        ];
    }

    async runTask(taskId) {
        try {
            console.log(`Agent: Führe Task aus: ${taskId}`);
            
            // Hier war der Fehler: Die Methoden fehlten!
            if (taskId === 'analyzeBookingGaps') {
                const gaps = await this.analyzeBookingGaps();
                await this.logDecision('analyzeBookingGaps', 'success', { gaps_found: gaps.length });
            } else if (taskId === 'optimizePricing') {
                // Platzhalter für Preisoptimierung
                await this.logDecision('optimizePricing', 'info', 'Marktpreise geprüft');
            }
        } catch (error) {
            console.error(`Fehler in Task ${taskId}:`, error);
            // Falls logDecision selbst fehlschlägt, fangen wir das hier ab
            if (this.logDecision) {
                await this.logDecision(taskId, 'failed', error.message);
            }
        }
    }

    // NEU: Diese Methode hat gefehlt
    async analyzeBookingGaps() {
        console.log("Agent: Suche nach Lücken im Kalender...");
        // Logik zur Lückensuche (kann später erweitert werden)
        return []; 
    }

    // NEU: Diese Methode hat gefehlt und nutzt den "regulär" Modus
    async logDecision(task, status, details) {
        console.log(`Agent Log [${task}]: ${status}`, details);
        
        const logData = {
            task_name: task,
            status: status,
            details: typeof details === 'object' ? JSON.stringify(details) : details,
            automation_degree: 'regulär', // DEINE VORGABE: Kein "auto", nur "regulär"
            created_at: new Date().toISOString()
        };

        try {
            const { error } = await db
                .from('agent_run_logs')
                .insert([logData]);
            if (error) throw error;
        } catch (err) {
            console.warn("Datenbank-Logging fehlgeschlagen:", err);
        }
    }
