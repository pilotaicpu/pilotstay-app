<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>PilotStay - Host Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#09090b;color:#fafafa;min-height:100vh}
.loading-screen{position:fixed;inset:0;background:#09090b;display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:16px}
.spinner{width:48px;height:48px;border:3px solid #27272a;border-top-color:#f97316;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.pulse{animation:pulse 2s infinite}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* Tutorial - Interactive Spotlight */
#tutorial-overlay{position:fixed;inset:0;z-index:5000}
#tutorial-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0);z-index:5001;transition:background .3s}
#tutorial-backdrop.active{background:rgba(0,0,0,.85)}
#tutorial-spotlight{position:absolute;z-index:5002;border-radius:6px;box-shadow:0 0 0 9999px rgba(0,0,0,.88), 0 0 30px rgba(249,115,22,.5);transition:all .4s ease;pointer-events:none}
#tutorial-tooltip{position:fixed;z-index:5003;background:linear-gradient(145deg,#1a1a1f,#131316);border:1px solid #f97316;border-radius:8px;padding:24px;width:380px;max-width:90vw;animation:tutorialFadeIn .4s ease;box-shadow:0 16px 48px rgba(0,0,0,.5)}
@keyframes tutorialFadeIn{from{opacity:0;transform:scale(.95) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes tutorialPulse{0%,100%{box-shadow:0 0 0 9999px rgba(0,0,0,.88), 0 0 30px rgba(249,115,22,.5)}50%{box-shadow:0 0 0 9999px rgba(0,0,0,.88), 0 0 50px rgba(249,115,22,.7)}}
#tutorial-spotlight.pulse{animation:tutorialPulse 2s infinite}
#tutorial-arrow{position:absolute;width:0;height:0;border:10px solid transparent}
#tutorial-arrow.left{right:100%;top:24px;border-right-color:#f97316}
#tutorial-arrow.right{left:100%;top:24px;border-left-color:#f97316}
#tutorial-arrow.top{bottom:100%;left:24px;border-bottom-color:#f97316}
#tutorial-arrow.bottom{top:100%;left:24px;border-top-color:#f97316}
#tutorial-arrow.hidden{display:none}
.tutorial-header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.tutorial-icon{font-size:32px;line-height:1}
.tutorial-step-label{font-size:10px;color:#f97316;font-weight:600;text-transform:uppercase;letter-spacing:1px}
.tutorial-title{font-size:18px;font-weight:700;margin-bottom:8px;color:#fafafa}
.tutorial-desc{color:#a1a1aa;font-size:13px;line-height:1.6;margin-bottom:18px}
.tutorial-progress{display:flex;gap:5px;margin-bottom:18px;justify-content:center}
.tutorial-dot{width:8px;height:8px;border-radius:2px;background:#27272a;transition:all .3s}
.tutorial-dot.done{background:#22c55e}
.tutorial-dot.active{background:#f97316;transform:scale(1.3);box-shadow:0 0 8px rgba(249,115,22,.5)}
.tutorial-actions{display:flex;gap:10px;align-items:center}
.tutorial-skip{background:none;border:none;color:#71717a;font-size:12px;cursor:pointer;padding:8px 14px;transition:color .2s}
.tutorial-skip:hover{color:#fafafa}
.tutorial-next{flex:1;padding:12px 20px;background:linear-gradient(135deg,#f97316,#fb923c);border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.tutorial-next:hover{transform:scale(1.01);box-shadow:0 4px 16px rgba(249,115,22,.4)}
.tutorial-highlight{position:relative;z-index:5002;box-shadow:0 0 0 3px rgba(249,115,22,0.6),0 0 20px rgba(249,115,22,0.4),0 0 40px rgba(249,115,22,0.2);border-radius:8px;animation:tutorial-pulse 1.5s ease-in-out infinite}
@keyframes tutorial-pulse{0%,100%{box-shadow:0 0 0 3px rgba(249,115,22,0.6),0 0 20px rgba(249,115,22,0.4),0 0 40px rgba(249,115,22,0.2)}50%{box-shadow:0 0 0 5px rgba(249,115,22,0.8),0 0 30px rgba(249,115,22,0.5),0 0 50px rgba(249,115,22,0.3)}}
.feature-flip-inner.flipped{transform:rotateY(180deg)}

/* Sidebar */
.sidebar{width:260px;background:#131316;border-right:1px solid #27272a;position:fixed;height:100vh;display:flex;flex-direction:column;z-index:100}
.sidebar-header{padding:20px;border-bottom:1px solid #27272a;display:flex;align-items:center;gap:12px}
.sidebar-logo{width:44px;height:44px;background:linear-gradient(135deg,#f97316,#fb923c);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:22px}
.sidebar-title{font-weight:700;font-size:18px}
.sidebar-sub{font-size:11px;color:#f97316}
.nav{flex:1;padding:16px;overflow-y:auto;scrollbar-width:none;-ms-overflow-style:none}
.nav::-webkit-scrollbar{display:none}
.nav-section{font-size:10px;color:#52525b;text-transform:uppercase;letter-spacing:1px;padding:12px 14px 8px}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:6px;cursor:pointer;color:#a1a1aa;margin-bottom:4px;transition:all .2s;font-size:13px;position:relative}
.nav-item:hover{background:#1f1f23;color:#fafafa}
.nav-item.active{background:#f9731620;color:#f97316}
.nav-icon{font-size:18px;width:24px;text-align:center}
.nav-badge{position:absolute;right:12px;min-width:20px;height:20px;background:#ef4444;border-radius:4px;font-size:10px;color:#fff;display:flex;align-items:center;justify-content:center}
.user-section{padding:16px;border-top:1px solid #27272a}
.user-card{display:flex;align-items:center;gap:12px;padding:12px;background:#18181b;border-radius:8px;margin-bottom:12px}
.user-avatar{width:40px;height:40px;background:linear-gradient(135deg,#f97316,#fb923c);border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px}
.user-name{font-size:14px;font-weight:600}
.user-plan{font-size:11px;color:#a1a1aa}
.logout-btn{width:100%;padding:10px;background:#27272a;border:none;border-radius:6px;color:#a1a1aa;font-size:12px;cursor:pointer}
.logout-btn:hover{background:#3f3f46;color:#fafafa}

/* Plan Cards */
.plan-card{transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1)}
.plan-card:hover{transform:translateY(-4px)}

/* Main */
.main{margin-left:260px;min-height:100vh}
.header{padding:24px 32px;border-bottom:1px solid #27272a;display:flex;justify-content:space-between;align-items:center;background:#09090b;position:sticky;top:0;z-index:50}
.header-title{font-size:24px;font-weight:700}
.header-subtitle{color:#71717a;font-size:13px;margin-top:4px}
.content{padding:32px}

/* ==================== MESSAGES MODULE CSS ==================== */
.messages-container{display:flex !important;flex-direction:row !important;flex-wrap:nowrap !important;gap:16px;height:calc(100vh - 200px);min-height:500px;max-height:800px;width:100%}
.messages-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:500px;text-align:center}
.messages-empty-icon{font-size:64px;margin-bottom:16px}
.messages-empty-title{font-size:18px;font-weight:700;margin-bottom:8px}
.messages-empty-text{color:#a1a1aa;margin-bottom:24px}

/* Chat List (Left Column) */
.chat-list{width:320px !important;min-width:320px !important;max-width:320px !important;flex-shrink:0 !important;flex-grow:0 !important;background:#18181b;border-radius:8px;border:1px solid #27272a;display:flex;flex-direction:column;overflow:hidden;height:100%}
.chat-list-header{padding:14px 16px;border-bottom:1px solid #27272a;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.chat-list-title{font-weight:600;font-size:14px}
.chat-list-actions{display:flex;gap:8px;align-items:center}
.chat-list-items{flex:1;overflow-y:auto;padding:8px}
.chat-list-item{display:flex;gap:12px;padding:12px;border-radius:6px;cursor:pointer;margin-bottom:4px;border-left:3px solid transparent;transition:all 0.15s ease}
.chat-list-item:hover{background:#27272a}
.chat-list-item-active{background:#27272a;border-left-color:#f97316}
.chat-list-avatar{width:40px;height:40px;border-radius:6px;background:linear-gradient(135deg,#ea580c,#f97316);display:flex;align-items:center;justify-content:center;font-weight:600;color:#fff;flex-shrink:0;font-size:14px}
.chat-list-info{flex:1;min-width:0;overflow:hidden}
.chat-list-name{font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chat-list-property{font-size:10px;color:#71717a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chat-list-preview{font-size:11px;color:#71717a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.chat-unread-badge{background:#f97316;color:#fff;font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;flex-shrink:0}

/* Chat Window (Right Column) */
.chat-window{flex:1 1 auto !important;min-width:0 !important;background:#18181b;border-radius:8px;border:1px solid #27272a;display:flex;flex-direction:column;overflow:hidden;height:100%}
.chat-window-empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center}
.chat-window-empty-icon{font-size:48px;margin-bottom:12px;opacity:0.5}
.chat-window-empty-text{color:#71717a}
.chat-window-header{padding:14px 16px;border-bottom:1px solid #27272a;display:flex;align-items:center;gap:12px;flex-shrink:0}
.chat-header-avatar{width:44px;height:44px;border-radius:6px;background:linear-gradient(135deg,#ea580c,#f97316);display:flex;align-items:center;justify-content:center;font-weight:600;color:#fff;flex-shrink:0}
.chat-header-info{flex:1;min-width:0}
.chat-header-name{font-weight:600;font-size:15px}
.chat-header-property{font-size:11px;color:#71717a}

/* Messages Area */
.chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.chat-no-messages{color:#71717a;text-align:center;padding:40px}
.chat-message{display:flex;flex-direction:column;max-width:75%}
.chat-message-left{align-self:flex-start}
.chat-message-right{align-self:flex-end}
.chat-message-meta{font-size:10px;color:#71717a;margin-bottom:4px}
.chat-message-right .chat-message-meta{text-align:right}
.chat-bubble{padding:12px 16px;border-radius:8px;font-size:13px;line-height:1.5;word-wrap:break-word}
.bubble-guest{background:#27272a;border:1px solid #3f3f46;border-radius:4px 8px 8px 8px}
.bubble-host{background:linear-gradient(135deg,#ea580c,#f97316);border-radius:8px 8px 4px 8px}
.bubble-ai{background:linear-gradient(135deg,#7c3aed,#8b5cf6);border-radius:8px 8px 4px 8px}

/* Smart Replies */
.smart-replies{padding:12px 16px;border-top:1px solid #27272a;background:#1a1a1e;flex-shrink:0}
.smart-replies-label{font-size:11px;color:#71717a;margin-bottom:8px}
.smart-replies-buttons{display:flex;flex-wrap:wrap;gap:8px}
.smart-reply-btn{background:#27272a;border:1px solid #3f3f46;padding:8px 14px;border-radius:20px;font-size:12px;cursor:pointer;color:#fafafa;transition:all 0.15s ease}
.smart-reply-btn:hover{background:#3f3f46;border-color:#52525b}

/* Input Area */
.chat-input-area{padding:14px 16px;border-top:1px solid #27272a;display:flex;gap:10px;align-items:center;flex-shrink:0;background:#18181b}
.chat-input{flex:1;background:#27272a;border:1px solid #3f3f46;border-radius:8px;padding:10px 14px;color:#fafafa;font-size:14px}
.chat-input:focus{outline:none;border-color:#f97316}
.chat-input::placeholder{color:#71717a}
.btn-icon{padding:8px 10px;background:#27272a;border:1px solid #3f3f46;border-radius:8px;cursor:pointer;font-size:14px}
.btn-icon:hover{background:#3f3f46}
.btn-icon-only{width:44px;height:44px;display:flex;align-items:center;justify-content:center}
/* ==================== END MESSAGES CSS ==================== */

/* Cards */
.card{background:#131316;border:1px solid #27272a;border-radius:8px;padding:20px;margin-bottom:16px;transition:all .2s}
.card:hover{border-color:#3f3f46}
.card-title{font-size:14px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:10px}
.card-ai{background:linear-gradient(135deg,#131316,#1a1a2e);border-color:#8b5cf650}
.property-card{display:flex;flex-direction:column;min-height:240px}
.property-card:hover{border-color:#f97316;box-shadow:0 4px 20px rgba(249,115,22,.1)}

/* Stats */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.stat-card{background:#131316;border:1px solid #27272a;border-radius:8px;padding:24px;text-align:center}
.stat-icon{font-size:28px;margin-bottom:12px}
.stat-value{font-size:32px;font-weight:700}
.stat-label{font-size:12px;color:#71717a;margin-top:6px}
.stat-change{font-size:11px;margin-top:8px;padding:4px 8px;border-radius:4px;display:inline-block}
.stat-change.up{background:#22c55e20;color:#22c55e}
.stat-change.down{background:#ef444420;color:#ef4444}

/* Grids */
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}

/* Buttons */
.btn{padding:12px 20px;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:all .2s}
.btn:hover{transform:scale(1.01)}
.btn-primary{background:linear-gradient(135deg,#f97316,#fb923c);color:#fff}
.btn-success{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff}
.btn-secondary{background:#27272a;color:#fafafa;border:1px solid #3f3f46}
.btn-ai{background:linear-gradient(135deg,#8b5cf6,#a78bfa);color:#fff}
.btn-sm{padding:8px 14px;font-size:12px}

/* Inputs */
.input{width:100%;padding:14px 16px;background:#18181b;border:1px solid #27272a;border-radius:6px;color:#fafafa;font-size:14px;transition:all .2s}
.input:focus{outline:none;border-color:#f97316}
.input::placeholder{color:#52525b}
.label{display:block;font-size:12px;color:#a1a1aa;margin-bottom:8px}
.select{width:100%;padding:14px 16px;background:#18181b;border:1px solid #27272a;border-radius:6px;color:#fafafa;font-size:14px}

/* Tags */
.tag{padding:4px 12px;border-radius:4px;font-size:11px;font-weight:600}
.tag-green{background:#22c55e20;color:#22c55e}
.tag-orange{background:#f9731620;color:#f97316}
.tag-blue{background:#3b82f620;color:#3b82f6}
.tag-purple{background:#8b5cf620;color:#8b5cf6}
.tag-red{background:#ef444420;color:#ef4444}

/* Lists */
.list-item{display:flex;align-items:center;gap:16px;padding:16px;background:#18181b;border-radius:8px;margin-bottom:10px;transition:all .2s}
.list-item:hover{background:#1f1f23}
.list-icon{font-size:28px}
.list-info{flex:1}
.list-title{font-weight:600;font-size:14px}
.list-subtitle{font-size:12px;color:#71717a;margin-top:2px}

/* Empty State */
.empty-state{text-align:center;padding:60px 20px;color:#71717a}
.empty-icon{font-size:56px;margin-bottom:16px}
.empty-title{font-size:16px;font-weight:600;color:#fafafa;margin-bottom:8px}
.empty-desc{font-size:13px;margin-bottom:20px}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
.modal{background:#131316;border:1px solid #27272a;border-radius:8px;padding:28px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
.modal-title{font-size:18px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;gap:10px}

/* Table */
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:14px 16px;text-align:left;border-bottom:1px solid #27272a}
.table th{font-size:11px;color:#71717a;text-transform:uppercase}
.table tr:hover td{background:#18181b}

/* Chat */
.chat-container{display:grid;grid-template-columns:280px 1fr;gap:20px;height:calc(100vh - 200px)}
.chat-list{background:#131316;border:1px solid #27272a;border-radius:8px;overflow:hidden;display:flex;flex-direction:column}
.chat-list-header{padding:16px;border-bottom:1px solid #27272a;font-weight:600}
.chat-list-items{flex:1;overflow-y:auto}
.chat-item{display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer;border-bottom:1px solid #27272a20;transition:all .2s}
.chat-item:hover,.chat-item.active{background:#1f1f23}
.chat-item.active{border-left:3px solid #f97316}
.chat-avatar{width:40px;height:40px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px}
.chat-preview{flex:1;min-width:0}
.chat-name{font-weight:600;font-size:13px;margin-bottom:2px}
.chat-last{font-size:11px;color:#71717a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chat-time{font-size:10px;color:#52525b}
.chat-unread{min-width:20px;height:20px;background:#ef4444;border-radius:4px;font-size:10px;color:#fff;display:flex;align-items:center;justify-content:center}
.chat-window{background:#131316;border:1px solid #27272a;border-radius:8px;display:flex;flex-direction:column;max-height:calc(100vh - 200px)}
.chat-header{padding:16px 20px;border-bottom:1px solid #27272a;display:flex;align-items:center;gap:12px;flex-shrink:0}
.chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px;min-height:200px;max-height:450px}
.message{max-width:75%;display:flex;flex-direction:column}
.message.sent{align-self:flex-end;align-items:flex-end}
.message.received{align-self:flex-start;align-items:flex-start}
.message-sender{font-size:10px;font-weight:600;margin-bottom:4px;padding:0 4px}
.message.sent .message-sender{color:#f97316}
.message.received .message-sender{color:#22c55e}
.message-bubble{padding:12px 16px;border-radius:8px;font-size:14px;line-height:1.5;word-wrap:break-word}
.message.sent .message-bubble{background:linear-gradient(135deg,#f97316,#fb923c);color:#fff;border-bottom-right-radius:4px}
.message.received .message-bubble{background:#27272a;color:#fafafa;border-bottom-left-radius:4px}
.message-ai .message-bubble{background:linear-gradient(135deg,#8b5cf6,#a78bfa);color:#fff}
.message-time{font-size:10px;color:#52525b;margin-top:4px;padding:0 4px}
.chat-input{padding:16px;border-top:1px solid #27272a;display:flex;gap:12px;flex-shrink:0}
.chat-input input{flex:1}
.smart-replies{padding:12px 16px;border-top:1px solid #27272a;background:#18181b;flex-shrink:0;max-height:120px;overflow-y:auto}
.smart-replies-title{font-size:11px;color:#8b5cf6;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.smart-reply-btn{padding:8px 14px;background:#27272a;border:1px solid #3f3f46;border-radius:6px;color:#fafafa;font-size:12px;cursor:pointer;margin-right:8px;margin-bottom:8px;transition:all .2s}
.smart-reply-btn:hover{background:#8b5cf620;border-color:#8b5cf6}


/* Reviews */
.review-card{background:#18181b;border-radius:12px;padding:20px;margin-bottom:16px}
.review-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.review-avatar{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;background:linear-gradient(135deg,#3b82f6,#60a5fa)}
.review-info{flex:1}
.review-name{font-weight:600;font-size:14px}
.review-meta{font-size:11px;color:#71717a;margin-top:2px}
.review-stars{color:#fbbf24}
.review-text{font-size:14px;line-height:1.6;margin-bottom:16px}
.review-reply{background:#131316;border-radius:10px;padding:14px;margin-top:12px}
.review-reply-label{font-size:11px;color:#71717a;margin-bottom:6px}
.ai-suggestion{background:linear-gradient(135deg,#8b5cf620,#8b5cf610);border:1px solid #8b5cf640;border-radius:12px;padding:16px;margin-top:12px}
.ai-suggestion-header{font-size:12px;color:#8b5cf6;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.ai-suggestion-text{font-size:13px;line-height:1.6;margin-bottom:12px}

/* Pricing */
.pricing-card{background:#18181b;border-radius:12px;padding:20px}
.pricing-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.pricing-property{font-weight:600;font-size:16px}
.pricing-current{font-size:24px;font-weight:700}
.pricing-suggestion{display:flex;align-items:center;gap:12px;padding:16px;background:linear-gradient(135deg,#22c55e10,#22c55e05);border:1px solid #22c55e40;border-radius:10px;margin-top:12px}
.pricing-arrow{font-size:24px}
.pricing-new{font-size:28px;font-weight:700;color:#22c55e}
.pricing-reason{font-size:12px;color:#a1a1aa;margin-top:4px}
.pricing-factors{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.pricing-calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:16px}
.cal-header{font-size:10px;color:#71717a;text-align:center;padding:8px}
.cal-day{aspect-ratio:1;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:12px;cursor:pointer;transition:all .2s}
.cal-day:hover{background:#27272a}
.cal-day.low{background:#22c55e20;color:#22c55e}
.cal-day.medium{background:#f9731620;color:#f97316}
.cal-day.high{background:#ef444420;color:#ef4444}
.cal-day .cal-price{font-size:9px;margin-top:2px}

/* Toggle */
.toggle{width:48px;height:26px;border-radius:13px;background:#27272a;border:none;cursor:pointer;position:relative;transition:all .2s}
.toggle.active{background:#22c55e}
.toggle-knob{width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;left:3px;transition:all .2s}
.toggle.active .toggle-knob{left:25px}

/* Responsive */
@media(max-width:1200px){.stats-grid{grid-template-columns:repeat(2,1fr)}.chat-container{grid-template-columns:1fr}}
@media(max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}
@media(max-width:768px){.sidebar{display:none}.main{margin-left:0}}
</style>
</head>
<body>

<!-- Loading -->
<div class="loading-screen" id="loading">
  <div class="spinner"></div>
  <div style="color:#71717a">PilotStay wird geladen...</div>
</div>

<!-- Tutorial Spotlight Overlay -->
<div id="tutorial-overlay" style="display:none">
  <div id="tutorial-backdrop"></div>
  <div id="tutorial-spotlight"></div>
  <div id="tutorial-tooltip">
    <div id="tutorial-arrow"></div>
    <div class="tutorial-header">
      <span id="tutorial-step-icon" class="tutorial-icon">üëã</span>
      <span id="tutorial-step-label" class="tutorial-step-label">Schritt 1 von 10</span>
    </div>
    <div id="tutorial-step-title" class="tutorial-title">Willkommen!</div>
    <div id="tutorial-step-desc" class="tutorial-desc">Beschreibung</div>
    <div id="tutorial-progress" class="tutorial-progress"></div>
    <div class="tutorial-actions">
      <button id="tutorial-skip" class="tutorial-skip">√úberspringen</button>
      <button id="tutorial-next" class="tutorial-next">Weiter ‚Üí</button>
    </div>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none">
  
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">üè†</div>
      <div>
        <div class="sidebar-title">PilotStay</div>
        <div class="sidebar-sub">Host Dashboard</div>
      </div>
    </div>
    
    <nav class="nav">
      <div class="nav-section">Hauptmen√º</div>
      <div class="nav-item active" data-page="dashboard">
        <span class="nav-icon">üìä</span>Dashboard
      </div>
      <div class="nav-item" data-page="bookings">
        <span class="nav-icon">üìÖ</span>Buchungen
      </div>
      <div class="nav-item" data-page="properties">
        <span class="nav-icon">üè†</span>Objekte
      </div>
      <!-- HIDDEN: Partner module temporarily disabled
      <div class="nav-item" data-page="partners">
        <span class="nav-icon">ü§ù</span>Partner
      </div>
      -->
      
      <div class="nav-section">KI-Tools</div>
      <div class="nav-item" data-page="messages">
        <span class="nav-icon">üí¨</span>Nachrichten
        <span class="nav-badge" id="msg-badge" style="display:none">0</span>
      </div>
      <div class="nav-item" data-page="reviews">
        <span class="nav-icon">‚≠ê</span>Bewertungen
      </div>
      <div class="nav-item" data-page="pricing">
        <span class="nav-icon">üí∞</span>Preisoptimierung
      </div>
      
      <div class="nav-section">System</div>
      <div class="nav-item" data-page="automation">
        <span class="nav-icon">ü§ñ</span>Automatisierung
      </div>
      <div class="nav-item" data-page="billing">
        <span class="nav-icon">üí≥</span>Payments & Billing
      </div>
      <div class="nav-item" data-page="settings">
        <span class="nav-icon">‚öôÔ∏è</span>Einstellungen
      </div>
    </nav>
    
    <div class="user-section">
      <div class="user-card">
        <div class="user-avatar" id="user-avatar">?</div>
        <div>
          <div class="user-name" id="user-name">Laden...</div>
          <div class="user-plan" id="user-plan">Laden...</div>
        </div>
      </div>
      <button class="logout-btn" id="logout-btn">üö™ Abmelden</button>
    </div>
  </aside>
  
  <!-- Main -->
  <main class="main">
    <div class="header">
      <div>
        <div class="header-title" id="page-title">Dashboard</div>
        <div class="header-subtitle" id="page-subtitle"></div>
      </div>
      <div style="display:flex;align-items:center;gap:16px">
        <!-- Notification Button -->
        <button onclick="showNotifications()" style="position:relative;background:none;border:none;cursor:pointer;padding:8px">
          <span style="font-size:20px">üîî</span>
          <span id="notification-badge" style="display:none;position:absolute;top:2px;right:2px;background:#ef4444;color:white;font-size:10px;font-weight:700;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center">0</span>
        </button>
        <div id="header-actions"></div>
      </div>
    </div>
    <div class="content" id="content"></div>
  </main>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal" style="display:none">
  <div class="modal" id="modal-content"></div>
</div>

<script>
// =====================
// SUPABASE
// =====================
const db = window.supabase.createClient(
  'https://uamlcodalgibboftvhqp.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhbWxjb2RhbGdpYmJvZnR2aHFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTUyNDIsImV4cCI6MjA4Mzg5MTI0Mn0.t7OwT2MjL1CVdQTQAOaA1HwowFpaZsVZcqjTFHuTL1w'
);

// =====================
// STATE
// =====================
let user, profile, currentPage = 'dashboard';
let properties = [], bookings = [];
let settingsTab = 'profile'; // profile, address, company, payment, help
let billingTab = 'plans'; // plans, current, invoices, usage

// Subscription & Billing
const STRIPE_BILLING_URL = 'https://uamlcodalgibboftvhqp.supabase.co/functions/v1/stripe-billing';
let subscriptionPlans = [];
let userSubscription = null;
let scheduledPlanChange = null; // For scheduled plan changes

// =====================
// FEATURE ACCESS CONTROL SYSTEM
// =====================
const ADMIN_EMAIL = 'neglia.antonino@gmx.de';

// Feature definitions per plan
const PLAN_FEATURES = {
  'takeoff': {
    features: ['dashboard', 'properties', 'bookings', 'calendar', 'basic_analytics', 'email_notifications'],
    limits: { properties: 10 },
    automationModes: { smartReplies: ['off', 'manual'], reviewReplies: ['off', 'manual'], autoPricing: ['off', 'manual'] }
  },
  'cruise': {
    features: ['dashboard', 'properties', 'bookings', 'calendar', 'basic_analytics', 'email_notifications', 
               'smart_replies', 'review_replies', 'auto_pricing', 'event_analysis', 'advanced_kpis'],
    limits: { properties: 50 },
    automationModes: { smartReplies: ['off', 'manual', 'hybrid'], reviewReplies: ['off', 'manual', 'hybrid'], autoPricing: ['off', 'manual', 'hybrid'] }
  },
  'autopilot': {
    features: ['dashboard', 'properties', 'bookings', 'calendar', 'basic_analytics', 'email_notifications',
               'smart_replies', 'review_replies', 'auto_pricing', 'event_analysis', 'advanced_kpis',
               'full_automation', 'priority_ai', 'early_access', 'partner_network'],
    limits: { properties: 200 },
    automationModes: { smartReplies: ['off', 'manual', 'hybrid', 'auto'], reviewReplies: ['off', 'manual', 'hybrid', 'auto'], autoPricing: ['off', 'manual', 'hybrid', 'auto'] }
  },
  'enterprise': {
    features: ['all'],
    limits: { properties: Infinity },
    automationModes: { smartReplies: ['off', 'manual', 'hybrid', 'auto'], reviewReplies: ['off', 'manual', 'hybrid', 'auto'], autoPricing: ['off', 'manual', 'hybrid', 'auto'] }
  }
};

// Feature display names and descriptions (for tooltips)
const FEATURE_INFO = {
  'dashboard': { name: 'Dashboard', desc: '√úbersicht aller wichtigen KPIs und Statistiken' },
  'properties': { name: 'Objektverwaltung', desc: 'Verwalte deine Ferienwohnungen und Apartments' },
  'bookings': { name: 'Buchungen', desc: 'Alle Reservierungen im √úberblick' },
  'calendar': { name: 'Kalender', desc: 'Visualisierung aller Buchungen im Kalender' },
  'basic_analytics': { name: 'Basis-Analytics', desc: 'Grundlegende Auswertungen und Statistiken' },
  'email_notifications': { name: 'E-Mail Benachrichtigungen', desc: 'Automatische E-Mails bei neuen Buchungen' },
  'smart_replies': { name: 'Smart Replies', desc: 'KI-generierte Antworten auf G√§stenachrichten' },
  'review_replies': { name: 'Review-Antworten', desc: 'KI-generierte Antworten auf G√§stebewertungen' },
  'auto_pricing': { name: 'Auto-Pricing', desc: 'Dynamische Preisoptimierung basierend auf Nachfrage & Events' },
  'event_analysis': { name: 'Event-Analyse', desc: 'Erkennung von Events und Veranstaltungen in der N√§he' },
  'advanced_kpis': { name: 'Erweiterte KPIs', desc: 'Detaillierte Leistungskennzahlen und Vergleiche' },
  'full_automation': { name: 'Vollautomatisierung', desc: 'Komplett autonome G√§stekommunikation' },
  'priority_ai': { name: 'Priorisierte KI', desc: 'Schnellere KI-Verarbeitung und bessere Modelle' },
  'early_access': { name: 'Early Access', desc: 'Zugang zu neuen Features vor allen anderen' },
  'partner_network': { name: 'Partner-Netzwerk', desc: 'Zugang zu verifizierten Reinigungskr√§ften & Services' }
};

// Check if user is admin (bypass all restrictions)
function isAdmin() {
  return user?.email === ADMIN_EMAIL || profile?.role === 'admin';
}

// Get current active plan - ONLY from Stripe-verified subscription
function getCurrentPlan() {
  // Admin bypass
  if (isAdmin()) {
    return userSubscription?.plan_id || 'autopilot';
  }
  
  // No subscription data = no plan
  if (!userSubscription) {
    return null;
  }
  
  // Check if user has an active subscription (Stripe-verified)
  const status = userSubscription.status;
  const hasActiveSubscription = status === 'active' || status === 'trialing';
  
  // If subscription is not active, no plan access
  if (!hasActiveSubscription) {
    return null;
  }
  
  // Check for upgrade trial - if active, use the trial plan for FEATURES
  if (userSubscription.upgrade_trial_plan && userSubscription.upgrade_trial_ends) {
    const trialEnd = new Date(userSubscription.upgrade_trial_ends);
    if (new Date() < trialEnd) {
      // Trial is active - use the higher plan for features
      console.log('Upgrade trial active, using features from:', userSubscription.upgrade_trial_plan);
      return userSubscription.upgrade_trial_plan;
    }
  }
  
  // Return the plan from subscription (this was verified against Stripe)
  const planId = userSubscription.plan_id;
  
  // Validate that it's a real plan
  if (planId && PLAN_FEATURES[planId]) {
    return planId;
  }
  
  return null;
}

// Get the BILLING plan (for display purposes, not features)
function getBillingPlan() {
  if (!userSubscription) return null;
  return userSubscription.plan_id;
}

// Check if user is in an upgrade trial
function isInUpgradeTrial() {
  if (!userSubscription?.upgrade_trial_plan || !userSubscription?.upgrade_trial_ends) {
    return false;
  }
  return new Date() < new Date(userSubscription.upgrade_trial_ends);
}

// Check if user has access to a specific feature
function hasFeatureAccess(featureId) {
  if (isAdmin()) return true;
  
  const plan = getCurrentPlan();
  if (!plan) return false; // No plan = no features
  
  const planFeatures = PLAN_FEATURES[plan];
  if (!planFeatures) return false;
  
  if (planFeatures.features.includes('all')) return true;
  return planFeatures.features.includes(featureId);
}

// Check if automation mode is allowed for current plan
function isAutomationModeAllowed(feature, mode) {
  if (isAdmin()) return true;
  
  const plan = getCurrentPlan();
  // No plan = only 'off' allowed
  if (!plan) return mode === 'off';
  
  const planFeatures = PLAN_FEATURES[plan];
  if (!planFeatures) return false;
  
  const allowedModes = planFeatures.automationModes[feature];
  return allowedModes ? allowedModes.includes(mode) : false;
}

// Check if user can toggle automation feature at all
function canToggleAutomation(feature) {
  if (isAdmin()) return true;
  
  const plan = getCurrentPlan();
  if (!plan) return false; // No plan = no automation at all
  
  // Map feature to required plan feature
  const featureMap = {
    'smartReplies': 'smart_replies',
    'reviewReplies': 'review_replies',
    'autoPricing': 'auto_pricing'
  };
  
  const requiredFeature = featureMap[feature];
  if (!requiredFeature) return true; // Unknown feature, allow
  
  return hasFeatureAccess(requiredFeature);
}

// Module to feature mapping - which modules require which plan
const MODULE_REQUIREMENTS = {
  'dashboard': null, // Always available
  'bookings': null, // Always available  
  'properties': null, // Always available
  'messages': 'smart_replies', // Requires Cruise+
  'reviews': 'review_replies', // Requires Cruise+
  'pricing': 'auto_pricing', // Requires Cruise+
  'automation': null, // Always available (but features inside are restricted)
  'billing': null, // Always available
  'settings': null // Always available
};

// Check if user can access a module
function canAccessModule(moduleName) {
  if (isAdmin()) return true;
  
  const plan = getCurrentPlan();
  
  // Without a plan, only allow basic modules
  if (!plan) {
    const freeModules = ['dashboard', 'bookings', 'properties', 'automation', 'billing', 'settings'];
    return freeModules.includes(moduleName);
  }
  
  const requiredFeature = MODULE_REQUIREMENTS[moduleName];
  if (!requiredFeature) return true; // No requirement
  
  return hasFeatureAccess(requiredFeature);
}

// Get required plan for a module
function getRequiredPlanForModule(moduleName) {
  const requiredFeature = MODULE_REQUIREMENTS[moduleName];
  if (!requiredFeature) return 'takeoff';
  
  // Find the lowest plan that has this feature
  const planOrder = ['takeoff', 'cruise', 'autopilot', 'enterprise'];
  for (const plan of planOrder) {
    const features = PLAN_FEATURES[plan]?.features || [];
    if (features.includes('all') || features.includes(requiredFeature)) {
      return plan;
    }
  }
  return 'cruise'; // Default
}

// Get property limit for current plan
function getPropertyLimit() {
  if (isAdmin()) return Infinity;
  
  const plan = getCurrentPlan();
  if (!plan) return 3; // Free tier
  
  const planFeatures = PLAN_FEATURES[plan];
  return planFeatures?.limits?.properties || 10;
}

// Get only active properties (for billing and feature access)
function getActiveProperties() {
  return properties.filter(p => p.active !== false);
}

// Check if property should have feature access
function propertyHasAccess(propertyId) {
  const prop = properties.find(p => p.id === propertyId);
  if (!prop || prop.active === false) return false;
  return true;
}

// Show upgrade required modal
function showUpgradeRequired(featureName, requiredPlan = 'cruise') {
  const planNames = { takeoff: 'Takeoff', cruise: 'Cruise', autopilot: 'Autopilot', enterprise: 'Enterprise' };
  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="width:48px;height:48px;margin:0 auto 16px;background:rgba(249,115,22,0.1);border-radius:12px;display:flex;align-items:center;justify-content:center">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
      </div>
      <div style="font-size:18px;font-weight:700;margin-bottom:8px">Upgrade erforderlich</div>
      <div style="color:#a1a1aa;margin-bottom:24px;line-height:1.5">
        <strong>${featureName}</strong> ist ab dem <span style="color:#f97316">${planNames[requiredPlan]}</span> Plan verf√ºgbar.
      </div>
      <div style="display:flex;gap:12px;justify-content:center">
        <button class="btn btn-secondary" onclick="hideModal()">Sp√§ter</button>
        <button class="btn btn-primary" onclick="hideModal(); setPage('billing'); setBillingTab('plans', true)">
          Pl√§ne ansehen
        </button>
      </div>
    </div>
  `);
}

// Smoobu Integration
const SMOOBU_PROXY_URL = 'https://uamlcodalgibboftvhqp.supabase.co/functions/v1/smoobu-proxy';

let smoobuConfig = {
  apiKey: localStorage.getItem('smoobu_api_key') || '',
  connected: localStorage.getItem('smoobu_connected') === 'true',
  lastSync: localStorage.getItem('smoobu_last_sync') || null,
  syncInterval: null,
  smoobuUser: null,
  smoobuApartments: []
};

// AI Proxy URL (your Supabase Edge Function - keeps OpenAI key secret)
const AI_PROXY_URL = 'https://uamlcodalgibboftvhqp.supabase.co/functions/v1/ai-proxy';

// Automation Settings - persisted in localStorage and Supabase
// Modes: 'off' | 'manual' | 'auto' | 'hybrid'
let automationSettings = {
  // Smart Replies for Guest Messages
  smartReplies: localStorage.getItem('auto_smart_replies') !== 'false',
  smartRepliesMode: localStorage.getItem('smart_replies_mode') || 'manual', // manual, auto, hybrid
  
  // Review Replies
  reviewReplies: localStorage.getItem('auto_review_replies') !== 'false',
  reviewRepliesMode: localStorage.getItem('review_replies_mode') || 'manual',
  
  // Auto Pricing
  autoPricing: localStorage.getItem('auto_pricing') !== 'false',
  autoPricingMode: localStorage.getItem('auto_pricing_mode') || 'manual',
  
  // Auto Jobs (Cleaning etc)
  autoJobs: localStorage.getItem('auto_jobs') === 'true',
  autoJobsMode: localStorage.getItem('auto_jobs_mode') || 'manual',
  
  // AI Learning & Personalization
  aiLearning: localStorage.getItem('ai_learning') !== 'false',
  aiTone: localStorage.getItem('ai_tone') || 'friendly', // formal, friendly, casual
  aiLanguage: localStorage.getItem('ai_language') || 'de'
};

// AI Context - Learned patterns and preferences per property
let aiContext = {
  properties: {}, // propertyId -> { wifi, parking, checkin, checkout, houseRules, customInfo }
  savedReplies: [], // Successful replies that can be reused
  feedbackHistory: [], // { messageId, response, rating, timestamp }
  commonQuestions: {} // question pattern -> best answer
};

// Server-side notifications (from cron job)
let notifications = [];
let unreadNotificationCount = 0;

// Auto-reply categories for hybrid mode
const autoReplyCategories = {
  // Simple questions - can be auto-answered
  simple: [
    'wifi', 'wlan', 'internet', 'passwort', 'password',
    'parkplatz', 'parken', 'parking', 'garage',
    'check-in', 'checkin', 'check-out', 'checkout', 'zeit', 'uhrzeit', 'time',
    'adresse', 'address', 'anfahrt', 'weg', 'finden',
    'schl√ºssel', 'key', 'code', 'zugang',
    'm√ºll', 'trash', 'garbage', 'recycling',
    'heizung', 'heating', 'klimaanlage', 'ac', 'air conditioning',
    'handt√ºcher', 'towels', 'bettw√§sche', 'bedding',
    'danke', 'thanks', 'thank you', 'super', 'toll', 'great'
  ],
  // Complex questions - need manual approval
  complex: [
    'problem', 'kaputt', 'broken', 'funktioniert nicht', 'not working',
    'beschwerde', 'complaint', 'unzufrieden', 'unhappy',
    'stornieren', 'cancel', 'stornierung', 'cancellation',
    'erstattung', 'refund', 'geld zur√ºck', 'money back',
    'verl√§ngern', 'extend', 'l√§nger', 'longer', 'weitere nacht',
    'fr√ºher', 'earlier', 'sp√§ter', 'later', '√§ndern', 'change',
    'notfall', 'emergency', 'dringend', 'urgent',
    'unfall', 'accident', 'verletzt', 'injured',
    'polizei', 'police', 'krankenhaus', 'hospital'
  ]
};

// Check if a message is simple (for hybrid mode)
function isSimpleQuestion(message) {
  const text = message.toLowerCase();
  
  // Check if contains complex keywords
  for (const keyword of autoReplyCategories.complex) {
    if (text.includes(keyword)) return false;
  }
  
  // Check if contains simple keywords
  for (const keyword of autoReplyCategories.simple) {
    if (text.includes(keyword)) return true;
  }
  
  // Default to complex (needs manual approval) for safety
  return false;
}

// Demo data for AI features
// Chats - loaded from Smoobu messages API
let chats = [];
let activeChat = null;

// Reviews - loaded from Smoobu/Airbnb API
let reviews = [];

let pricingData = {
  enabled: true,
  strategy: 'balanced',
  properties: [], // Will be populated from Smoobu sync or local properties
  dailyPrices: {}, // propertyId -> [{date, basePrice, finalPrice, factors, events}]
  events: [], // Cached events from Ticketmaster
  lastEventFetch: null
};

// German holidays 2025/2026
const germanHolidays = [
  { date: '2025-01-01', name: 'Neujahr', boost: 0.20 },
  { date: '2025-04-18', name: 'Karfreitag', boost: 0.15 },
  { date: '2025-04-20', name: 'Ostersonntag', boost: 0.25 },
  { date: '2025-04-21', name: 'Ostermontag', boost: 0.25 },
  { date: '2025-05-01', name: 'Tag der Arbeit', boost: 0.15 },
  { date: '2025-05-29', name: 'Christi Himmelfahrt', boost: 0.20 },
  { date: '2025-06-08', name: 'Pfingstsonntag', boost: 0.20 },
  { date: '2025-06-09', name: 'Pfingstmontag', boost: 0.20 },
  { date: '2025-10-03', name: 'Tag der Deutschen Einheit', boost: 0.15 },
  { date: '2025-12-24', name: 'Heiligabend', boost: 0.30 },
  { date: '2025-12-25', name: '1. Weihnachtstag', boost: 0.35 },
  { date: '2025-12-26', name: '2. Weihnachtstag', boost: 0.35 },
  { date: '2025-12-31', name: 'Silvester', boost: 0.50 },
  { date: '2026-01-01', name: 'Neujahr', boost: 0.20 },
  { date: '2026-04-03', name: 'Karfreitag', boost: 0.15 },
  { date: '2026-04-05', name: 'Ostersonntag', boost: 0.25 },
  { date: '2026-04-06', name: 'Ostermontag', boost: 0.25 },
  { date: '2026-05-01', name: 'Tag der Arbeit', boost: 0.15 },
  { date: '2026-05-14', name: 'Christi Himmelfahrt', boost: 0.20 },
  { date: '2026-05-24', name: 'Pfingstsonntag', boost: 0.20 },
  { date: '2026-05-25', name: 'Pfingstmontag', boost: 0.20 },
  { date: '2026-10-03', name: 'Tag der Deutschen Einheit', boost: 0.15 },
  { date: '2026-12-24', name: 'Heiligabend', boost: 0.30 },
  { date: '2026-12-25', name: '1. Weihnachtstag', boost: 0.35 },
  { date: '2026-12-26', name: '2. Weihnachtstag', boost: 0.35 },
  { date: '2026-12-31', name: 'Silvester', boost: 0.50 },
];

// Ticketmaster API (free tier: 5000 calls/day)
const TICKETMASTER_API_KEY = 'pLOeuGq2JL05uEGrZG7DuGWu6sh2OnMz'; // Public demo key

// Tutorial - Interactive Spotlight Tour with Active Navigation
const tutorialSteps = [
  {
    id: 'welcome',
    icon: 'üëã',
    title: 'Willkommen bei PilotStay',
    desc: 'In wenigen Schritten zeige ich dir die Navigation deines Dashboards.',
    target: null,
    position: 'center',
    navigate: null,
    button: 'Starten'
  },
  {
    id: 'sidebar',
    icon: 'üìç',
    title: 'Deine Navigation',
    desc: 'Die Sidebar links ist deine zentrale Steuerung. Von hier erreichst du alle Module.',
    target: '.sidebar',
    position: 'right',
    navigate: null,
    button: 'Weiter'
  },
  {
    id: 'nav-dashboard',
    icon: 'üìä',
    title: 'Dashboard',
    desc: 'Deine Startseite mit allen KPIs: Umsatz, Buchungen, Nachrichten und dein KI-Aktivierungsstatus.',
    target: '[data-page="dashboard"]',
    position: 'right',
    navigate: null,
    button: 'Weiter'
  },
  {
    id: 'nav-bookings',
    icon: 'üìÖ',
    title: 'Buchungen',
    desc: 'Alle Reservierungen auf einen Blick. Synchronisiert automatisch mit Smoobu.',
    target: '[data-page="bookings"]',
    position: 'right',
    navigate: null,
    button: 'Weiter'
  },
  {
    id: 'nav-properties',
    icon: 'üè†',
    title: 'Objekte',
    desc: 'Deine Ferienwohnungen verwalten. Import via Smoobu oder manuell anlegen.',
    target: '[data-page="properties"]',
    position: 'right',
    navigate: null,
    button: 'Weiter'
  },
  {
    id: 'nav-messages',
    icon: 'üí¨',
    title: 'Nachrichten',
    desc: 'G√§stekommunikation mit KI-Unterst√ºtzung. Smart Replies generiert passende Antworten.',
    target: '[data-page="messages"]',
    position: 'right',
    navigate: null,
    button: 'Weiter'
  },
  {
    id: 'nav-reviews',
    icon: '‚≠ê',
    title: 'Bewertungen',
    desc: 'G√§stebewertungen verwalten. KI erstellt personalisierte Antwortvorschl√§ge.',
    target: '[data-page="reviews"]',
    position: 'right',
    navigate: null,
    button: 'Weiter'
  },
  {
    id: 'nav-pricing',
    icon: 'üí∞',
    title: 'Preisoptimierung',
    desc: 'Dynamische Preise basierend auf Nachfrage, Events und Saisons.',
    target: '[data-page="pricing"]',
    position: 'right',
    navigate: null,
    button: 'Weiter'
  },
  {
    id: 'nav-automation',
    icon: 'ü§ñ',
    title: 'Automatisierung',
    desc: 'Smoobu verbinden und KI-Automatisierungen konfigurieren.',
    target: '[data-page="automation"]',
    position: 'right',
    navigate: null,
    button: 'Weiter'
  },
  {
    id: 'nav-billing',
    icon: 'üí≥',
    title: 'Payments & Billing',
    desc: 'Abonnement, Pl√§ne, Rechnungen und Zahlungsmethoden.',
    target: '[data-page="billing"]',
    position: 'right',
    navigate: null,
    button: 'Weiter'
  },
  {
    id: 'nav-settings',
    icon: '‚öôÔ∏è',
    title: 'Einstellungen',
    desc: 'Profil, Adresse, Unternehmensdaten und Hilfe.',
    target: '[data-page="settings"]',
    position: 'right',
    navigate: null,
    button: 'Weiter'
  },
  {
    id: 'complete',
    icon: '‚úÖ',
    title: 'Fertig!',
    desc: 'Du kennst jetzt alle Bereiche. Tipp: Verbinde zuerst Smoobu unter "Automatisierung".',
    target: null,
    position: 'center',
    navigate: null,
    button: 'Los geht\'s'
  }
];
let tutorialCurrentStep = 0;

// =====================
// INIT
// =====================
async function init() {
  try {
    // Check if running locally (file://)
    if (window.location.protocol === 'file:') {
      showLocalFileError();
      return;
    }
    
    const {data:{session}, error} = await db.auth.getSession();
    
    if (error) {
      console.error('Auth error:', error);
      showAuthError(error.message);
      return;
    }
    
    if (!session) {
      // No session - redirect to login
      window.location.href = 'auth.html';
      return;
    }
    
    user = session.user;
    const {data:p} = await db.from('profiles').select('*').eq('id', user.id).single();
    profile = p;
    
    if (profile?.role !== 'host' && profile?.role !== 'admin') {
      window.location.href = 'partner-dashboard.html';
      return;
    }
    
    await loadData();
    await loadAutomationSettings();
    await loadSubscription(); // Load user subscription
    loadPricingStrategy();
    
    document.getElementById('loading').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    
    renderUser();
    checkSmoobuConnection();
    checkCheckoutResult(); // Check for Stripe checkout result
    renderPage();
    bindEvents();
    
    // Show tutorial on first login - ACCOUNT-BASED check (not localStorage)
    // Only check Supabase profile for tutorial completion (account-based)
    const tutorialDone = profile?.tutorial_completed === true;
    const isNewAccount = !tutorialDone && profile?.created_at && 
      (new Date() - new Date(profile.created_at)) < 24 * 60 * 60 * 1000; // Account less than 24h old
    
    if (!tutorialDone) {
      // Always show tutorial for accounts that haven't completed it
      setTimeout(() => startTutorial(), 500);
    }
    
    // Start auto-refresh every 7 seconds
    startAutoRefresh();
    
  } catch (err) {
    console.error('Init error:', err);
    showAuthError(err.message);
  }
}

// Auto-refresh functionality
let autoRefreshInterval = null;

function startAutoRefresh() {
  // Refresh data every 7 seconds
  autoRefreshInterval = setInterval(async () => {
    try {
      // Only refresh if page is visible
      if (document.hidden) return;
      
      // Skip auto-refresh on billing page to prevent interrupting user
      if (currentPage === 'billing') return;
      
      // Reload core data silently
      await loadData();
      await loadSubscription();
      
      // Check Smoobu connection status
      await verifySmoobuConnection();
      
      // Re-render current page without flashing
      renderUser();
      renderPage();
      
      console.log('Auto-refresh completed:', new Date().toLocaleTimeString());
    } catch (e) {
      console.error('Auto-refresh error:', e);
    }
  }, 7000);
}

// Verify Smoobu connection is still active
async function verifySmoobuConnection() {
  if (!smoobuConfig.apiKey) {
    smoobuConfig.connected = false;
    return;
  }
  
  try {
    const response = await fetch(`${SMOOBU_PROXY_URL}?endpoint=me`, {
      headers: { 'Api-Key': smoobuConfig.apiKey }
    });
    
    if (response.ok) {
      const data = await response.json();
      smoobuConfig.connected = true;
      smoobuConfig.smoobuUser = data;
      localStorage.setItem('smoobu_connected', 'true');
    } else {
      // API call failed - connection is broken
      smoobuConfig.connected = false;
      localStorage.setItem('smoobu_connected', 'false');
      console.warn('Smoobu connection failed:', response.status);
    }
  } catch (e) {
    smoobuConfig.connected = false;
    localStorage.setItem('smoobu_connected', 'false');
    console.warn('Smoobu connection error:', e);
  }
}

function stopAutoRefresh() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
    autoRefreshInterval = null;
  }
}

function showLocalFileError() {
  document.getElementById('loading').innerHTML = `
    <div style="text-align:center;max-width:400px;padding:20px">
      <div style="font-size:48px;margin-bottom:16px">‚ö†Ô∏è</div>
      <div style="font-size:18px;font-weight:700;margin-bottom:12px">Lokale Datei erkannt</div>
      <div style="color:#a1a1aa;font-size:14px;line-height:1.6;margin-bottom:24px">
        Das Dashboard kann nicht als lokale Datei ge√∂ffnet werden.<br><br>
        Bitte √∂ffne es √ºber deine Vercel-URL:
      </div>
      <a href="https://pilotstay-appp.vercel.app" class="btn btn-primary" style="text-decoration:none">
        üåê Zu PilotStay √∂ffnen
      </a>
      <div style="margin-top:24px;padding-top:24px;border-top:1px solid #27272a">
        <div style="font-size:12px;color:#71717a">Oder lade die Datei auf GitHub hoch und deploye √ºber Vercel</div>
      </div>
    </div>
  `;
}

function showAuthError(message) {
  document.getElementById('loading').innerHTML = `
    <div style="text-align:center;max-width:400px;padding:20px">
      <div style="font-size:48px;margin-bottom:16px">üîê</div>
      <div style="font-size:18px;font-weight:700;margin-bottom:12px">Nicht eingeloggt</div>
      <div style="color:#a1a1aa;font-size:14px;line-height:1.6;margin-bottom:24px">
        Du musst dich zuerst anmelden um das Dashboard zu nutzen.
      </div>
      <a href="auth.html" class="btn btn-primary" style="text-decoration:none">
        üîë Zum Login
      </a>
      ${message ? `<div style="margin-top:16px;font-size:11px;color:#ef4444">${message}</div>` : ''}
    </div>
  `;
}

async function loadData() {
  const {data:pr} = await db.from('properties').select('*').eq('host_id', user.id).order('created_at', {ascending:false});
  properties = pr || [];
  const {data:bk} = await db.from('bookings').select('*,properties(name)').eq('host_id', user.id).order('check_in', {ascending:true});
  bookings = bk || [];
  
  // Load notifications
  await loadNotifications();
  
  // Load messages from Smoobu (if connected)
  if (smoobuConfig.connected && smoobuConfig.apiKey) {
    await loadSmoobuMessages();
  }
  
  // Initialize pricing data from properties
  initializePricingData();
  
  // Fetch events for properties (async, don't wait)
  fetchEventsForProperties();
}

// Load notifications from server (created by cron job)
async function loadNotifications() {
  try {
    const { data, error } = await db
      .from('notifications')
      .select('*')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false })
      .limit(50);
    
    if (!error && data) {
      notifications = data;
      unreadNotificationCount = data.filter(n => !n.read).length;
      updateNotificationBadge();
    }
  } catch (e) {
    console.log('Could not load notifications:', e);
  }
}

// Load messages from Smoobu for all active bookings
async function loadSmoobuMessages() {
  if (!smoobuConfig.connected || !smoobuConfig.apiKey) return;
  
  try {
    // Get active bookings (check-out within last 7 days or future)
    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    const activeBookings = bookings.filter(b => 
      b.smoobu_id && 
      b.check_out >= sevenDaysAgo &&
      b.status !== 'cancelled'
    );
    
    console.log(`Loading messages for ${activeBookings.length} active bookings...`);
    
    // Clear existing chats
    chats = [];
    
    // Load messages for each booking (limit to 15 to avoid rate limits)
    for (const booking of activeBookings.slice(0, 15)) {
      try {
        const response = await fetch(
          `${SMOOBU_PROXY_URL}?action=messages&bookingId=${booking.smoobu_id}`,
          { headers: { 'x-smoobu-key': smoobuConfig.apiKey } }
        );
        
        if (!response.ok) continue;
        
        const data = await response.json();
        const messages = data.messages || data || [];
        
        if (!Array.isArray(messages) || messages.length === 0) continue;
        
        // Find the property for this booking
        const property = properties.find(p => p.id === booking.property_id);
        
        // Convert Smoobu messages to chat format
        // Log first message structure for debugging
        if (messages.length > 0 && !window._smoobuMsgLogged) {
          console.log('üìß SMOOBU MESSAGE STRUCTURE:');
          console.log(JSON.stringify(messages[0], null, 2));
          window._smoobuMsgLogged = true;
        }
        
        const chatMessages = messages.map(msg => {
          // Safely convert to string - handle numbers, null, undefined
          const safeStr = (val) => val === null || val === undefined ? '' : String(val).toLowerCase();
          
          const typeVal = safeStr(msg.type);
          const fromVal = safeStr(msg.from);
          const dirVal = safeStr(msg.direction);
          const sentByVal = safeStr(msg.sent_by);
          const senderVal = safeStr(msg.sender);
          
          // Smoobu type values: 1 = HostToGuest, 2 = GuestToHost
          // WICHTIG: Check HOST (type 1) FIRST to prevent loop!
          const isFromHost = 
            msg.type === 1 || 
            msg.type === '1' ||
            typeVal === 'host' || 
            typeVal === 'hosttoguest' ||
            typeVal === 'outgoing' ||
            typeVal === 'sent' ||
            fromVal === 'host' || 
            fromVal === 'me' ||
            fromVal === 'owner' ||
            dirVal === 'out' ||
            dirVal === 'outgoing' ||
            dirVal === 'outbound' ||
            sentByVal === 'host' ||
            sentByVal === 'owner' ||
            senderVal === 'host' ||
            senderVal === 'owner';
          
          // Only check GUEST if NOT from host
          const isFromGuest = !isFromHost && (
            msg.type === 2 || 
            msg.type === '2' ||
            typeVal === 'guest' || 
            typeVal === 'guesttohost' ||
            typeVal === 'incoming' ||
            typeVal === 'received' ||
            fromVal === 'guest' || 
            fromVal === 'them' ||
            fromVal === 'customer' ||
            dirVal === 'in' ||
            dirVal === 'incoming' ||
            dirVal === 'inbound' ||
            sentByVal === 'guest' ||
            sentByVal === 'customer' ||
            senderVal === 'guest' ||
            senderVal === 'customer'
          );
          
          // Determine final direction - HOST takes priority
          const finalFrom = isFromHost ? 'me' : (isFromGuest ? 'them' : 'them');
          
          console.log(`üì® Msg ${msg.id}: type=${msg.type} isHost=${isFromHost} isGuest=${isFromGuest} ‚Üí ${finalFrom === 'them' ? 'GUEST' : 'HOST'}`);
          
          return {
            id: msg.id || Math.random().toString(36).substr(2, 9),
            from: finalFrom,
            text: msg.message || msg.text || msg.body || msg.content || '',
            time: msg.created_at ? new Date(msg.created_at).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : '',
            timestamp: msg.created_at || msg.timestamp || msg.date || new Date().toISOString(),
            ai: msg.ai || msg.sent_by_ai || false
          };
        }).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        
        // Get last message
        const lastMsg = chatMessages[chatMessages.length - 1];
        const unreadCount = chatMessages.filter(m => m.from === 'them' && !m.read).length;
        
        // Create initials from guest name
        const nameParts = (booking.guest_name || 'Gast').split(' ');
        const avatar = nameParts.map(p => p[0]).join('').toUpperCase().substring(0, 2);
        
        // Determine platform from booking source
        let platform = 'direct';
        const source = (booking.source || '').toLowerCase();
        if (source.includes('airbnb')) platform = 'airbnb';
        else if (source.includes('booking')) platform = 'booking';
        else if (source.includes('expedia') || source.includes('vrbo')) platform = 'expedia';
        
        // Add to chats
        chats.push({
          id: booking.smoobu_id,
          bookingId: booking.id,
          smoobuId: booking.smoobu_id,
          name: booking.guest_name || 'Gast',
          avatar: avatar,
          platform: platform,
          property: property?.name || 'Unbekannt',
          propertyId: booking.property_id,
          checkIn: booking.check_in,
          checkOut: booking.check_out,
          unread: unreadCount,
          lastMsg: lastMsg?.text?.substring(0, 50) || 'Keine Nachrichten',
          time: lastMsg?.time || '',
          messages: chatMessages
        });
        
        // Small delay to avoid rate limits
        await new Promise(r => setTimeout(r, 150));
        
      } catch (e) {
        console.error(`Error loading messages for booking ${booking.smoobu_id}:`, e);
      }
    }
    
    // Sort chats by last message time (newest first)
    chats.sort((a, b) => {
      const aLast = a.messages[a.messages.length - 1]?.timestamp || '';
      const bLast = b.messages[b.messages.length - 1]?.timestamp || '';
      return new Date(bLast) - new Date(aLast);
    });
    
    console.log(`Loaded ${chats.length} conversations with messages`);
    
    // Update unread badge
    const totalUnread = chats.reduce((sum, c) => sum + (c.unread || 0), 0);
    const badge = document.getElementById('msg-badge');
    if (badge) {
      badge.textContent = totalUnread;
      badge.style.display = totalUnread > 0 ? 'flex' : 'none';
    }
    
  } catch (error) {
    console.error('Error loading Smoobu messages:', error);
  }
}

// Update notification badge in header
function updateNotificationBadge() {
  const badge = document.getElementById('notification-badge');
  if (badge) {
    if (unreadNotificationCount > 0) {
      badge.textContent = unreadNotificationCount > 9 ? '9+' : unreadNotificationCount;
      badge.style.display = 'flex';
    } else {
      badge.style.display = 'none';
    }
  }
}

// Show notifications panel
function showNotifications() {
  const unreadList = notifications.filter(n => !n.read);
  const readList = notifications.filter(n => n.read).slice(0, 10);
  
  const renderNotification = (n) => `
    <div class="card" style="margin-bottom:8px;padding:12px;${!n.read ? 'border-left:3px solid #f97316;' : 'opacity:0.7;'}">
      <div style="display:flex;justify-content:space-between;align-items:start">
        <div style="flex:1">
          <div style="font-weight:600;font-size:13px">${n.title}</div>
          <div style="font-size:12px;color:#a1a1aa;margin-top:4px">${n.body || ''}</div>
          <div style="font-size:10px;color:#71717a;margin-top:6px">${new Date(n.created_at).toLocaleString('de-DE')}</div>
        </div>
        ${!n.read ? `<button class="btn btn-sm btn-secondary" onclick="markNotificationRead('${n.id}')" style="font-size:10px;padding:4px 8px">‚úì</button>` : ''}
      </div>
    </div>
  `;
  
  showModal(`
    <div class="modal-title">üîî Benachrichtigungen</div>
    
    ${unreadList.length > 0 ? `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-size:12px;color:#f97316;font-weight:600">${unreadList.length} ungelesen</div>
        <button class="btn btn-sm btn-secondary" onclick="markAllNotificationsRead()" style="font-size:11px">Alle als gelesen</button>
      </div>
      <div style="max-height:300px;overflow-y:auto;margin-bottom:16px">
        ${unreadList.map(renderNotification).join('')}
      </div>
    ` : `
      <div style="text-align:center;padding:20px;color:#71717a">
        <div style="font-size:32px;margin-bottom:8px">‚úÖ</div>
        <div>Keine ungelesenen Benachrichtigungen</div>
      </div>
    `}
    
    ${readList.length > 0 ? `
      <div style="font-size:12px;color:#71717a;margin-bottom:8px">Fr√ºhere Benachrichtigungen</div>
      <div style="max-height:200px;overflow-y:auto">
        ${readList.map(renderNotification).join('')}
      </div>
    ` : ''}
    
    <button class="btn btn-secondary" onclick="hideModal()" style="width:100%;margin-top:16px">Schlie√üen</button>
  `);
}

// Mark single notification as read
async function markNotificationRead(id) {
  try {
    await db.from('notifications').update({ read: true }).eq('id', id);
    const notif = notifications.find(n => n.id === id);
    if (notif) notif.read = true;
    unreadNotificationCount = Math.max(0, unreadNotificationCount - 1);
    updateNotificationBadge();
    showNotifications(); // Refresh modal
  } catch (e) {
    console.log('Error marking notification read:', e);
  }
}

// Mark all notifications as read
async function markAllNotificationsRead() {
  try {
    await db.from('notifications').update({ read: true }).eq('user_id', user.id).eq('read', false);
    notifications.forEach(n => n.read = true);
    unreadNotificationCount = 0;
    updateNotificationBadge();
    showNotifications(); // Refresh modal
  } catch (e) {
    console.log('Error marking all notifications read:', e);
  }
}

async function initializePricingData() {
  if (properties.length === 0) {
    pricingData.properties = [];
    pricingData.dailyPrices = {};
    return;
  }
  
  // Calculate occupancy for each property based on bookings
  const now = new Date();
  const sixtyDaysFromNow = new Date(now.getTime() + 60 * 24 * 60 * 60 * 1000);
  
  pricingData.properties = properties.map(prop => {
    // Count booked days in next 60 days
    const propBookings = bookings.filter(b => 
      b.property_id === prop.id && 
      new Date(b.check_out) >= now &&
      new Date(b.check_in) <= sixtyDaysFromNow &&
      b.status !== 'cancelled'
    );
    
    let bookedDays = 0;
    propBookings.forEach(b => {
      const checkIn = new Date(Math.max(new Date(b.check_in), now));
      const checkOut = new Date(Math.min(new Date(b.check_out), sixtyDaysFromNow));
      const days = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
      bookedDays += Math.max(0, days);
    });
    
    const occupancy = Math.min(100, Math.round((bookedDays / 60) * 100));
    const basePrice = prop.base_price || 80;
    
    return {
      id: prop.smoobu_id || prop.id,
      localId: prop.id,
      name: prop.name,
      city: prop.city || '',
      basePrice: basePrice,
      currentPrice: basePrice,
      occupancy: occupancy
    };
  });
  
  // Calculate daily prices for each property
  await calculateAllDailyPrices();
}

async function calculateAllDailyPrices() {
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  
  for (const prop of pricingData.properties) {
    pricingData.dailyPrices[prop.id] = [];
    
    // Generate prices for next 60 days
    for (let i = 0; i < 60; i++) {
      const date = new Date(now);
      date.setDate(date.getDate() + i);
      const dateStr = date.toISOString().split('T')[0];
      
      const dayPrice = calculateDayPrice(prop, date, dateStr);
      pricingData.dailyPrices[prop.id].push(dayPrice);
    }
  }
  
  // After calculating, fetch current Smoobu prices and compare
  if (smoobuConfig.connected) {
    await compareWithSmoobuPrices();
  }
}

// Fetch current prices from Smoobu and mark already-applied prices
async function compareWithSmoobuPrices() {
  console.log('üîÑ Comparing prices with Smoobu...');
  
  const now = new Date();
  const startDate = now.toISOString().split('T')[0];
  const endDate = new Date(now.getTime() + 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
  
  let totalMatched = 0;
  
  for (const prop of pricingData.properties) {
    try {
      const response = await fetch(
        `${SMOOBU_PROXY_URL}?action=rates&apartments=${prop.id}&start_date=${startDate}&end_date=${endDate}`,
        {
          headers: {
            'x-smoobu-key': smoobuConfig.apiKey
          }
        }
      );
      
      if (!response.ok) {
        console.warn(`Failed to fetch rates for ${prop.name}: ${response.status}`);
        continue;
      }
      
      const data = await response.json();
      console.log(`Smoobu rates response for ${prop.name}:`, data);
      
      // Smoobu returns: { data: { [apartmentId]: { [date]: { price: X } } } }
      // Try multiple possible structures
      const apartmentRates = data?.data?.[prop.id] || data?.[prop.id] || data?.data || {};
      
      // Compare each day
      const dailyPrices = pricingData.dailyPrices[prop.id];
      if (!dailyPrices) continue;
      
      let matchedCount = 0;
      
      for (const day of dailyPrices) {
        const smoobuData = apartmentRates[day.date];
        if (smoobuData) {
          const smoobuPrice = parseFloat(smoobuData.price) || parseFloat(smoobuData.daily_price) || null;
          day.smoobuPrice = smoobuPrice;
          
          // Mark as applied if Smoobu price matches our calculated price (within ‚Ç¨1 tolerance)
          if (smoobuPrice !== null && Math.abs(smoobuPrice - day.finalPrice) <= 1) {
            day.applied = true;
            matchedCount++;
          } else if (smoobuPrice !== null) {
            // Prices don't match - show what Smoobu has vs what we calculated
            day.applied = false;
            console.log(`Price mismatch for ${day.date}: Smoobu=${smoobuPrice}, Calculated=${day.finalPrice}`);
          }
        }
      }
      
      totalMatched += matchedCount;
      console.log(`‚úÖ ${prop.name}: ${matchedCount} prices already match Smoobu`);
      
    } catch (error) {
      console.error(`Error fetching Smoobu prices for ${prop.name}:`, error);
    }
  }
  
  console.log(`üéØ Total prices already synced with Smoobu: ${totalMatched}`);
  
  // Re-render the page to show updated applied status
  if (currentPage === 'pricing') {
    renderPage();
  }
}

// =====================================================================
// EVENT IMPACT CLASSIFICATION SYSTEM - NEW
// Classifies events by impact: high, medium, low
// =====================================================================

/**
 * Classifies the impact level of an event
 * @param {Object} event - Ticketmaster Event object (normalized)
 * @returns {Object} { level: 'low'|'medium'|'high', multiplier: number, reason: string }
 */
function classifyEventImpact(event) {
  if (!event) return { level: 'none', multiplier: 1.0, reason: 'Kein Event' };
  
  const venueName = (event._embedded?.venues?.[0]?.name || '').toLowerCase();
  const eventName = (event.name || '').toLowerCase();
  const eventType = (event.classifications?.[0]?.segment?.name || '').toLowerCase();
  
  // HIGH IMPACT: Large venues, Major Events
  // Multiplier: 1.35 = +35% price increase
  const highImpactVenues = ['arena', 'stadion', 'stadium', 'olympia', 'halle', 'dome', 'allianz', 'veltins', 'signal iduna', 'mercedes-benz'];
  const highImpactEvents = ['concert', 'konzert', 'festival', 'bundesliga', 'champions league', 'finale', 'meisterschaft', 'weltmeisterschaft'];
  
  for (const keyword of highImpactVenues) {
    if (venueName.includes(keyword)) {
      return { level: 'high', multiplier: 1.35, reason: `Gro√üveranstaltung (${venueName.substring(0, 25)})` };
    }
  }
  
  for (const keyword of highImpactEvents) {
    if (eventName.includes(keyword) || eventType.includes(keyword)) {
      return { level: 'high', multiplier: 1.30, reason: `Major Event: ${event.name?.substring(0, 25)}...` };
    }
  }
  
  // MEDIUM IMPACT: Medium venues, regular concerts/sports
  // Multiplier: 1.15-1.20 = +15-20% price increase
  const mediumImpactVenues = ['theater', 'theatre', 'club', 'zentrum', 'center', 'hof', 'haus', 'philharmonie', 'oper', 'opera'];
  const mediumImpactTypes = ['music', 'sport', 'sports', 'comedy', 'musical'];
  
  for (const keyword of mediumImpactVenues) {
    if (venueName.includes(keyword)) {
      return { level: 'medium', multiplier: 1.20, reason: `Event: ${event.name?.substring(0, 30)}` };
    }
  }
  
  for (const keyword of mediumImpactTypes) {
    if (eventType.includes(keyword)) {
      return { level: 'medium', multiplier: 1.15, reason: `${eventType}: ${event.name?.substring(0, 25)}` };
    }
  }
  
  // LOW IMPACT: Default for all other recognized events
  // Multiplier: 1.08 = +8% price increase
  return { level: 'low', multiplier: 1.08, reason: `Event in der N√§he` };
}

/**
 * Gets all events for a specific date and city
 * @param {string} dateStr - ISO date (YYYY-MM-DD)
 * @param {string} propCity - City of the property
 * @returns {Array} Array of events with impact classification
 */
function getEventsForDateAndCity(dateStr, propCity) {
  if (!pricingData.events || pricingData.events.length === 0) return [];
  if (!propCity) return [];
  
  const propCityLower = propCity.toLowerCase().trim();
  
  return pricingData.events
    .filter(event => {
      // Match date first
      const eventDate = event.dates?.start?.localDate;
      if (eventDate !== dateStr) return false;
      
      // BEST MATCH: Use the _searchedCity tag we added when fetching
      if (event._searchedCity) {
        return event._searchedCity === propCityLower || 
               event._searchedCity.includes(propCityLower) || 
               propCityLower.includes(event._searchedCity);
      }
      
      // FALLBACK: Try to match from venue data
      const eventCity = (event._embedded?.venues?.[0]?.city?.name || '').toLowerCase().trim();
      const venueName = (event._embedded?.venues?.[0]?.name || '').toLowerCase();
      
      return eventCity.includes(propCityLower) || 
             propCityLower.includes(eventCity) ||
             venueName.includes(propCityLower);
    })
    .map(event => ({
      ...event,
      impact: classifyEventImpact(event)
    }));
}

/**
 * Calculates combined event multiplier for a day
 * Multiple events on the same day have cumulative effect (capped)
 * @param {Array} eventsWithImpact - Events with impact classification
 * @returns {Object} { multiplier: number, factors: Array, events: Array }
 */
function calculateEventMultiplier(eventsWithImpact) {
  if (!eventsWithImpact || eventsWithImpact.length === 0) {
    return { multiplier: 1.0, factors: [], events: [] };
  }
  
  // Sort by impact level (high first)
  const sorted = [...eventsWithImpact].sort((a, b) => {
    const order = { high: 0, medium: 1, low: 2 };
    return (order[a.impact.level] || 3) - (order[b.impact.level] || 3);
  });
  
  // Take highest impact event as base
  const primaryEvent = sorted[0];
  let baseMultiplier = primaryEvent.impact.multiplier;
  
  // Additional events give diminishing bonus (max +10% extra)
  const additionalBoost = Math.min(0.10, (sorted.length - 1) * 0.03);
  
  // Final multiplier (max 1.50 = +50%)
  const finalMultiplier = Math.min(1.50, baseMultiplier + additionalBoost);
  
  // Build factors array for display
  const factors = sorted.map(event => ({
    type: 'event',
    level: event.impact.level,
    label: `üé≠ ${event.impact.reason} +${Math.round((event.impact.multiplier - 1) * 100)}%`,
    boost: event.impact.multiplier - 1
  }));
  
  // Events array for detail view
  const events = sorted.map(event => ({
    name: event.name,
    venue: event._embedded?.venues?.[0]?.name || '',
    url: event.url,
    impact: event.impact.level
  }));
  
  return { multiplier: finalMultiplier, factors, events };
}

/**
 * Updates the pricing KPI display with event statistics
 * @param {Object} payload - { totalEvents, eventDays, avgImpact }
 */
function updatePricingKPI(payload = {}) {
  try {
    let totalEvents = 0, eventDays = 0, avgImpact = 0;
    
    if (Array.isArray(payload)) {
      totalEvents = payload.length;
      const days = new Set(payload.map(e => e?.date || e?.localDate || e?.startDate).filter(Boolean));
      eventDays = days.size;
    } else if (payload && typeof payload === 'object') {
      totalEvents = Number(payload.totalEvents ?? 0) || 0;
      eventDays = Number(payload.eventDays ?? 0) || 0;
      avgImpact = Number(payload.avgImpact ?? 0) || 0;
    }
    
    // Update KPI elements if they exist
    const eventsEl = document.querySelector('[data-kpi="events"]') || document.getElementById('kpiEvents');
    const daysEl = document.querySelector('[data-kpi="event-days"]') || document.getElementById('kpiDays');
    const impactEl = document.querySelector('[data-kpi="impact"]') || document.getElementById('kpiImpact');
    
    if (eventsEl) eventsEl.textContent = String(totalEvents);
    if (daysEl) daysEl.textContent = String(eventDays);
    if (impactEl) impactEl.textContent = `${avgImpact > 0 ? '+' : ''}${avgImpact}%`;
  } catch (e) {
    console.warn('updatePricingKPI failed:', e);
  }
}

// =====================================================================
// MODIFIED: calculateDayPrice with Event Impact Classification
// =====================================================================
function calculateDayPrice(prop, date, dateStr) {
  const basePrice = prop.basePrice;
  let finalPrice = basePrice;
  let factors = [];
  let events = [];
  
  // Strategy multipliers
  const strategyMultipliers = {
    conservative: { weekend: 0.08, holiday: 0.15, event: 0.10, lowDemand: -0.03 },
    balanced: { weekend: 0.15, holiday: 0.25, event: 0.20, lowDemand: -0.05 },
    aggressive: { weekend: 0.25, holiday: 0.40, event: 0.35, lowDemand: -0.08 }
  };
  const multipliers = strategyMultipliers[pricingData.strategy] || strategyMultipliers.balanced;
  
  const dayOfWeek = date.getDay();
  
  // 1. Weekend pricing (Fr, Sa)
  if (dayOfWeek === 5 || dayOfWeek === 6) {
    const boost = multipliers.weekend;
    finalPrice *= (1 + boost);
    factors.push({ type: 'weekend', label: `üóìÔ∏è Wochenende +${Math.round(boost * 100)}%`, boost });
  }
  
  // 2. Sunday slight boost
  if (dayOfWeek === 0) {
    const boost = multipliers.weekend * 0.5;
    finalPrice *= (1 + boost);
    factors.push({ type: 'sunday', label: `üóìÔ∏è Sonntag +${Math.round(boost * 100)}%`, boost });
  }
  
  // 3. Check holidays
  const holiday = germanHolidays.find(h => h.date === dateStr);
  if (holiday) {
    const boost = Math.min(holiday.boost, multipliers.holiday * 2);
    finalPrice *= (1 + boost);
    factors.push({ type: 'holiday', label: `üéâ ${holiday.name} +${Math.round(boost * 100)}%`, boost });
  }
  
  // =====================================================================
  // 4. EVENT PRICING - NEW IMPLEMENTATION
  // Uses the new event impact classification system
  // =====================================================================
  const eventsForDay = getEventsForDateAndCity(dateStr, prop.city);
  
  if (eventsForDay.length > 0) {
    // Calculate combined event multiplier
    const eventResult = calculateEventMultiplier(eventsForDay);
    
    // Apply strategy modifier to event multiplier
    // Conservative: Reduce event impact by 30%
    // Aggressive: Increase event impact by 20%
    let strategyModifier = 1.0;
    if (pricingData.strategy === 'conservative') {
      strategyModifier = 0.7;
    } else if (pricingData.strategy === 'aggressive') {
      strategyModifier = 1.2;
    }
    
    // Calculate final event boost (always positive, prices only go UP)
    const rawEventBoost = (eventResult.multiplier - 1) * strategyModifier;
    const eventBoost = Math.max(0, rawEventBoost); // Never negative
    
    if (eventBoost > 0) {
      finalPrice *= (1 + eventBoost);
      
      // Add event factors to display (max 2 to avoid clutter)
      const displayFactors = eventResult.factors.slice(0, 2);
      displayFactors.forEach(f => {
        // Recalculate displayed boost with strategy modifier
        const adjustedBoost = Math.max(0, f.boost * strategyModifier);
        factors.push({
          type: 'event',
          level: f.level,
          label: f.label.replace(/\+\d+%/, `+${Math.round(adjustedBoost * 100)}%`),
          boost: adjustedBoost
        });
      });
      
      // Show remaining events count if more than 2
      if (eventsForDay.length > 2) {
        factors.push({
          type: 'event-extra',
          label: `üé≠ +${eventsForDay.length - 2} weitere Events`,
          boost: 0
        });
      }
    }
    
    // Store events for detail view
    events = eventResult.events;
  }
  // =====================================================================
  // END EVENT PRICING
  // =====================================================================
  
  // 5. Check if date is booked (no adjustment needed, but mark it)
  const isBooked = bookings.some(b => {
    const checkIn = new Date(b.check_in);
    const checkOut = new Date(b.check_out);
    return b.property_id === prop.localId && 
           date >= checkIn && 
           date < checkOut && 
           b.status !== 'cancelled';
  });
  
  // 6. Low demand adjustment (only if NO positive factors exist)
  const hasPositiveFactors = factors.some(f => f.boost > 0);
  
  if (!hasPositiveFactors && dayOfWeek >= 1 && dayOfWeek <= 4) {
    // Check if there's a gap (no bookings before and after)
    const prevDay = new Date(date);
    prevDay.setDate(prevDay.getDate() - 1);
    const nextDay = new Date(date);
    nextDay.setDate(nextDay.getDate() + 1);
    
    const hasSurroundingBookings = bookings.some(b => {
      const checkIn = new Date(b.check_in);
      const checkOut = new Date(b.check_out);
      return b.property_id === prop.localId && 
             ((prevDay >= checkIn && prevDay < checkOut) || (nextDay >= checkIn && nextDay < checkOut));
    });
    
    if (!hasSurroundingBookings && prop.occupancy < 50) {
      const discount = multipliers.lowDemand;
      finalPrice *= (1 + discount);
      factors.push({ type: 'low', label: `üìâ Geringe Nachfrage ${Math.round(discount * 100)}%`, boost: discount });
    }
  }
  
  // Round to nearest euro
  finalPrice = Math.round(finalPrice);
  
  // Ensure price never falls below base price (prices only go UP)
  finalPrice = Math.max(finalPrice, basePrice);
  
  // Calculate total change percentage
  const changePercent = Math.round(((finalPrice - basePrice) / basePrice) * 100);
  
  return {
    date: dateStr,
    dayOfWeek,
    basePrice,
    finalPrice,
    changePercent,
    factors,
    events,
    isBooked,
    applied: false,
    // NEW: Event impact summary for calendar display
    eventImpact: events.length > 0 ? (events[0]?.impact || 'low') : null,
    eventCount: events.length
  };
}

// Fetch events from Ticketmaster for all property cities (via smoobu-proxy to avoid CORS)
async function fetchEventsForProperties() {
  // Only fetch once per hour
  const now = Date.now();
  if (pricingData.lastEventFetch && (now - pricingData.lastEventFetch) < 3600000) {
    return;
  }
  
  // Get unique cities from properties
  const cities = [...new Set(properties.map(p => p.city).filter(c => c && c.length > 2))];
  
  if (cities.length === 0) {
    console.log('No cities to fetch events for');
    return;
  }
  
  console.log('üé≠ Fetching events for cities:', cities);
  pricingData.events = [];
  
  const startDate = new Date().toISOString().split('T')[0];
  const endDate = new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
  
  // City aliases for Ticketmaster (handles umlauts and alternative names)
  const citySearchTerms = {
    'm√ºnchen': ['Munich', 'Muenchen'],
    'k√∂ln': ['Cologne', 'Koeln'],
    'd√ºsseldorf': ['Duesseldorf'],
    'n√ºrnberg': ['Nuremberg', 'Nuernberg'],
    'frankfurt': ['Frankfurt am Main', 'Frankfurt'],
    'hannover': ['Hanover', 'Hannover'],
    'z√ºrich': ['Zurich', 'Zuerich'],
    'wien': ['Vienna', 'Wien']
  };
  
  // Helper to get search terms for a city
  const getSearchTerms = (city) => {
    const cityLower = city.toLowerCase();
    for (const [key, aliases] of Object.entries(citySearchTerms)) {
      if (cityLower.includes(key) || key.includes(cityLower)) {
        return [city, ...aliases];
      }
    }
    return [city];
  };
  
  // Use smoobu-proxy with action=ticketmaster to avoid CORS issues
  for (const city of cities) {
    const searchTerms = getSearchTerms(city);
    let foundEvents = false;
    
    for (const searchTerm of searchTerms) {
      if (foundEvents) break; // Skip if already found events for this city
      
      try {
        const response = await fetch(
          `${SMOOBU_PROXY_URL}?action=ticketmaster&city=${encodeURIComponent(searchTerm)}&countryCode=DE&startDate=${startDate}&endDate=${endDate}&size=50`
        );
        
        if (response.ok) {
          const data = await response.json();
          if (data.events && data.events.length > 0) {
            // Tag events with original city name for matching
            const taggedEvents = data.events.map(e => ({
              ...e,
              _searchedCity: city.toLowerCase().trim() // Use original city name
            }));
            pricingData.events.push(...taggedEvents);
            console.log(`‚úÖ Found ${data.events.length} events in ${city} (searched: ${searchTerm})`);
            foundEvents = true;
          }
        }
      } catch (error) {
        console.error(`‚ùå Error fetching events for ${searchTerm}:`, error);
      }
    }
    
    if (!foundEvents) {
      console.log(`‚ÑπÔ∏è No events found in ${city} (tried: ${searchTerms.join(', ')})`);
    }
  }
  
  pricingData.lastEventFetch = now;
  
  // =====================================================================
  // DEBUG: Log event cities to diagnose matching issues
  // =====================================================================
  if (pricingData.events.length > 0) {
    const eventCities = [...new Set(pricingData.events.map(e => 
      e._embedded?.venues?.[0]?.city?.name || 'KEINE STADT'
    ))];
    console.log('üèôÔ∏è Event cities from Ticketmaster:', eventCities);
    console.log('üè† Property cities:', pricingData.properties.map(p => p.city));
    
    // Check for matching issues
    pricingData.properties.forEach(prop => {
      const propCity = prop.city?.toLowerCase().trim() || '';
      const matchingEvents = pricingData.events.filter(e => {
        const eventCity = (e._embedded?.venues?.[0]?.city?.name || '').toLowerCase().trim();
        return eventCity.includes(propCity) || propCity.includes(eventCity);
      });
      console.log(`üìç ${prop.name} (${prop.city}): ${matchingEvents.length} matching events`);
    });
  }
  
  // =====================================================================
  // NEW: Calculate event impact statistics
  // =====================================================================
  if (pricingData.events.length > 0) {
    const uniqueDates = new Set(pricingData.events.map(e => e.dates?.start?.localDate).filter(Boolean));
    const avgImpact = Math.round(pricingData.events.reduce((sum, e) => {
      const impact = classifyEventImpact(e);
      return sum + ((impact.multiplier - 1) * 100);
    }, 0) / pricingData.events.length);
    
    console.log(`üìä Event Statistics: ${pricingData.events.length} events, ${uniqueDates.size} event days, avg impact: +${avgImpact}%`);
    
    // Update KPI if the function exists
    if (typeof updatePricingKPI === 'function') {
      updatePricingKPI({
        totalEvents: pricingData.events.length,
        eventDays: uniqueDates.size,
        avgImpact: avgImpact
      });
    }
  }
  
  // Recalculate daily prices with events
  if (pricingData.events.length > 0) {
    await calculateAllDailyPrices();
    if (currentPage === 'pricing') {
      renderPage();
    }
  }
}

// Apply all suggested prices to Smoobu (day by day)
async function applyAllDailyPrices(propertyId) {
  const prop = pricingData.properties.find(p => p.id === propertyId);
  const dailyPrices = pricingData.dailyPrices[propertyId];
  
  if (!prop || !dailyPrices || !smoobuConfig.connected) {
    showToast('‚ùå Smoobu nicht verbunden');
    return;
  }
  
  showModal(`
    <div style="text-align:center;padding:40px">
      <div class="spinner" style="margin:0 auto 20px"></div>
      <div style="font-size:16px;font-weight:600">√úbertrage Preise zu Smoobu...</div>
      <div style="color:#71717a;font-size:13px;margin-top:8px">
        <span id="price-progress">0</span> / ${dailyPrices.filter(d => !d.isBooked).length} Tage
      </div>
    </div>
  `);
  
  let successCount = 0;
  let errorCount = 0;
  let processedCount = 0;
  let lastError = null;
  
  // Filter out booked days
  const daysToUpdate = dailyPrices.filter(d => !d.isBooked);
  
  for (let i = 0; i < daysToUpdate.length; i++) {
    const day = daysToUpdate[i];
    
    // Smoobu API format - dates as array of single dates
    const requestBody = {
      apartments: [parseInt(propertyId)],
      operations: [{
        dates: [day.date],  // Single date, not range
        daily_price: day.finalPrice
      }]
    };
    
    console.log('Sending to Smoobu:', JSON.stringify(requestBody));
    
    try {
      const response = await fetch(`${SMOOBU_PROXY_URL}?action=update-rates`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-smoobu-key': smoobuConfig.apiKey
        },
        body: JSON.stringify(requestBody)
      });
      
      const responseData = await response.json().catch(() => ({}));
      
      if (response.ok) {
        day.applied = true;
        successCount++;
      } else {
        console.error('Smoobu Error Response:', response.status, responseData);
        lastError = responseData;
        errorCount++;
        
        // Stop after first error to debug
        if (errorCount === 1) {
          console.error('First error details:', {
            status: response.status,
            propertyId: propertyId,
            date: day.date,
            price: day.finalPrice,
            response: responseData
          });
        }
      }
    } catch (error) {
      errorCount++;
      console.error('Network error applying price:', error);
    }
    
    processedCount++;
    document.getElementById('price-progress').textContent = processedCount;
    
    // Small delay to avoid rate limiting
    await new Promise(resolve => setTimeout(resolve, 150));
  }
  
  hideModal();
  
  if (errorCount === 0) {
    showToast(`‚úÖ ${successCount} Tagespreise erfolgreich √ºbertragen!`);
  } else {
    showToast(`‚ö†Ô∏è ${successCount} √ºbertragen, ${errorCount} Fehler`);
    if (lastError) {
      console.error('Last error from Smoobu:', lastError);
    }
  }
  
  renderPage();
}

// Apply single day price
async function applySingleDayPrice(propertyId, dateStr) {
  const dailyPrices = pricingData.dailyPrices[propertyId];
  const day = dailyPrices?.find(d => d.date === dateStr);
  
  if (!day || !smoobuConfig.connected) {
    showToast('‚ùå Fehler beim √úbertragen');
    return;
  }
  
  try {
    const response = await fetch(`${SMOOBU_PROXY_URL}?action=update-rates`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-smoobu-key': smoobuConfig.apiKey
      },
      body: JSON.stringify({
        apartments: [parseInt(propertyId)],
        operations: [{
          dates: [dateStr],  // Single date
          daily_price: day.finalPrice
        }]
      })
    });
    
    if (response.ok) {
      day.applied = true;
      showToast(`‚úÖ Preis f√ºr ${formatDateShort(dateStr)} √ºbertragen`);
      renderPage();
    } else {
      const errorData = await response.json().catch(() => ({}));
      console.error('Price update error:', errorData);
      showToast('‚ùå Fehler beim √úbertragen');
    }
  } catch (error) {
    console.error('Error:', error);
    showToast('‚ùå Fehler beim √úbertragen');
  }
}

function formatDateShort(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
}

// =====================
// TUTORIAL - Interactive Spotlight Tour
// =====================

// Show Smoobu onboarding for new users who haven't connected yet
function showSmoobuOnboarding() {
  const onboardingDone = localStorage.getItem('smoobu_onboarding_done');
  if (onboardingDone || smoobuConfig.connected) return false;
  
  showModal(`
    <div style="text-align:center;max-width:500px;margin:0 auto">
      <div style="margin-bottom:24px">
        <div style="font-size:48px;margin-bottom:16px">üîó</div>
        <div style="font-size:22px;font-weight:700;margin-bottom:8px">Smoobu Konto verbinden</div>
        <div style="color:#a1a1aa;font-size:14px">Schritt 2 von 3: Deine Buchungsdaten verkn√ºpfen</div>
      </div>
      
      <div style="background:linear-gradient(135deg,#18181b,#1f1f23);border-radius:12px;padding:20px;margin-bottom:20px;text-align:left;border:1px solid #27272a">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <img src="https://www.smoobu.com/wp-content/uploads/2021/06/smoobu-logo.svg" style="height:24px;filter:brightness(0) invert(1)" onerror="this.style.display='none'">
          <div>
            <span style="font-weight:600">F√ºr Smoobu Professional Nutzer</span>
            <div style="font-size:11px;color:#71717a">PilotStay erweitert dein bestehendes Smoobu mit KI</div>
          </div>
        </div>
        <div style="font-size:12px;color:#a1a1aa;margin-bottom:12px">
          Durch die Verbindung erh√§ltst du Zugriff auf:
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
          <div style="display:flex;align-items:center;gap:8px;font-size:11px;color:#e4e4e7">
            <span style="color:#22c55e">‚úì</span> Echtzeit-Buchungssync
          </div>
          <div style="display:flex;align-items:center;gap:8px;font-size:11px;color:#e4e4e7">
            <span style="color:#22c55e">‚úì</span> KI-G√§stekommunikation
          </div>
          <div style="display:flex;align-items:center;gap:8px;font-size:11px;color:#e4e4e7">
            <span style="color:#22c55e">‚úì</span> Automatische Reviews
          </div>
          <div style="display:flex;align-items:center;gap:8px;font-size:11px;color:#e4e4e7">
            <span style="color:#22c55e">‚úì</span> Dynamische Preise
          </div>
        </div>
      </div>
      
      <!-- Info Box -->
      <div style="background:#3b82f608;border:1px solid #3b82f620;border-radius:8px;padding:12px;margin-bottom:20px;text-align:left">
        <div style="display:flex;align-items:start;gap:10px">
          <span style="font-size:16px">üí°</span>
          <div style="font-size:11px;color:#a1a1aa;line-height:1.5">
            <strong style="color:#3b82f6">Smoobu Professional</strong> wird f√ºr alle KI-Funktionen ben√∂tigt. 
            Falls du bereits ein anderes PMS nutzt, wechselst du ganz einfach zu Smoobu.
          </div>
        </div>
      </div>
      
      <div style="display:flex;flex-direction:column;gap:10px">
        <button class="btn btn-primary" style="padding:14px;font-size:14px" onclick="hideModal(); setPage('automation'); showToast('üí° Verbinde jetzt deinen Smoobu API-Key')">
          ‚úì Ich nutze bereits Smoobu Professional
        </button>
        <a href="https://www.smoobu.com" target="_blank" class="btn btn-secondary" style="padding:12px;font-size:13px;text-decoration:none;display:block">
          Mehr √ºber Smoobu erfahren ‚Üí
        </a>
        <button class="btn" style="padding:10px;font-size:11px;color:#52525b;background:transparent;border:none" onclick="skipSmoobuOnboarding()">
          Sp√§ter einrichten
        </button>
      </div>
      
      <!-- Progress indicator -->
      <div style="margin-top:20px;display:flex;justify-content:center;gap:8px">
        <div style="width:24px;height:4px;background:#22c55e;border-radius:2px"></div>
        <div style="width:24px;height:4px;background:#f97316;border-radius:2px"></div>
        <div style="width:24px;height:4px;background:#27272a;border-radius:2px"></div>
      </div>
      <div style="font-size:10px;color:#52525b;margin-top:8px">Account erstellt ‚Üí Smoobu verbinden ‚Üí Los geht's</div>
    </div>
  `);
  return true;
}

function skipSmoobuOnboarding() {
  localStorage.setItem('smoobu_onboarding_done', 'skipped');
  hideModal();
  showToast('üí° Du kannst Smoobu jederzeit unter Automatisierung verbinden');
}

function startTutorial() {
  // Check if Smoobu onboarding should be shown first
  const tutorialDone = localStorage.getItem('pilotbnb_tutorial_done');
  if (!tutorialDone && !smoobuConfig.connected) {
    if (showSmoobuOnboarding()) return;
  }
  
  tutorialCurrentStep = 0;
  document.getElementById('tutorial-overlay').style.display = 'block';
  
  // Build progress dots
  const progressContainer = document.getElementById('tutorial-progress');
  progressContainer.innerHTML = tutorialSteps.map((_, i) => 
    `<div class="tutorial-dot" data-step="${i}"></div>`
  ).join('');
  
  // Bind events
  document.getElementById('tutorial-next').onclick = nextTutorialStep;
  document.getElementById('tutorial-skip').onclick = endTutorial;
  
  // Delay backdrop fade
  setTimeout(() => {
    document.getElementById('tutorial-backdrop').classList.add('active');
  }, 50);
  
  showTutorialStep();
}

function showTutorialStep() {
  const step = tutorialSteps[tutorialCurrentStep];
  const totalSteps = tutorialSteps.length;
  
  // Update content
  document.getElementById('tutorial-step-icon').textContent = step.icon;
  document.getElementById('tutorial-step-label').textContent = `Schritt ${tutorialCurrentStep + 1} von ${totalSteps}`;
  document.getElementById('tutorial-step-title').textContent = step.title;
  document.getElementById('tutorial-step-desc').textContent = step.desc;
  document.getElementById('tutorial-next').textContent = step.button;
  
  // Update progress dots
  document.querySelectorAll('.tutorial-dot').forEach((dot, i) => {
    dot.className = 'tutorial-dot' + (i < tutorialCurrentStep ? ' done' : i === tutorialCurrentStep ? ' active' : '');
  });
  
  // Position spotlight and tooltip
  const spotlight = document.getElementById('tutorial-spotlight');
  const tooltip = document.getElementById('tutorial-tooltip');
  const arrow = document.getElementById('tutorial-arrow');
  const tooltipWidth = 380;
  const tooltipMargin = 24;
  
  if (step.target && step.position !== 'center') {
    const target = document.querySelector(step.target);
    if (target) {
      const rect = target.getBoundingClientRect();
      const padding = 8;
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      
      // Position spotlight
      spotlight.style.display = 'block';
      spotlight.style.top = (rect.top - padding) + 'px';
      spotlight.style.left = (rect.left - padding) + 'px';
      spotlight.style.width = (rect.width + padding * 2) + 'px';
      spotlight.style.height = (rect.height + padding * 2) + 'px';
      spotlight.classList.add('pulse');
      
      // Reset tooltip transform
      tooltip.style.transform = 'none';
      arrow.className = '';
      
      // Calculate best position for tooltip
      if (step.position === 'right') {
        // Position to the right of target
        let tooltipLeft = rect.right + tooltipMargin;
        let tooltipTop = Math.max(20, rect.top);
        
        // Check if tooltip would go off-screen to the right
        if (tooltipLeft + tooltipWidth > viewportWidth - 20) {
          // Position below instead
          tooltipLeft = Math.max(20, Math.min(rect.left, viewportWidth - tooltipWidth - 20));
          tooltipTop = rect.bottom + tooltipMargin;
          arrow.classList.add('top');
        } else {
          arrow.classList.add('left');
        }
        
        tooltip.style.left = tooltipLeft + 'px';
        tooltip.style.top = tooltipTop + 'px';
        
      } else if (step.position === 'left') {
        // For content area - always position in center-right of content area
        // Content starts at 260px (sidebar width) + some margin
        const sidebarWidth = 260;
        const contentCenterX = sidebarWidth + ((viewportWidth - sidebarWidth) / 2);
        
        let tooltipLeft = contentCenterX - (tooltipWidth / 2);
        let tooltipTop = 120; // Below header
        
        // Ensure it stays on screen
        tooltipLeft = Math.max(sidebarWidth + 40, Math.min(tooltipLeft, viewportWidth - tooltipWidth - 40));
        
        tooltip.style.left = tooltipLeft + 'px';
        tooltip.style.top = tooltipTop + 'px';
        arrow.classList.add('hidden'); // No arrow for center positioning
        
        // Hide spotlight for content area (too large)
        spotlight.style.display = 'none';
        spotlight.classList.remove('pulse');
        
      } else if (step.position === 'bottom') {
        tooltip.style.left = Math.max(20, Math.min(rect.left, viewportWidth - tooltipWidth - 20)) + 'px';
        tooltip.style.top = (rect.bottom + tooltipMargin) + 'px';
        arrow.classList.add('top');
      } else if (step.position === 'top') {
        tooltip.style.left = Math.max(20, Math.min(rect.left, viewportWidth - tooltipWidth - 20)) + 'px';
        tooltip.style.top = (rect.top - 250) + 'px';
        arrow.classList.add('bottom');
      }
    } else {
      // Target not found, center
      centerTooltip();
    }
  } else {
    // Center position (no spotlight)
    centerTooltip();
  }
}

function centerTooltip() {
  const spotlight = document.getElementById('tutorial-spotlight');
  const tooltip = document.getElementById('tutorial-tooltip');
  const arrow = document.getElementById('tutorial-arrow');
  
  spotlight.style.display = 'none';
  spotlight.classList.remove('pulse');
  tooltip.style.left = '50%';
  tooltip.style.top = '50%';
  tooltip.style.transform = 'translate(-50%, -50%)';
  arrow.className = 'hidden';
}

function nextTutorialStep() {
  tutorialCurrentStep++;
  
  if (tutorialCurrentStep >= tutorialSteps.length) {
    endTutorial();
  } else {
    const step = tutorialSteps[tutorialCurrentStep];
    
    // Navigate to the module if specified
    if (step.navigate) {
      setPage(step.navigate);
    }
    
    // Small delay to let the page render
    setTimeout(() => {
      // Animate tooltip out and in
      const tooltip = document.getElementById('tutorial-tooltip');
      tooltip.style.animation = 'none';
      tooltip.offsetHeight; // Trigger reflow
      tooltip.style.animation = 'tutorialFadeIn .4s ease';
      
      showTutorialStep();
    }, step.navigate ? 150 : 0);
  }
}

function endTutorial() {
  document.getElementById('tutorial-backdrop').classList.remove('active');
  
  setTimeout(() => {
    document.getElementById('tutorial-overlay').style.display = 'none';
    document.getElementById('tutorial-spotlight').style.display = 'none';
    localStorage.setItem('ps_tut_done', '1');
    
    // Save to Supabase for cross-device sync
    saveTutorialCompleted();
    
    // Navigate to dashboard
    setPage('dashboard');
    
    // Show welcome toast
    showToast('Einf√ºhrung abgeschlossen');
  }, 300);
}

// Save tutorial completed status to Supabase
async function saveTutorialCompleted() {
  try {
    await db.from('profiles').update({
      tutorial_completed: true
    }).eq('id', user.id);
  } catch (e) {
    console.log('Could not save tutorial status:', e);
  }
}

function resetTutorial() {
  localStorage.removeItem('ps_tut_done');
  // Also reset in Supabase
  try {
    db.from('profiles').update({ tutorial_completed: false }).eq('id', user.id);
  } catch (e) {}
  startTutorial();
}

// =====================
// USER
// =====================
function renderUser() {
  const n = profile?.first_name || user?.email?.split('@')[0] || 'User';
  document.getElementById('user-avatar').textContent = n[0].toUpperCase();
  document.getElementById('user-name').textContent = n + (profile?.last_name ? ' ' + profile.last_name : '');
  
  // Update plan display - ONLY from Stripe-verified subscription
  const planEl = document.getElementById('user-plan');
  if (planEl) {
    // Only use userSubscription (which is Stripe-verified), NOT profile.subscription_plan
    const status = userSubscription?.status;
    
    // status === 'canceled' means FULLY canceled, regardless of cancel_at_period_end
    const isFullyCanceled = status === 'canceled';
    const isActiveSubscription = (status === 'active' || status === 'trialing') && !isFullyCanceled;
    
    if (isFullyCanceled) {
      // Subscription is fully canceled - show "Plan w√§hlen"
      planEl.innerHTML = `<span style="color:#71717a;cursor:pointer" onclick="setPage('billing')">Plan w√§hlen</span>`;
    } else if (isActiveSubscription && userSubscription?.plan_id) {
      const planId = userSubscription.plan_id;
      const planNames = {
        'takeoff': { name: 'Takeoff', color: '#3b82f6' },
        'cruise': { name: 'Cruise', color: '#f97316' },
        'autopilot': { name: 'Autopilot', color: '#8b5cf6' },
        'enterprise': { name: 'Enterprise', color: '#71717a' }
      };
      
      const plan = planNames[planId] || { name: planId, color: '#f97316' };
      const isCanceled = userSubscription?.cancel_at_period_end;
      const hasScheduledChange = scheduledPlanChange && scheduledPlanChange.newPlanId !== planId;
      
      // Build status display
      let statusHtml = '';
      
      if (isCanceled) {
        // Manual cancellation pending
        const endDate = userSubscription?.current_period_end 
          ? new Date(userSubscription.current_period_end).toLocaleDateString('de-DE', {day:'numeric', month:'short'})
          : '';
        statusHtml = `<div style="font-size:9px;color:#ef4444;margin-top:2px">Endet ${endDate}</div>`;
      } else if (hasScheduledChange) {
        // Plan change scheduled
        const changeDate = new Date(scheduledPlanChange.effectiveDate).toLocaleDateString('de-DE', {day:'numeric', month:'short'});
        statusHtml = `<div style="font-size:9px;color:#3b82f6;margin-top:2px">Wechsel ${changeDate}</div>`;
      } else {
        statusHtml = `<div style="font-size:9px;color:#22c55e;margin-top:2px">Aktiv</div>`;
      }
      
      planEl.innerHTML = `
        <div style="color:${plan.color};font-weight:500">${plan.name}</div>
        ${statusHtml}
      `;
    } else if (status === 'past_due' || status === 'unpaid') {
      // Payment failed
      planEl.innerHTML = `
        <div style="color:#71717a;font-weight:500">${userSubscription?.plan_id || 'Plan'}</div>
        <div style="font-size:9px;color:#ef4444;margin-top:2px">Zahlung fehlgeschlagen</div>
      `;
    } else if (status === 'incomplete') {
      // Checkout started but not completed
      planEl.innerHTML = `<span style="color:#f97316;cursor:pointer" onclick="setPage('billing')">Einrichtung ausstehend</span>`;
    } else {
      // No active subscription
      planEl.innerHTML = `<span style="color:#71717a;cursor:pointer" onclick="setPage('billing')">Plan w√§hlen</span>`;
    }
  }
  
  // Update sidebar locked states
  updateSidebarLocks();
}

// Update sidebar to show locked modules
function updateSidebarLocks() {
  // All modules that can be locked (everything except billing and settings)
  const lockableModules = ['bookings', 'properties', 'partners', 'messages', 'reviews', 'pricing', 'automation'];
  
  const currentPlan = getCurrentPlan();
  const hasActivePlan = currentPlan !== null;
  
  lockableModules.forEach(module => {
    const navItem = document.querySelector(`[data-page="${module}"]`);
    if (!navItem) return;
    
    // If no active plan, lock EVERYTHING except billing and settings
    // If has plan, check module access based on plan
    const isLocked = !hasActivePlan || !canAccessModule(module);
    
    // Remove existing lock indicator
    const existingLock = navItem.querySelector('.nav-lock');
    if (existingLock) existingLock.remove();
    
    if (isLocked) {
      navItem.style.opacity = '0.6';
      navItem.style.position = 'relative';
      const lockSpan = document.createElement('span');
      lockSpan.className = 'nav-lock';
      lockSpan.style.cssText = 'position:absolute;right:12px;top:50%;transform:translateY(-50%);display:flex;align-items:center;justify-content:center;width:18px;height:18px;background:rgba(113,113,122,0.2);border-radius:4px;';
      lockSpan.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#71717a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';
      navItem.appendChild(lockSpan);
    } else {
      navItem.style.opacity = '1';
    }
  });
}

// =====================
// NAVIGATION
// =====================
function setPage(p) {
  // Billing and settings are always accessible
  const alwaysAccessible = ['billing', 'settings'];
  
  if (!alwaysAccessible.includes(p)) {
    const currentPlan = getCurrentPlan();
    
    // If no plan at all, redirect to billing
    if (!currentPlan) {
      showModal(`
        <div style="text-align:center;padding:20px">
          <div style="width:48px;height:48px;margin:0 auto 16px;background:rgba(249,115,22,0.1);border-radius:12px;display:flex;align-items:center;justify-content:center">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
          </div>
          <div style="font-size:18px;font-weight:700;margin-bottom:8px">Plan erforderlich</div>
          <div style="color:#a1a1aa;margin-bottom:24px;line-height:1.5">
            W√§hle einen Plan um alle PilotStay-Funktionen freizuschalten.
          </div>
          <button class="btn btn-primary" onclick="hideModal(); setPage('billing'); setBillingTab('plans', true)">
            Plan ausw√§hlen
          </button>
        </div>
      `);
      return;
    }
    
    // Check if user can access this specific module based on their plan
    if (!canAccessModule(p)) {
      const requiredPlan = getRequiredPlanForModule(p);
      const moduleNames = {
        'bookings': 'Buchungen',
        'properties': 'Objekte',
        'partners': 'Partner-Netzwerk',
        'messages': 'Nachrichten',
        'reviews': 'Bewertungen',
        'pricing': 'Preisoptimierung',
        'automation': 'Automation'
      };
      showUpgradeRequired(moduleNames[p] || p, requiredPlan);
      return;
    }
  }
  
  currentPage = p;
  document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.page === p));
  renderPage();
}

// Get correct automation status tag based on actual settings
function getAutomationStatusTag(feature, label) {
  const settingsKey = feature; // smartReplies, reviewReplies, autoPricing
  const modeKey = feature + 'Mode'; // smartRepliesMode, etc.
  
  const enabled = automationSettings[settingsKey];
  const mode = automationSettings[modeKey] || 'manual';
  
  if (!enabled || mode === 'off') {
    return `<span class="tag tag-orange">üß† ${label} aus</span>`;
  }
  
  // Check if mode is allowed for current plan
  if (!isAutomationModeAllowed(settingsKey, mode)) {
    return `<span class="tag tag-orange" style="display:inline-flex;align-items:center;gap:4px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg> ${label}</span>`;
  }
  
  const modeLabels = {
    'manual': 'Manuell',
    'hybrid': 'Hybrid',
    'auto': 'Auto'
  };
  
  const modeColors = {
    'manual': 'tag-blue',
    'hybrid': 'tag-purple', 
    'auto': 'tag-green'
  };
  
  return `<span class="tag ${modeColors[mode] || 'tag-purple'}">üß† ${label} (${modeLabels[mode] || mode})</span>`;
}

// =====================
// RENDER PAGE
// =====================
function renderPage() {
  const c = document.getElementById('content');
  const t = document.getElementById('page-title');
  const s = document.getElementById('page-subtitle');
  const a = document.getElementById('header-actions');
  const date = new Date().toLocaleDateString('de-DE', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
  
  switch(currentPage) {
    case 'dashboard':
      const firstName = profile?.first_name || profile?.name?.split(' ')[0] || user?.email?.split('@')[0] || '';
      t.textContent = firstName ? `Willkommen zur√ºck, ${firstName}! üëã` : 'Willkommen zur√ºck! üëã';
      s.textContent = date;
      a.innerHTML = ''; // No quick-add on dashboard
      c.innerHTML = renderDashboard();
      break;
    case 'bookings':
      t.textContent = 'Buchungen';
      s.textContent = bookings.length + ' Buchungen insgesamt';
      a.innerHTML = ''; // Button only in module content
      c.innerHTML = renderBookings();
      break;
    case 'properties':
      t.textContent = 'Objekte';
      s.textContent = properties.length + ' Objekte verwaltet';
      a.innerHTML = ''; // Button only in module content
      c.innerHTML = renderProperties();
      break;
    case 'partners':
      t.textContent = 'Partner';
      s.textContent = 'Finde Reinigungskr√§fte & Services';
      a.innerHTML = '';
      c.innerHTML = renderPartners();
      break;
    case 'messages':
      t.textContent = 'üí¨ Nachrichten';
      s.textContent = 'KI-gest√ºtzte G√§stekommunikation';
      a.innerHTML = getAutomationStatusTag('smartReplies', 'Smart Replies');
      c.innerHTML = renderMessages();
      break;
    case 'reviews':
      t.textContent = '‚≠ê Bewertungen';
      s.textContent = 'KI-generierte Antwortvorschl√§ge';
      a.innerHTML = getAutomationStatusTag('reviewReplies', 'KI-Antworten');
      c.innerHTML = renderReviews();
      break;
    case 'pricing':
      t.textContent = 'üí∞ Preisoptimierung';
      s.textContent = 'KI-gesteuerte dynamische Preise';
      a.innerHTML = getAutomationStatusTag('autoPricing', 'Auto-Pricing');
      c.innerHTML = renderPricing();
      break;
    case 'automation':
      t.textContent = 'Automatisierung';
      s.textContent = 'KI-Features & Auto-Pilot';
      a.innerHTML = '';
      c.innerHTML = renderAutomation();
      break;
    case 'billing':
      t.textContent = 'üí≥ Payments & Billing';
      s.textContent = 'Abo, Pl√§ne & Rechnungen verwalten';
      a.innerHTML = '';
      c.innerHTML = renderBillingPage();
      break;
    case 'settings':
      t.textContent = 'Einstellungen';
      s.textContent = 'Profil & Integrationen';
      a.innerHTML = '';
      c.innerHTML = renderSettings();
      break;
  }
}

// =====================
// DASHBOARD
// =====================
function renderDashboard() {
  // Calculate current month revenue - exclude cancelled bookings
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
  const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
  
  // Filter out cancelled bookings for all calculations
  const activeBookings = bookings.filter(b => b.status !== 'cancelled');
  
  // Current month bookings (active only)
  const currentMonthBookings = activeBookings.filter(b => {
    const checkIn = new Date(b.check_in);
    return checkIn.getMonth() === currentMonth && checkIn.getFullYear() === currentYear;
  });
  
  // Last month bookings (active only)
  const lastMonthBookings = activeBookings.filter(b => {
    const checkIn = new Date(b.check_in);
    return checkIn.getMonth() === lastMonth && checkIn.getFullYear() === lastMonthYear;
  });
  
  const currentRev = currentMonthBookings.reduce((s,b) => s + (b.total_price||0), 0);
  const lastRev = lastMonthBookings.reduce((s,b) => s + (b.total_price||0), 0);
  const totalRev = activeBookings.reduce((s,b) => s + (b.total_price||0), 0);
  
  // Calculate percentage change
  let revChange = 0;
  let revChangeText = '';
  if (lastRev > 0) {
    revChange = Math.round(((currentRev - lastRev) / lastRev) * 100);
    revChangeText = revChange >= 0 ? `+${revChange}%` : `${revChange}%`;
  } else if (currentRev > 0) {
    revChangeText = '+100%';
    revChange = 100;
  } else {
    revChangeText = '‚Äî';
  }
  
  // Upcoming bookings - only active ones, future check-ins
  const upcoming = activeBookings
    .filter(b => new Date(b.check_in) >= new Date())
    .sort((a,b) => new Date(a.check_in) - new Date(b.check_in))
    .slice(0,5);
  const unreadMsgs = chats.reduce((s,c) => s + c.unread, 0);
  const pendingReviews = reviews.filter(r => !r.replied).length;
  
  return `
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-value">‚Ç¨${totalRev.toLocaleString()}</div>
        <div class="stat-label">Umsatz (Gesamt)</div>
        ${revChangeText !== '‚Äî' ? `<div class="stat-change ${revChange >= 0 ? 'up' : 'down'}">${revChangeText} vs. Vormonat</div>` : ''}
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìÖ</div>
        <div class="stat-value">${activeBookings.length}</div>
        <div class="stat-label">Buchungen</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üí¨</div>
        <div class="stat-value">${unreadMsgs}</div>
        <div class="stat-label">Neue Nachrichten</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚≠ê</div>
        <div class="stat-value">${pendingReviews}</div>
        <div class="stat-label">Unbeantwortete Bewertungen</div>
      </div>
    </div>
    
    <!-- AI Score -->
    ${(() => {
      // Calculate KI-Score dynamically - only real features
      const activeFeatures = [
        automationSettings.smartReplies && automationSettings.smartRepliesMode !== 'off',
        automationSettings.reviewReplies && automationSettings.reviewRepliesMode !== 'off',
        automationSettings.autoPricing && automationSettings.autoPricingMode !== 'off',
        smoobuConfig.connected
      ].filter(Boolean).length;
      
      const totalFeatures = 4;
      const score = properties.length > 0 ? Math.round((activeFeatures / totalFeatures) * 100) : 0;
      
      // Build active features tags - clean style without excessive emojis
      const featureTags = [];
      if (automationSettings.smartReplies && automationSettings.smartRepliesMode !== 'off') featureTags.push('<span class="tag tag-purple">Smart Replies</span>');
      if (automationSettings.reviewReplies && automationSettings.reviewRepliesMode !== 'off') featureTags.push('<span class="tag tag-purple">Review-Antworten</span>');
      if (automationSettings.autoPricing && automationSettings.autoPricingMode !== 'off') featureTags.push('<span class="tag tag-purple">Auto-Pricing</span>');
      if (smoobuConfig.connected) featureTags.push('<span class="tag tag-green">Smoobu</span>');
      
      const inactiveCount = totalFeatures - activeFeatures;
      
      return `
        <div class="card card-ai" style="margin-bottom:24px">
          <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap">
            <div style="text-align:center;min-width:100px">
              <div style="font-size:48px;font-weight:700;color:${score >= 80 ? '#22c55e' : score >= 50 ? '#8b5cf6' : '#f97316'}">${score}%</div>
              <div style="font-size:12px;color:#a1a1aa">KI-Score</div>
            </div>
            <div style="flex:1;padding-left:20px;border-left:1px solid #27272a;min-width:200px">
              <div style="font-weight:600;margin-bottom:8px">${activeFeatures > 0 ? 'Aktive Features:' : 'Keine Features aktiv'}</div>
              <div style="display:flex;flex-wrap:wrap;gap:8px">
                ${featureTags.length > 0 ? featureTags.join('') : '<span style="color:#71717a;font-size:13px">Features unter Automatisierung aktivieren</span>'}
              </div>
              ${inactiveCount > 0 && properties.length > 0 ? `
                <div style="margin-top:10px;font-size:12px;color:#a1a1aa">
                  ${inactiveCount} weitere Feature${inactiveCount > 1 ? 's' : ''} verf√ºgbar
                </div>
              ` : ''}
            </div>
            <button class="btn btn-ai" onclick="setPage('automation')">Mehr</button>
          </div>
        </div>
      `;
    })()}
    
    <div class="grid-2">
      <div class="card">
        <div class="card-title">üìÖ Kommende Buchungen</div>
        ${upcoming.length ? upcoming.map(b => `
          <div class="list-item">
            <div class="list-icon">üë§</div>
            <div class="list-info">
              <div class="list-title">${b.guest_name}</div>
              <div class="list-subtitle">${b.properties?.name || ''} ¬∑ ${fmtDate(b.check_in)}</div>
            </div>
            <div style="color:#22c55e;font-weight:700">‚Ç¨${b.total_price||0}</div>
          </div>
        `).join('') : `
          <div class="empty-state" style="padding:30px">
            <div class="empty-icon">üì≠</div>
            <div class="empty-desc">Keine Buchungen</div>
          </div>
        `}
      </div>
      
      <div class="card">
        <div class="card-title">üè† Deine Objekte</div>
        ${properties.length ? properties.slice(0,4).map(p => `
          <div class="list-item">
            <div class="list-icon">${p.property_type === 'house' ? 'üè°' : 'üè¢'}</div>
            <div class="list-info">
              <div class="list-title">${p.name}</div>
              <div class="list-subtitle">${p.city || '-'}</div>
            </div>
            <span class="tag tag-green">Aktiv</span>
          </div>
        `).join('') : `
          <div class="empty-state" style="padding:30px">
            <div class="empty-icon">üèöÔ∏è</div>
            <button class="btn btn-primary" onclick="showAddProp()">+ Objekt</button>
          </div>
        `}
      </div>
    </div>
  `;
}

// =====================
// MESSAGES (AI)
// =====================
// =====================================================
// MESSAGES MODULE - COMPLETE REWRITE
// =====================================================

function renderMessages() {
  // Check Smoobu connection
  if (!smoobuConfig.connected) {
    return `
      <div class="messages-empty">
        <div class="messages-empty-icon">üí¨</div>
        <div class="messages-empty-title">Smoobu verbinden</div>
        <div class="messages-empty-text">Verbinde dein Smoobu-Konto um Nachrichten zu sehen.</div>
        <button class="btn btn-primary" onclick="showSmoobuConnect()">üîó Verbinden</button>
      </div>`;
  }
  
  // Check if chats exist
  if (!chats || chats.length === 0) {
    return `
      <div class="messages-empty">
        <div class="messages-empty-icon">üì≠</div>
        <div class="messages-empty-title">Keine Nachrichten</div>
        <div class="messages-empty-text">Es gibt noch keine Konversationen.</div>
        <button class="btn btn-secondary" onclick="loadSmoobuMessages().then(()=>renderPage())">üîÑ Aktualisieren</button>
      </div>`;
  }
  
  // Get selected chat
  const selectedChat = activeChat ? chats.find(c => String(c.id) === String(activeChat)) : null;
  
  return `
    <div style="display:flex;flex-direction:row;gap:16px;height:650px">
      ${renderChatWindow(selectedChat)}
      ${renderChatList()}
    </div>`;
}

function renderChatList() {
  const kiStatus = automationSettings.smartReplies 
    ? '<span class="tag tag-green">KI aktiv</span>' 
    : '<span class="tag tag-orange">KI aus</span>';
  
  let listItems = '';
  chats.forEach(chat => {
    const isActive = String(activeChat) === String(chat.id);
    const bgStyle = isActive ? 'background:#27272a;border-left:3px solid #f97316;' : 'border-left:3px solid transparent;';
    const unreadBadge = chat.unread > 0 ? `<span style="background:#f97316;color:#fff;font-size:10px;font-weight:600;padding:2px 6px;border-radius:10px;flex-shrink:0">${chat.unread}</span>` : '';
    
    listItems += `
      <div onclick="selectChat('${chat.id}')" style="display:flex;gap:12px;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:4px;${bgStyle}">
        <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#ea580c,#f97316);display:flex;align-items:center;justify-content:center;font-weight:600;color:#fff;flex-shrink:0">${chat.avatar || '?'}</div>
        <div style="flex:1;min-width:0;overflow:hidden">
          <div style="font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${chat.name || 'Unbekannt'}</div>
          <div style="font-size:10px;color:#71717a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${chat.property || ''}</div>
          <div style="font-size:11px;color:#71717a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${chat.lastMsg || ''}</div>
        </div>
        ${unreadBadge}
      </div>`;
  });
  
  return `
    <div style="width:320px;min-width:320px;flex-shrink:0;background:#18181b;border-radius:12px;border:1px solid #27272a;display:flex;flex-direction:column;overflow:hidden">
      <div style="padding:14px 16px;border-bottom:1px solid #27272a;display:flex;justify-content:space-between;align-items:center">
        <span style="font-weight:600">Konversationen (${chats.length})</span>
        <div style="display:flex;gap:8px;align-items:center">
          ${kiStatus}
          <button class="btn btn-sm btn-secondary" onclick="loadSmoobuMessages().then(()=>renderPage())" style="padding:4px 8px">üîÑ</button>
        </div>
      </div>
      <div style="flex:1;overflow-y:auto;padding:8px">${listItems}</div>
    </div>`;
}

function renderChatWindow(chat) {
  if (!chat) {
    return `
      <div style="flex:1;min-width:0;background:#18181b;border-radius:12px;border:1px solid #27272a;display:flex;align-items:center;justify-content:center">
        <div style="text-align:center;color:#71717a">
          <div style="font-size:48px;margin-bottom:12px;opacity:0.5">üí¨</div>
          <div>W√§hle eine Konversation</div>
        </div>
      </div>`;
  }
  
  // Build messages
  let messagesHtml = '';
  if (chat.messages && chat.messages.length > 0) {
    chat.messages.forEach(msg => {
      const isGuest = msg.from === 'them' || msg.from === 'guest';
      const isAI = msg.ai === true;
      const alignSelf = isGuest ? 'flex-start' : 'flex-end';
      const textAlign = isGuest ? 'left' : 'right';
      const bubbleStyle = isGuest 
        ? 'background:#27272a;border:1px solid #3f3f46;border-radius:4px 16px 16px 16px' 
        : isAI 
          ? 'background:linear-gradient(135deg,#7c3aed,#8b5cf6);border-radius:16px 16px 4px 16px'
          : 'background:linear-gradient(135deg,#ea580c,#f97316);border-radius:16px 16px 4px 16px';
      const senderIcon = isGuest ? 'üë§' : (isAI ? 'ü§ñ' : 'üè†');
      const senderName = isGuest ? chat.name : (isAI ? 'KI' : 'Du');
      
      messagesHtml += `
        <div style="align-self:${alignSelf};max-width:75%">
          <div style="font-size:10px;color:#71717a;margin-bottom:4px;text-align:${textAlign}">${senderIcon} ${senderName} ¬∑ ${msg.time || ''}</div>
          <div style="${bubbleStyle};padding:12px 16px;font-size:13px;line-height:1.5">${msg.text || ''}</div>
        </div>`;
    });
  } else {
    messagesHtml = '<div style="color:#71717a;text-align:center;padding:40px">Keine Nachrichten</div>';
  }
  
  // Smart replies
  const smartReplies = automationSettings.smartReplies ? getSmartReplies(chat) : [];
  let smartRepliesHtml = '';
  if (smartReplies.length > 0) {
    const buttons = smartReplies.map((reply, i) => 
      `<button onclick="sendSmartReply(${i})" style="background:#27272a;border:1px solid #3f3f46;padding:8px 14px;border-radius:20px;font-size:12px;cursor:pointer;color:#fafafa">${reply}</button>`
    ).join('');
    smartRepliesHtml = `
      <div style="padding:12px 16px;border-top:1px solid #27272a;background:#1a1a1e;flex-shrink:0">
        <div style="font-size:11px;color:#71717a;margin-bottom:8px">üß† KI-Vorschl√§ge</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px">${buttons}</div>
      </div>`;
  }
  
  // Platform tag
  const platformTag = chat.platform === 'airbnb' ? 'Airbnb' 
    : chat.platform === 'booking' ? 'Booking' 
    : 'Direkt';
  const platformClass = chat.platform === 'airbnb' ? 'tag-red' 
    : chat.platform === 'booking' ? 'tag-blue' 
    : 'tag-orange';
  
  return `
    <div style="flex:1;min-width:0;background:#18181b;border-radius:12px;border:1px solid #27272a;display:flex;flex-direction:column;overflow:hidden">
      <div style="padding:14px 16px;border-bottom:1px solid #27272a;display:flex;align-items:center;gap:12px;flex-shrink:0">
        <div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#ea580c,#f97316);display:flex;align-items:center;justify-content:center;font-weight:600;color:#fff">${chat.avatar || '?'}</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;font-size:15px">${chat.name || 'Unbekannt'}</div>
          <div style="font-size:11px;color:#71717a">${chat.property || ''}</div>
        </div>
        <span class="tag ${platformClass}">${platformTag}</span>
      </div>
      
      <div id="chat-messages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px">
        ${messagesHtml}
      </div>
      
      ${smartRepliesHtml}
      
      <div style="padding:14px 16px;border-top:1px solid #27272a;display:flex;gap:10px;align-items:center;flex-shrink:0">
        <button class="btn btn-secondary" onclick="showAiCompose()" style="padding:10px 12px">ü§ñ</button>
        <input type="text" id="msg-input" class="input" placeholder="Nachricht schreiben..." style="flex:1" onkeypress="if(event.key==='Enter')sendMessage()">
        <button class="btn btn-primary" onclick="sendMessage()">Senden</button>
      </div>
    </div>`;
}

// Select chat
function selectChat(chatId) {
  activeChat = String(chatId);
  const chat = chats.find(c => String(c.id) === activeChat);
  if (chat) {
    chat.unread = 0;
    console.log('Selected chat:', chat.name, '- Messages:', chat.messages?.length || 0);
  }
  renderPage();
  setTimeout(scrollChatToBottom, 100);
}

// Scroll to bottom
function scrollChatToBottom() {
  const el = document.getElementById('chat-messages');
  if (el) el.scrollTop = el.scrollHeight;
}

// Get smart replies
// Smart reply cache
let smartReplyCache = {};

function getSmartReplies(chat) {
  if (!chat || !chat.messages || chat.messages.length === 0) return [];
  
  const lastMsg = chat.messages[chat.messages.length - 1];
  if (!lastMsg || lastMsg.from === 'me') return [];
  
  // Check cache first
  const cacheKey = `${chat.id}_${lastMsg.id || lastMsg.time}`;
  if (smartReplyCache[cacheKey]) {
    return smartReplyCache[cacheKey];
  }
  
  // Get immediate enhanced keyword replies
  const fallbackReplies = getEnhancedKeywordReplies(lastMsg.text || '', chat);
  smartReplyCache[cacheKey] = fallbackReplies;
  
  // Try to get AI replies in background (don't block)
  if (automationSettings.smartReplies) {
    generateAISmartReplies(chat, lastMsg, cacheKey);
  }
  
  return fallbackReplies;
}

// Keyword-based fallback replies
// Generate AI smart replies in background
async function generateAISmartReplies(chat, lastMsg, cacheKey) {
  console.log('ü§ñ Generating AI Smart Replies...');
  console.log('   Guest message:', lastMsg.text?.substring(0, 50));
  
  try {
    const session = await db?.auth?.getSession();
    const token = session?.data?.session?.access_token;
    
    console.log('   Auth token:', token ? '‚úì SET' : '‚úó NOT SET');
    
    if (!token) {
      console.log('   ‚ö†Ô∏è No auth token - using keyword replies only');
      return;
    }
    
    console.log('   Calling AI_PROXY_URL:', AI_PROXY_URL);
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000); // 8s timeout
    
    const response = await fetch(AI_PROXY_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({
        action: 'smart-replies',
        data: {
          guestName: chat.name,
          guestMessage: lastMsg.text,
          propertyName: chat.property,
          conversationHistory: chat.messages.slice(-5).map(m => ({
            from: m.from === 'me' ? 'host' : 'guest',
            text: m.text
          }))
        }
      }),
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    console.log('   AI Response status:', response.status);
    
    if (response.ok) {
      const data = await response.json();
      console.log('   AI Response data:', data);
      
      if (data.replies && data.replies.length > 0) {
        console.log('   ‚úÖ Got AI replies:', data.replies);
        smartReplyCache[cacheKey] = data.replies;
        if (String(activeChat) === String(chat.id) && currentPage === 'messages') {
          renderPage();
        }
      }
    } else if (response.status === 401) {
      // JWT invalid - use enhanced keyword replies instead
      console.log('   ‚ö†Ô∏è AI Auth failed (401) - using enhanced keyword replies');
      const enhancedReplies = getEnhancedKeywordReplies(lastMsg.text, chat);
      if (enhancedReplies.length > 0) {
        smartReplyCache[cacheKey] = enhancedReplies;
        if (String(activeChat) === String(chat.id) && currentPage === 'messages') {
          renderPage();
        }
      }
    } else {
      const errorText = await response.text();
      console.error('   ‚ùå AI Error:', response.status, errorText);
    }
  } catch (e) {
    if (e.name === 'AbortError') {
      console.log('   ‚ö†Ô∏è AI request timed out - using keyword replies');
    } else {
      console.error('   ‚ùå AI Exception:', e.message);
    }
  }
}

// Enhanced keyword replies with more context
function getEnhancedKeywordReplies(text, chat) {
  const t = (text || '').toLowerCase();
  const guestName = chat?.name?.split(' ')[0] || '';
  
  // WLAN/Internet
  if (t.includes('wlan') || t.includes('wifi') || t.includes('internet') || t.includes('passwort') || t.includes('password')) {
    return [
      `Hi ${guestName}! Das WLAN-Passwort findest du in der Wohnung am Router. üì∂`,
      'Die Zugangsdaten stehen auch im G√§stebuch auf dem Tisch!',
      'Ich schicke dir die WLAN-Daten gleich per Nachricht.'
    ];
  }
  
  // Check-in/Checkout
  if (t.includes('check-in') || t.includes('checkin') || t.includes('anreise') || t.includes('ankommen') || t.includes('fr√ºher')) {
    return [
      `Hi ${guestName}! Check-in ist ab 15:00 Uhr m√∂glich. üîë`,
      'Ich kann auch einen fr√ºheren Check-in pr√ºfen - wann kommst du an?',
      'Die Adresse und Zugangsdaten habe ich dir per E-Mail geschickt!'
    ];
  }
  
  if (t.includes('checkout') || t.includes('check-out') || t.includes('abreise') || t.includes('sp√§ter') || t.includes('verl√§nger')) {
    return [
      `Hi ${guestName}! Checkout ist bis 11:00 Uhr. ‚è∞`,
      'Ein sp√§terer Checkout bis 14 Uhr ist gegen Aufpreis m√∂glich!',
      'Ich schaue nach ob sp√§tes Checkout m√∂glich ist und melde mich!'
    ];
  }
  
  // Parkplatz
  if (t.includes('park') || t.includes('auto') || t.includes('garage') || t.includes('stell')) {
    return [
      `Hi ${guestName}! Kostenlose Parkpl√§tze findest du direkt vor dem Haus. üöó`,
      'Es gibt auch eine Tiefgarage im Geb√§ude.',
      'Am besten auf der Stra√üe parken - ist in der Gegend kostenlos!'
    ];
  }
  
  // Schl√ºssel
  if (t.includes('schl√ºssel') || t.includes('key') || t.includes('lockbox') || t.includes('code') || t.includes('t√ºr')) {
    return [
      `Hi ${guestName}! Der Schl√ºssel ist in der Lockbox neben der Eingangst√ºr. üîë`,
      'Den Code f√ºr die Lockbox habe ich dir per E-Mail geschickt!',
      'Ich schicke dir die Zugangsdaten gleich nochmal.'
    ];
  }
  
  // Probleme/Beschwerden
  if (t.includes('problem') || t.includes('kaputt') || t.includes('funktioniert nicht') || t.includes('defekt') || t.includes('schmutzig') || t.includes('dreckig')) {
    return [
      `Oh nein ${guestName}! Das tut mir sehr leid. Kannst du mir mehr Details geben?`,
      'Ich k√ºmmere mich sofort darum! Was genau ist das Problem?',
      'Danke f√ºr den Hinweis - ich schicke gleich jemanden vorbei!'
    ];
  }
  
  // Heizung/Klima
  if (t.includes('heiz') || t.includes('kalt') || t.includes('warm') || t.includes('temperatur') || t.includes('klima')) {
    return [
      'Die Heizung kannst du am Thermostat an der Wand einstellen! üå°Ô∏è',
      'Dreh den Regler auf 3-4 f√ºr angenehme W√§rme.',
      'Ich erkl√§re dir gerne wie die Heizung funktioniert!'
    ];
  }
  
  // Danke/Positiv
  if (t.includes('danke') || t.includes('super') || t.includes('toll') || t.includes('perfekt') || t.includes('wunderbar') || t.includes('top')) {
    return [
      `Sehr gerne ${guestName}! Freut mich dass alles passt. üòä`,
      'Das freut mich zu h√∂ren! Bei Fragen jederzeit melden.',
      'Super! Genie√ü deinen Aufenthalt! üåü'
    ];
  }
  
  // Begr√º√üung
  if (t.includes('hallo') || t.includes('hi') || t.includes('hey') || t.includes('guten') || t.includes('servus') || t.includes('moin')) {
    return [
      `Hallo ${guestName}! Wie kann ich dir helfen? üëã`,
      'Hi! Ist alles in Ordnung? Bei Fragen bin ich da!',
      `Guten Tag ${guestName}! Was kann ich f√ºr dich tun?`
    ];
  }
  
  // Frage nach Empfehlungen
  if (t.includes('restaurant') || t.includes('essen') || t.includes('empfehl') || t.includes('tipp') || t.includes('sehensw√ºrd')) {
    return [
      `Gute Frage ${guestName}! In der Gegend gibt es viele tolle Restaurants.`,
      'Ich schicke dir gleich ein paar Empfehlungen!',
      'Was f√ºr Essen magst du am liebsten? Dann kann ich besser empfehlen.'
    ];
  }
  
  // Default
  return [
    `Danke f√ºr deine Nachricht ${guestName}! üòä`,
    'Ich melde mich gleich bei dir!',
    'Alles klar, verstanden!'
  ];
}

// Send smart reply
async function sendSmartReply(idx) {
  const chat = chats.find(c => String(c.id) === String(activeChat));
  if (!chat) return;
  
  const replies = getSmartReplies(chat);
  const text = replies[idx];
  if (!text) return;
  
  // Add message
  chat.messages.push({
    id: 'sr_' + Date.now(),
    from: 'me',
    text: text,
    time: new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}),
    ai: true
  });
  chat.lastMsg = text;
  chat.unread = 0;
  
  renderPage();
  scrollChatToBottom();
  
  // Send via Smoobu
  if (smoobuConfig.connected && chat.smoobuId) {
    try {
      await sendMessageViaSmoobu(chat.smoobuId, text);
      showToast('‚úÖ Nachricht gesendet');
    } catch (e) {
      console.error('Smoobu error:', e);
      showToast('‚ö†Ô∏è Lokal gespeichert');
    }
  } else {
    showToast('üí¨ Nachricht hinzugef√ºgt');
  }
}

// Send message
async function sendMessage() {
  const input = document.getElementById('msg-input');
  if (!input) {
    console.error('‚ùå msg-input element not found!');
    return;
  }
  
  const text = input.value.trim();
  if (!text) {
    console.log('‚ö†Ô∏è Empty message, not sending');
    return;
  }
  
  if (!activeChat) {
    console.error('‚ùå No activeChat selected');
    return;
  }
  
  const chat = chats.find(c => String(c.id) === String(activeChat));
  if (!chat) {
    console.error('‚ùå Chat not found for ID:', activeChat);
    console.log('   Available chats:', chats.map(c => ({ id: c.id, smoobuId: c.smoobuId, name: c.name })));
    return;
  }
  
  // Debug info
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('üì§ SENDING MESSAGE');
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('   Text:', text);
  console.log('   Chat ID:', chat.id);
  console.log('   Chat smoobuId:', chat.smoobuId);
  console.log('   smoobuConfig.connected:', smoobuConfig.connected);
  console.log('   smoobuConfig.apiKey:', smoobuConfig.apiKey ? '‚úì SET' : '‚úó NOT SET');
  
  // Clear input
  input.value = '';
  
  // Add message locally
  const newMsg = {
    id: 'msg_' + Date.now(),
    from: 'me',
    text: text,
    time: new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}),
    pending: true
  };
  chat.messages.push(newMsg);
  chat.lastMsg = text;
  
  renderPage();
  scrollChatToBottom();
  
  // Check if we can send
  const canSend = smoobuConfig.connected && chat.smoobuId && smoobuConfig.apiKey;
  console.log('   Can send to Smoobu:', canSend ? '‚úì YES' : '‚úó NO');
  
  if (canSend) {
    try {
      const url = `${SMOOBU_PROXY_URL}?action=send-message`;
      const payload = { bookingId: chat.smoobuId, messageBody: text };
      
      console.log('   URL:', url);
      console.log('   Payload:', JSON.stringify(payload));
      
      const response = await fetch(url, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json', 
          'x-smoobu-key': smoobuConfig.apiKey 
        },
        body: JSON.stringify(payload)
      });
      
      console.log('   Response Status:', response.status);
      const responseText = await response.text();
      console.log('   Response Body:', responseText);
      
      if (response.ok) {
        newMsg.pending = false;
        newMsg.sent = true;
        console.log('‚úÖ Message sent successfully!');
        showToast('‚úÖ Nachricht gesendet');
      } else {
        newMsg.error = true;
        console.error('‚ùå Smoobu returned error:', response.status);
        showToast('‚ö†Ô∏è Fehler ' + response.status);
      }
    } catch (e) {
      newMsg.error = true;
      console.error('‚ùå Exception while sending:', e);
      showToast('‚ö†Ô∏è ' + e.message);
    }
  } else {
    newMsg.pending = false;
    console.log('‚ÑπÔ∏è Message saved locally only');
    if (!smoobuConfig.connected) console.log('   Reason: Smoobu not connected');
    if (!chat.smoobuId) console.log('   Reason: No smoobuId on chat');
    if (!smoobuConfig.apiKey) console.log('   Reason: No API key');
    showToast('üí¨ Lokal gespeichert');
  }
  
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  renderPage();
}

// AI Compose
function showAiCompose() {
  const chat = chats.find(c => String(c.id) === String(activeChat));
  if (!chat) return;
  
  showModal(`
    <div class="modal-title">ü§ñ KI-Nachricht verfassen</div>
    <p style="color:#a1a1aa;margin-bottom:16px">W√§hle eine Vorlage f√ºr ${chat.name}</p>
    
    <div style="display:grid;gap:10px;margin-bottom:20px">
      <button class="btn btn-secondary" style="text-align:left;padding:14px" onclick="useTemplate('welcome')">
        <strong>üëã Willkommen</strong><br><small style="color:#71717a">Begr√º√üe den Gast</small>
      </button>
      <button class="btn btn-secondary" style="text-align:left;padding:14px" onclick="useTemplate('checkin')">
        <strong>üîë Check-in Info</strong><br><small style="color:#71717a">Anreise-Details</small>
      </button>
      <button class="btn btn-secondary" style="text-align:left;padding:14px" onclick="useTemplate('checkout')">
        <strong>üèÅ Checkout</strong><br><small style="color:#71717a">Abreise-Erinnerung</small>
      </button>
      <button class="btn btn-secondary" style="text-align:left;padding:14px" onclick="useTemplate('wifi')">
        <strong>üì∂ WLAN</strong><br><small style="color:#71717a">Zugangsdaten</small>
      </button>
      <button class="btn btn-secondary" style="text-align:left;padding:14px" onclick="useTemplate('thanks')">
        <strong>üôè Danke</strong><br><small style="color:#71717a">Nach dem Aufenthalt</small>
      </button>
    </div>
    
    <button class="btn btn-secondary" onclick="hideModal()" style="width:100%">Abbrechen</button>
  `);
}

function useTemplate(type) {
  const chat = chats.find(c => String(c.id) === String(activeChat));
  if (!chat) { hideModal(); return; }
  
  const templates = {
    welcome: `Hallo ${chat.name}! üëã\n\nHerzlich willkommen! Ich freue mich auf deinen Aufenthalt.\n\nBei Fragen bin ich jederzeit erreichbar.\n\nViele Gr√º√üe`,
    checkin: `Hallo ${chat.name}! üîë\n\nHier sind deine Check-in Infos:\n\nüìç Adresse: Siehe Buchung\n‚è∞ Check-in: ab 15:00 Uhr\nüîê Schl√ºssel: Lockbox neben der T√ºr\n\nBis bald!`,
    checkout: `Hallo ${chat.name}! üè†\n\nKurze Erinnerung: Checkout ist bis 11:00 Uhr.\n\nBitte:\n‚Ä¢ Fenster schlie√üen\n‚Ä¢ M√ºll mitnehmen\n‚Ä¢ Schl√ºssel in Lockbox\n\nDanke f√ºr deinen Aufenthalt! ‚≠ê`,
    wifi: `Hallo ${chat.name}! üì∂\n\nWLAN-Daten:\nNetzwerk: GuestWiFi\nPasswort: Guest2024\n\nViel Spa√ü!`,
    thanks: `Hallo ${chat.name}! üôè\n\nVielen Dank f√ºr deinen Aufenthalt!\n\nWir w√ºrden uns √ºber eine Bewertung freuen. ‚≠ê\n\nBis zum n√§chsten Mal!`
  };
  
  const message = templates[type] || templates.welcome;
  
  hideModal();
  showModal(`
    <div class="modal-title">‚úèÔ∏è Nachricht bearbeiten</div>
    <textarea id="template-text" style="width:100%;min-height:180px;background:#18181b;border:1px solid #27272a;border-radius:8px;padding:12px;color:#fafafa;font-size:14px;resize:vertical;margin-bottom:16px">${message}</textarea>
    <div style="display:flex;gap:12px">
      <button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Abbrechen</button>
      <button class="btn btn-primary" onclick="sendTemplateMessage()" style="flex:1">üì§ Senden</button>
    </div>
  `);
}

async function sendTemplateMessage() {
  const textarea = document.getElementById('template-text');
  const text = textarea?.value?.trim();
  if (!text) { hideModal(); return; }
  
  const chat = chats.find(c => String(c.id) === String(activeChat));
  if (!chat) { hideModal(); return; }
  
  hideModal();
  
  chat.messages.push({
    id: 'tpl_' + Date.now(),
    from: 'me',
    text: text,
    time: new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}),
    ai: true
  });
  chat.lastMsg = text.substring(0, 50);
  
  renderPage();
  scrollChatToBottom();
  
  if (smoobuConfig.connected && chat.smoobuId) {
    try {
      await sendMessageViaSmoobu(chat.smoobuId, text);
      showToast('‚úÖ Nachricht gesendet');
    } catch (e) {
      showToast('‚ö†Ô∏è Lokal gespeichert');
    }
  } else {
    showToast('üí¨ Nachricht hinzugef√ºgt');
  }
}

// =====================================================
// END MESSAGES MODULE
// =====================================================

// =====================
// REVIEWS (AI)
// =====================
function renderReviews() {
  const validRatings = reviews.filter(r => r.rating);
  const avgRating = validRatings.length ? (validRatings.reduce((s,r) => s + r.rating, 0) / validRatings.length).toFixed(1) : '-';
  const pending = reviews.filter(r => !r.replied).length;
  const unverified = reviews.filter(r => r.status === 'unverified').length;
  const aiEnabled = automationSettings.reviewReplies;
  
  // Tab state
  const activeTab = window.reviewsActiveTab || 'all';
  
  // Filter reviews based on tab
  let filteredReviews = reviews;
  if (activeTab === 'unverified') {
    filteredReviews = reviews.filter(r => r.status === 'unverified');
  } else if (activeTab === 'pending') {
    filteredReviews = reviews.filter(r => !r.replied);
  }
  
  // If no reviews, show setup info
  if (reviews.length === 0) {
    return `
      <div style="max-width:700px;margin:40px auto">
        <div class="card" style="text-align:center;padding:48px 32px">
          <div style="font-size:64px;margin-bottom:20px">‚≠ê</div>
          <div style="font-size:22px;font-weight:700;margin-bottom:12px">Bewertungen importieren</div>
          <div style="color:#a1a1aa;margin-bottom:32px;line-height:1.6">
            Importiere deine Airbnb-Bewertungen automatisch per E-Mail-Weiterleitung.<br>
            Sobald du eine neue Bewertung erh√§ltst, wird sie hier angezeigt.
          </div>
          <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="showEmailSetupModal()">üìß E-Mail-Import einrichten</button>
            <button class="btn btn-secondary" onclick="showAddReviewModal()">‚ûï Manuell hinzuf√ºgen</button>
          </div>
        </div>
        
        <div class="card" style="margin-top:20px">
          <div class="card-title">üìã So funktioniert der E-Mail-Import</div>
          <div style="display:flex;flex-direction:column;gap:16px">
            <div style="display:flex;gap:12px;align-items:flex-start">
              <div style="background:#f97316;color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0">1</div>
              <div><div style="font-weight:600">E-Mail-Adresse kopieren</div><div style="font-size:13px;color:#a1a1aa">Klicke auf "E-Mail-Import einrichten" um deine pers√∂nliche Weiterleitungsadresse zu erhalten.</div></div>
            </div>
            <div style="display:flex;gap:12px;align-items:flex-start">
              <div style="background:#f97316;color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0">2</div>
              <div><div style="font-weight:600">Airbnb-Benachrichtigungen weiterleiten</div><div style="font-size:13px;color:#a1a1aa">Richte in deinem E-Mail-Programm eine automatische Weiterleitung f√ºr Airbnb-Mails ein.</div></div>
            </div>
            <div style="display:flex;gap:12px;align-items:flex-start">
              <div style="background:#f97316;color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0">3</div>
              <div><div style="font-weight:600">Bewertungen automatisch erhalten</div><div style="font-size:13px;color:#a1a1aa">Neue Bewertungen erscheinen automatisch hier - mit KI-Antwortvorschl√§gen!</div></div>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  
  return `
    <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:24px">
      <div class="stat-card">
        <div class="stat-value" style="color:#fbbf24">${avgRating}</div>
        <div class="stat-label">‚≠ê Durchschnitt</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${reviews.length}</div>
        <div class="stat-label">Bewertungen</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color:#f97316">${unverified}</div>
        <div class="stat-label">üìß Ungepr√ºft</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color:#8b5cf6">${pending}</div>
        <div class="stat-label">üß† Ohne Antwort</div>
      </div>
    </div>
    
    <!-- Action Bar -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">
      <div style="display:flex;gap:8px">
        <button class="btn btn-sm ${activeTab === 'all' ? 'btn-primary' : 'btn-secondary'}" onclick="setReviewsTab('all')">Alle (${reviews.length})</button>
        <button class="btn btn-sm ${activeTab === 'unverified' ? 'btn-primary' : 'btn-secondary'}" onclick="setReviewsTab('unverified')">${unverified > 0 ? 'üî¥ ' : ''}Ungepr√ºft (${unverified})</button>
        <button class="btn btn-sm ${activeTab === 'pending' ? 'btn-primary' : 'btn-secondary'}" onclick="setReviewsTab('pending')">Ohne Antwort (${pending})</button>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-sm btn-secondary" onclick="showEmailSetupModal()">üìß Import-Setup</button>
        <button class="btn btn-sm btn-secondary" onclick="showAddReviewModal()">‚ûï Manuell</button>
        ${pending > 0 && aiEnabled ? '<button class="btn btn-sm btn-ai" onclick="generateAllAiSuggestions()">‚ú® Alle KI-Antworten</button>' : ''}
      </div>
    </div>
    
    <!-- Unverified hint -->
    ${unverified > 0 ? `
      <div class="card" style="background:#f9731610;border-color:#f9731650;margin-bottom:20px">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-size:24px">üìß</div>
          <div style="flex:1">
            <div style="font-weight:600">${unverified} neue Bewertung${unverified > 1 ? 'en' : ''} aus E-Mail-Import</div>
            <div style="font-size:12px;color:#a1a1aa">Bitte √ºberpr√ºfe die extrahierten Daten und best√§tige sie.</div>
          </div>
          <button class="btn btn-sm btn-primary" onclick="setReviewsTab('unverified')">Jetzt pr√ºfen</button>
        </div>
      </div>
    ` : ''}
    
    <!-- Reviews List -->
    ${filteredReviews.map(r => {
      const isUnverified = r.status === 'unverified';
      const confidencePercent = Math.round((r.confidence || 0) * 100);
      const confidenceColor = confidencePercent >= 70 ? '#22c55e' : confidencePercent >= 40 ? '#f97316' : '#ef4444';
      const displayRating = r.rating || 0;
      
      return `
        <div class="review-card" style="${isUnverified ? 'border-left:3px solid #f97316' : ''}">
          <!-- Unverified Banner -->
          ${isUnverified ? `
            <div style="background:#f9731620;padding:8px 12px;margin:-20px -20px 16px -20px;border-radius:14px 14px 0 0;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                <span style="font-size:12px;font-weight:600;color:#f97316">üìß Aus E-Mail importiert</span>
                <span style="font-size:11px;color:#a1a1aa">Konfidenz: <span style="color:${confidenceColor}">${confidencePercent}%</span></span>
                ${r.parsing_strategy ? `<span style="font-size:10px;color:#71717a;background:#27272a;padding:2px 6px;border-radius:4px">${r.parsing_strategy}</span>` : ''}
              </div>
              <div style="display:flex;gap:6px">
                <button class="btn btn-sm" style="background:#22c55e;color:#fff;padding:4px 10px;font-size:11px" onclick="confirmReview('${r.id}')">‚úì Best√§tigen</button>
                <button class="btn btn-sm btn-secondary" style="padding:4px 10px;font-size:11px" onclick="editReviewData('${r.id}')">‚úèÔ∏è Bearbeiten</button>
              </div>
            </div>
          ` : ''}
          
          <!-- Header -->
          <div class="review-header">
            <div class="review-avatar">${r.guest ? r.guest.split(' ').map(n => n[0]).join('') : '?'}</div>
            <div class="review-info">
              <div class="review-name">${r.guest || r.guest_name || '<span style="color:#71717a">Unbekannter Gast</span>'}</div>
              <div class="review-meta">
                ${r.property || r.airbnb_listing_name || `<span style="color:#f97316;cursor:pointer" onclick="assignProperty('${r.id}')">+ Objekt zuweisen</span>`}
                ¬∑ ${r.date || (r.review_date ? new Date(r.review_date).toLocaleDateString('de-DE') : 'Datum unbekannt')}
                ${r.platform ? `¬∑ <span class="tag tag-${r.platform === 'airbnb' || r.platform === 'airbnb_email' ? 'red' : 'blue'}" style="font-size:9px">${r.platform === 'airbnb_email' ? 'Airbnb' : r.platform}</span>` : ''}
              </div>
            </div>
            <div class="review-stars">
              ${displayRating > 0 ? '‚òÖ'.repeat(displayRating) + '‚òÜ'.repeat(5 - displayRating) : '<span style="color:#71717a;font-size:12px">Keine Sterne</span>'}
            </div>
          </div>
          
          <!-- Review Text -->
          <div class="review-text">${r.text || r.review_text || ''}</div>
          
          <!-- Airbnb Link if available -->
          ${r.airbnb_review_url ? `<div style="margin-top:8px"><a href="${r.airbnb_review_url}" target="_blank" style="font-size:12px;color:#f97316">üîó In Airbnb √∂ffnen</a></div>` : ''}
          
          <!-- Reply Section -->
          ${r.replied ? `
            <div class="review-reply">
              <div class="review-reply-label">‚úì Deine Antwort:</div>
              <div style="font-size:14px">${r.reply || r.user_reply_text || ''}</div>
            </div>
          ` : (aiEnabled ? `
            <div class="ai-suggestion">
              <div class="ai-suggestion-header">üß† KI-Antwortvorschlag</div>
              <div class="ai-suggestion-text">${r.aiSuggestion || r.ai_reply_text || 'Klicke auf "Generieren" um einen KI-Vorschlag zu erhalten'}</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
                ${r.aiSuggestion || r.ai_reply_text ? `<button class="btn btn-ai btn-sm" onclick="useAiReplyWithCopy('${r.id}')">üìã Kopieren & Verwenden</button>` : ''}
                <button class="btn btn-secondary btn-sm" onclick="regenAiReply('${r.id}')">${r.aiSuggestion || r.ai_reply_text ? 'üîÑ Neu' : '‚ú® Generieren'}</button>
                <button class="btn btn-secondary btn-sm" onclick="editReply('${r.id}')">‚úèÔ∏è Manuell</button>
                <button class="btn btn-sm" style="background:linear-gradient(135deg,#ff5a5f,#ff8c8c);color:#fff" onclick="openAirbnbToReply('${r.id}')">
                  <span style="margin-right:4px">üè†</span> Auf Airbnb antworten
                </button>
              </div>
            </div>
          ` : `
            <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-secondary btn-sm" onclick="editReply('${r.id}')">‚úèÔ∏è Antwort schreiben</button>
              <button class="btn btn-sm" style="background:linear-gradient(135deg,#ff5a5f,#ff8c8c);color:#fff" onclick="openAirbnbToReply('${r.id}')">
                <span style="margin-right:4px">üè†</span> Auf Airbnb antworten
              </button>
            </div>
          `)}
        </div>
      `;
    }).join('')}
  `;
}

// Enhanced useAiReply with clipboard
function useAiReplyWithCopy(id) {
  const review = reviews.find(r => String(r.id) === String(id));
  if (!review) return;
  
  const replyText = review.aiSuggestion || review.ai_reply_text;
  if (!replyText) {
    showToast('‚ö†Ô∏è Kein KI-Vorschlag vorhanden');
    return;
  }
  
  // Copy to clipboard
  navigator.clipboard.writeText(replyText).then(() => {
    review.replied = true;
    review.reply = replyText;
    review.user_reply_text = replyText;
    review.replied_at = new Date().toISOString();
    
    showToast('‚úÖ Antwort in Zwischenablage kopiert!');
    
    // Show option to open Airbnb
    if (review.airbnb_review_url) {
      setTimeout(() => {
        if (confirm('Antwort kopiert! M√∂chtest du Airbnb √∂ffnen um die Antwort einzuf√ºgen?')) {
          window.open(review.airbnb_review_url, '_blank');
        }
      }, 500);
    }
    
    renderPage();
  }).catch(() => {
    // Fallback for older browsers
    const textarea = document.createElement('textarea');
    textarea.value = replyText;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    
    review.replied = true;
    review.reply = replyText;
    showToast('‚úÖ Antwort kopiert!');
    renderPage();
  });
}

// Open Airbnb to reply - copies text first, then opens Airbnb
function openAirbnbToReply(id) {
  const review = reviews.find(r => String(r.id) === String(id));
  if (!review) return;
  
  const replyText = review.aiSuggestion || review.ai_reply_text || '';
  
  // Determine the best Airbnb URL
  let airbnbUrl;
  if (review.airbnb_review_url) {
    // Direct link to specific review
    airbnbUrl = review.airbnb_review_url;
  } else {
    // Fallback to general reviews page
    airbnbUrl = 'https://www.airbnb.com/hosting/reviews';
  }
  
  // If we have a reply text, copy it first
  if (replyText) {
    navigator.clipboard.writeText(replyText).then(() => {
      showToast('‚úÖ Antwort kopiert! Airbnb √∂ffnet sich...');
      
      // Mark as in-progress
      review.replied = true;
      review.reply = replyText;
      review.replied_at = new Date().toISOString();
      renderPage();
      
      // Open Airbnb after short delay
      setTimeout(() => {
        window.open(airbnbUrl, '_blank');
      }, 800);
      
    }).catch(() => {
      // Fallback copy
      const textarea = document.createElement('textarea');
      textarea.value = replyText;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      
      showToast('‚úÖ Antwort kopiert!');
      window.open(airbnbUrl, '_blank');
    });
  } else {
    // No reply text yet - show modal to generate or write one first
    showModal(`
      <div class="modal-title">üè† Auf Airbnb antworten</div>
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:48px;margin-bottom:16px">‚úçÔ∏è</div>
        <div style="color:#a1a1aa;margin-bottom:24px;line-height:1.6">
          Du hast noch keine Antwort vorbereitet.<br>
          M√∂chtest du zuerst eine KI-Antwort generieren?
        </div>
        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
          <button class="btn btn-ai" onclick="hideModal();regenAiReply('${id}')">
            ‚ú® KI-Antwort generieren
          </button>
          <button class="btn btn-secondary" onclick="hideModal();window.open('${airbnbUrl}','_blank')">
            Trotzdem √∂ffnen ‚Üí
          </button>
        </div>
      </div>
    `);
  }
}

// Quick reply workflow: Generate AI reply and open Airbnb in one click
async function quickReplyToAirbnb(id) {
  const review = reviews.find(r => String(r.id) === String(id));
  if (!review) return;
  
  showToast('ü§ñ Generiere Antwort...');
  
  // Generate AI reply first
  await regenAiReply(id);
  
  // Wait for generation, then trigger Airbnb open
  setTimeout(() => {
    openAirbnbToReply(id);
  }, 2000);
}

function useAiReply(id) {
  const review = reviews.find(r => r.id === id);
  if (review) {
    review.replied = true;
    review.reply = review.aiSuggestion;
    showToast('‚úÖ Antwort ver√∂ffentlicht!');
    renderPage();
  }
}

async function regenAiReply(id) {
  const review = reviews.find(r => r.id === id);
  if (!review) return;
  
  // Show loading state
  review.aiSuggestion = 'ü§ñ Generiere neue Antwort...';
  renderPage();
  
  try {
    const session = await db.auth.getSession();
    const token = session?.data?.session?.access_token || '';
    
    const response = await fetch(AI_PROXY_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({
        action: 'review-reply',
        data: {
          guestName: review.guest,
          rating: review.rating,
          reviewText: review.text,
          propertyName: review.property
        }
      })
    });
    
    if (!response.ok) throw new Error('AI request failed');
    
    const data = await response.json();
    review.aiSuggestion = data.reply || 'Fehler bei der Generierung';
    
    showToast('‚úÖ Neue Antwort generiert!');
    
  } catch (error) {
    console.error('AI Review Reply Error:', error);
    // Fallback
    const alternatives = [
      'Herzlichen Dank f√ºr Ihre tolle Bewertung! Es freut mich sehr, dass Sie zufrieden waren. Ich hoffe, Sie bald wieder begr√º√üen zu d√ºrfen!',
      'Wow, vielen Dank f√ºr das gro√üartige Feedback! G√§ste wie Sie machen die Vermietung zu einer Freude. Bis zum n√§chsten Mal! üôè',
      'Danke f√ºr die lieben Worte! Es war mir eine Freude, Sie als Gast zu haben. Kommen Sie gerne wieder!'
    ];
    review.aiSuggestion = alternatives[Math.floor(Math.random() * alternatives.length)];
    showToast('‚ö†Ô∏è Fallback-Antwort verwendet');
  }
  
  renderPage();
}

// Generate AI suggestions for all unanswered reviews
async function generateAllAiSuggestions() {
  const unanswered = reviews.filter(r => !r.replied);
  if (unanswered.length === 0) {
    showToast('‚úÖ Alle Bewertungen sind bereits beantwortet!');
    return;
  }
  
  showToast(`ü§ñ Generiere ${unanswered.length} Antworten...`);
  
  const session = await db.auth.getSession();
  const token = session?.data?.session?.access_token || '';
  
  for (const review of unanswered) {
    try {
      const response = await fetch(AI_PROXY_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
          action: 'review-reply',
          data: {
            guestName: review.guest,
            rating: review.rating,
            reviewText: review.text,
            propertyName: review.property
          }
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        review.aiSuggestion = data.reply;
      }
    } catch (error) {
      console.error('Error generating reply for review', review.id, error);
    }
    
    // Small delay between requests
    await new Promise(resolve => setTimeout(resolve, 500));
  }
  
  showToast('‚úÖ Alle Antworten generiert!');
  renderPage();
}

function editReply(id) {
  const review = reviews.find(r => r.id === id);
  showModal(`
    <div class="modal-title">‚úèÔ∏è Antwort bearbeiten</div>
    <div style="margin-bottom:16px">
      <label class="label">Deine Antwort</label>
      <textarea class="input" id="reply-text" rows="4" style="resize:vertical">${review.aiSuggestion}</textarea>
    </div>
    <div style="display:flex;gap:12px">
      <button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Abbrechen</button>
      <button class="btn btn-primary" onclick="saveReply(${id})" style="flex:1">üíæ Speichern</button>
    </div>
  `);
}

function saveReply(id) {
  const review = reviews.find(r => r.id === id);
  const text = document.getElementById('reply-text').value.trim();
  if (review && text) {
    review.replied = true;
    review.reply = text;
    hideModal();
    renderPage();
  }
}

// Show modal to manually add a review
function showAddReviewModal() {
  const propertyOptions = properties.map(p => 
    `<option value="${p.name}">${p.name}</option>`
  ).join('');
  
  showModal(`
    <div class="modal-title">‚ûï Bewertung hinzuf√ºgen</div>
    <div style="margin-bottom:12px">
      <label class="label">Gast Name</label>
      <input type="text" class="input" id="review-guest" placeholder="z.B. Maria Schmidt">
    </div>
    <div style="margin-bottom:12px">
      <label class="label">Objekt</label>
      <select class="input" id="review-property">
        ${propertyOptions || '<option value="">Kein Objekt</option>'}
      </select>
    </div>
    <div style="margin-bottom:12px">
      <label class="label">Bewertung</label>
      <select class="input" id="review-rating">
        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 Sterne)</option>
        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 Sterne)</option>
        <option value="3">‚≠ê‚≠ê‚≠ê (3 Sterne)</option>
        <option value="2">‚≠ê‚≠ê (2 Sterne)</option>
        <option value="1">‚≠ê (1 Stern)</option>
      </select>
    </div>
    <div style="margin-bottom:12px">
      <label class="label">Bewertungstext</label>
      <textarea class="input" id="review-text" rows="4" placeholder="Text der Bewertung..."></textarea>
    </div>
    <div style="margin-bottom:12px">
      <label class="label">Plattform</label>
      <select class="input" id="review-platform">
        <option value="airbnb">Airbnb</option>
        <option value="booking">Booking.com</option>
        <option value="google">Google</option>
        <option value="direct">Direkt</option>
      </select>
    </div>
    <div style="display:flex;gap:12px">
      <button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Abbrechen</button>
      <button class="btn btn-primary" onclick="addReview()" style="flex:1">‚ûï Hinzuf√ºgen</button>
    </div>
  `);
}

// Add a new review manually
async function addReview() {
  const guest = document.getElementById('review-guest').value.trim();
  const property = document.getElementById('review-property').value;
  const rating = parseInt(document.getElementById('review-rating').value);
  const text = document.getElementById('review-text').value.trim();
  const platform = document.getElementById('review-platform').value;
  
  if (!guest || !text) {
    showToast('‚ö†Ô∏è Bitte Gast und Text eingeben');
    return;
  }
  
  // Create new review
  const newReview = {
    id: Date.now(),
    guest: guest,
    property: property || 'Unbekannt',
    rating: rating,
    text: text,
    platform: platform,
    date: new Date().toLocaleDateString('de-DE'),
    replied: false,
    aiSuggestion: null
  };
  
  // Add to reviews array
  reviews.unshift(newReview);
  
  // Save to Supabase (if reviews table exists)
  try {
    await db.from('reviews').insert({
      host_id: user.id,
      guest_name: guest,
      property_name: property,
      rating: rating,
      review_text: text,
      platform: platform,
      replied: false
    });
  } catch (e) {
    console.log('Could not save review to DB (table may not exist):', e);
  }
  
  hideModal();
  showToast('‚úÖ Bewertung hinzugef√ºgt!');
  renderPage();
  
  // If AI reviews enabled, generate suggestion
  if (automationSettings.reviewReplies) {
    setTimeout(() => regenAiReply(newReview.id), 500);
  }
}

// =====================
// EMAIL IMPORT FUNCTIONS
// =====================

// Set reviews tab filter
function setReviewsTab(tab) {
  window.reviewsActiveTab = tab;
  renderPage();
}

// Confirm an unverified review
async function confirmReview(id) {
  const review = reviews.find(r => String(r.id) === String(id));
  if (!review) return;
  
  review.status = 'confirmed';
  showToast('‚úÖ Bewertung best√§tigt!');
  
  // Save to database if connected
  if (user && db) {
    try {
      await db.from('reviews').update({ status: 'confirmed', updated_at: new Date().toISOString() }).eq('id', id);
    } catch (e) {
      console.error('Failed to update review status:', e);
    }
  }
  
  renderPage();
}

// Edit review data modal
function editReviewData(id) {
  const review = reviews.find(r => String(r.id) === String(id));
  if (!review) return;
  
  const propertyOptions = properties.map(p => {
    const selected = (review.property_id === p.id || review.property === p.name) ? 'selected' : '';
    return `<option value="${p.id}" ${selected}>${p.name}</option>`;
  }).join('');
  
  showModal(`
    <div class="modal-title">‚úèÔ∏è Bewertung bearbeiten</div>
    <div style="background:#27272a;padding:12px;border-radius:8px;margin-bottom:16px;font-size:12px;color:#a1a1aa">
      üìß Importiert mit Konfidenz: ${Math.round((review.confidence || 0) * 100)}%
      ${review.parsing_notes ? '<br>Notizen: ' + review.parsing_notes : ''}
    </div>
    <div style="margin-bottom:12px">
      <label class="label">Gast Name</label>
      <input type="text" class="input" id="edit-guest" value="${review.guest || review.guest_name || ''}" placeholder="Name des Gastes">
    </div>
    <div style="margin-bottom:12px">
      <label class="label">Objekt</label>
      <select class="input" id="edit-property">
        <option value="">-- Objekt ausw√§hlen --</option>
        ${propertyOptions}
      </select>
    </div>
    <div style="margin-bottom:12px">
      <label class="label">Bewertung (Sterne)</label>
      <select class="input" id="edit-rating">
        <option value="">Unbekannt</option>
        <option value="5" ${review.rating === 5 ? 'selected' : ''}>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
        <option value="4" ${review.rating === 4 ? 'selected' : ''}>‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
        <option value="3" ${review.rating === 3 ? 'selected' : ''}>‚≠ê‚≠ê‚≠ê (3)</option>
        <option value="2" ${review.rating === 2 ? 'selected' : ''}>‚≠ê‚≠ê (2)</option>
        <option value="1" ${review.rating === 1 ? 'selected' : ''}>‚≠ê (1)</option>
      </select>
    </div>
    <div style="margin-bottom:12px">
      <label class="label">Datum</label>
      <input type="date" class="input" id="edit-date" value="${review.review_date || ''}">
    </div>
    <div style="margin-bottom:12px">
      <label class="label">Bewertungstext</label>
      <textarea class="input" id="edit-text" rows="4">${review.text || review.review_text || ''}</textarea>
    </div>
    <div style="display:flex;gap:12px">
      <button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Abbrechen</button>
      <button class="btn btn-primary" onclick="saveReviewData('${id}')" style="flex:1">üíæ Speichern & Best√§tigen</button>
    </div>
  `);
}

// Save edited review data
async function saveReviewData(id) {
  const review = reviews.find(r => String(r.id) === String(id));
  if (!review) return;
  
  const guest = document.getElementById('edit-guest').value.trim();
  const propertyId = document.getElementById('edit-property').value;
  const rating = document.getElementById('edit-rating').value;
  const date = document.getElementById('edit-date').value;
  const text = document.getElementById('edit-text').value.trim();
  
  // Update local
  review.guest = guest || review.guest;
  review.guest_name = guest || review.guest_name;
  if (propertyId) {
    review.property_id = propertyId;
    const prop = properties.find(p => p.id === propertyId);
    if (prop) review.property = prop.name;
  }
  review.rating = rating ? parseInt(rating) : review.rating;
  review.review_date = date || review.review_date;
  review.text = text || review.text;
  review.review_text = text || review.review_text;
  review.status = 'manual';
  
  // Save to database
  if (user && db) {
    try {
      await db.from('reviews').update({
        guest_name: review.guest_name,
        property_id: review.property_id,
        rating: review.rating,
        review_date: review.review_date,
        review_text: review.review_text,
        status: 'manual',
        updated_at: new Date().toISOString()
      }).eq('id', id);
    } catch (e) {
      console.error('Failed to save review:', e);
    }
  }
  
  hideModal();
  showToast('‚úÖ Bewertung gespeichert!');
  renderPage();
}

// Assign property to review
function assignProperty(id) {
  editReviewData(id);
}

// Show email setup modal
function showEmailSetupModal() {
  // Generate or get forwarding email based on user
  let forwardingEmail = localStorage.getItem('pilotstay_forwarding_email');
  let userToken = localStorage.getItem('pilotstay_forwarding_token');
  
  if (!forwardingEmail || !userToken) {
    userToken = Math.random().toString(36).substr(2, 12) + Math.random().toString(36).substr(2, 12);
    forwardingEmail = 'review-' + userToken.substr(0, 8) + '@reviews.pilotstay.app';
    localStorage.setItem('pilotstay_forwarding_email', forwardingEmail);
    localStorage.setItem('pilotstay_forwarding_token', userToken);
    
    // Save to database if logged in
    if (user && db) {
      saveUserEmailConfig(forwardingEmail, userToken);
    }
  }
  
  showModal(`
    <div class="modal-title">üìß E-Mail-Import einrichten</div>
    
    <div style="background:linear-gradient(135deg,#131316,#1a1a2e);border:1px solid #8b5cf650;border-radius:12px;padding:20px;margin-bottom:20px">
      <div style="font-size:12px;color:#a1a1aa;margin-bottom:8px">Deine pers√∂nliche Weiterleitungsadresse:</div>
      <div style="display:flex;gap:8px;align-items:center">
        <input type="text" class="input" id="forwarding-email" value="${forwardingEmail}" readonly style="flex:1;font-family:monospace;font-size:13px">
        <button class="btn btn-primary" onclick="copyForwardingEmail()">üìã Kopieren</button>
      </div>
      <div style="font-size:11px;color:#71717a;margin-top:8px">
        üîí Diese Adresse ist nur f√ºr dich - Bewertungen werden automatisch deinem Account zugeordnet.
      </div>
    </div>
    
    <!-- Confirmation Status -->
    <div id="confirmation-status" style="background:#27272a;border-radius:8px;padding:16px;margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <span style="font-size:16px">üîÑ</span>
        <span style="font-weight:600">Weiterleitungs-Status</span>
        <button class="btn btn-sm btn-secondary" onclick="checkConfirmationStatus()" style="margin-left:auto;padding:4px 8px;font-size:11px">Aktualisieren</button>
      </div>
      <div id="confirmation-details" style="font-size:13px;color:#a1a1aa">
        Wird geladen...
      </div>
    </div>
    
    <div style="margin-bottom:20px">
      <div style="font-weight:600;margin-bottom:12px">üìã Einrichtung in 3 Schritten:</div>
      
      <div style="background:#27272a;border-radius:8px;padding:16px;margin-bottom:12px">
        <div style="font-weight:600;margin-bottom:8px">1Ô∏è‚É£ Gmail Weiterleitung</div>
        <div style="font-size:13px;color:#a1a1aa;line-height:1.5">
          ‚Ä¢ √ñffne Gmail ‚Üí Einstellungen ‚Üí "Weiterleitung und POP/IMAP"<br>
          ‚Ä¢ Klicke "Weiterleitungsadresse hinzuf√ºgen"<br>
          ‚Ä¢ F√ºge deine PilotStay-Adresse ein<br>
          ‚Ä¢ <strong style="color:#22c55e">‚ú® Best√§tigung erfolgt automatisch!</strong><br>
          ‚Ä¢ Erstelle einen Filter: von "airbnb" ‚Üí weiterleiten
        </div>
      </div>
      
      <div style="background:#27272a;border-radius:8px;padding:16px;margin-bottom:12px">
        <div style="font-weight:600;margin-bottom:8px">2Ô∏è‚É£ Outlook/Mail Weiterleitung</div>
        <div style="font-size:13px;color:#a1a1aa;line-height:1.5">
          ‚Ä¢ Einstellungen ‚Üí Regeln ‚Üí Neue Regel<br>
          ‚Ä¢ Bedingung: Absender enth√§lt "airbnb"<br>
          ‚Ä¢ Aktion: Weiterleiten an PilotStay-Adresse
        </div>
      </div>
      
      <div style="background:#27272a;border-radius:8px;padding:16px">
        <div style="font-weight:600;margin-bottom:8px">3Ô∏è‚É£ Test senden</div>
        <div style="font-size:13px;color:#a1a1aa;line-height:1.5">
          Leite eine bestehende Airbnb-Bewertungs-E-Mail weiter um zu testen.
        </div>
      </div>
    </div>
    
    <div style="display:flex;gap:12px">
      <button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Schlie√üen</button>
      <button class="btn btn-primary" onclick="testEmailImport()" style="flex:1">üß™ Test-Import</button>
    </div>
  `);
  
  // Load confirmation status
  setTimeout(checkConfirmationStatus, 500);
}

// Save user email config to database
async function saveUserEmailConfig(email, token) {
  if (!user || !db) return;
  
  try {
    // Check if config exists
    const { data: existing } = await db
      .from('user_email_configs')
      .select('id')
      .eq('user_id', user.id)
      .single();
    
    if (existing) {
      await db.from('user_email_configs').update({
        forwarding_email: email,
        forwarding_token: token,
        updated_at: new Date().toISOString()
      }).eq('user_id', user.id);
    } else {
      await db.from('user_email_configs').insert({
        user_id: user.id,
        forwarding_email: email,
        forwarding_token: token
      });
    }
    console.log('Email config saved');
  } catch (e) {
    console.log('Could not save email config:', e);
  }
}

// Check confirmation status
async function checkConfirmationStatus() {
  const detailsEl = document.getElementById('confirmation-details');
  if (!detailsEl) return;
  
  detailsEl.innerHTML = '<span style="color:#71717a">üîÑ Pr√ºfe Status...</span>';
  
  if (!user || !db) {
    detailsEl.innerHTML = '<span style="color:#f97316">‚ö†Ô∏è Bitte einloggen um Status zu sehen</span>';
    return;
  }
  
  try {
    // Check for recent confirmations
    const { data: confirmations, error } = await db
      .from('email_confirmations')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(5);
    
    if (error) throw error;
    
    if (!confirmations || confirmations.length === 0) {
      detailsEl.innerHTML = `
        <div style="color:#71717a">Noch keine Weiterleitungen eingerichtet.</div>
        <div style="margin-top:8px;font-size:12px">Sobald du eine Weiterleitung bei Gmail/Outlook einrichtest, wird der Status hier angezeigt.</div>
      `;
      return;
    }
    
    // Show recent confirmations
    let html = '<div style="display:flex;flex-direction:column;gap:8px">';
    
    for (const conf of confirmations) {
      const date = new Date(conf.created_at).toLocaleString('de-DE');
      const provider = conf.email_from?.includes('google') ? 'Gmail' : 
                       conf.email_from?.includes('outlook') ? 'Outlook' : 
                       conf.email_from?.includes('gmx') ? 'GMX' : 'E-Mail';
      
      if (conf.link_clicked) {
        html += `
          <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#22c55e20;border-radius:6px">
            <span style="color:#22c55e">‚úÖ</span>
            <div>
              <div style="color:#22c55e;font-weight:500">${provider} Weiterleitung best√§tigt</div>
              <div style="font-size:11px;color:#71717a">${date}</div>
            </div>
          </div>
        `;
      } else if (conf.confirmation_code) {
        html += `
          <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#f9731620;border-radius:6px">
            <span style="color:#f97316">üîë</span>
            <div>
              <div style="color:#f97316;font-weight:500">Best√§tigungscode: <code style="background:#27272a;padding:2px 6px;border-radius:4px">${conf.confirmation_code}</code></div>
              <div style="font-size:11px;color:#71717a">${provider} - ${date}</div>
            </div>
          </div>
        `;
      } else {
        html += `
          <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#ef444420;border-radius:6px">
            <span style="color:#ef4444">‚è≥</span>
            <div>
              <div style="color:#ef4444;font-weight:500">${provider} - Manuelle Best√§tigung n√∂tig</div>
              <div style="font-size:11px;color:#71717a">${date}</div>
            </div>
          </div>
        `;
      }
    }
    
    html += '</div>';
    detailsEl.innerHTML = html;
    
  } catch (e) {
    console.error('Error checking confirmation status:', e);
    detailsEl.innerHTML = '<span style="color:#71717a">Status konnte nicht geladen werden</span>';
  }
}

// Copy forwarding email
function copyForwardingEmail() {
  const input = document.getElementById('forwarding-email');
  input.select();
  document.execCommand('copy');
  showToast('‚úÖ E-Mail-Adresse kopiert!');
}

// Test email import with sample data
async function testEmailImport() {
  showToast('üß™ Importiere Test-Bewertung...');
  hideModal();
  
  // Create a test review locally
  const testReview = {
    id: 'test_' + Date.now(),
    guest: 'Maria Testgast',
    guest_name: 'Maria Testgast',
    property: properties.length > 0 ? properties[0].name : 'Test-Apartment',
    property_id: properties.length > 0 ? properties[0].id : null,
    rating: 5,
    text: 'Wundersch√∂ne Unterkunft! Alles war super sauber und der Gastgeber hat uns sehr herzlich empfangen. Die Lage ist perfekt - direkt in der Innenstadt mit vielen Restaurants und Caf√©s in der N√§he. Wir kommen definitiv wieder!',
    review_text: 'Wundersch√∂ne Unterkunft! Alles war super sauber...',
    platform: 'airbnb_email',
    date: new Date().toLocaleDateString('de-DE'),
    review_date: new Date().toISOString().split('T')[0],
    status: 'unverified',
    confidence: 0.85,
    parsing_strategy: 'test_import',
    parsing_notes: 'Test-Import zur Demonstration',
    airbnb_listing_name: properties.length > 0 ? properties[0].name : null,
    replied: false,
    aiSuggestion: null
  };
  
  reviews.unshift(testReview);
  
  setTimeout(() => {
    showToast('‚úÖ Test-Bewertung importiert! Bitte √ºberpr√ºfen.');
    window.reviewsActiveTab = 'unverified';
    renderPage();
  }, 1000);
}

// Load reviews from database (including email-imported ones)
async function loadReviewsFromDB() {
  if (!user || !db) return;
  
  try {
    const { data, error } = await db
      .from('reviews')
      .select('*')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false });
    
    if (error) {
      console.error('Error loading reviews:', error);
      return;
    }
    
    if (data && data.length > 0) {
      // Merge with existing reviews
      data.forEach(dbReview => {
        const exists = reviews.find(r => r.id === dbReview.id);
        if (!exists) {
          reviews.push({
            id: dbReview.id,
            guest: dbReview.guest_name,
            guest_name: dbReview.guest_name,
            property: dbReview.property_id ? (properties.find(p => p.id === dbReview.property_id)?.name || 'Unbekannt') : dbReview.airbnb_listing_name,
            property_id: dbReview.property_id,
            rating: dbReview.rating,
            text: dbReview.review_text,
            review_text: dbReview.review_text,
            platform: dbReview.platform,
            date: dbReview.review_date ? new Date(dbReview.review_date).toLocaleDateString('de-DE') : null,
            review_date: dbReview.review_date,
            status: dbReview.status,
            confidence: dbReview.confidence,
            parsing_strategy: dbReview.parsing_strategy,
            parsing_notes: dbReview.parsing_notes,
            airbnb_listing_name: dbReview.airbnb_listing_name,
            airbnb_review_url: dbReview.airbnb_review_url,
            replied: !!dbReview.replied_at,
            reply: dbReview.user_reply_text,
            aiSuggestion: dbReview.ai_reply_text,
            ai_reply_text: dbReview.ai_reply_text
          });
        }
      });
      
      console.log(`Loaded ${data.length} reviews from database`);
    }
  } catch (e) {
    console.error('Error in loadReviewsFromDB:', e);
  }
}

// =====================
// PRICING (AI)
// =====================
function renderPricing() {
  const dayNames = ['So','Mo','Di','Mi','Do','Fr','Sa'];
  const aiEnabled = automationSettings.autoPricing;
  
  // Check if there are any properties
  if (pricingData.properties.length === 0) {
    return `
      <div class="empty-state" style="padding:60px 20px">
        <div class="empty-icon">üí∞</div>
        <div class="empty-title">Keine Objekte f√ºr Preisoptimierung</div>
        <div class="empty-desc" style="margin-bottom:20px">
          ${properties.length === 0 
            ? 'F√ºge zuerst Objekte hinzu oder verbinde Smoobu um die Preisoptimierung zu nutzen.' 
            : 'Synchronisiere deine Smoobu-Daten um Preise zu optimieren.'}
        </div>
        <div style="display:flex;gap:12px;justify-content:center">
          ${properties.length === 0 
            ? '<button class="btn btn-primary" onclick="setPage(\'properties\')">üè† Objekte hinzuf√ºgen</button>'
            : '<button class="btn btn-primary" onclick="setPage(\'automation\')">üîÑ Smoobu verbinden</button>'}
        </div>
      </div>
    `;
  }
  
  // Count events found
  const eventCount = pricingData.events?.length || 0;
  
  return `
    ${!aiEnabled ? `
      <div class="card" style="background:#f9731610;border-color:#f9731650;margin-bottom:20px">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-size:24px">‚ö†Ô∏è</div>
          <div style="flex:1">
            <div style="font-weight:600">Auto-Pricing deaktiviert</div>
            <div style="font-size:12px;color:#a1a1aa">Preise werden nicht automatisch optimiert</div>
          </div>
          <button class="btn btn-sm btn-primary" onclick="toggleAutomation('autoPricing');setPage('pricing')">Aktivieren</button>
        </div>
      </div>
    ` : `
      <div class="card card-ai" style="margin-bottom:24px">
        <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap">
          <div style="font-size:48px">üß†</div>
          <div style="flex:1;min-width:200px">
            <div style="font-weight:700;font-size:18px;margin-bottom:4px">KI-Preisoptimierung aktiv</div>
            <div style="color:#a1a1aa;font-size:13px">Tagesbasierte Preise mit Event-Erkennung</div>
          </div>
          <div style="display:flex;gap:16px;flex-wrap:wrap">
            <div style="text-align:center;padding:8px 16px;background:#22c55e15;border-radius:8px">
              <div style="font-size:20px;font-weight:700;color:#22c55e">${eventCount}</div>
              <div style="font-size:10px;color:#71717a">Events erkannt</div>
            </div>
            <div style="text-align:center;padding:8px 16px;background:#8b5cf615;border-radius:8px">
              <div style="font-size:20px;font-weight:700;color:#8b5cf6">60</div>
              <div style="font-size:10px;color:#71717a">Tage optimiert</div>
            </div>
          </div>
        </div>
      </div>
    `}
    
    ${pricingData.properties.map(prop => {
      const dailyPrices = pricingData.dailyPrices[prop.id] || [];
      const next30Days = dailyPrices.slice(0, 30);
      const avgChange = next30Days.length ? Math.round(next30Days.reduce((s, d) => s + d.changePercent, 0) / next30Days.length) : 0;
      const eventsInPeriod = next30Days.filter(d => d.events.length > 0).length;
      const notApplied = next30Days.filter(d => !d.applied && !d.isBooked).length;
      
      return `
        <div class="pricing-card" style="margin-bottom:24px">
          <div class="pricing-header" style="margin-bottom:16px">
            <div>
              <div class="pricing-property">${prop.name}</div>
              <div style="font-size:12px;color:#71717a">${prop.city || 'Keine Stadt'} ¬∑ Basispreis: ‚Ç¨${prop.basePrice}/Nacht</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:12px;color:#71717a">Durchschn. Anpassung</div>
              <div style="font-size:24px;font-weight:700;color:${avgChange >= 0 ? '#22c55e' : '#ef4444'}">${avgChange >= 0 ? '+' : ''}${avgChange}%</div>
            </div>
          </div>
          
          <!-- Stats Row -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px">
            <div style="background:#18181b;padding:12px;border-radius:8px;text-align:center">
              <div style="font-size:18px;font-weight:700">${prop.occupancy}%</div>
              <div style="font-size:10px;color:#71717a">Auslastung</div>
            </div>
            <div style="background:#18181b;padding:12px;border-radius:8px;text-align:center">
              <div style="font-size:18px;font-weight:700;color:#f97316">${eventsInPeriod}</div>
              <div style="font-size:10px;color:#71717a">Event-Tage</div>
            </div>
            <div style="background:#18181b;padding:12px;border-radius:8px;text-align:center">
              <div style="font-size:18px;font-weight:700;color:#8b5cf6">${notApplied}</div>
              <div style="font-size:10px;color:#71717a">Zu √ºbertragen</div>
            </div>
            <div style="background:#18181b;padding:12px;border-radius:8px;text-align:center">
              ${notApplied > 0 ? `
                <button class="btn btn-sm btn-primary" onclick="applyAllDailyPrices('${prop.id}')" style="width:100%" ${!smoobuConfig.connected ? 'disabled' : ''}>
                  ‚úì Alle √ºbernehmen
                </button>
              ` : `
                <button class="btn btn-sm btn-secondary" style="width:100%;cursor:default" disabled>
                  ‚úÖ Alle synchronisiert
                </button>
              `}
            </div>
          </div>
          
          <!-- Calendar Header -->
          <div style="font-size:13px;font-weight:600;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
            <span>üìÖ Preiskalender (n√§chste 30 Tage)</span>
            <span style="font-size:11px;color:#71717a">Klicke auf einen Tag f√ºr Details</span>
          </div>
          
          <!-- Calendar Grid -->
          <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:16px">
            ${['Mo','Di','Mi','Do','Fr','Sa','So'].map(d => `
              <div style="text-align:center;font-size:10px;color:#71717a;padding:4px">${d}</div>
            `).join('')}
            
            ${(() => {
              // Find first day offset
              const firstDate = next30Days[0] ? new Date(next30Days[0].date) : new Date();
              let startDay = firstDate.getDay();
              startDay = startDay === 0 ? 6 : startDay - 1; // Convert to Monday-start
              
              let html = '';
              // Add empty cells for offset
              for (let i = 0; i < startDay; i++) {
                html += '<div></div>';
              }
              
              // Add day cells
              next30Days.forEach((day, idx) => {
                const date = new Date(day.date);
                const dayNum = date.getDate();
                const hasEvent = day.events.length > 0;
                const isHoliday = day.factors.some(f => f.type === 'holiday');
                const isWeekend = day.dayOfWeek === 0 || day.dayOfWeek === 5 || day.dayOfWeek === 6;
                
                let bgColor = '#18181b';
                let borderColor = 'transparent';
                
                if (day.isBooked) {
                  bgColor = '#27272a';
                  borderColor = '#3f3f46';
                } else if (hasEvent) {
                  bgColor = '#f9731620';
                  borderColor = '#f97316';
                } else if (isHoliday) {
                  bgColor = '#8b5cf620';
                  borderColor = '#8b5cf6';
                } else if (day.changePercent > 10) {
                  bgColor = '#22c55e15';
                } else if (day.changePercent < -3) {
                  bgColor = '#ef444415';
                }
                
                html += `
                  <div onclick="showDayPriceDetail('${prop.id}', '${day.date}')" 
                       style="background:${bgColor};border:2px solid ${borderColor};border-radius:8px;padding:6px;text-align:center;cursor:pointer;transition:all .2s;${day.applied ? 'opacity:0.6' : ''}"
                       onmouseover="this.style.transform='scale(1.05)'" 
                       onmouseout="this.style.transform='scale(1)'">
                    <div style="font-size:11px;color:#a1a1aa">${dayNum}</div>
                    <div style="font-size:13px;font-weight:700;color:${day.changePercent > 0 ? '#22c55e' : day.changePercent < 0 ? '#ef4444' : '#fafafa'}">‚Ç¨${day.finalPrice}</div>
                    ${hasEvent ? '<div style="font-size:8px">üé≠</div>' : ''}
                    ${isHoliday ? '<div style="font-size:8px">üéâ</div>' : ''}
                    ${day.isBooked ? '<div style="font-size:8px">üîí</div>' : ''}
                    ${day.applied ? '<div style="font-size:8px">‚úì</div>' : ''}
                  </div>
                `;
              });
              
              return html;
            })()}
          </div>
          
          <!-- Legend -->
          <div style="display:flex;gap:16px;flex-wrap:wrap;font-size:11px;color:#71717a;padding:12px;background:#18181b;border-radius:8px">
            <span>üé≠ Event</span>
            <span>üéâ Feiertag</span>
            <span>üîí Gebucht</span>
            <span>‚úì √úbertragen</span>
            <span style="color:#22c55e">‚ñ† Erh√∂ht</span>
            <span style="color:#ef4444">‚ñ† Reduziert</span>
          </div>
        </div>
      `;
    }).join('')}
    
    <!-- Events Found Section -->
    ${pricingData.events.length > 0 ? `
      <div class="card">
        <div class="card-title">üé≠ Erkannte Events in deiner Region</div>
        <div style="max-height:300px;overflow-y:auto">
          ${pricingData.events.slice(0, 10).map(event => `
            <div class="list-item" style="margin-bottom:8px">
              <div class="list-icon">üé´</div>
              <div class="list-info">
                <div class="list-title">${event.name}</div>
                <div class="list-subtitle">
                  ${event.dates?.start?.localDate || ''} ¬∑ ${event._embedded?.venues?.[0]?.name || ''} ¬∑ ${event._embedded?.venues?.[0]?.city?.name || ''}
                </div>
              </div>
              <a href="${event.url}" target="_blank" class="btn btn-sm btn-secondary">‚Üó</a>
            </div>
          `).join('')}
        </div>
        ${pricingData.events.length > 10 ? `
          <div style="text-align:center;padding:12px;color:#71717a;font-size:12px">
            +${pricingData.events.length - 10} weitere Events
          </div>
        ` : ''}
      </div>
    ` : `
      <div class="card">
        <div class="card-title">üé≠ Events</div>
        <div style="text-align:center;padding:20px;color:#71717a">
          <div style="font-size:24px;margin-bottom:8px">üîç</div>
          <div style="font-size:13px">Events werden automatisch gesucht...</div>
          <div style="font-size:11px;margin-top:4px">Basierend auf den St√§dten deiner Objekte</div>
        </div>
      </div>
    `}
    
    <!-- Pricing Strategy -->
    <div class="card" style="margin-top:16px">
      <div class="card-title">‚öôÔ∏è Pricing-Strategie</div>
      <div class="grid-3" style="margin-bottom:16px">
        <div class="list-item" style="cursor:pointer;${pricingData.strategy==='conservative'?'border:2px solid #22c55e':''}" onclick="setPricingStrategy('conservative')">
          <div class="list-icon">üê¢</div>
          <div class="list-info">
            <div class="list-title">Konservativ</div>
            <div class="list-subtitle">Kleine Anpassungen, stabil</div>
          </div>
        </div>
        <div class="list-item" style="cursor:pointer;${pricingData.strategy==='balanced'?'border:2px solid #22c55e':''}" onclick="setPricingStrategy('balanced')">
          <div class="list-icon">‚öñÔ∏è</div>
          <div class="list-info">
            <div class="list-title">Ausgewogen</div>
            <div class="list-subtitle">Gute Balance</div>
          </div>
        </div>
        <div class="list-item" style="cursor:pointer;${pricingData.strategy==='aggressive'?'border:2px solid #22c55e':''}" onclick="setPricingStrategy('aggressive')">
          <div class="list-icon">üöÄ</div>
          <div class="list-info">
            <div class="list-title">Aggressiv</div>
            <div class="list-subtitle">Max. Umsatz</div>
          </div>
        </div>
      </div>
      <div style="padding:12px;background:#18181b;border-radius:10px;font-size:12px;color:#a1a1aa">
        üí° Strategie beeinflusst alle Preisanpassungen: Wochenenden, Feiertage, Events
      </div>
    </div>
  `;
}

// Show day price detail modal
function showDayPriceDetail(propertyId, dateStr) {
  const prop = pricingData.properties.find(p => p.id === propertyId);
  const dailyPrices = pricingData.dailyPrices[propertyId];
  const day = dailyPrices?.find(d => d.date === dateStr);
  
  if (!prop || !day) return;
  
  const date = new Date(dateStr);
  const dateFormatted = date.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
  
  showModal(`
    <div class="modal-title">üìÖ ${dateFormatted}</div>
    <div style="margin-bottom:20px">
      <div style="font-size:14px;color:#a1a1aa">${prop.name}</div>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
      <div style="background:#18181b;padding:16px;border-radius:10px;text-align:center">
        <div style="font-size:12px;color:#71717a">Basispreis</div>
        <div style="font-size:24px;font-weight:700">‚Ç¨${day.basePrice}</div>
      </div>
      <div style="background:${day.changePercent >= 0 ? '#22c55e15' : '#ef444415'};padding:16px;border-radius:10px;text-align:center">
        <div style="font-size:12px;color:#71717a">Optimierter Preis</div>
        <div style="font-size:24px;font-weight:700;color:${day.changePercent >= 0 ? '#22c55e' : '#ef4444'}">‚Ç¨${day.finalPrice}</div>
        <div style="font-size:12px;color:${day.changePercent >= 0 ? '#22c55e' : '#ef4444'}">${day.changePercent >= 0 ? '+' : ''}${day.changePercent}%</div>
      </div>
    </div>
    
    ${day.isBooked ? `
      <div style="background:#27272a;padding:16px;border-radius:10px;margin-bottom:20px;text-align:center">
        <div style="font-size:24px;margin-bottom:8px">üîí</div>
        <div style="color:#a1a1aa">Dieser Tag ist bereits gebucht</div>
      </div>
    ` : ''}
    
    ${day.factors.length > 0 ? `
      <div style="margin-bottom:20px">
        <div style="font-size:12px;color:#71717a;margin-bottom:8px">Preisfaktoren:</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          ${day.factors.map(f => `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#18181b;border-radius:8px">
              <span style="font-size:13px">${f.label}</span>
              <span style="color:${f.boost >= 0 ? '#22c55e' : '#ef4444'};font-weight:600">${f.boost >= 0 ? '+' : ''}${Math.round(f.boost * 100)}%</span>
            </div>
          `).join('')}
        </div>
      </div>
    ` : ''}
    
    ${day.events.length > 0 ? `
      <div style="margin-bottom:20px">
        <div style="font-size:12px;color:#71717a;margin-bottom:8px">Events an diesem Tag:</div>
        ${day.events.map(e => `
          <div style="padding:12px;background:#f9731615;border:1px solid #f9731650;border-radius:8px;margin-bottom:8px">
            <div style="font-weight:600">${e.name}</div>
            <div style="font-size:12px;color:#a1a1aa">${e.venue}</div>
          </div>
        `).join('')}
      </div>
    ` : ''}
    
    <div style="display:flex;gap:12px">
      <button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Schlie√üen</button>
      ${!day.isBooked && smoobuConfig.connected ? `
        <button class="btn btn-primary" onclick="applySingleDayPrice('${propertyId}', '${dateStr}');hideModal()" style="flex:1" ${day.applied ? 'disabled' : ''}>
          ${day.applied ? '‚úì Bereits √ºbertragen' : '‚úì Preis √ºbernehmen'}
        </button>
      ` : ''}
    </div>
  `);
}

// Pricing Strategy Functions
async function setPricingStrategy(strategy) {
  pricingData.strategy = strategy;
  localStorage.setItem('pricing_strategy', strategy);
  
  // Save to Supabase
  saveAutomationSettings();
  
  // Recalculate all daily prices with new strategy
  await calculateAllDailyPrices();
  
  showToast(`‚úÖ Strategie auf "${strategy === 'conservative' ? 'Konservativ' : strategy === 'balanced' ? 'Ausgewogen' : 'Aggressiv'}" gesetzt`);
  renderPage();
}

// Load saved strategy on init - now handled by loadAutomationSettings
function loadPricingStrategy() {
  // This is now a backup - primary loading happens in loadAutomationSettings
  const saved = localStorage.getItem('pricing_strategy');
  if (saved && !pricingData.strategy) {
    pricingData.strategy = saved;
  }
}

async function applyPrice(propId, newPrice) {
  const prop = pricingData.properties.find(p => p.id === propId);
  if (!prop) return;
  
  // Check if Smoobu is connected and auto-pricing is enabled
  if (smoobuConfig.connected && automationSettings.autoPricing) {
    showModal(`
      <div style="text-align:center;padding:40px">
        <div class="spinner" style="margin:0 auto 20px"></div>
        <div style="font-size:16px;font-weight:600">Aktualisiere Preis...</div>
        <div style="color:#71717a;font-size:13px;margin-top:8px">Sende an Smoobu ‚Üí Airbnb/Booking</div>
      </div>
    `);
    
    try {
      // Get dates for the next 30 days
      const today = new Date();
      const dates = [];
      for (let i = 0; i < 30; i++) {
        const d = new Date(today);
        d.setDate(d.getDate() + i);
        dates.push(d.toISOString().split('T')[0]);
      }
      
      // Create date range string
      const startDate = dates[0];
      const endDate = dates[dates.length - 1];
      
      // Send to Smoobu via Edge Function
      const response = await fetch(`${SMOOBU_PROXY_URL}?action=update-rates`, {
        method: 'POST',
        headers: {
          'x-smoobu-key': smoobuConfig.apiKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          apartments: [propId],
          operations: [{
            dates: [`${startDate}:${endDate}`],
            daily_price: newPrice
          }]
        })
      });
      
      const result = await response.json();
      
      if (!response.ok || result.error) {
        throw new Error(result.error || 'Preis-Update fehlgeschlagen');
      }
      
      // Success - update local state
      prop.currentPrice = newPrice;
      
      hideModal();
      showToast(`‚úÖ Preis auf ‚Ç¨${newPrice} aktualisiert (Smoobu ‚Üí Airbnb/Booking)`);
      renderPage();
      
    } catch (error) {
      hideModal();
      console.error('Price update error:', error);
      showModal(`
        <div style="text-align:center;padding:20px">
          <div style="font-size:64px;margin-bottom:16px">‚ö†Ô∏è</div>
          <div style="font-size:18px;font-weight:700;margin-bottom:8px">Preis-Update fehlgeschlagen</div>
          <div style="color:#ef4444;margin-bottom:16px;font-size:13px">${error.message}</div>
          <div style="color:#71717a;font-size:12px;margin-bottom:24px">Der Preis wurde lokal aktualisiert, aber nicht zu Smoobu gesendet.</div>
          <button class="btn btn-secondary" onclick="hideModal()" style="width:100%">Schlie√üen</button>
        </div>
      `);
      
      // Still update locally
      prop.currentPrice = newPrice;
      renderPage();
    }
  } else {
    // No Smoobu connection - just update locally
    prop.currentPrice = newPrice;
    showToast(`üí∞ Preis lokal auf ‚Ç¨${newPrice} aktualisiert`);
    renderPage();
  }
}

// =====================
// OTHER PAGES
// =====================
function renderBookings() {
  // Separate active and cancelled bookings
  const activeBookings = bookings.filter(b => b.status !== 'cancelled');
  const cancelledBookings = bookings.filter(b => b.status === 'cancelled');
  
  if (!bookings.length) return '<div class="empty-state"><div class="empty-icon">üìÖ</div><div class="empty-title">Keine Buchungen</div><button class="btn btn-primary" onclick="showAddBook()">+ Buchung</button></div>';
  
  return `
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px">
        <div class="card-title" style="margin:0">üìÖ Aktive Buchungen (${activeBookings.length})</div>
        <div style="display:flex;gap:8px;align-items:center">
          ${cancelledBookings.length > 0 ? `
            <button class="btn btn-sm btn-secondary" onclick="toggleCancelledBookings()" id="toggle-cancelled-btn">
              ${window.showCancelledBookings ? 'üôà Stornierte ausblenden' : `üëÅÔ∏è ${cancelledBookings.length} Stornierte anzeigen`}
            </button>
          ` : ''}
          <button class="btn btn-sm btn-primary" onclick="showAddBook()">+ Neue Buchung</button>
        </div>
      </div>
      
      ${activeBookings.length > 0 ? `
        <table class="table">
          <thead>
            <tr>
              <th>Gast</th>
              <th>Objekt</th>
              <th>Check-in</th>
              <th>Check-out</th>
              <th>Betrag</th>
              <th>Status</th>
              <th style="width:100px">Aktionen</th>
            </tr>
          </thead>
          <tbody>
            ${activeBookings.map(b => `
              <tr>
                <td><strong>${b.guest_name}</strong></td>
                <td>${b.properties?.name || '-'}</td>
                <td>${fmtDate(b.check_in)}</td>
                <td>${fmtDate(b.check_out)}</td>
                <td><strong>‚Ç¨${b.total_price || 0}</strong></td>
                <td><span class="tag tag-green">Best√§tigt</span></td>
                <td>
                  <div style="display:flex;gap:4px">
                    <button class="btn btn-sm btn-secondary" onclick="editBooking('${b.id}')" title="Bearbeiten">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-secondary" onclick="deleteBooking('${b.id}')" title="L√∂schen" style="color:#ef4444">üóëÔ∏è</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      ` : `
        <div class="empty-state" style="padding:30px">
          <div class="empty-icon">üì≠</div>
          <div class="empty-desc">Keine aktiven Buchungen</div>
        </div>
      `}
    </div>
    
    ${window.showCancelledBookings && cancelledBookings.length > 0 ? `
      <div class="card" style="margin-top:16px;opacity:0.7">
        <div class="card-title" style="color:#ef4444">üö´ Stornierte Buchungen (${cancelledBookings.length})</div>
        <table class="table">
          <thead>
            <tr>
              <th>Gast</th>
              <th>Objekt</th>
              <th>Check-in</th>
              <th>Check-out</th>
              <th>Betrag</th>
              <th>Status</th>
              <th style="width:100px">Aktionen</th>
            </tr>
          </thead>
          <tbody>
            ${cancelledBookings.map(b => `
              <tr style="opacity:0.6">
                <td><strong>${b.guest_name}</strong></td>
                <td>${b.properties?.name || '-'}</td>
                <td>${fmtDate(b.check_in)}</td>
                <td>${fmtDate(b.check_out)}</td>
                <td><strong style="text-decoration:line-through">‚Ç¨${b.total_price || 0}</strong></td>
                <td><span class="tag tag-red">Storniert</span></td>
                <td>
                  <div style="display:flex;gap:4px">
                    <button class="btn btn-sm btn-secondary" onclick="deleteBooking('${b.id}')" title="L√∂schen" style="color:#ef4444">üóëÔ∏è</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    ` : ''}
  `;
}

function toggleCancelledBookings() {
  window.showCancelledBookings = !window.showCancelledBookings;
  renderPage();
}

function renderProperties() {
  if (!properties.length) return '<div class="empty-state"><div class="empty-icon">üè†</div><div class="empty-title">Keine Objekte</div><button class="btn btn-primary" onclick="showAddProp()">+ Objekt</button></div>';
  
  return `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div style="font-size:14px;color:#a1a1aa">${properties.length} Objekt${properties.length > 1 ? 'e' : ''}</div>
    </div>
    <div class="grid-3">
      ${properties.map(p => `
        <div class="card property-card">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
            <div style="font-size:32px">${p.property_type === 'house' ? 'üè°' : 'üè¢'}</div>
            <span class="tag ${p.active !== false ? 'tag-green' : 'tag-orange'}">${p.active !== false ? 'Aktiv' : 'Inaktiv'}</span>
          </div>
          <div style="font-weight:700;font-size:16px;margin-bottom:4px">${p.name}</div>
          <div style="color:#71717a;font-size:13px;margin-bottom:8px">${p.city || '-'}</div>
          <div style="font-size:12px;color:#a1a1aa;margin-bottom:12px">üõèÔ∏è ${p.bedrooms || 1} Zimmer ¬∑ üë• ${p.max_guests || 2} G√§ste</div>
          ${p.base_price ? `<div style="font-size:18px;font-weight:700;color:#22c55e;margin-bottom:12px">‚Ç¨${p.base_price}/Nacht</div>` : '<div style="margin-bottom:12px"></div>'}
          ${p.smoobu_id ? '<div style="font-size:10px;color:#71717a;margin-bottom:12px">üîó Smoobu verbunden</div>' : '<div style="margin-bottom:12px"></div>'}
          <div style="display:flex;gap:8px;border-top:1px solid #27272a;padding-top:12px;margin-top:auto">
            <button class="btn btn-sm btn-secondary" onclick="editProperty('${p.id}')" style="flex:1">‚úèÔ∏è Bearbeiten</button>
            <button class="btn btn-sm btn-secondary" onclick="deleteProperty('${p.id}')" style="color:#ef4444">üóëÔ∏è</button>
          </div>
        </div>
      `).join('')}
      <div class="card" style="border-style:dashed;display:flex;align-items:center;justify-content:center;min-height:220px;cursor:pointer" onclick="showAddProp()">
        <div style="text-align:center;color:#71717a">
          <div style="font-size:32px;margin-bottom:8px">+</div>
          <div>Hinzuf√ºgen</div>
        </div>
      </div>
    </div>
  `;
}

function renderPartners() {
  return '<div style="max-width:650px;margin:80px auto;text-align:center">' +
    '<div class="card" style="background:linear-gradient(135deg,#131316 0%,#1a1a2e 50%,#1e1e3f 100%);border:2px solid #f9731640;padding:56px 40px;border-radius:20px;box-shadow:0 20px 60px rgba(249,115,22,0.1)">' +
      '<div style="font-size:72px;margin-bottom:28px">ü§ù</div>' +
      '<div style="font-size:28px;font-weight:700;margin-bottom:16px;background:linear-gradient(135deg,#f97316,#fb923c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">Bald neu f√ºr dich!</div>' +
      '<div style="font-size:18px;color:#fafafa;line-height:1.7;margin-bottom:8px">Das <strong style="color:#f97316">PilotStay Partnernetzwerk</strong></div>' +
      '<div style="font-size:16px;color:#a1a1aa;line-height:1.7;margin-bottom:32px">F√ºr noch mehr Entlastung und Zeitgewinn bei der Verwaltung deiner Unterk√ºnfte.</div>' +
      '<div style="display:flex;flex-wrap:wrap;gap:16px;justify-content:center;margin-top:40px">' +
        '<div style="background:#27272a;border-radius:16px;padding:20px 24px;text-align:center;min-width:150px;border:1px solid #3f3f46">' +
          '<div style="font-size:32px;margin-bottom:10px">üßπ</div>' +
          '<div style="font-size:14px;font-weight:600;color:#fafafa">Reinigung</div>' +
          '<div style="font-size:11px;color:#71717a;margin-top:4px">Professionelle Partner</div>' +
        '</div>' +
        '<div style="background:#27272a;border-radius:16px;padding:20px 24px;text-align:center;min-width:150px;border:1px solid #3f3f46">' +
          '<div style="font-size:32px;margin-bottom:10px">üîê</div>' +
          '<div style="font-size:14px;font-weight:600;color:#fafafa">Smart Locks</div>' +
          '<div style="font-size:11px;color:#71717a;margin-top:4px">Schl√ºssellose √úbergabe</div>' +
        '</div>' +
        '<div style="background:#27272a;border-radius:16px;padding:20px 24px;text-align:center;min-width:150px;border:1px solid #3f3f46">' +
          '<div style="font-size:32px;margin-bottom:10px">üì∏</div>' +
          '<div style="font-size:14px;font-weight:600;color:#fafafa">Fotografie</div>' +
          '<div style="font-size:11px;color:#71717a;margin-top:4px">Professionelle Bilder</div>' +
        '</div>' +
        '<div style="background:#27272a;border-radius:16px;padding:20px 24px;text-align:center;min-width:150px;border:1px solid #3f3f46">' +
          '<div style="font-size:32px;margin-bottom:10px">üõ†Ô∏è</div>' +
          '<div style="font-size:14px;font-weight:600;color:#fafafa">Handwerker</div>' +
          '<div style="font-size:11px;color:#71717a;margin-top:4px">Reparaturen & Wartung</div>' +
        '</div>' +
      '</div>' +
      '<div style="margin-top:40px;padding-top:28px;border-top:1px solid #27272a">' +
        '<div style="font-size:13px;color:#71717a">üîî Du wirst benachrichtigt, sobald das Partnernetzwerk verf√ºgbar ist.</div>' +
      '</div>' +
    '</div>' +
  '</div>';
}

function renderAutomation() {
  const smoobuConnected = smoobuConfig.connected;
  const lastSync = smoobuConfig.lastSync ? new Date(smoobuConfig.lastSync).toLocaleString('de-DE') : 'Nie';
  
  // Helper to display next sync time
  function getNextSyncDisplay() {
    const nextSync = parseInt(localStorage.getItem('smoobu_next_sync')) || 0;
    if (!nextSync) return '';
    
    const now = Date.now();
    const diff = nextSync - now;
    
    if (diff <= 0) return 'N√§chster Sync: F√§llig';
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    
    if (hours > 0) {
      return `N√§chster Sync: in ${hours}h ${minutes % 60}min`;
    }
    return `N√§chster Sync: in ${minutes} min`;
  }
  
  // Calculate active features count (only count if enabled AND not 'off')
  const activeFeatures = [
    automationSettings.smartReplies && automationSettings.smartRepliesMode !== 'off',
    automationSettings.reviewReplies,
    automationSettings.autoPricing && automationSettings.autoPricingMode !== 'off',
    smoobuConnected
  ].filter(Boolean).length;
  
  // Count auto features
  const autoFeatures = [
    automationSettings.smartRepliesMode === 'auto' || automationSettings.smartRepliesMode === 'hybrid',
    automationSettings.autoPricingMode === 'auto'
  ].filter(Boolean).length;
  
  const totalFeatures = 4;
  const score = Math.round((activeFeatures / totalFeatures) * 100);
  
  // Mode labels and colors
  const modeLabels = {
    'off': { label: 'Aus', color: '#71717a', icon: '‚≠ï' },
    'manual': { label: 'Manuell', color: '#3b82f6', icon: 'üõ°Ô∏è' },
    'auto': { label: 'Automatisch', color: '#22c55e', icon: 'ü§ñ' },
    'hybrid': { label: 'Hybrid', color: '#8b5cf6', icon: '‚ö°' }
  };
  
  return `
    <div class="card card-ai" style="margin-bottom:24px">
      <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap">
        <div style="text-align:center;min-width:100px" title="KI-Score = Aktive Features (Smart Replies, Reviews, Pricing, Smoobu) / 4">
          <div style="font-size:48px;font-weight:700;color:${score >= 80 ? '#22c55e' : score >= 50 ? '#8b5cf6' : '#f97316'}">${score}%</div>
          <div style="font-size:11px;color:#a1a1aa">KI-Score</div>
          <div style="font-size:9px;color:#52525b">${activeFeatures}/4 Features</div>
        </div>
        <div style="flex:1;padding-left:20px;border-left:1px solid #27272a;min-width:200px">
          <div style="font-size:18px;font-weight:700;margin-bottom:4px">${activeFeatures} von ${totalFeatures} Features aktiv</div>
          <div style="color:#a1a1aa;font-size:13px">
            ${autoFeatures > 0 ? `ü§ñ ${autoFeatures} laufen vollautomatisch` : 'Aktiviere Auto-Modus f√ºr maximale Zeitersparnis'}
          </div>
          <div style="margin-top:12px;background:#27272a;border-radius:10px;height:8px;overflow:hidden">
            <div style="background:linear-gradient(90deg,#8b5cf6,#a78bfa);height:100%;width:${score}%;transition:width .5s"></div>
          </div>
        </div>
        <button class="btn btn-ai" onclick="showAiSettings()">‚öôÔ∏è KI-Einstellungen</button>
      </div>
    </div>
    
    <!-- SMOOBU INTEGRATION -->
    <div class="card" style="border-color:${smoobuConnected ? '#22c55e' : '#f97316'}50;background:linear-gradient(135deg,#131316,${smoobuConnected ? '#22c55e' : '#f97316'}08)">
      <!-- Status Header -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="display:flex;align-items:center;gap:12px">
          <img src="https://www.smoobu.com/wp-content/uploads/2021/06/smoobu-logo.svg" style="height:28px;filter:brightness(0) invert(1)" onerror="this.outerHTML='<span style=font-size:24px>üîó</span>'">
          <div>
            <div style="font-size:16px;font-weight:700">Smoobu Integration</div>
            <div style="font-size:11px;color:#71717a">Technische Datenbasis f√ºr PilotStay</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          ${smoobuConnected ? `
            <span class="tag tag-green" style="padding:6px 12px">‚úì Verbunden</span>
          ` : smoobuConfig.apiKey ? `
            <span class="tag tag-orange" style="padding:6px 12px">‚ö†Ô∏è API pr√ºfen</span>
          ` : `
            <span class="tag" style="background:#27272a;color:#71717a;padding:6px 12px">Nicht verbunden</span>
          `}
        </div>
      </div>
      
      ${smoobuConnected ? `
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px">
          <div style="background:#18181b;padding:16px;border-radius:10px;text-align:center">
            <div style="font-size:24px;font-weight:700;color:#22c55e">${properties.length}</div>
            <div style="font-size:11px;color:#71717a">Objekte synchronisiert</div>
          </div>
          <div style="background:#18181b;padding:16px;border-radius:10px;text-align:center">
            <div style="font-size:24px;font-weight:700;color:#3b82f6">${bookings.length}</div>
            <div style="font-size:11px;color:#71717a">Buchungen importiert</div>
          </div>
          <div style="background:#18181b;padding:16px;border-radius:10px;text-align:center">
            <div style="font-size:24px;font-weight:700;color:#8b5cf6">${getSyncIntervalDisplay()}</div>
            <div style="font-size:11px;color:#71717a">Sync-Intervall</div>
          </div>
        </div>
        
        <div style="display:flex;align-items:center;gap:12px;padding:12px;background:#18181b;border-radius:10px;margin-bottom:16px">
          <div style="width:10px;height:10px;border-radius:50%;background:#22c55e;animation:pulse 2s infinite"></div>
          <div style="flex:1">
            <div style="font-size:13px">Auto-Sync aktiv</div>
            <div style="font-size:11px;color:#71717a">Letzter Sync: ${lastSync}</div>
            <div style="font-size:10px;color:#71717a">${getNextSyncDisplay()}</div>
          </div>
          <button class="btn btn-sm btn-secondary" onclick="syncSmoobuNow()">üîÑ Jetzt synchronisieren</button>
        </div>
        
        <div style="display:flex;gap:12px">
          <button class="btn btn-secondary" onclick="showSmoobuSettings()" style="flex:1">‚öôÔ∏è Einstellungen</button>
          <button class="btn btn-secondary" onclick="disconnectSmoobu()" style="color:#ef4444">Trennen</button>
        </div>
      ` : `
        <!-- Not Connected State - For Smoobu Professional Users -->
        <div style="background:#18181b;border-radius:12px;padding:20px;margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
            <div style="width:40px;height:40px;background:#f9731615;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">üéØ</div>
            <div>
              <div style="font-size:14px;font-weight:600">F√ºr Smoobu Professional Nutzer</div>
              <div style="font-size:11px;color:#71717a">Verbinde dein bestehendes Smoobu-Konto</div>
            </div>
          </div>
          <p style="font-size:12px;color:#a1a1aa;margin-bottom:0;line-height:1.5">
            PilotStay erweitert dein Smoobu Professional mit KI-gest√ºtzter Automatisierung. 
            Verbinde deinen API-Key, um alle Funktionen freizuschalten.
          </p>
        </div>
        
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:16px">
          <!-- API Input - Prominent -->
          <div style="background:#0c0c0e;border:2px solid #3b82f630;border-radius:12px;padding:20px">
            <label style="display:block;font-size:13px;font-weight:600;color:#fff;margin-bottom:8px">
              Smoobu API Key
            </label>
            <input class="input" type="password" id="smoobu-api-key" 
                   placeholder="F√ºge hier deinen Smoobu API-Key ein..." 
                   value="${smoobuConfig.apiKey}"
                   style="padding:14px 16px;font-size:14px;background:#18181b;border:1px solid #3f3f46;margin-bottom:8px">
            <div style="font-size:10px;color:#71717a;margin-bottom:16px">
              üìç Smoobu Dashboard ‚Üí Einstellungen ‚Üí API
            </div>
            <button class="btn btn-primary" onclick="connectSmoobu()" style="width:100%;padding:14px;font-size:14px">
              üîó Verbinden
            </button>
          </div>
          
          <!-- Info Box -->
          <div style="background:#18181b;border-radius:12px;padding:16px;display:flex;flex-direction:column;justify-content:center">
            <div style="font-size:11px;font-weight:600;color:#a1a1aa;margin-bottom:12px">Voraussetzung</div>
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
              <span style="color:#f97316">‚ö°</span>
              <span style="font-size:11px;color:#e4e4e7">Smoobu Professional</span>
            </div>
            <p style="font-size:10px;color:#52525b;line-height:1.4;margin-bottom:12px">
              Die Professional-Version wird f√ºr alle KI-Features ben√∂tigt.
            </p>
            <a href="https://www.smoobu.com" target="_blank" style="font-size:10px;color:#3b82f6;text-decoration:none">
              Mehr erfahren ‚Üí
            </a>
          </div>
        </div>
      `}
    </div>
    
    <!-- KI FEATURES with Mode Selection -->
    <div style="margin-top:24px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center">
      <div style="font-size:14px;font-weight:600;color:#a1a1aa">ü§ñ KI-Features</div>
      <div style="font-size:11px;color:#71717a">
        üõ°Ô∏è Manuell = Du best√§tigst ¬∑ ü§ñ Auto = KI handelt selbst ¬∑ ‚ö° Hybrid = Smart-Mix
      </div>
    </div>
    
    <!-- Pending Messages Alert -->
    ${pendingAutoReplies.length > 0 ? `
      <div class="card" style="background:#f9731610;border-color:#f9731650;margin-bottom:16px;cursor:pointer" onclick="showPendingReplies()">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-size:24px">‚ö†Ô∏è</div>
          <div style="flex:1">
            <div style="font-weight:600">${pendingAutoReplies.length} Nachricht${pendingAutoReplies.length > 1 ? 'en' : ''} wartet auf Pr√ºfung</div>
            <div style="font-size:12px;color:#a1a1aa">Hybrid-Modus: Komplexe Anfragen brauchen deine Best√§tigung</div>
          </div>
          <button class="btn btn-sm btn-primary">Pr√ºfen ‚Üí</button>
        </div>
      </div>
    ` : ''}
    
    <div class="grid-2">
      <!-- Smart Replies -->
      <div class="card" style="${automationSettings.smartReplies && canToggleAutomation('smartReplies') ? 'border-color:#22c55e50' : ''}">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
          <div class="card-title" style="margin-bottom:0">Smart Replies ${!canToggleAutomation('smartReplies') ? '<span style="color:#71717a;font-size:11px;font-weight:400">(Plan erforderlich)</span>' : ''}</div>
          ${canToggleAutomation('smartReplies') ? `
            <button class="toggle ${automationSettings.smartReplies ? 'active' : ''}" onclick="toggleAutomation('smartReplies')">
              <span class="toggle-knob"></span>
            </button>
          ` : `
            <button class="toggle" style="opacity:0.4;cursor:not-allowed" onclick="showUpgradeRequired('Smart Replies', 'cruise')">
              <span class="toggle-knob"></span>
            </button>
          `}
        </div>
        <p style="color:#a1a1aa;font-size:13px;margin-bottom:12px">KI schl√§gt automatisch passende Antworten auf G√§steanfragen vor</p>
        
        ${!canToggleAutomation('smartReplies') ? `
          <div style="background:#f9731610;padding:12px;border-radius:6px;font-size:12px;color:#f97316;display:flex;align-items:center;gap:8px">
            <span>üîí</span> Verf√ºgbar ab <strong style="cursor:pointer" onclick="setBillingTab('plans', true);setPage('billing')">Cruise</strong>
          </div>
        ` : automationSettings.smartReplies ? `
          <!-- Auto-Reply Status - only show if actually running -->
          ${smoobuConfig.connected && (automationSettings.smartRepliesMode === 'auto' || automationSettings.smartRepliesMode === 'hybrid') && isAutomationModeAllowed('smartReplies', automationSettings.smartRepliesMode) ? `
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:8px;background:#22c55e15;border-radius:6px">
              <div style="width:8px;height:8px;border-radius:50%;background:#22c55e;animation:pulse 2s infinite"></div>
              <span style="font-size:11px;color:#22c55e">Auto-Reply aktiv (pr√ºft alle 30s)</span>
            </div>
          ` : ''}
          
          <div style="margin-bottom:12px">
            <div style="font-size:11px;color:#71717a;margin-bottom:6px">Automatisierung:</div>
            <div style="display:flex;gap:6px">
              ${['manual', 'hybrid', 'auto'].map(mode => {
                const allowed = isAutomationModeAllowed('smartReplies', mode);
                const isActive = automationSettings.smartRepliesMode === mode;
                return `
                <button class="btn btn-sm ${isActive ? 'btn-primary' : 'btn-secondary'}" 
                        onclick="${allowed ? `setAutomationMode('smartReplies', '${mode}')` : `showUpgradeRequired('${modeLabels[mode].label}', 'autopilot')`}"
                        style="flex:1;font-size:11px;padding:6px;${!allowed ? 'opacity:0.6' : ''}">
                  ${allowed ? modeLabels[mode].icon : 'üîí'} ${modeLabels[mode].label}
                </button>
              `}).join('')}
            </div>
          </div>
          <div style="background:#18181b;padding:10px;border-radius:6px;font-size:11px;color:#a1a1aa">
            ${automationSettings.smartRepliesMode === 'manual' ? 'Du siehst Vorschl√§ge und entscheidest selbst' :
              automationSettings.smartRepliesMode === 'hybrid' ? 'Einfache Fragen ‚Üí Auto ¬∑ Komplexe ‚Üí Manuell' :
              'KI antwortet automatisch auf alle G√§steanfragen'}
          </div>
        ` : `
          <div style="display:flex;align-items:center;gap:8px">
            <span class="tag tag-orange">Deaktiviert</span>
          </div>
        `}
      </div>
      
      <!-- Review Replies -->
      <div class="card" style="${automationSettings.reviewReplies && canToggleAutomation('reviewReplies') ? 'border-color:#22c55e50' : ''}">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
          <div class="card-title" style="margin-bottom:0">Review-Antworten ${!canToggleAutomation('reviewReplies') ? '<span style="color:#71717a;font-size:11px;font-weight:400">(Plan erforderlich)</span>' : ''}</div>
          ${canToggleAutomation('reviewReplies') ? `
            <button class="toggle ${automationSettings.reviewReplies ? 'active' : ''}" onclick="toggleAutomation('reviewReplies')">
              <span class="toggle-knob"></span>
            </button>
          ` : `
            <button class="toggle" style="opacity:0.4;cursor:not-allowed" onclick="showUpgradeRequired('Review-Antworten', 'cruise')">
              <span class="toggle-knob"></span>
            </button>
          `}
        </div>
        <p style="color:#a1a1aa;font-size:13px;margin-bottom:12px">KI generiert personalisierte Antworten auf G√§stebewertungen</p>
        
        ${!canToggleAutomation('reviewReplies') ? `
          <div style="background:#f9731610;padding:12px;border-radius:6px;font-size:12px;color:#f97316;display:flex;align-items:center;gap:8px">
            <span>üîí</span> Verf√ºgbar ab <strong style="cursor:pointer" onclick="setBillingTab('plans', true);setPage('billing')">Cruise</strong>
          </div>
        ` : automationSettings.reviewReplies ? `
          <div style="background:#18181b;padding:10px;border-radius:6px;font-size:11px;color:#a1a1aa">
            KI generiert Vorschl√§ge, du pr√ºfst und ver√∂ffentlichst manuell
          </div>
        ` : `
          <div style="display:flex;align-items:center;gap:8px">
            <span class="tag tag-orange">Deaktiviert</span>
          </div>
        `}
      </div>
      
      <!-- Auto Pricing -->
      <div class="card" style="${automationSettings.autoPricing && canToggleAutomation('autoPricing') ? 'border-color:#22c55e50' : ''}">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
          <div class="card-title" style="margin-bottom:0">Auto-Pricing ${!canToggleAutomation('autoPricing') ? '<span style="color:#71717a;font-size:11px;font-weight:400">(Plan erforderlich)</span>' : ''}</div>
          ${canToggleAutomation('autoPricing') ? `
            <button class="toggle ${automationSettings.autoPricing ? 'active' : ''}" onclick="toggleAutomation('autoPricing')">
              <span class="toggle-knob"></span>
            </button>
          ` : `
            <button class="toggle" style="opacity:0.4;cursor:not-allowed" onclick="showUpgradeRequired('Auto-Pricing', 'cruise')">
              <span class="toggle-knob"></span>
            </button>
          `}
        </div>
        <p style="color:#a1a1aa;font-size:13px;margin-bottom:12px">KI optimiert Preise basierend auf Nachfrage, Events & Saison</p>
        
        ${!canToggleAutomation('autoPricing') ? `
          <div style="background:#f9731610;padding:12px;border-radius:6px;font-size:12px;color:#f97316;display:flex;align-items:center;gap:8px">
            <span>üîí</span> Verf√ºgbar ab <strong style="cursor:pointer" onclick="setBillingTab('plans', true);setPage('billing')">Cruise</strong>
          </div>
        ` : automationSettings.autoPricing ? `
          <div style="margin-bottom:12px">
            <div style="font-size:11px;color:#71717a;margin-bottom:6px">Automatisierung:</div>
            <div style="display:flex;gap:6px">
              ${['manual', 'auto'].map(mode => {
                const allowed = isAutomationModeAllowed('autoPricing', mode);
                const isActive = automationSettings.autoPricingMode === mode;
                return `
                <button class="btn btn-sm ${isActive ? 'btn-primary' : 'btn-secondary'}" 
                        onclick="${allowed ? `setAutomationMode('autoPricing', '${mode}')` : `showUpgradeRequired('Auto-Pricing (${modeLabels[mode].label})', 'autopilot')`}"
                        style="flex:1;font-size:11px;padding:6px;${!allowed ? 'opacity:0.6' : ''}">
                  ${allowed ? modeLabels[mode].icon : 'üîí'} ${modeLabels[mode].label}
                </button>
              `}).join('')}
            </div>
          </div>
          <div style="background:#18181b;padding:10px;border-radius:6px;font-size:11px;color:#a1a1aa">
            ${automationSettings.autoPricingMode === 'manual' ? 'Du siehst Preisvorschl√§ge und √ºbertr√§gst manuell' :
              'KI passt Preise automatisch an und synct zu Smoobu'}
          </div>
        ` : `
          <div style="display:flex;align-items:center;gap:8px">
            <span class="tag tag-orange">Deaktiviert</span>
          </div>
        `}
      </div>
      
      <!-- Coming Soon Feature -->
      <div class="card" style="border-color:#f9731630;background:linear-gradient(135deg,#131316,#f9731608);position:relative;overflow:hidden">
        <div style="position:absolute;top:12px;right:12px">
          <span class="tag" style="background:linear-gradient(135deg,#f97316,#fb923c);color:#fff;font-size:10px;font-weight:600">BETA Q2 2026</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
          <div class="card-title" style="margin-bottom:0">Partner-Netzwerk</div>
        </div>
        <p style="color:#a1a1aa;font-size:13px;margin-bottom:16px">
          Vernetze dich mit verifizierten Dienstleistern und optimiere dein Property Management
        </p>
        
        <div style="background:#18181b;padding:14px;border-radius:6px;margin-bottom:12px">
          <div style="font-size:12px;color:#f97316;font-weight:600;margin-bottom:8px">Was erwartet dich:</div>
          <ul style="font-size:12px;color:#a1a1aa;margin:0;padding-left:16px;line-height:1.8">
            <li>Verifizierte Reinigungskr√§fte in deiner Region</li>
            <li>Automatische Auftragsvergabe bei Check-out</li>
            <li>Schl√ºssel√ºbergabe-Services & Co-Hosts</li>
            <li>Wartungs- und Reparaturdienste auf Abruf</li>
          </ul>
        </div>
        
        <div style="display:flex;flex-direction:column;gap:4px;font-size:11px;color:#71717a">
          <div>Beta Q2 2026</div>
          <div>Vollst√§ndiger Release Q4 2026</div>
        </div>
      </div>
    </div>
    
    <!-- AI Learning Card -->
    <div class="card" style="margin-top:20px;background:linear-gradient(135deg,#131316,#8b5cf608);border-color:#8b5cf630">
      <div style="display:flex;align-items:start;gap:16px">
        <div style="font-size:32px">üß†</div>
        <div style="flex:1">
          <div style="font-size:16px;font-weight:700;margin-bottom:4px">KI-Lernen & Personalisierung</div>
          <div style="font-size:13px;color:#a1a1aa;margin-bottom:12px">
            Die KI lernt aus deinem Feedback und wird mit der Zeit besser
          </div>
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div style="background:#18181b;padding:10px 14px;border-radius:8px;font-size:12px">
              <span style="color:#22c55e;font-weight:600">${aiContext.feedbackHistory.length}</span>
              <span style="color:#71717a"> Bewertungen</span>
            </div>
            <div style="background:#18181b;padding:10px 14px;border-radius:8px;font-size:12px">
              <span style="color:#3b82f6;font-weight:600">${aiContext.savedReplies.length}</span>
              <span style="color:#71717a"> Gespeicherte Antworten</span>
            </div>
            <div style="background:#18181b;padding:10px 14px;border-radius:8px;font-size:12px">
              <span style="color:#8b5cf6;font-weight:600">${Object.keys(aiContext.properties).length}</span>
              <span style="color:#71717a"> Objekt-Profile</span>
            </div>
          </div>
        </div>
        <button class="btn btn-sm btn-secondary" onclick="showPropertyContextManager()">Objekt-Infos ‚Üí</button>
      </div>
    </div>
    
    <!-- Zeit-Ersparnis Summary -->
    <div class="card" style="margin-top:20px;background:linear-gradient(135deg,#131316,#22c55e08);border-color:#22c55e30">
      <div style="display:flex;align-items:center;gap:20px">
        <div style="font-size:40px">‚è±Ô∏è</div>
        <div style="flex:1">
          <div style="font-size:16px;font-weight:700;color:#22c55e">
            ~${calculateTimeSaved()}h pro Woche gespart pro Property
          </div>
          <div style="font-size:12px;color:#a1a1aa;margin-top:4px">
            Durch ${activeFeatures} aktive Automatisierungen
            ${autoFeatures > 0 ? ` (${autoFeatures} vollautomatisch)` : ''}
          </div>
        </div>
        ${activeFeatures < totalFeatures ? `
          <button class="btn btn-sm btn-success" onclick="activateAllAutomation()">
            Alle aktivieren
          </button>
        ` : ''}
      </div>
    </div>
  `;
}

// Set automation mode for a feature
function setAutomationMode(feature, mode) {
  automationSettings[feature + 'Mode'] = mode;
  localStorage.setItem(feature.replace(/([A-Z])/g, '_$1').toLowerCase() + '_mode', mode);
  saveAutomationSettings();
  
  const modeNames = { manual: 'Manuell', auto: 'Automatisch', hybrid: 'Hybrid' };
  const featureNames = {
    smartReplies: 'Smart Replies',
    reviewReplies: 'Review-Antworten', 
    autoPricing: 'Auto-Pricing',
    autoJobs: 'Auto-Jobs'
  };
  
  showToast(`${featureNames[feature]}: ${modeNames[mode]} Modus aktiviert`);
  
  // If switching smartReplies to auto/hybrid, ensure polling is running
  if (feature === 'smartReplies' && (mode === 'auto' || mode === 'hybrid')) {
    if (smoobuConfig.connected && automationSettings.smartReplies) {
      startMessagePolling();
      showToast('ü§ñ KI antwortet jetzt automatisch auf Nachrichten!');
    }
  }
  
  renderPage();
}

// Show AI Settings Modal
function showAiSettings() {
  showModal(`
    <div class="modal-title">‚öôÔ∏è KI-Einstellungen</div>
    
    <div style="margin-bottom:20px">
      <label class="label">üó£Ô∏è Kommunikationsstil</label>
      <select class="input" id="ai-tone" onchange="updateAiTone(this.value)">
        <option value="formal" ${automationSettings.aiTone === 'formal' ? 'selected' : ''}>Formell (Sie-Form)</option>
        <option value="friendly" ${automationSettings.aiTone === 'friendly' ? 'selected' : ''}>Freundlich (Du-Form)</option>
        <option value="casual" ${automationSettings.aiTone === 'casual' ? 'selected' : ''}>Locker (Du + Emojis)</option>
      </select>
      <div style="font-size:11px;color:#71717a;margin-top:4px">Bestimmt wie die KI mit G√§sten kommuniziert</div>
    </div>
    
    <div style="margin-bottom:20px">
      <label class="label">üåç Sprache</label>
      <select class="input" id="ai-language" onchange="updateAiLanguage(this.value)">
        <option value="de" ${automationSettings.aiLanguage === 'de' ? 'selected' : ''}>Deutsch</option>
        <option value="en" ${automationSettings.aiLanguage === 'en' ? 'selected' : ''}>English</option>
        <option value="auto" ${automationSettings.aiLanguage === 'auto' ? 'selected' : ''}>Auto (erkennt Sprache des Gastes)</option>
      </select>
    </div>
    
    <div style="margin-bottom:20px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <label class="label" style="margin:0">üß† KI-Lernen aktivieren</label>
        <button class="toggle ${automationSettings.aiLearning ? 'active' : ''}" onclick="toggleAiLearning()">
          <span class="toggle-knob"></span>
        </button>
      </div>
      <div style="font-size:11px;color:#71717a">
        Die KI speichert erfolgreiche Antworten und lernt aus deinem Feedback (üëç/üëé)
      </div>
    </div>
    
    <div style="border-top:1px solid #27272a;padding-top:16px;margin-top:16px">
      <div style="font-size:12px;font-weight:600;margin-bottom:8px">‚ö†Ô∏è Gefahrenzone</div>
      <button class="btn btn-secondary" onclick="resetAiLearning()" style="color:#ef4444;font-size:12px">
        üóëÔ∏è Alle gelernten Daten l√∂schen
      </button>
    </div>
    
    <div style="display:flex;gap:12px;margin-top:20px">
      <button class="btn btn-primary" onclick="hideModal()" style="flex:1">Fertig</button>
    </div>
  `);
}

function updateAiTone(tone) {
  automationSettings.aiTone = tone;
  localStorage.setItem('ai_tone', tone);
  saveAutomationSettings();
  showToast('‚úÖ Kommunikationsstil aktualisiert');
}

function updateAiLanguage(lang) {
  automationSettings.aiLanguage = lang;
  localStorage.setItem('ai_language', lang);
  saveAutomationSettings();
  showToast('‚úÖ Sprache aktualisiert');
}

function toggleAiLearning() {
  automationSettings.aiLearning = !automationSettings.aiLearning;
  localStorage.setItem('ai_learning', automationSettings.aiLearning);
  saveAutomationSettings();
  showToast(automationSettings.aiLearning ? '‚úÖ KI-Lernen aktiviert' : '‚ùå KI-Lernen deaktiviert');
  showAiSettings(); // Refresh modal
}

function resetAiLearning() {
  if (confirm('Bist du sicher? Alle gelernten Daten werden gel√∂scht.')) {
    aiContext = {
      properties: {},
      savedReplies: [],
      feedbackHistory: [],
      commonQuestions: {}
    };
    localStorage.removeItem('ai_context');
    showToast('üóëÔ∏è KI-Daten gel√∂scht');
    hideModal();
    renderPage();
  }
}

// Property Context Manager
function showPropertyContextManager() {
  const propList = properties.map(p => {
    const ctx = aiContext.properties[p.id] || {};
    return `
      <div class="card" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:600">${p.name}</div>
            <div style="font-size:11px;color:#71717a">${p.city || 'Keine Stadt'}</div>
          </div>
          <button class="btn btn-sm btn-secondary" onclick="editPropertyContext('${p.id}')">
            ${Object.keys(ctx).length > 0 ? '‚úèÔ∏è Bearbeiten' : '+ Infos hinzuf√ºgen'}
          </button>
        </div>
        ${Object.keys(ctx).length > 0 ? `
          <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:6px">
            ${ctx.wifi ? '<span class="tag tag-green">üì∂ WLAN</span>' : ''}
            ${ctx.parking ? '<span class="tag tag-green">üöó Parkplatz</span>' : ''}
            ${ctx.checkin ? '<span class="tag tag-green">üîë Check-in</span>' : ''}
            ${ctx.checkout ? '<span class="tag tag-green">üèÅ Checkout</span>' : ''}
            ${ctx.houseRules ? '<span class="tag tag-green">üìã Hausregeln</span>' : ''}
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
  
  showModal(`
    <div class="modal-title">üè† Objekt-Informationen f√ºr KI</div>
    <div style="font-size:13px;color:#a1a1aa;margin-bottom:16px">
      F√ºge wichtige Infos hinzu, damit die KI bessere Antworten geben kann
    </div>
    
    ${properties.length > 0 ? propList : `
      <div style="text-align:center;padding:30px;color:#71717a">
        <div style="font-size:32px;margin-bottom:8px">üè†</div>
        Verbinde erst Smoobu um Objekte zu sehen
      </div>
    `}
    
    <button class="btn btn-secondary" onclick="hideModal()" style="width:100%;margin-top:12px">Schlie√üen</button>
  `);
}

function editPropertyContext(propertyId) {
  const property = properties.find(p => p.id === propertyId);
  const ctx = aiContext.properties[propertyId] || {};
  
  showModal(`
    <div class="modal-title">üè† ${property?.name || 'Objekt'} - KI Infos</div>
    
    <div style="margin-bottom:16px">
      <label class="label">üì∂ WLAN-Passwort</label>
      <input class="input" id="ctx-wifi" placeholder="z.B. Guest2024" value="${ctx.wifi || ''}">
    </div>
    
    <div style="margin-bottom:16px">
      <label class="label">üöó Parkplatz-Info</label>
      <input class="input" id="ctx-parking" placeholder="z.B. Kostenlos vor dem Haus" value="${ctx.parking || ''}">
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
      <div>
        <label class="label">üîë Check-in Zeit</label>
        <input class="input" type="time" id="ctx-checkin" value="${ctx.checkin || '15:00'}">
      </div>
      <div>
        <label class="label">üèÅ Check-out Zeit</label>
        <input class="input" type="time" id="ctx-checkout" value="${ctx.checkout || '11:00'}">
      </div>
    </div>
    
    <div style="margin-bottom:16px">
      <label class="label">üìã Hausregeln</label>
      <textarea class="input" id="ctx-rules" placeholder="z.B. Nicht rauchen, keine Partys..." style="min-height:80px">${ctx.houseRules || ''}</textarea>
    </div>
    
    <div style="margin-bottom:16px">
      <label class="label">üìù Weitere wichtige Infos</label>
      <textarea class="input" id="ctx-custom" placeholder="Alles was die KI sonst noch wissen sollte..." style="min-height:80px">${ctx.customInfo || ''}</textarea>
    </div>
    
    <div style="display:flex;gap:12px">
      <button class="btn btn-secondary" onclick="showPropertyContextManager()" style="flex:1">Zur√ºck</button>
      <button class="btn btn-primary" onclick="savePropertyContext('${propertyId}')" style="flex:1">üíæ Speichern</button>
    </div>
  `);
}

function savePropertyContext(propertyId) {
  aiContext.properties[propertyId] = {
    wifi: document.getElementById('ctx-wifi').value,
    parking: document.getElementById('ctx-parking').value,
    checkin: document.getElementById('ctx-checkin').value,
    checkout: document.getElementById('ctx-checkout').value,
    houseRules: document.getElementById('ctx-rules').value,
    customInfo: document.getElementById('ctx-custom').value
  };
  
  // Save to localStorage
  localStorage.setItem('ai_context', JSON.stringify(aiContext));
  
  // Save to Supabase for cross-device sync
  saveAiContextToSupabase();
  
  showToast('‚úÖ Objekt-Infos gespeichert');
  showPropertyContextManager();
}

// =====================
// AUTO-REPLY PROCESSOR
// =====================

// Process incoming message and potentially auto-reply
async function processIncomingMessage(chat, message) {
  // Check if smart replies is enabled
  if (!automationSettings.smartReplies) return null;
  
  const mode = automationSettings.smartRepliesMode;
  
  // If manual mode, just generate suggestions (handled elsewhere)
  if (mode === 'manual') return null;
  
  // Check if this is a simple or complex question
  const isSimple = isSimpleQuestion(message.text);
  
  // If hybrid mode and complex question, don't auto-reply
  if (mode === 'hybrid' && !isSimple) {
    console.log('Hybrid mode: Complex question detected, needs manual approval');
    return { needsApproval: true, reason: 'Komplexe Frage erkannt' };
  }
  
  // Generate AI response
  try {
    const response = await generateAutoReply(chat, message);
    
    if (mode === 'auto' || (mode === 'hybrid' && isSimple)) {
      // Auto-send the response
      return { autoSent: true, response };
    }
    
    return { suggestion: response };
  } catch (error) {
    console.error('Auto-reply error:', error);
    return { error: error.message };
  }
}

// Generate auto-reply using AI
async function generateAutoReply(chat, message) {
  // Get property context
  const booking = bookings.find(b => b.guest_name?.includes(chat.name.split(' ')[0]));
  const property = booking ? properties.find(p => p.id === booking.property_id) : properties[0];
  const propertyContext = property ? aiContext.properties[property.id] : null;
  
  // Get conversation history
  const history = chat.messages.slice(-6).map(m => m.text);
  
  // Build context for AI
  const contextInfo = propertyContext ? `
    Objekt: ${property.name}
    WLAN: ${propertyContext.wifi || 'Nicht angegeben'}
    Parkplatz: ${propertyContext.parking || 'Nicht angegeben'}
    Check-in: ${propertyContext.checkin || '15:00'}
    Check-out: ${propertyContext.checkout || '11:00'}
    Hausregeln: ${propertyContext.houseRules || 'Keine'}
    Weitere Infos: ${propertyContext.customInfo || 'Keine'}
  ` : '';
  
  const session = await db.auth.getSession();
  const token = session?.data?.session?.access_token || '';
  
  const response = await fetch(AI_PROXY_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({
      action: 'auto-reply',
      data: {
        guestName: chat.name,
        guestMessage: message.text,
        conversationHistory: history,
        propertyContext: contextInfo,
        tone: automationSettings.aiTone,
        language: automationSettings.aiLanguage
      }
    })
  });
  
  if (!response.ok) throw new Error('AI request failed');
  
  const data = await response.json();
  return data.reply;
}

// Simulate incoming message (for demo/testing)
function simulateIncomingMessage(chatId, messageText) {
  const chat = chats.find(c => c.id == chatId);
  if (!chat) return;
  
  const newMessage = {
    id: 'm' + Date.now(),
    from: 'them',
    text: messageText,
    time: new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'})
  };
  
  chat.messages.push(newMessage);
  chat.unread++;
  chat.lastMsg = messageText;
  
  // Process with auto-reply
  processIncomingMessage(chat, newMessage).then(result => {
    if (result?.autoSent) {
      // Add AI response to chat
      chat.messages.push({
        id: 'm' + Date.now(),
        from: 'me',
        text: result.response,
        time: new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}),
        ai: true,
        autoSent: true
      });
      chat.lastMsg = result.response;
      chat.unread = 0;
      showToast('ü§ñ Auto-Reply gesendet: ' + chat.name);
    } else if (result?.needsApproval) {
      showToast('‚ö†Ô∏è Neue Nachricht von ' + chat.name + ' - Manuelle Pr√ºfung n√∂tig');
    }
    renderPage();
  });
  
  renderPage();
}

// =====================
// FEEDBACK SYSTEM
// =====================

// Rate an AI response
function rateAiResponse(messageId, rating) {
  // Find the message
  let foundChat = null;
  let foundMessage = null;
  
  for (const chat of chats) {
    const msg = chat.messages.find(m => m.id === messageId);
    if (msg) {
      foundChat = chat;
      foundMessage = msg;
      break;
    }
  }
  
  if (!foundMessage) return;
  
  // Save feedback
  const feedback = {
    messageId,
    chatId: foundChat.id,
    guestMessage: foundChat.messages[foundChat.messages.indexOf(foundMessage) - 1]?.text || '',
    response: foundMessage.text,
    rating, // 'good' or 'bad'
    timestamp: new Date().toISOString()
  };
  
  aiContext.feedbackHistory.push(feedback);
  
  // If good rating, save as successful reply
  if (rating === 'good' && automationSettings.aiLearning) {
    aiContext.savedReplies.push({
      question: feedback.guestMessage,
      answer: feedback.response,
      useCount: 1
    });
  }
  
  // Save to localStorage
  localStorage.setItem('ai_context', JSON.stringify(aiContext));
  saveAiContextToSupabase();
  
  // Mark message as rated
  foundMessage.rated = rating;
  
  showToast(rating === 'good' ? 'üëç Danke! KI lernt dazu.' : 'üëé Verstanden, wird verbessert.');
  renderPage();
}

// Save AI context to Supabase
async function saveAiContextToSupabase() {
  try {
    await db.from('profiles').update({
      ai_context: aiContext
    }).eq('id', user.id);
  } catch (e) {
    console.log('Could not save AI context to Supabase:', e);
  }
}

// Load AI context from Supabase
async function loadAiContextFromSupabase() {
  try {
    const { data } = await db.from('profiles').select('ai_context').eq('id', user.id).single();
    if (data?.ai_context) {
      aiContext = { ...aiContext, ...data.ai_context };
    }
  } catch (e) {
    console.log('Using local AI context:', e);
  }
  
  // Also try localStorage as fallback
  const localContext = localStorage.getItem('ai_context');
  if (localContext) {
    try {
      const parsed = JSON.parse(localContext);
      aiContext = { ...aiContext, ...parsed };
    } catch (e) {}
  }
}

// =====================
// AUTOMATION TOGGLE FUNCTIONS
// =====================

function toggleAutomation(feature) {
  // Check if user can toggle this feature
  if (!canToggleAutomation(feature)) {
    const featureNames = {
      smartReplies: 'Smart Replies',
      reviewReplies: 'Review-Antworten',
      autoPricing: 'Auto-Pricing'
    };
    const requiredPlans = {
      smartReplies: 'cruise',
      reviewReplies: 'cruise',
      autoPricing: 'cruise'
    };
    showUpgradeRequired(featureNames[feature] || feature, requiredPlans[feature] || 'cruise');
    return;
  }
  
  // Toggle the setting
  automationSettings[feature] = !automationSettings[feature];
  
  // Save to localStorage
  localStorage.setItem('auto_' + feature.replace(/([A-Z])/g, '_$1').toLowerCase(), automationSettings[feature]);
  
  // Save to Supabase (for cross-device sync)
  saveAutomationSettings();
  
  // Show feedback
  const featureNames = {
    smartReplies: 'Smart Replies',
    reviewReplies: 'Review-Antworten',
    autoPricing: 'Auto-Pricing'
  };
  
  showToast(automationSettings[feature] 
    ? `${featureNames[feature]} aktiviert` 
    : `${featureNames[feature]} deaktiviert`
  );
  
  // Start/stop message polling when smartReplies is toggled
  if (feature === 'smartReplies' && smoobuConfig.connected) {
    if (automationSettings.smartReplies) {
      startMessagePolling();
      requestNotificationPermission();
    } else {
      stopMessagePolling();
    }
  }
  
  // Re-render the page
  renderPage();
}

function activateAllAutomation() {
  // Only activate features user has access to
  if (canToggleAutomation('smartReplies')) {
    automationSettings.smartReplies = true;
    localStorage.setItem('auto_smart_replies', 'true');
  }
  if (canToggleAutomation('reviewReplies')) {
    automationSettings.reviewReplies = true;
    localStorage.setItem('auto_review_replies', 'true');
  }
  if (canToggleAutomation('autoPricing')) {
    automationSettings.autoPricing = true;
    localStorage.setItem('auto_pricing', 'true');
  }
  
  saveAutomationSettings();
  showToast('Automatisierungen aktiviert');
  renderPage();
}

async function saveAutomationSettings() {
  try {
    await db.from('profiles').update({
      // On/Off settings
      automation_smart_replies: automationSettings.smartReplies,
      automation_review_replies: automationSettings.reviewReplies,
      automation_pricing: automationSettings.autoPricing,
      automation_jobs: automationSettings.autoJobs,
      // Mode settings (manual/auto/hybrid)
      smart_replies_mode: automationSettings.smartRepliesMode,
      review_replies_mode: automationSettings.reviewRepliesMode,
      auto_pricing_mode: automationSettings.autoPricingMode,
      auto_jobs_mode: automationSettings.autoJobsMode,
      // AI settings
      ai_tone: automationSettings.aiTone,
      ai_language: automationSettings.aiLanguage,
      ai_learning: automationSettings.aiLearning,
      // AI Context (property infos, saved replies, feedback)
      ai_context: aiContext,
      // Smoobu settings
      smoobu_api_key: smoobuConfig.apiKey || null,
      smoobu_connected: smoobuConfig.connected,
      pricing_strategy: pricingData.strategy
    }).eq('id', user.id);
    
    // Also save to localStorage as backup
    localStorage.setItem('auto_smart_replies', automationSettings.smartReplies);
    localStorage.setItem('auto_review_replies', automationSettings.reviewReplies);
    localStorage.setItem('auto_pricing', automationSettings.autoPricing);
    localStorage.setItem('auto_jobs', automationSettings.autoJobs);
    localStorage.setItem('smart_replies_mode', automationSettings.smartRepliesMode);
    localStorage.setItem('review_replies_mode', automationSettings.reviewRepliesMode);
    localStorage.setItem('auto_pricing_mode', automationSettings.autoPricingMode);
    localStorage.setItem('auto_jobs_mode', automationSettings.autoJobsMode);
    localStorage.setItem('ai_tone', automationSettings.aiTone);
    localStorage.setItem('ai_language', automationSettings.aiLanguage);
    localStorage.setItem('ai_learning', automationSettings.aiLearning);
    localStorage.setItem('ai_context', JSON.stringify(aiContext));
    localStorage.setItem('pricing_strategy', pricingData.strategy);
    
  } catch (e) {
    console.log('Could not save to Supabase:', e);
  }
}

async function loadAutomationSettings() {
  try {
    const { data } = await db.from('profiles').select('*').eq('id', user.id).single();
    if (data) {
      // Load on/off settings
      if (data.automation_smart_replies !== undefined && data.automation_smart_replies !== null) {
        automationSettings.smartReplies = data.automation_smart_replies;
      }
      if (data.automation_review_replies !== undefined && data.automation_review_replies !== null) {
        automationSettings.reviewReplies = data.automation_review_replies;
      }
      if (data.automation_pricing !== undefined && data.automation_pricing !== null) {
        automationSettings.autoPricing = data.automation_pricing;
      }
      if (data.automation_jobs !== undefined && data.automation_jobs !== null) {
        automationSettings.autoJobs = data.automation_jobs;
      }
      
      // Load mode settings
      if (data.smart_replies_mode) {
        automationSettings.smartRepliesMode = data.smart_replies_mode;
      }
      if (data.review_replies_mode) {
        automationSettings.reviewRepliesMode = data.review_replies_mode;
      }
      if (data.auto_pricing_mode) {
        automationSettings.autoPricingMode = data.auto_pricing_mode;
      }
      if (data.auto_jobs_mode) {
        automationSettings.autoJobsMode = data.auto_jobs_mode;
      }
      
      // Load AI settings
      if (data.ai_tone) {
        automationSettings.aiTone = data.ai_tone;
      }
      if (data.ai_language) {
        automationSettings.aiLanguage = data.ai_language;
      }
      if (data.ai_learning !== undefined && data.ai_learning !== null) {
        automationSettings.aiLearning = data.ai_learning;
      }
      
      // Load AI Context
      if (data.ai_context) {
        aiContext = { ...aiContext, ...data.ai_context };
      }
      
      // Load Smoobu settings
      if (data.smoobu_api_key) {
        smoobuConfig.apiKey = data.smoobu_api_key;
        localStorage.setItem('smoobu_api_key', data.smoobu_api_key);
      }
      if (data.smoobu_connected !== undefined && data.smoobu_connected !== null) {
        smoobuConfig.connected = data.smoobu_connected;
        localStorage.setItem('smoobu_connected', data.smoobu_connected);
      }
      
      // Load Smoobu sync interval
      if (data.smoobu_sync_interval) {
        localStorage.setItem('smoobu_sync_interval', data.smoobu_sync_interval.toString());
      }
      
      // Load Smoobu last sync time
      if (data.smoobu_last_sync) {
        smoobuConfig.lastSync = data.smoobu_last_sync;
        localStorage.setItem('smoobu_last_sync', data.smoobu_last_sync);
      }
      
      // Load pricing strategy
      if (data.pricing_strategy) {
        pricingData.strategy = data.pricing_strategy;
        localStorage.setItem('pricing_strategy', data.pricing_strategy);
      }
    }
  } catch (e) {
    console.log('Using localStorage settings:', e);
    // Fallback to localStorage
    const localContext = localStorage.getItem('ai_context');
    if (localContext) {
      try {
        aiContext = { ...aiContext, ...JSON.parse(localContext) };
      } catch (parseError) {}
    }
  }
}

function calculateTimeSaved() {
  let hours = 0;
  if (automationSettings.smartReplies) hours += 2;
  if (automationSettings.reviewReplies) hours += 1;
  if (automationSettings.autoPricing) hours += 1.5;
  if (automationSettings.autoJobs) hours += 3;
  if (smoobuConfig.connected) hours += 2;
  return hours;
}

// Check if feature is enabled (used by other modules)
function isFeatureEnabled(feature) {
  return automationSettings[feature] === true;
}

// =====================
// SMOOBU FUNCTIONS
// =====================

async function connectSmoobu() {
  const apiKey = document.getElementById('smoobu-api-key').value.trim();
  if (!apiKey) {
    alert('Bitte API-Key eingeben');
    return;
  }
  
  // Show loading
  showModal(`
    <div style="text-align:center;padding:40px">
      <div class="spinner" style="margin:0 auto 20px"></div>
      <div style="font-size:16px;font-weight:600">Verbinde mit Smoobu...</div>
      <div style="color:#71717a;font-size:13px;margin-top:8px">API-Key wird √ºberpr√ºft</div>
    </div>
  `);
  
  try {
    // Test API connection via Edge Function
    const response = await fetch(`${SMOOBU_PROXY_URL}?action=me`, {
      method: 'GET',
      headers: { 
        'x-smoobu-key': apiKey,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (!response.ok || data.error) {
      throw new Error(data.error || data.details?.detail || 'API-Key ung√ºltig');
    }
    
    // Success! Save config
    smoobuConfig.apiKey = apiKey;
    smoobuConfig.connected = true;
    smoobuConfig.lastSync = new Date().toISOString();
    smoobuConfig.smoobuUser = data;
    
    // Save to localStorage
    localStorage.setItem('smoobu_api_key', apiKey);
    localStorage.setItem('smoobu_connected', 'true');
    localStorage.setItem('smoobu_last_sync', smoobuConfig.lastSync);
    
    // Save to Supabase
    await db.from('profiles').update({
      smoobu_connected: true,
      smoobu_last_sync: smoobuConfig.lastSync
    }).eq('id', user.id);
    
    hideModal();
    
    // Show success with user info
    showModal(`
      <div style="text-align:center;padding:20px">
        <div style="font-size:64px;margin-bottom:16px">‚úÖ</div>
        <div style="font-size:18px;font-weight:700;margin-bottom:8px">Erfolgreich verbunden!</div>
        <div style="color:#a1a1aa;margin-bottom:8px">Smoobu-Konto: ${data.firstName} ${data.lastName}</div>
        <div style="color:#71717a;font-size:12px;margin-bottom:24px">${data.email}</div>
        <button class="btn btn-primary" onclick="hideModal();syncSmoobuNow()" style="width:100%">üîÑ Daten jetzt synchronisieren</button>
      </div>
    `);
    
    // Start auto-sync
    startSmoobuAutoSync();
    
  } catch (error) {
    hideModal();
    showModal(`
      <div style="text-align:center;padding:20px">
        <div style="font-size:64px;margin-bottom:16px">‚ùå</div>
        <div style="font-size:18px;font-weight:700;margin-bottom:8px">Verbindung fehlgeschlagen</div>
        <div style="color:#ef4444;margin-bottom:24px;font-size:13px">${error.message}</div>
        <button class="btn btn-secondary" onclick="hideModal()" style="width:100%">Schlie√üen</button>
      </div>
    `);
  }
}

function disconnectSmoobu() {
  if (!confirm('Smoobu-Verbindung wirklich trennen?')) return;
  
  smoobuConfig.connected = false;
  smoobuConfig.apiKey = '';
  
  localStorage.removeItem('smoobu_api_key');
  localStorage.removeItem('smoobu_connected');
  localStorage.removeItem('smoobu_last_sync');
  
  if (smoobuConfig.syncInterval) {
    clearInterval(smoobuConfig.syncInterval);
  }
  
  // Update Supabase
  db.from('hosts').update({ smoobu_connected: false }).eq('id', user.id);
  
  renderPage();
}

async function syncSmoobuNow() {
  if (!smoobuConfig.apiKey) {
    alert('Bitte zuerst Smoobu verbinden');
    return;
  }
  
  showModal(`
    <div style="text-align:center;padding:40px">
      <div class="spinner" style="margin:0 auto 20px"></div>
      <div style="font-size:16px;font-weight:600">Synchronisiere...</div>
      <div style="color:#71717a;font-size:13px;margin-top:8px" id="sync-status">Lade Objekte...</div>
    </div>
  `);
  
  try {
    // Step 1: Sync Apartments from Smoobu
    document.getElementById('sync-status').textContent = 'Lade Objekte aus Smoobu...';
    
    const apartmentsRes = await fetch(`${SMOOBU_PROXY_URL}?action=apartments`, {
      headers: { 'x-smoobu-key': smoobuConfig.apiKey }
    });
    const apartmentsData = await apartmentsRes.json();
    
    if (apartmentsData.apartments) {
      smoobuConfig.smoobuApartments = apartmentsData.apartments;
      
      // Sync to Supabase
      for (const apt of apartmentsData.apartments) {
        try {
          // Get details for each apartment
          const detailRes = await fetch(`${SMOOBU_PROXY_URL}?action=apartment&id=${apt.id}`, {
            headers: { 'x-smoobu-key': smoobuConfig.apiKey }
          });
          const detail = await detailRes.json();
          
          // Check if property already exists
          const { data: existingProps } = await db.from('properties')
            .select('id')
            .eq('smoobu_id', apt.id)
            .limit(1);
          
          const existing = existingProps && existingProps.length > 0 ? existingProps[0] : null;
          
          if (existing) {
            // Update existing - ONLY update Smoobu-specific fields, preserve user edits
            // First get current data to preserve user-edited fields
            const { data: currentData } = await db.from('properties')
              .select('city, zip, street, bedrooms, max_guests, base_price')
              .eq('id', existing.id)
              .single();
            
            const propertyData = {
              host_id: user.id,
              smoobu_id: apt.id,
              name: apt.name,
              // Only update location if user hasn't set their own value
              city: currentData?.city || detail.location?.city || '',
              zip: currentData?.zip || detail.location?.zip || '',
              street: currentData?.street || detail.location?.street || '',
              country: detail.location?.country || '',
              // Preserve user edits for these fields
              bedrooms: currentData?.bedrooms || detail.rooms?.bedrooms || 1,
              max_guests: currentData?.max_guests || detail.rooms?.maxOccupancy || 2,
              base_price: currentData?.base_price || (detail.price?.minimal ? parseFloat(detail.price.minimal) : null),
              property_type: 'apartment',
              active: true
            };
            
            await db.from('properties').update(propertyData).eq('id', existing.id);
          } else {
            // Insert new - use Smoobu data as initial values
            const propertyData = {
              host_id: user.id,
              smoobu_id: apt.id,
              name: apt.name,
              city: detail.location?.city || '',
              zip: detail.location?.zip || '',
              street: detail.location?.street || '',
              country: detail.location?.country || '',
              bedrooms: detail.rooms?.bedrooms || 1,
              max_guests: detail.rooms?.maxOccupancy || 2,
              base_price: detail.price?.minimal ? parseFloat(detail.price.minimal) : null,
              property_type: 'apartment',
              active: true
            };
            
            await db.from('properties').insert(propertyData);
          }
        } catch (propError) {
          console.error('Error syncing property:', apt.id, propError);
        }
      }
    }
    
    // Step 2: Sync Bookings from Smoobu
    document.getElementById('sync-status').textContent = 'Lade Buchungen aus Smoobu...';
    
    const bookingsRes = await fetch(`${SMOOBU_PROXY_URL}?action=bookings`, {
      headers: { 'x-smoobu-key': smoobuConfig.apiKey }
    });
    const bookingsData = await bookingsRes.json();
    
    if (bookingsData.bookings && bookingsData.bookings.length > 0) {
      for (const booking of bookingsData.bookings) {
        try {
          // Find local property by smoobu_id
          const { data: localProps } = await db.from('properties')
            .select('id')
            .eq('smoobu_id', booking.apartment?.id)
            .limit(1);
          
          const localProp = localProps && localProps.length > 0 ? localProps[0] : null;
          
          if (localProp) {
            // Check if booking already exists
            const { data: existingBookings } = await db.from('bookings')
              .select('id')
              .eq('smoobu_id', booking.id)
              .limit(1);
            
            const existingBooking = existingBookings && existingBookings.length > 0 ? existingBookings[0] : null;
            
            const bookingData = {
              host_id: user.id,
              property_id: localProp.id,
              smoobu_id: booking.id,
              guest_name: booking['guest-name'] || 'Unbekannt',
              guest_email: booking.email || '',
              guest_phone: booking.phone || '',
              check_in: booking.arrival,
              check_out: booking.departure,
              total_price: booking.price || 0,
              adults: booking.adults || 1,
              children: booking.children || 0,
              status: booking.type === 'cancellation' ? 'cancelled' : 'confirmed',
              source: booking.channel?.name || 'Smoobu'
            };
            
            if (existingBooking) {
              // Update existing
              await db.from('bookings').update(bookingData).eq('id', existingBooking.id);
            } else {
              // Insert new
              await db.from('bookings').insert(bookingData);
            }
          }
        } catch (bookingError) {
          console.error('Error syncing booking:', booking.id, bookingError);
        }
      }
    }
    
    // Step 3: Update pricing data from Smoobu
    document.getElementById('sync-status').textContent = 'Lade Preise...';
    
    if (smoobuConfig.smoobuApartments.length > 0) {
      const today = new Date().toISOString().split('T')[0];
      const endDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      const apartmentIds = smoobuConfig.smoobuApartments.map(a => a.id).join(',');
      
      const ratesRes = await fetch(
        `${SMOOBU_PROXY_URL}?action=rates&apartments=${apartmentIds}&start_date=${today}&end_date=${endDate}`,
        { headers: { 'x-smoobu-key': smoobuConfig.apiKey } }
      );
      const ratesData = await ratesRes.json();
      
      // Update local pricing data
      if (ratesData.data) {
        pricingData.properties = smoobuConfig.smoobuApartments.map(apt => {
          const rates = ratesData.data[apt.id] || {};
          const prices = Object.values(rates).map(r => r.price).filter(p => p);
          const avgPrice = prices.length ? Math.round(prices.reduce((a,b) => a+b, 0) / prices.length) : 80;
          
          return {
            id: apt.id,
            name: apt.name,
            basePrice: avgPrice,
            currentPrice: avgPrice,
            suggestedPrice: Math.round(avgPrice * 1.1), // Simple suggestion: +10%
            occupancy: Math.round(Math.random() * 40 + 50), // Placeholder
            factors: ['Saison-Anpassung', 'Wochenend-Aufschlag']
          };
        });
      }
    }
    
    // Update last sync time
    smoobuConfig.lastSync = new Date().toISOString();
    localStorage.setItem('smoobu_last_sync', smoobuConfig.lastSync);
    
    // Save lastSync to Supabase for cross-device sync
    try {
      await db.from('profiles').update({
        smoobu_last_sync: smoobuConfig.lastSync
      }).eq('id', user.id);
    } catch (e) {
      console.log('Could not save lastSync to Supabase:', e);
    }
    
    // Reload data from Supabase
    await loadData();
    
    // Sync property count to Stripe for billing
    await syncPropertyUsage();
    
    hideModal();
    renderPage();
    
    // Show success toast
    const syncedProps = smoobuConfig.smoobuApartments.length;
    const syncedBookings = bookingsData.bookings?.length || 0;
    showToast(`‚úÖ Sync fertig: ${syncedProps} Objekte, ${syncedBookings} Buchungen`);
    
  } catch (error) {
    hideModal();
    console.error('Sync error:', error);
    showModal(`
      <div style="text-align:center;padding:20px">
        <div style="font-size:64px;margin-bottom:16px">‚ö†Ô∏è</div>
        <div style="font-size:18px;font-weight:700;margin-bottom:8px">Sync-Fehler</div>
        <div style="color:#ef4444;margin-bottom:24px;font-size:13px">${error.message}</div>
        <button class="btn btn-secondary" onclick="hideModal()" style="width:100%">Schlie√üen</button>
      </div>
    `);
  }
}

function startSmoobuAutoSync() {
  // Clear existing interval
  if (smoobuConfig.syncInterval) {
    clearInterval(smoobuConfig.syncInterval);
    smoobuConfig.syncInterval = null;
  }
  
  // Get saved interval (default: 60 minutes)
  const intervalMinutes = parseInt(localStorage.getItem('smoobu_sync_interval')) || 60;
  const intervalMs = intervalMinutes * 60 * 1000;
  
  console.log(`Auto-sync started: every ${intervalMinutes} minutes`);
  
  // Store next sync time
  const updateNextSync = () => {
    const nextSync = Date.now() + intervalMs;
    localStorage.setItem('smoobu_next_sync', nextSync.toString());
  };
  updateNextSync();
  
  // Check if sync is overdue (for when tab was inactive)
  const checkAndSync = async () => {
    if (!smoobuConfig.connected || !smoobuConfig.apiKey) return;
    
    const nextSync = parseInt(localStorage.getItem('smoobu_next_sync')) || 0;
    const now = Date.now();
    
    if (now >= nextSync) {
      console.log('Auto-sync running (was due)...');
      try {
        await syncSmoobuSilent();
        updateNextSync();
      } catch (e) {
        console.error('Auto-sync error:', e);
      }
    }
  };
  
  // Run sync on visibility change (when tab becomes active)
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      checkAndSync();
    }
  });
  
  // Also check on window focus
  window.addEventListener('focus', checkAndSync);
  
  // Regular interval (works when tab is active)
  smoobuConfig.syncInterval = setInterval(async () => {
    if (smoobuConfig.connected && smoobuConfig.apiKey) {
      console.log('Auto-sync Smoobu running...');
      try {
        await syncSmoobuSilent();
        updateNextSync();
      } catch (e) {
        console.error('Auto-sync error:', e);
      }
    }
  }, intervalMs);
  
  // Check immediately if sync is overdue
  setTimeout(checkAndSync, 2000);
}

// Silent sync (no modals, just background update)
async function syncSmoobuSilent() {
  try {
    // Sync Apartments
    const apartmentsRes = await fetch(`${SMOOBU_PROXY_URL}?action=apartments`, {
      headers: { 'x-smoobu-key': smoobuConfig.apiKey }
    });
    const apartmentsData = await apartmentsRes.json();
    
    if (apartmentsData.apartments) {
      smoobuConfig.smoobuApartments = apartmentsData.apartments;
      
      for (const apt of apartmentsData.apartments) {
        try {
          const detailRes = await fetch(`${SMOOBU_PROXY_URL}?action=apartment&id=${apt.id}`, {
            headers: { 'x-smoobu-key': smoobuConfig.apiKey }
          });
          const detail = await detailRes.json();
          
          const { data: existingProps } = await db.from('properties')
            .select('id, city, zip, street, bedrooms, max_guests, base_price')
            .eq('smoobu_id', apt.id)
            .limit(1);
          
          const existing = existingProps && existingProps.length > 0 ? existingProps[0] : null;
          
          if (existing) {
            // Update - preserve user-edited fields
            const propertyData = {
              host_id: user.id,
              smoobu_id: apt.id,
              name: apt.name,
              city: existing.city || detail.location?.city || '',
              zip: existing.zip || detail.location?.zip || '',
              street: existing.street || detail.location?.street || '',
              country: detail.location?.country || '',
              bedrooms: existing.bedrooms || detail.rooms?.bedrooms || 1,
              max_guests: existing.max_guests || detail.rooms?.maxOccupancy || 2,
              base_price: existing.base_price || (detail.price?.minimal ? parseFloat(detail.price.minimal) : null),
              property_type: 'apartment',
              active: true
            };
            await db.from('properties').update(propertyData).eq('id', existing.id);
          } else {
            // Insert new
            const propertyData = {
              host_id: user.id,
              smoobu_id: apt.id,
              name: apt.name,
              city: detail.location?.city || '',
              zip: detail.location?.zip || '',
              street: detail.location?.street || '',
              country: detail.location?.country || '',
              bedrooms: detail.rooms?.bedrooms || 1,
              max_guests: detail.rooms?.maxOccupancy || 2,
              base_price: detail.price?.minimal ? parseFloat(detail.price.minimal) : null,
              property_type: 'apartment',
              active: true
            };
            await db.from('properties').insert(propertyData);
          }
        } catch (e) {
          console.error('Silent sync property error:', apt.id, e);
        }
      }
    }
    
    // Sync Bookings
    const bookingsRes = await fetch(`${SMOOBU_PROXY_URL}?action=bookings`, {
      headers: { 'x-smoobu-key': smoobuConfig.apiKey }
    });
    const bookingsData = await bookingsRes.json();
    
    if (bookingsData.bookings && bookingsData.bookings.length > 0) {
      for (const booking of bookingsData.bookings) {
        try {
          const { data: localProps } = await db.from('properties')
            .select('id')
            .eq('smoobu_id', booking.apartment?.id)
            .limit(1);
          
          const localProp = localProps && localProps.length > 0 ? localProps[0] : null;
          
          if (localProp) {
            const { data: existingBookings } = await db.from('bookings')
              .select('id')
              .eq('smoobu_id', booking.id)
              .limit(1);
            
            const existingBooking = existingBookings && existingBookings.length > 0 ? existingBookings[0] : null;
            
            const bookingData = {
              host_id: user.id,
              property_id: localProp.id,
              smoobu_id: booking.id,
              guest_name: booking['guest-name'] || 'Unbekannt',
              guest_email: booking.email || '',
              guest_phone: booking.phone || '',
              check_in: booking.arrival,
              check_out: booking.departure,
              total_price: booking.price || 0,
              adults: booking.adults || 1,
              children: booking.children || 0,
              status: booking.type === 'cancellation' ? 'cancelled' : 'confirmed',
              source: booking.channel?.name || 'Smoobu'
            };
            
            if (existingBooking) {
              await db.from('bookings').update(bookingData).eq('id', existingBooking.id);
            } else {
              await db.from('bookings').insert(bookingData);
            }
          }
        } catch (e) {
          console.error('Silent sync booking error:', booking.id, e);
        }
      }
    }
    
    // Update last sync time
    smoobuConfig.lastSync = new Date().toISOString();
    localStorage.setItem('smoobu_last_sync', smoobuConfig.lastSync);
    
    // Save lastSync to Supabase for cross-device sync
    try {
      await db.from('profiles').update({
        smoobu_last_sync: smoobuConfig.lastSync
      }).eq('id', user.id);
    } catch (e) {
      console.log('Could not save lastSync to Supabase:', e);
    }
    
    // Reload data
    await loadData();
    
    // AUTO-PRICING: If mode is "auto", automatically upload optimized prices to Smoobu
    if (automationSettings.autoPricing && automationSettings.autoPricingMode === 'auto') {
      await autoUploadPricesToSmoobu();
    }
    
    // Update UI if on dashboard
    if (currentPage === 'dashboard' || currentPage === 'automation') {
      renderPage();
    }
    
    console.log('Auto-sync completed:', new Date().toLocaleTimeString());
    
  } catch (error) {
    console.error('Silent sync error:', error);
  }
}

// Automatically upload all optimized prices to Smoobu (when auto mode is enabled)
async function autoUploadPricesToSmoobu() {
  if (!smoobuConfig.connected || !smoobuConfig.apiKey) return;
  if (!pricingData.properties || pricingData.properties.length === 0) return;
  
  console.log('ü§ñ Auto-Pricing: Uploading optimized prices to Smoobu...');
  
  let totalUpdated = 0;
  let totalErrors = 0;
  
  for (const prop of pricingData.properties) {
    const dailyPrices = pricingData.dailyPrices[prop.id];
    if (!dailyPrices || dailyPrices.length === 0) continue;
    
    // Filter: only days that are not booked and not already applied
    const daysToUpdate = dailyPrices.filter(d => !d.isBooked && !d.applied);
    
    if (daysToUpdate.length === 0) {
      console.log(`‚úÖ ${prop.name}: All prices already synced`);
      continue;
    }
    
    console.log(`üì§ ${prop.name}: Uploading ${daysToUpdate.length} prices...`);
    
    // Batch update - send multiple dates at once for efficiency
    const batchSize = 10;
    for (let i = 0; i < daysToUpdate.length; i += batchSize) {
      const batch = daysToUpdate.slice(i, i + batchSize);
      
      const requestBody = {
        apartments: [parseInt(prop.id)],
        operations: batch.map(day => ({
          dates: [day.date],
          daily_price: day.finalPrice
        }))
      };
      
      try {
        const response = await fetch(`${SMOOBU_PROXY_URL}?action=update-rates`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-smoobu-key': smoobuConfig.apiKey
          },
          body: JSON.stringify(requestBody)
        });
        
        if (response.ok) {
          // Mark as applied
          batch.forEach(day => day.applied = true);
          totalUpdated += batch.length;
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error(`Error uploading prices for ${prop.name}:`, errorData);
          totalErrors += batch.length;
        }
      } catch (error) {
        console.error(`Network error uploading prices for ${prop.name}:`, error);
        totalErrors += batch.length;
      }
      
      // Small delay between batches to avoid rate limiting
      await new Promise(r => setTimeout(r, 200));
    }
  }
  
  if (totalUpdated > 0) {
    console.log(`‚úÖ Auto-Pricing: ${totalUpdated} prices uploaded to Smoobu`);
    showToast(`ü§ñ Auto-Pricing: ${totalUpdated} Preise zu Smoobu √ºbertragen`);
  }
  
  if (totalErrors > 0) {
    console.warn(`‚ö†Ô∏è Auto-Pricing: ${totalErrors} prices failed to upload`);
  }
}

function stopSmoobuAutoSync() {
  if (smoobuConfig.syncInterval) {
    clearInterval(smoobuConfig.syncInterval);
    smoobuConfig.syncInterval = null;
    console.log('Auto-sync stopped');
  }
}

// =====================
// MESSAGE POLLING & AUTO-REPLY SYSTEM
// =====================

let messagePollingInterval = null;
let lastKnownMessages = {}; // reservationId -> lastMessageId
let pendingAutoReplies = []; // Messages waiting for manual approval

// Load last known messages from localStorage
function loadLastKnownMessages() {
  try {
    const saved = localStorage.getItem('pilotstay_last_known_messages');
    if (saved) {
      lastKnownMessages = JSON.parse(saved);
      console.log('üìö Loaded lastKnownMessages:', Object.keys(lastKnownMessages).length, 'bookings');
    }
  } catch (e) {
    console.error('Error loading lastKnownMessages:', e);
    lastKnownMessages = {};
  }
}

// Save last known messages to localStorage
function saveLastKnownMessages() {
  try {
    localStorage.setItem('pilotstay_last_known_messages', JSON.stringify(lastKnownMessages));
  } catch (e) {
    console.error('Error saving lastKnownMessages:', e);
  }
}

// Debug function - call from console: debugAutoReply()
window.debugAutoReply = function() {
  console.log('========== AUTO-REPLY DEBUG ==========');
  console.log('üîó Smoobu connected:', smoobuConfig.connected);
  console.log('üîë API Key present:', !!smoobuConfig.apiKey);
  console.log('ü§ñ Smart Replies enabled:', automationSettings.smartReplies);
  console.log('‚öôÔ∏è Mode:', automationSettings.smartRepliesMode || 'manual');
  console.log('üìä Polling active:', !!messagePollingInterval);
  console.log('üìö Known message IDs:', Object.keys(lastKnownMessages).length, 'bookings');
  console.log('üí¨ Active chats:', chats.length);
  console.log('üìã Active bookings with smoobu_id:', bookings.filter(b => b.smoobu_id).length);
  
  // Check conditions
  const issues = [];
  if (!smoobuConfig.connected) issues.push('‚ùå Smoobu nicht verbunden');
  if (!smoobuConfig.apiKey) issues.push('‚ùå API Key fehlt');
  if (!automationSettings.smartReplies) issues.push('‚ùå Smart Replies deaktiviert');
  if (automationSettings.smartRepliesMode === 'off') issues.push('‚ùå Mode ist OFF');
  if (!messagePollingInterval) issues.push('‚ùå Polling l√§uft nicht');
  if (bookings.filter(b => b.smoobu_id).length === 0) issues.push('‚ùå Keine Buchungen mit Smoobu ID');
  
  if (issues.length === 0) {
    console.log('‚úÖ Alles OK - Auto-Reply sollte funktionieren');
    console.log('   ‚Üí Warte auf neue G√§stenachrichten...');
  } else {
    console.log('‚ö†Ô∏è Probleme gefunden:');
    issues.forEach(i => console.log('  ', i));
  }
  
  console.log('======================================');
  return { smoobuConfig, automationSettings, chats: chats.length, bookings: bookings.length };
};

// Start polling for new messages
function startMessagePolling() {
  if (messagePollingInterval) {
    clearInterval(messagePollingInterval);
  }
  
  // Load saved state
  loadLastKnownMessages();
  
  // Poll every 30 seconds for new messages
  const pollIntervalMs = 30 * 1000;
  
  console.log('‚úÖ Message polling started (every 30s)');
  console.log(`   Smart Replies: ${automationSettings.smartReplies ? 'ON' : 'OFF'}`);
  console.log(`   Mode: ${automationSettings.smartRepliesMode || 'manual'}`);
  
  // Initial poll after 5 seconds (give time for data to load)
  setTimeout(() => pollForNewMessages(), 5000);
  
  // Start interval
  messagePollingInterval = setInterval(() => {
    if (smoobuConfig.connected && smoobuConfig.apiKey) {
      pollForNewMessages();
    }
  }, pollIntervalMs);
}

function stopMessagePolling() {
  if (messagePollingInterval) {
    clearInterval(messagePollingInterval);
    messagePollingInterval = null;
    console.log('‚èπÔ∏è Message polling stopped');
  }
}

// Poll Smoobu for new messages across all reservations
async function pollForNewMessages() {
  if (!smoobuConfig.connected || !smoobuConfig.apiKey) {
    return; // Silent skip
  }
  if (!automationSettings.smartReplies) {
    return; // Silent skip
  }
  
  console.log('üîç Polling for new messages...');
  
  try {
    // Get recent bookings (active ones with potential messages)
    const activeBookings = bookings.filter(b => {
      if (!b.check_out) return false;
      const checkout = new Date(b.check_out);
      const now = new Date();
      // Include bookings that checked out within last 7 days or future
      return checkout >= new Date(now - 7 * 24 * 60 * 60 * 1000) && b.status !== 'cancelled';
    });
    
    console.log(`üìã Checking ${Math.min(activeBookings.length, 3)} bookings for new messages`);
    
    let newMessagesFound = 0;
    
    for (const booking of activeBookings.slice(0, 3)) { // Limit to 3 to reduce API calls
      if (!booking.smoobu_id) continue;
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
        
        const response = await fetch(
          `${SMOOBU_PROXY_URL}?action=messages&bookingId=${booking.smoobu_id}`,
          { 
            headers: { 'x-smoobu-key': smoobuConfig.apiKey },
            signal: controller.signal
          }
        );
        
        clearTimeout(timeoutId);
        
        if (!response.ok) continue;
        
        const data = await response.json();
        const messages = data.messages || data || [];
        
        if (!Array.isArray(messages) || messages.length === 0) continue;
        
        // Log message structure for debugging
        if (messages.length > 0 && !window._msgStructureLogged) {
          console.log('üìß Message structure sample:', JSON.stringify(messages[0], null, 2));
          window._msgStructureLogged = true;
        }
        
        // Check for new guest messages
        const lastKnown = lastKnownMessages[booking.smoobu_id] || '';
        
        // Message type detection for Smoobu
        // Smoobu API: type 1 = Host‚ÜíGuest, type 2 = Guest‚ÜíHost
        const isGuestMessage = (m) => {
          // First check if it's explicitly a HOST message (type 1)
          if (m.type === 1 || m.type === '1') {
            return false; // Definitely from host
          }
          
          // Safely convert to string for other checks
          const safeStr = (val) => val === null || val === undefined ? '' : String(val).toLowerCase();
          
          const typeVal = safeStr(m.type);
          const fromVal = safeStr(m.from);
          const dirVal = safeStr(m.direction);
          const senderVal = safeStr(m.sender);
          const sentByVal = safeStr(m.sent_by);
          
          // Check for HOST indicators first
          if (typeVal === 'host' || 
              typeVal === 'hosttoguest' ||
              typeVal === 'outgoing' ||
              fromVal === 'host' || 
              fromVal === 'me' ||
              fromVal === 'owner' ||
              dirVal === 'out' ||
              dirVal === 'outgoing' ||
              senderVal === 'host' ||
              senderVal === 'owner' ||
              sentByVal === 'host') {
            return false; // From host
          }
          
          // Now check for GUEST indicators
          // Smoobu uses type: 2 = Guest‚ÜíHost
          return m.type === 2 || 
                 m.type === '2' ||
                 typeVal === 'guest' || 
                 typeVal === 'incoming' || 
                 typeVal === 'guesttohost' ||
                 fromVal === 'guest' || 
                 dirVal === 'in' ||
                 dirVal === 'incoming' ||
                 senderVal === 'guest' ||
                 sentByVal === 'guest';
        };
        
        // Use message ID as string for comparison (handles both numeric and string IDs)
        const newGuestMessages = messages.filter(m => {
          const msgId = String(m.id || '');
          const isNew = !lastKnown || msgId > lastKnown;
          const isFromGuest = isGuestMessage(m);
          
          // Always log for debugging
          console.log(`   üìß Message ID=${msgId}, type=${m.type}, from=${m.from || 'undefined'} ‚Üí ${isFromGuest ? 'GUEST' : 'HOST'}, isNew=${isNew}`);
          
          if (isNew && isFromGuest) {
            console.log(`   üÜï New GUEST message detected!`);
          } else if (isNew && !isFromGuest) {
            console.log(`   ‚è≠Ô∏è Skipping HOST message (our own reply)`);
          }
          
          return isNew && isFromGuest;
        });
        
        // Update last known message (use max ID as string)
        const allIds = messages.map(m => String(m.id || '0'));
        const maxId = allIds.sort().pop() || '0';
        lastKnownMessages[booking.smoobu_id] = maxId;
        
        // Process new messages
        for (const msg of newGuestMessages) {
          newMessagesFound++;
          console.log(`üì® New message from ${booking.guest_name}: "${(msg.message || msg.text || '').substring(0, 50)}..."`);
          await handleNewGuestMessage(booking, msg);
        }
        
      } catch (e) {
        // Completely silent - network errors during polling are expected
      }
      
      // Small delay between bookings to avoid rate limits
      await new Promise(r => setTimeout(r, 200));
    }
    
    if (newMessagesFound > 0) {
      console.log(`‚úÖ Found ${newMessagesFound} new message(s)`);
    }
    
    // Save updated lastKnownMessages
    saveLastKnownMessages();
    
  } catch (error) {
    // Silent - polling errors are non-critical
  }
}

// Handle a new guest message
async function handleNewGuestMessage(booking, message) {
  const messageText = message.message || message.text || message.body || '';
  const guestName = booking.guest_name || 'Gast';
  
  console.log(`üì© Processing message from ${guestName}: "${messageText.substring(0, 50)}..."`);
  console.log(`   Mode: ${automationSettings.smartRepliesMode || 'manual'}`);
  
  // Find property for context
  const property = properties.find(p => p.id === booking.property_id);
  const propertyContext = property ? aiContext.properties[property.smoobu_id || property.id] : null;
  
  // Update local chat data
  let chat = chats.find(c => c.smoobuId === booking.smoobu_id || c.bookingId === booking.smoobu_id);
  if (!chat) {
    // Create new chat entry
    console.log(`   Creating new chat entry for ${guestName}`);
    chat = {
      id: booking.smoobu_id,
      bookingId: booking.smoobu_id,
      smoobuId: booking.smoobu_id,
      name: guestName,
      avatar: guestName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase(),
      platform: booking.source?.toLowerCase().includes('airbnb') ? 'airbnb' : 
                booking.source?.toLowerCase().includes('booking') ? 'booking' : 'direct',
      property: property?.name || 'Unbekannt',
      checkIn: booking.check_in,
      checkOut: booking.check_out,
      unread: 0,
      lastMsg: '',
      time: new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}),
      propertyId: property?.id,
      messages: []
    };
    chats.unshift(chat);
  }
  
  // Add message to chat
  const newMsg = {
    id: 'smoobu_' + message.id,
    from: 'them',
    text: messageText,
    time: new Date(message.created_at || Date.now()).toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}),
    timestamp: message.created_at || new Date().toISOString(),
    smoobuId: message.id
  };
  
  // Check if message already exists
  if (!chat.messages.find(m => m.id === newMsg.id)) {
    chat.messages.push(newMsg);
    chat.unread++;
    chat.lastMsg = messageText.substring(0, 50);
    chat.time = newMsg.time;
    console.log(`   Added message to chat (now ${chat.messages.length} messages)`);
  } else {
    console.log(`   Message already exists, skipping`);
    return;
  }
  
  // Determine action based on mode
  const mode = automationSettings.smartRepliesMode || 'manual';
  const isSimple = isSimpleQuestion(messageText);
  console.log(`   Question type: ${isSimple ? 'SIMPLE' : 'COMPLEX'}`);
  
  if (mode === 'manual') {
    console.log(`   Mode=manual ‚Üí Just notification`);
    showNotification(`üí¨ ${guestName}`, messageText.substring(0, 100));
    renderPage();
    return;
  }
  
  if (mode === 'hybrid' && !isSimple) {
    console.log(`   Mode=hybrid + COMPLEX ‚Üí Manual approval needed`);
    showNotification(`‚ö†Ô∏è Manuelle Pr√ºfung`, `${guestName}: ${messageText.substring(0, 80)}`);
    
    // Add to pending queue
    pendingAutoReplies.push({
      booking,
      message: newMsg,
      chat,
      property,
      timestamp: Date.now()
    });
    
    renderPage();
    return;
  }
  
  // Auto mode or simple question in hybrid mode - generate and send reply
  console.log(`   Mode=${mode} ‚Üí Generating auto-reply...`);
  try {
    showNotification('ü§ñ Generiere Antwort...', guestName);
    
    const reply = await generateAutoReplyForMessage(chat, newMsg, property, propertyContext);
    
    if (reply) {
      // Send via Smoobu
      const sendResult = await sendMessageViaSmoobu(booking.smoobu_id, reply);
      
      if (sendResult.success) {
        // Add to local chat
        const replyMsg = {
          id: 'auto_' + Date.now(),
          from: 'me',
          text: reply,
          time: new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}),
          ai: true,
          autoSent: true,
          needsFeedback: automationSettings.aiLearning
        };
        
        chat.messages.push(replyMsg);
        chat.lastMsg = reply;
        chat.unread = 0;
        
        showNotification('‚úÖ Auto-Reply gesendet', `An ${guestName}`);
        console.log(`Auto-reply sent to ${guestName}: ${reply.substring(0, 50)}...`);
        
        // Track for learning (simple console log for now)
        if (automationSettings.aiLearning) {
          console.log('üìä AI Usage tracked:', {
            type: 'auto-reply',
            guestMessage: messageText.substring(0, 50),
            aiResponse: reply.substring(0, 50),
            autoSent: true
          });
        }
      } else {
        console.error('Failed to send auto-reply:', sendResult.error);
        showNotification('‚ùå Senden fehlgeschlagen', sendResult.error);
      }
    }
    
  } catch (error) {
    console.error('Auto-reply error:', error);
    showNotification('‚ùå KI-Fehler', error.message);
  }
  
  renderPage();
}

// Generate auto-reply for a message
async function generateAutoReplyForMessage(chat, message, property, propertyContext) {
  // Get conversation history
  const history = chat.messages.slice(-6).map(m => m.text);
  
  // Build context
  let contextInfo = '';
  if (property) {
    contextInfo = `Objekt: ${property.name}\n`;
    if (propertyContext) {
      if (propertyContext.wifi) contextInfo += `WLAN: ${propertyContext.wifi}\n`;
      if (propertyContext.parking) contextInfo += `Parkplatz: ${propertyContext.parking}\n`;
      if (propertyContext.checkin) contextInfo += `Check-in: ${propertyContext.checkin}\n`;
      if (propertyContext.checkout) contextInfo += `Check-out: ${propertyContext.checkout}\n`;
      if (propertyContext.houseRules) contextInfo += `Hausregeln: ${propertyContext.houseRules}\n`;
    }
  }
  
  try {
    const session = await db.auth.getSession();
    const token = session?.data?.session?.access_token || '';
    
    const response = await fetch(AI_PROXY_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({
        action: 'auto-reply',
        data: {
          guestName: chat.name,
          guestMessage: message.text,
          conversationHistory: history,
          propertyContext: contextInfo,
          tone: automationSettings.aiTone || 'friendly',
          language: automationSettings.aiLanguage || 'de'
        }
      })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'AI request failed');
    }
    
    const data = await response.json();
    return data.reply;
    
  } catch (error) {
    console.error('Generate auto-reply error:', error);
    
    // Fallback to simple response
    return getSimpleFallbackReply(message.text);
  }
}

// Simple fallback reply if AI fails
function getSimpleFallbackReply(messageText) {
  const text = messageText.toLowerCase();
  
  if (text.includes('wifi') || text.includes('wlan') || text.includes('internet')) {
    const ctx = Object.values(aiContext.properties)[0];
    if (ctx?.wifi) return `Das WLAN-Passwort ist: ${ctx.wifi} üì∂`;
    return 'Die WLAN-Zugangsdaten findest du in der Wohnung - ich schicke sie dir gleich! üì∂';
  }
  
  if (text.includes('check-in') || text.includes('checkin') || text.includes('ankommen')) {
    const ctx = Object.values(aiContext.properties)[0];
    if (ctx?.checkin) return `Check-in ist ab ${ctx.checkin}. Ich melde mich wenn alles bereit ist! üîë`;
    return 'Check-in ist ab 15:00 Uhr. Ich melde mich rechtzeitig! üîë';
  }
  
  if (text.includes('checkout') || text.includes('abreise')) {
    const ctx = Object.values(aiContext.properties)[0];
    if (ctx?.checkout) return `Check-out ist bis ${ctx.checkout}. Gute Heimreise! üëã`;
    return 'Check-out ist bis 11:00 Uhr. Gute Heimreise! üëã';
  }
  
  if (text.includes('danke') || text.includes('super') || text.includes('toll')) {
    return 'Freut mich sehr! Bei Fragen einfach melden. üòä';
  }
  
  // Default - don't auto-reply with generic message
  return null;
}

// Send message via Smoobu API
async function sendMessageViaSmoobu(reservationId, messageText) {
  try {
    const response = await fetch(`${SMOOBU_PROXY_URL}?action=send-message`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-smoobu-key': smoobuConfig.apiKey
      },
      body: JSON.stringify({
        bookingId: reservationId,
        messageBody: messageText
      })
    });
    
    if (response.ok) {
      return { success: true };
    } else {
      const error = await response.json();
      return { success: false, error: error.message || 'Senden fehlgeschlagen' };
    }
  } catch (error) {
    return { success: false, error: error.message };
  }
}

// Show browser notification
function showNotification(title, body) {
  // Show in-app toast
  showToast(`${title}: ${body}`);
  
  // Try browser notification if permitted
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(title, { body, icon: 'üè†' });
  }
}

// Request notification permission
function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        showToast('‚úÖ Benachrichtigungen aktiviert');
      }
    });
  }
}

// View pending auto-replies (for hybrid mode)
function showPendingReplies() {
  if (pendingAutoReplies.length === 0) {
    showToast('‚úÖ Keine ausstehenden Nachrichten');
    return;
  }
  
  const list = pendingAutoReplies.map((item, idx) => `
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
        <div>
          <div style="font-weight:600">${item.chat.name}</div>
          <div style="font-size:11px;color:#71717a">${item.property?.name || 'Unbekanntes Objekt'}</div>
        </div>
        <span class="tag tag-orange">Ausstehend</span>
      </div>
      <div style="background:#18181b;padding:10px;border-radius:8px;font-size:13px;margin-bottom:12px">
        "${item.message.text}"
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-sm btn-ai" onclick="approvePendingReply(${idx})">ü§ñ KI antworten</button>
        <button class="btn btn-sm btn-secondary" onclick="openChatForPending(${idx})">‚úèÔ∏è Manuell</button>
        <button class="btn btn-sm btn-secondary" onclick="dismissPendingReply(${idx})" style="color:#ef4444">‚úï</button>
      </div>
    </div>
  `).join('');
  
  showModal(`
    <div class="modal-title">‚ö†Ô∏è Ausstehende Nachrichten (${pendingAutoReplies.length})</div>
    <div style="font-size:13px;color:#a1a1aa;margin-bottom:16px">
      Diese Nachrichten brauchen deine Pr√ºfung (Hybrid-Modus)
    </div>
    <div style="max-height:400px;overflow-y:auto">
      ${list}
    </div>
    <button class="btn btn-secondary" onclick="hideModal()" style="width:100%;margin-top:12px">Schlie√üen</button>
  `);
}

async function approvePendingReply(idx) {
  const item = pendingAutoReplies[idx];
  if (!item) return;
  
  hideModal();
  showToast('ü§ñ Generiere Antwort...');
  
  const propertyContext = item.property ? aiContext.properties[item.property.smoobu_id || item.property.id] : null;
  const reply = await generateAutoReplyForMessage(item.chat, item.message, item.property, propertyContext);
  
  if (reply) {
    // Show for approval before sending
    showModal(`
      <div class="modal-title">ü§ñ KI-Antwort pr√ºfen</div>
      <div style="margin-bottom:12px">
        <div style="font-size:12px;color:#71717a">Nachricht von ${item.chat.name}:</div>
        <div style="background:#18181b;padding:10px;border-radius:8px;font-size:13px;margin-top:4px">"${item.message.text}"</div>
      </div>
      <div style="margin-bottom:16px">
        <div style="font-size:12px;color:#71717a">KI-Antwort:</div>
        <textarea id="pending-reply-text" class="input" style="min-height:100px;margin-top:4px">${reply}</textarea>
      </div>
      <div style="display:flex;gap:12px">
        <button class="btn btn-secondary" onclick="hideModal();showPendingReplies()" style="flex:1">Zur√ºck</button>
        <button class="btn btn-ai" onclick="sendApprovedReply(${idx})" style="flex:1">üì§ Senden</button>
      </div>
    `);
  } else {
    showToast('‚ùå Konnte keine Antwort generieren');
    showPendingReplies();
  }
}

async function sendApprovedReply(idx) {
  const item = pendingAutoReplies[idx];
  if (!item) return;
  
  const replyText = document.getElementById('pending-reply-text').value.trim();
  if (!replyText) return;
  
  hideModal();
  
  const result = await sendMessageViaSmoobu(item.booking.smoobu_id, replyText);
  
  if (result.success) {
    // Add to chat
    item.chat.messages.push({
      id: 'approved_' + Date.now(),
      from: 'me',
      text: replyText,
      time: new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}),
      ai: true
    });
    item.chat.unread = 0;
    item.chat.lastMsg = replyText;
    
    // Remove from pending
    pendingAutoReplies.splice(idx, 1);
    
    showToast('‚úÖ Nachricht gesendet!');
  } else {
    showToast('‚ùå Senden fehlgeschlagen: ' + result.error);
  }
  
  renderPage();
}

function openChatForPending(idx) {
  const item = pendingAutoReplies[idx];
  if (!item) return;
  
  hideModal();
  activeChat = item.chat.id;
  setPage('chat');
  
  // Remove from pending
  pendingAutoReplies.splice(idx, 1);
}

function dismissPendingReply(idx) {
  pendingAutoReplies.splice(idx, 1);
  if (pendingAutoReplies.length === 0) {
    hideModal();
  } else {
    showPendingReplies();
  }
}

function getSyncIntervalDisplay() {
  const interval = localStorage.getItem('smoobu_sync_interval') || '5';
  if (interval === '1') return '1 Min';
  if (interval === '60') return '1 Std';
  return interval + ' Min';
}

function showSmoobuSettings() {
  const currentInterval = localStorage.getItem('smoobu_sync_interval') || '5';
  
  showModal(`
    <div class="modal-title">‚öôÔ∏è Smoobu Einstellungen</div>
    
    <div style="margin-bottom:20px">
      <label class="label">Sync-Intervall</label>
      <select class="input" id="sync-interval">
        <option value="1" ${currentInterval === '1' ? 'selected' : ''}>Jede Minute</option>
        <option value="5" ${currentInterval === '5' ? 'selected' : ''}>Alle 5 Minuten</option>
        <option value="15" ${currentInterval === '15' ? 'selected' : ''}>Alle 15 Minuten</option>
        <option value="30" ${currentInterval === '30' ? 'selected' : ''}>Alle 30 Minuten</option>
        <option value="60" ${currentInterval === '60' ? 'selected' : ''}>St√ºndlich</option>
      </select>
      <div style="font-size:11px;color:#71717a;margin-top:6px">
        Automatische Synchronisierung mit Smoobu im Hintergrund
      </div>
    </div>
    
    <div style="margin-bottom:20px">
      <label class="label">Was synchronisieren?</label>
      <div style="display:flex;flex-direction:column;gap:12px;margin-top:8px">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
          <input type="checkbox" id="sync-properties" checked> <span>Objekte/Apartments</span>
        </label>
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
          <input type="checkbox" id="sync-bookings" checked> <span>Buchungen</span>
        </label>
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
          <input type="checkbox" id="sync-prices" checked> <span>Preise/Raten</span>
        </label>
      </div>
    </div>
    
    <div style="padding:12px;background:#18181b;border-radius:10px;margin-bottom:20px">
      <div style="font-size:12px;color:#71717a">API-Key (versteckt)</div>
      <div style="font-family:monospace;font-size:13px;margin-top:4px">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢${smoobuConfig.apiKey.slice(-8)}</div>
    </div>
    
    <div style="display:flex;gap:12px">
      <button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Abbrechen</button>
      <button class="btn btn-primary" onclick="saveSmoobuSettings()" style="flex:1">üíæ Speichern</button>
    </div>
  `);
}

async function saveSmoobuSettings() {
  // Save sync interval
  const interval = document.getElementById('sync-interval').value;
  localStorage.setItem('smoobu_sync_interval', interval);
  
  // Save to Supabase
  try {
    await db.from('profiles').update({
      smoobu_sync_interval: parseInt(interval)
    }).eq('id', user.id);
  } catch (e) {
    console.log('Could not save interval to Supabase:', e);
  }
  
  // Restart auto-sync with new interval
  startSmoobuAutoSync();
  
  hideModal();
  showToast(`‚úÖ Sync-Intervall auf ${interval === '1' ? '1 Minute' : interval + ' Minuten'} gesetzt`);
  renderPage();
}

function showToast(message) {
  const toast = document.createElement('div');
  toast.style.cssText = 'position:fixed;bottom:24px;right:24px;background:#22c55e;color:#fff;padding:12px 20px;border-radius:10px;font-size:14px;font-weight:600;z-index:9999;animation:slideIn .3s ease';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// Check Smoobu connection on load
function checkSmoobuConnection() {
  const connected = localStorage.getItem('smoobu_connected') === 'true';
  const apiKey = localStorage.getItem('smoobu_api_key');
  const lastSync = localStorage.getItem('smoobu_last_sync');
  
  if (connected && apiKey) {
    smoobuConfig.connected = true;
    smoobuConfig.apiKey = apiKey;
    smoobuConfig.lastSync = lastSync;
    startSmoobuAutoSync();
    
    // Start message polling for auto-replies
    if (automationSettings.smartReplies) {
      startMessagePolling();
      requestNotificationPermission();
    }
  }
}

function renderSettings() {
  const tabs = [
    { id: 'profile', icon: 'üë§', label: 'Profil' },
    { id: 'address', icon: 'üè†', label: 'Adresse' },
    { id: 'company', icon: 'üè¢', label: 'Unternehmen' },
    { id: 'payment', icon: 'üí≥', label: 'Zahlung' },
    { id: 'help', icon: 'üéì', label: 'Hilfe' },
    { id: 'danger', icon: '‚ö†Ô∏è', label: 'Gefahrenzone' }
  ];
  
  const renderTabNav = () => `
    <div style="display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap">
      ${tabs.map(tab => `
        <button 
          class="btn ${settingsTab === tab.id ? (tab.id === 'danger' ? 'btn-secondary' : 'btn-primary') : 'btn-secondary'}" 
          onclick="setSettingsTab('${tab.id}')"
          style="font-size:13px;padding:10px 16px;${tab.id === 'danger' && settingsTab === 'danger' ? 'border-color:#ef4444;color:#ef4444' : ''}"
        >
          ${tab.icon} ${tab.label}
        </button>
      `).join('')}
    </div>
  `;
  
  const renderProfileTab = () => `
    <div class="card">
      <div class="card-title">üë§ Pers√∂nliche Daten</div>
      <p style="color:#a1a1aa;font-size:13px;margin-bottom:20px">
        Deine grundlegenden Kontaktinformationen
      </p>
      <div class="grid-2" style="gap:16px;margin-bottom:20px">
        <div><label class="label">Vorname</label><input class="input" value="${profile?.first_name || ''}" id="s-fn"></div>
        <div><label class="label">Nachname</label><input class="input" value="${profile?.last_name || ''}" id="s-ln"></div>
      </div>
      <div style="margin-bottom:20px">
        <label class="label">E-Mail</label>
        <input class="input" value="${user?.email || ''}" disabled style="opacity:0.6">
        <div style="font-size:11px;color:#71717a;margin-top:4px">E-Mail kann nicht ge√§ndert werden</div>
      </div>
      <div style="margin-bottom:20px">
        <label class="label">Telefon</label>
        <input class="input" value="${profile?.phone || ''}" placeholder="+49 123 456789" id="s-ph">
      </div>
      <button class="btn btn-primary" onclick="saveProfileTab('profile')">üíæ Speichern</button>
    </div>
  `;
  
  const renderAddressTab = () => `
    <div class="card">
      <div class="card-title">üè† Adresse</div>
      <p style="color:#a1a1aa;font-size:13px;margin-bottom:20px">
        Deine Anschrift f√ºr Rechnungen und Korrespondenz
      </p>
      <div style="margin-bottom:16px">
        <label class="label">Stra√üe & Hausnummer</label>
        <input class="input" value="${profile?.street || ''}" placeholder="Musterstra√üe 123" id="s-street">
      </div>
      <div class="grid-2" style="gap:16px;margin-bottom:16px">
        <div><label class="label">PLZ</label><input class="input" value="${profile?.zip || ''}" placeholder="10115" id="s-zip"></div>
        <div><label class="label">Stadt</label><input class="input" value="${profile?.city || ''}" placeholder="Berlin" id="s-city"></div>
      </div>
      <div style="margin-bottom:20px">
        <label class="label">Land</label>
        <select class="input" id="s-country">
          <option value="DE" ${(profile?.country || 'DE') === 'DE' ? 'selected' : ''}>üá©üá™ Deutschland</option>
          <option value="AT" ${profile?.country === 'AT' ? 'selected' : ''}>üá¶üáπ √ñsterreich</option>
          <option value="CH" ${profile?.country === 'CH' ? 'selected' : ''}>üá®üá≠ Schweiz</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="saveProfileTab('address')">üíæ Speichern</button>
    </div>
  `;
  
  const renderCompanyTab = () => `
    <div class="card">
      <div class="card-title">üè¢ Unternehmensdaten</div>
      <p style="color:#a1a1aa;font-size:13px;margin-bottom:20px">
        Optional ‚Äì f√ºr Rechnungen und gesch√§ftliche Zwecke
      </p>
      
      <div style="background:#18181b;padding:12px;border-radius:8px;margin-bottom:20px;font-size:12px;color:#a1a1aa">
        <strong style="color:#f97316">üí° Tipp:</strong> Diese Angaben werden f√ºr die Erstellung von Rechnungen und steuerliche Dokumentation verwendet.
      </div>
      
      <div style="margin-bottom:16px">
        <label class="label">Firmenname</label>
        <input class="input" value="${profile?.company_name || ''}" placeholder="Meine Ferienwohnungen GmbH" id="s-company">
      </div>
      <div class="grid-2" style="gap:16px;margin-bottom:20px">
        <div>
          <label class="label">USt-IdNr.</label>
          <input class="input" value="${profile?.vat_id || ''}" placeholder="DE123456789" id="s-vat">
          <div style="font-size:10px;color:#71717a;margin-top:4px">Umsatzsteuer-Identifikationsnummer</div>
        </div>
        <div>
          <label class="label">Steuernummer</label>
          <input class="input" value="${profile?.tax_number || ''}" placeholder="12/345/67890" id="s-tax">
          <div style="font-size:10px;color:#71717a;margin-top:4px">Vom Finanzamt zugewiesen</div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="saveProfileTab('company')">üíæ Speichern</button>
    </div>
  `;
  
  const renderPaymentTab = () => `
    <div class="card">
      <div class="card-title">üí≥ Zahlungsinformationen</div>
      <p style="color:#a1a1aa;font-size:13px;margin-bottom:20px">
        F√ºr zuk√ºnftige Auszahlungen und Abrechnungen
      </p>
      
      <div style="background:#22c55e15;border:1px solid #22c55e30;padding:12px;border-radius:8px;margin-bottom:20px;font-size:12px;color:#22c55e">
        üîí Deine Daten werden verschl√ºsselt gespeichert und niemals an Dritte weitergegeben.
      </div>
      
      <div style="margin-bottom:16px">
        <label class="label">IBAN</label>
        <input class="input" value="${profile?.iban || ''}" placeholder="DE89 3704 0044 0532 0130 00" id="s-iban" style="font-family:monospace">
      </div>
      <div style="margin-bottom:20px">
        <label class="label">Kontoinhaber</label>
        <input class="input" value="${profile?.account_holder || ''}" placeholder="Max Mustermann" id="s-holder">
      </div>
      <button class="btn btn-primary" onclick="saveProfileTab('payment')">üíæ Speichern</button>
    </div>
    
    <div class="card" style="margin-top:16px;background:linear-gradient(135deg,#131316,#3b82f608);border-color:#3b82f630">
      <div class="card-title">üìä Zahlungs√ºbersicht</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px">
        <div style="background:#18181b;padding:16px;border-radius:10px;text-align:center">
          <div style="font-size:11px;color:#71717a;margin-bottom:4px">Gesamtumsatz</div>
          <div style="font-size:20px;font-weight:700;color:#22c55e">‚Ç¨ ${bookings.reduce((sum, b) => sum + (b.total_price || 0), 0).toLocaleString('de-DE')}</div>
        </div>
        <div style="background:#18181b;padding:16px;border-radius:10px;text-align:center">
          <div style="font-size:11px;color:#71717a;margin-bottom:4px">Buchungen</div>
          <div style="font-size:20px;font-weight:700;color:#3b82f6">${bookings.length}</div>
        </div>
        <div style="background:#18181b;padding:16px;border-radius:10px;text-align:center">
          <div style="font-size:11px;color:#71717a;margin-bottom:4px">√ò pro Buchung</div>
          <div style="font-size:20px;font-weight:700;color:#8b5cf6">‚Ç¨ ${bookings.length > 0 ? Math.round(bookings.reduce((sum, b) => sum + (b.total_price || 0), 0) / bookings.length).toLocaleString('de-DE') : '0'}</div>
        </div>
      </div>
    </div>
  `;
  
  const renderHelpTab = () => `
    <div class="card">
      <div class="card-title">üéì Tutorial & Einf√ºhrung</div>
      <p style="color:#a1a1aa;font-size:13px;margin-bottom:16px">
        M√∂chtest du das interaktive Tutorial nochmal durchlaufen?
      </p>
      <button class="btn btn-secondary" onclick="resetTutorial()">
        üîÑ Tutorial erneut starten
      </button>
    </div>
    
    <div class="card" style="margin-top:16px">
      <div class="card-title">üìö Ressourcen</div>
      <div style="display:flex;flex-direction:column;gap:12px;margin-top:16px">
        <a href="https://pilotstay.de/docs" target="_blank" class="btn btn-secondary" style="justify-content:flex-start;text-decoration:none">
          üìñ Dokumentation & FAQ
        </a>
        <a href="https://pilotstay.de/support" target="_blank" class="btn btn-secondary" style="justify-content:flex-start;text-decoration:none">
          üí¨ Support kontaktieren
        </a>
        <a href="https://pilotstay.de/feedback" target="_blank" class="btn btn-secondary" style="justify-content:flex-start;text-decoration:none">
          üêõ Fehler melden
        </a>
        <a href="https://pilotstay.de/changelog" target="_blank" class="btn btn-secondary" style="justify-content:flex-start;text-decoration:none">
          üìù Changelog
        </a>
      </div>
    </div>
    
    <div class="card" style="margin-top:16px;background:linear-gradient(135deg,#131316,#8b5cf608);border-color:#8b5cf630">
      <div class="card-title">‚ÑπÔ∏è App-Informationen</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:12px;font-size:13px;color:#a1a1aa">
        <div style="display:flex;justify-content:space-between">
          <span>Version</span>
          <span style="color:#fff">0.1 Beta</span>
        </div>
        <div style="display:flex;justify-content:space-between">
          <span>Letztes Update</span>
          <span style="color:#fff">Februar 2026</span>
        </div>
        <div style="display:flex;justify-content:space-between">
          <span>Plan</span>
          <span style="color:#f97316">${getCurrentPlan() ? (getCurrentPlan().charAt(0).toUpperCase() + getCurrentPlan().slice(1)) : 'Kein Plan'}</span>
        </div>
        <div style="display:flex;justify-content:space-between">
          <span>Account-Typ</span>
          <span style="color:#fff">${isAdmin() ? 'Administrator' : 'Host'}</span>
        </div>
      </div>
    </div>
  `;
  
  const renderDangerTab = () => `
    <div class="card" style="border-color:#ef444430">
      <div class="card-title" style="color:#ef4444">‚ö†Ô∏è Gefahrenzone</div>
      <div style="color:#a1a1aa;font-size:13px;margin-bottom:20px">
        Achtung: Diese Aktionen k√∂nnen nicht r√ºckg√§ngig gemacht werden.
      </div>
      
      <div style="background:#ef444410;border:1px solid #ef444430;border-radius:6px;padding:16px;margin-bottom:16px">
        <div style="font-weight:600;margin-bottom:8px;color:#ef4444">üö™ Abmelden</div>
        <div style="font-size:12px;color:#a1a1aa;margin-bottom:12px">
          Du wirst von deinem Account abgemeldet und musst dich erneut anmelden.
        </div>
        <button class="btn btn-secondary" style="color:#ef4444;border-color:#ef444440" onclick="confirmLogout()">
          Abmelden
        </button>
      </div>
      
      <div style="background:#ef444410;border:1px solid #ef444430;border-radius:6px;padding:16px">
        <div style="font-weight:600;margin-bottom:8px;color:#ef4444">üóëÔ∏è Konto l√∂schen</div>
        <div style="font-size:12px;color:#a1a1aa;margin-bottom:12px">
          <strong>Diese Aktion ist unwiderruflich!</strong><br>
          Alle deine Daten, Objekte, Buchungen und dein Abo werden dauerhaft gel√∂scht.
        </div>
        <button class="btn" style="background:#ef4444;color:#fff;border:none" onclick="confirmDeleteAccount()">
          üóëÔ∏è Konto endg√ºltig l√∂schen
        </button>
      </div>
    </div>
  `;
  
  let tabContent;
  switch(settingsTab) {
    case 'profile': tabContent = renderProfileTab(); break;
    case 'address': tabContent = renderAddressTab(); break;
    case 'company': tabContent = renderCompanyTab(); break;
    case 'payment': tabContent = renderPaymentTab(); break;
    case 'help': tabContent = renderHelpTab(); break;
    case 'danger': tabContent = renderDangerTab(); break;
    default: tabContent = renderProfileTab();
  }
  
  return renderTabNav() + tabContent;
}

function setSettingsTab(tab) {
  settingsTab = tab;
  renderPage();
}

async function saveProfileTab(tab) {
  let updateData = {};
  
  switch(tab) {
    case 'profile':
      updateData = {
        first_name: document.getElementById('s-fn')?.value?.trim() || null,
        last_name: document.getElementById('s-ln')?.value?.trim() || null,
        phone: document.getElementById('s-ph')?.value?.trim() || null
      };
      break;
    case 'address':
      updateData = {
        street: document.getElementById('s-street')?.value?.trim() || null,
        zip: document.getElementById('s-zip')?.value?.trim() || null,
        city: document.getElementById('s-city')?.value?.trim() || null,
        country: document.getElementById('s-country')?.value || 'DE'
      };
      break;
    case 'company':
      updateData = {
        company_name: document.getElementById('s-company')?.value?.trim() || null,
        vat_id: document.getElementById('s-vat')?.value?.trim() || null,
        tax_number: document.getElementById('s-tax')?.value?.trim() || null
      };
      break;
    case 'payment':
      updateData = {
        iban: document.getElementById('s-iban')?.value?.trim() || null,
        account_holder: document.getElementById('s-holder')?.value?.trim() || null
      };
      break;
  }
  
  const {error} = await db.from('profiles').update(updateData).eq('id', user.id);
  
  if (error) {
    console.error('Profile save error:', error);
    showToast('‚ùå Fehler beim Speichern');
  } else { 
    const {data} = await db.from('profiles').select('*').eq('id', user.id).single(); 
    profile = data; 
    renderUser();
    showToast('‚úÖ Gespeichert');
  }
}

// Delete Account with confirmation
async function confirmDeleteAccount() {
  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:48px;margin-bottom:16px">‚ö†Ô∏è</div>
      <div style="font-size:18px;font-weight:700;margin-bottom:8px;color:#ef4444">Konto endg√ºltig l√∂schen?</div>
      <div style="color:#a1a1aa;margin-bottom:20px;font-size:13px;line-height:1.6">
        Diese Aktion kann <strong style="color:#ef4444">nicht r√ºckg√§ngig</strong> gemacht werden!<br><br>
        Folgendes wird dauerhaft gel√∂scht:
      </div>
      <div style="text-align:left;background:#18181b;padding:16px;border-radius:6px;margin-bottom:20px;font-size:12px;color:#a1a1aa">
        ‚úó Alle deine Objekte und Buchungen<br>
        ‚úó Alle Nachrichten und Bewertungen<br>
        ‚úó Dein aktives Abonnement wird gek√ºndigt<br>
        ‚úó Alle pers√∂nlichen Daten
      </div>
      <div style="margin-bottom:20px">
        <label class="label">Gib "L√ñSCHEN" ein zur Best√§tigung:</label>
        <input class="input" id="delete-confirm" placeholder="L√ñSCHEN" style="text-align:center">
      </div>
      <div style="display:flex;gap:12px;justify-content:center">
        <button class="btn btn-secondary" onclick="hideModal()">Abbrechen</button>
        <button class="btn" style="background:#ef4444;color:#fff;border:none" onclick="executeDeleteAccount()">
          üóëÔ∏è Endg√ºltig l√∂schen
        </button>
      </div>
    </div>
  `);
}

async function executeDeleteAccount() {
  const confirmInput = document.getElementById('delete-confirm')?.value?.trim();
  
  if (confirmInput !== 'L√ñSCHEN') {
    showToast('Bitte gib "L√ñSCHEN" ein zur Best√§tigung');
    return;
  }
  
  showToast('Konto wird gel√∂scht...');
  
  try {
    const session = await db.auth.getSession();
    const token = session?.data?.session?.access_token;
    const userId = user.id;
    
    // 1. Cancel and delete Stripe subscription immediately
    if (userSubscription?.stripe_subscription_id) {
      try {
        await fetch(`${STRIPE_BILLING_URL}?action=delete-subscription`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          }
        });
      } catch (e) {
        console.log('Subscription delete error:', e);
      }
    }
    
    // 2. Delete all user data from all tables
    // Order matters - delete child records first
    
    // Delete messages/chats if table exists
    try {
      await db.from('messages').delete().eq('user_id', userId);
    } catch (e) {}
    
    // Delete bookings
    try {
      await db.from('bookings').delete().eq('user_id', userId);
    } catch (e) {}
    
    // Delete properties
    try {
      await db.from('properties').delete().eq('user_id', userId);
    } catch (e) {}
    
    // Delete user_subscriptions
    try {
      await db.from('user_subscriptions').delete().eq('user_id', userId);
    } catch (e) {}
    
    // Delete user_email_configs if exists
    try {
      await db.from('user_email_configs').delete().eq('user_id', userId);
    } catch (e) {}
    
    // Delete user_settings if exists
    try {
      await db.from('user_settings').delete().eq('user_id', userId);
    } catch (e) {}
    
    // Delete notifications if exists
    try {
      await db.from('notifications').delete().eq('user_id', userId);
    } catch (e) {}
    
    // Delete profile (this is crucial)
    try {
      await db.from('profiles').delete().eq('id', userId);
    } catch (e) {}
    
    // 3. Call edge function to delete auth user completely (requires service role)
    // This deletes the user from auth.users table including email
    try {
      const deleteResponse = await fetch(`${STRIPE_BILLING_URL}?action=delete-user`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ userId: userId })
      });
      const deleteResult = await deleteResponse.json();
      console.log('Auth user delete result:', deleteResult);
    } catch (e) {
      console.log('Auth user delete error:', e);
    }
    
    // 4. Clear all local storage
    localStorage.clear();
    sessionStorage.clear();
    
    // 5. Sign out (may fail if user already deleted, that's ok)
    try {
      await db.auth.signOut();
    } catch (e) {}
    
    hideModal();
    showToast('Konto und alle Daten wurden gel√∂scht');
    
    setTimeout(() => {
      window.location.href = 'auth.html';
    }, 1500);
    
  } catch (e) {
    console.error('Delete account error:', e);
    showToast('Fehler beim L√∂schen: ' + e.message);
  }
}

// =====================================================
// BILLING & SUBSCRIPTION FUNCTIONS
// =====================================================

// =====================================================
// BILLING PAGE (Standalone Module)
// =====================================================

function renderBillingPage() {
  // If user has active subscription, default to 'current' tab
  // Only check userSubscription (Stripe-verified), not profile
  const status = userSubscription?.status;
  const hasActivePlan = userSubscription?.plan_id && (status === 'active' || status === 'trialing');
  if (hasActivePlan && billingTab === 'plans' && !billingTabManuallySet) {
    billingTab = 'current';
  }
  
  const tabs = [
    { id: 'plans', icon: 'üìã', label: 'Pl√§ne' },
    { id: 'current', icon: '‚ú®', label: 'Aktueller Plan' },
    { id: 'invoices', icon: 'üßæ', label: 'Rechnungen' },
    { id: 'usage', icon: 'üìä', label: 'Nutzung' }
  ];
  
  const renderTabNav = () => `
    <div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap">
      ${tabs.map(tab => `
        <button 
          class="btn ${billingTab === tab.id ? 'btn-primary' : 'btn-secondary'}" 
          onclick="setBillingTab('${tab.id}', true)"
          style="font-size:12px;padding:8px 14px"
        >
          ${tab.icon} ${tab.label}
        </button>
      `).join('')}
    </div>
  `;
  
  let tabContent;
  switch(billingTab) {
    case 'plans': tabContent = renderPlansTab(); break;
    case 'current': tabContent = renderCurrentPlanTab(); break;
    case 'invoices': tabContent = renderInvoicesTab(); break;
    case 'usage': tabContent = renderUsageTab(); break;
    default: tabContent = renderPlansTab();
  }
  
  return renderTabNav() + tabContent;
}

let billingTabManuallySet = false;

function setBillingTab(tab, manual = false) {
  billingTab = tab;
  if (manual) billingTabManuallySet = true;
  renderPage();
}

// Plans Tab - Enhanced with tips and better guarantee display
function renderPlansTab() {
  const propertyCount = getActiveProperties().length;
  const currentPlanId = userSubscription?.plan_id;
  const subscriptionStatus = userSubscription?.status;
  
  // Check if user has any active subscription (including pending cancellation)
  const hasActiveSubscription = subscriptionStatus === 'active' || 
                                subscriptionStatus === 'trialing' || 
                                userSubscription?.cancel_at_period_end ||
                                userSubscription?.pending_plan_id;
  
  // Only show money-back guarantee for users WITHOUT an active plan
  const showGuarantee = !hasActiveSubscription;
  
  return `
    <!-- Header with enhanced guarantee badge -->
    <div style="background:linear-gradient(135deg,#131316,#1a1a2e);border-radius:12px;padding:18px;margin-bottom:14px;border:1px solid #27272a">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
        <div style="display:flex;align-items:center;gap:14px">
          <div style="width:44px;height:44px;background:#3b82f612;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px">üöÄ</div>
          <div>
            <div style="font-size:16px;font-weight:700">${hasActiveSubscription ? 'Dein Plan' : 'W√§hle deinen Plan'}</div>
            <div style="font-size:11px;color:#a1a1aa">${propertyCount} aktive Properties</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          ${currentPlanId && hasActiveSubscription ? `<span style="background:#22c55e12;color:#22c55e;padding:5px 10px;border-radius:6px;font-size:10px;font-weight:600">‚úì ${currentPlanId.charAt(0).toUpperCase() + currentPlanId.slice(1)}</span>` : ''}
          ${showGuarantee ? `
            <span style="background:linear-gradient(135deg,#22c55e15,#22c55e08);color:#22c55e;padding:6px 12px;border-radius:8px;font-size:11px;font-weight:600;border:1px solid #22c55e25;display:flex;align-items:center;gap:5px">
              <span style="font-size:14px">üõ°Ô∏è</span> 30-Tage Geld-zur√ºck-Garantie
            </span>
          ` : ''}
        </div>
      </div>
    </div>
    
    <!-- Plan Cards Grid -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-bottom:14px">
      ${renderPlanCards()}
    </div>
    
    <!-- Tips Section -->
    <div style="background:linear-gradient(135deg,#131316,#18181b);border-radius:10px;padding:16px;border:1px solid #27272a">
      <div style="font-size:12px;font-weight:600;color:#71717a;margin-bottom:12px;display:flex;align-items:center;gap:6px">
        <span>üí°</span> Welcher Plan passt zu dir?
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
        <div style="background:#18181b;border-radius:8px;padding:12px;border:1px solid #27272a">
          <div style="font-size:11px;font-weight:600;color:#3b82f6;margin-bottom:4px">üõ´ Takeoff</div>
          <div style="font-size:10px;color:#a1a1aa;line-height:1.4">Ideal f√ºr <strong style="color:#fff">Einsteiger</strong> mit 1-5 Properties. Alle Basisfunktionen, manuelle Kontrolle.</div>
        </div>
        <div style="background:#18181b;border-radius:8px;padding:12px;border:1px solid #f9731625">
          <div style="font-size:11px;font-weight:600;color:#f97316;margin-bottom:4px">‚úàÔ∏è Cruise <span style="font-size:9px;background:#f9731620;padding:2px 5px;border-radius:4px;margin-left:4px">Beliebt</span></div>
          <div style="font-size:10px;color:#a1a1aa;line-height:1.4">Perfekt f√ºr <strong style="color:#fff">wachsende Hosts</strong> mit 5-15 Properties. KI-Unterst√ºtzung im Hybrid-Modus.</div>
        </div>
        <div style="background:#18181b;border-radius:8px;padding:12px;border:1px solid #27272a">
          <div style="font-size:11px;font-weight:600;color:#8b5cf6;margin-bottom:4px">üöÄ Autopilot</div>
          <div style="font-size:10px;color:#a1a1aa;line-height:1.4">F√ºr <strong style="color:#fff">Profis</strong> mit 15+ Properties. Vollautomatische KI, maximale Zeitersparnis.</div>
        </div>
      </div>
    </div>
    
    <!-- Technical Foundation Note - For Smoobu Professional Users -->
    <div style="margin-top:14px;background:linear-gradient(135deg,#18181b,#1a1a2e);border-radius:10px;padding:14px 16px;border:1px solid #27272a;display:flex;align-items:center;gap:14px">
      <div style="flex-shrink:0">
        <img src="https://www.smoobu.com/wp-content/uploads/2021/06/smoobu-logo.svg" style="height:20px;filter:brightness(0) invert(0.6)" onerror="this.outerHTML='<span style=font-size:18px>‚öôÔ∏è</span>'">
      </div>
      <div style="flex:1">
        <div style="font-size:11px;font-weight:600;color:#a1a1aa;margin-bottom:2px">F√ºr Smoobu Professional Nutzer</div>
        <div style="font-size:10px;color:#71717a;line-height:1.4">PilotStay erweitert dein bestehendes Smoobu-Konto mit KI-gest√ºtzter Automatisierung f√ºr Nachrichten, Reviews und Preise.</div>
      </div>
    </div>
  `;
}

// Current Plan Tab - Enhanced with feature tooltips and scheduled changes
function renderCurrentPlanTab() {
  let currentPlan = userSubscription?.subscription_plans || null;
  // Only use userSubscription (Stripe-verified), not profile
  const planId = userSubscription?.plan_id;
  
  let status = 'none';
  if (userSubscription?.status) {
    status = userSubscription.status;
  }
  // Don't assume 'active' if no real status from Stripe
  
  const propertyCount = getActiveProperties().length;
  const isCanceled = userSubscription?.cancel_at_period_end;
  
  if (!currentPlan && planId) {
    const planData = {
      'takeoff': { id: 'takeoff', display_name: 'Takeoff', base_price_monthly: 89.99, price_per_property: 12.99 },
      'cruise': { id: 'cruise', display_name: 'Cruise', base_price_monthly: 129.99, price_per_property: 6.99 },
      'autopilot': { id: 'autopilot', display_name: 'Autopilot', base_price_monthly: 179.99, price_per_property: 2.99 },
      'enterprise': { id: 'enterprise', display_name: 'Enterprise', base_price_monthly: 0, price_per_property: 0 }
    };
    currentPlan = planData[planId] || null;
  }
  
  let basePrice = currentPlan?.base_price_monthly || 0;
  let propertyPrice = (currentPlan?.price_per_property || 0) * propertyCount;
  let totalPrice = basePrice + propertyPrice;
  
  // Status labels - distinguish between payment failure, user cancellation, and scheduled change
  const hasScheduledChange = scheduledPlanChange && scheduledPlanChange.newPlanId !== planId;
  
  const statusLabels = {
    'none': { label: 'Kein Abo', color: '#71717a' },
    'incomplete': { label: 'Einrichtung', color: '#f97316' },
    'incomplete_expired': { label: 'Abgelaufen', color: '#ef4444' },
    'trialing': { label: 'Aktiv', color: '#22c55e' },
    'active': { label: 'Aktiv', color: '#22c55e' },
    'past_due': { label: 'Zahlung fehlgeschlagen', color: '#ef4444' },
    'unpaid': { label: 'Zahlung ausstehend', color: '#ef4444' },
    'canceled': { label: 'Gek√ºndigt', color: '#ef4444' },
    'paused': { label: 'Pausiert', color: '#71717a' }
  };
  
  // Determine correct status display
  let currentStatus;
  
  // If status is 'canceled', the subscription is FULLY ended - ignore cancel_at_period_end
  const isFullyCanceled = status === 'canceled';
  
  if (isFullyCanceled) {
    // Subscription is fully canceled - show no plan screen
    return `
      <div class="card" style="text-align:center;padding:60px 20px;background:linear-gradient(135deg,#131316,#18181b);border:1px dashed #27272a">
        <div style="font-size:32px;margin-bottom:16px">üì≠</div>
        <div style="font-size:18px;font-weight:700;margin-bottom:8px">Noch kein Plan</div>
        <div style="color:#a1a1aa;margin-bottom:24px">W√§hle einen Plan um alle Features freizuschalten.</div>
        <button class="btn btn-primary" onclick="setBillingTab('plans', true)">Plan ausw√§hlen</button>
      </div>
    `;
  }
  
  if (isCanceled) {
    // Only show "Gek√ºndigt" for pending cancellations (not yet canceled)
    currentStatus = { label: 'Gek√ºndigt', color: '#ef4444' };
  } else if (hasScheduledChange) {
    // Scheduled plan change - NOT cancellation
    currentStatus = { label: 'Wechsel geplant', color: '#3b82f6' };
  } else {
    currentStatus = statusLabels[status] || statusLabels['none'];
  }
  
  if (!planId && !currentPlan) {
    return `
      <div class="card" style="text-align:center;padding:60px 20px;background:linear-gradient(135deg,#131316,#18181b);border:1px dashed #27272a">
        <div style="font-size:32px;margin-bottom:16px">üì≠</div>
        <div style="font-size:18px;font-weight:700;margin-bottom:8px">Noch kein Plan</div>
        <div style="color:#a1a1aa;margin-bottom:24px">W√§hle einen Plan um alle Features freizuschalten.</div>
        <button class="btn btn-primary" onclick="setBillingTab('plans', true)">Plan ausw√§hlen</button>
      </div>
    `;
  }
  
  const planColor = currentPlan?.id === 'takeoff' ? '#3b82f6' : currentPlan?.id === 'cruise' ? '#f97316' : currentPlan?.id === 'autopilot' ? '#8b5cf6' : '#71717a';
  
  // Get features for current plan with flip effect
  const planFeatureIds = PLAN_FEATURES[planId]?.features || [];
  const featureBoxes = planFeatureIds.filter(f => f !== 'all').slice(0, 8).map((featureId, idx) => {
    const info = FEATURE_INFO[featureId] || { name: featureId, desc: '' };
    const boxId = `feature-box-${idx}`;
    return `
      <div class="feature-flip-container" style="perspective:1000px;height:60px">
        <div id="${boxId}" class="feature-flip-inner" style="position:relative;width:100%;height:100%;transition:transform 0.5s;transform-style:preserve-3d;cursor:pointer" 
             onclick="this.classList.toggle('flipped')">
          <!-- Front -->
          <div style="position:absolute;width:100%;height:100%;backface-visibility:hidden;background:#18181b;border:1px solid #27272a;border-radius:6px;padding:12px;display:flex;align-items:center;gap:8px">
            <span style="color:${planColor};font-size:14px">‚úì</span>
            <span style="font-size:12px;color:#e4e4e7">${info.name}</span>
          </div>
          <!-- Back -->
          <div style="position:absolute;width:100%;height:100%;backface-visibility:hidden;transform:rotateY(180deg);background:${planColor}15;border:1px solid ${planColor}40;border-radius:6px;padding:10px;display:flex;align-items:center;overflow:hidden">
            <span style="font-size:10px;color:#a1a1aa;line-height:1.3">${info.desc || 'Feature-Beschreibung'}</span>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  return `
    <!-- Canceled Warning Banner - only for manual cancellation -->
    ${isCanceled && !hasScheduledChange ? `
      <div style="background:#ef444410;border:1px solid #ef444430;border-radius:6px;padding:14px 18px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div style="display:flex;align-items:center;gap:10px">
          <div>
            <div style="font-weight:600;color:#ef4444;font-size:13px">K√ºndigung aktiv</div>
            <div style="font-size:11px;color:#a1a1aa">Endet am ${userSubscription?.current_period_end ? new Date(userSubscription.current_period_end).toLocaleDateString('de-DE') : 'Periodenende'}</div>
          </div>
        </div>
        <button class="btn" style="background:#22c55e;color:#fff;border:none;padding:8px 16px;font-size:12px;font-weight:600" onclick="reactivateSubscription()">
          Reaktivieren
        </button>
      </div>
    ` : ''}
    
    <!-- Scheduled Plan Change Banner - NOT cancellation -->
    ${hasScheduledChange && !isCanceled ? `
      <div style="background:#3b82f610;border:1px solid #3b82f630;border-radius:6px;padding:14px 18px;margin-bottom:14px;display:flex;align-items:center;gap:12px">
        <div>
          <div style="font-weight:600;color:#3b82f6;font-size:13px">Wechsel geplant</div>
          <div style="font-size:11px;color:#a1a1aa">Ab ${new Date(scheduledPlanChange.effectiveDate).toLocaleDateString('de-DE')}: <strong style="color:#fff">${scheduledPlanChange.newPlanName}</strong></div>
        </div>
      </div>
    ` : ''}
    
    <!-- Payment Failed Banner -->
    ${(status === 'past_due' || status === 'unpaid') ? `
      <div style="background:#ef444410;border:1px solid #ef444430;border-radius:6px;padding:14px 18px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div>
          <div style="font-weight:600;color:#ef4444;font-size:13px">Zahlung fehlgeschlagen</div>
          <div style="font-size:11px;color:#a1a1aa">Bitte aktualisiere deine Zahlungsmethode</div>
        </div>
        <button class="btn btn-secondary" style="padding:8px 16px;font-size:12px" onclick="openBillingPortal()">
          Zahlungsmethode √§ndern
        </button>
      </div>
    ` : ''}
    
    <!-- Main Plan Card -->
    <div class="card" style="background:linear-gradient(135deg,#131316 0%,${planColor}08 100%);border:1px solid ${planColor}20;padding:20px">
      <!-- Header -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
        <div style="display:flex;align-items:center;gap:14px">
          <div style="width:48px;height:48px;background:${planColor}15;border-radius:8px;display:flex;align-items:center;justify-content:center;border:1px solid ${planColor}20">
            <span style="font-size:20px;font-weight:700;color:${planColor}">${(currentPlan?.display_name || 'P')[0]}</span>
          </div>
          <div>
            <div style="font-size:9px;color:#71717a;text-transform:uppercase;letter-spacing:1px">Aktueller Plan</div>
            <div style="font-size:20px;font-weight:700">${currentPlan?.display_name || 'PilotStay'}</div>
          </div>
        </div>
        <span style="display:inline-flex;align-items:center;background:${currentStatus.color}10;color:${currentStatus.color};font-size:11px;font-weight:600;padding:6px 12px;border-radius:4px;border:1px solid ${currentStatus.color}20">
          ${currentStatus.label}
        </span>
      </div>
      
      <!-- Pricing Row -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:18px">
        <div style="background:#18181b;padding:12px;border-radius:6px;text-align:center;border:1px solid #27272a">
          <div style="font-size:9px;color:#71717a;margin-bottom:3px">Grundgeb√ºhr</div>
          <div style="font-size:18px;font-weight:700">‚Ç¨${basePrice.toFixed(2)}</div>
        </div>
        <div style="background:#18181b;padding:12px;border-radius:6px;text-align:center;border:1px solid #27272a">
          <div style="font-size:9px;color:#71717a;margin-bottom:3px">${propertyCount} √ó ‚Ç¨${currentPlan?.price_per_property || 0}</div>
          <div style="font-size:18px;font-weight:700">‚Ç¨${propertyPrice.toFixed(2)}</div>
        </div>
        <div style="background:${planColor}10;padding:12px;border-radius:6px;text-align:center;border:1px solid ${planColor}25">
          <div style="font-size:9px;color:${planColor};margin-bottom:3px">Gesamt/Monat</div>
          <div style="font-size:18px;font-weight:700;color:${planColor}">‚Ç¨${totalPrice.toFixed(2)}</div>
        </div>
      </div>
      
      <!-- Actions Row -->
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;padding-top:14px;border-top:1px solid #27272a">
        <div style="font-size:12px;color:#a1a1aa">
          ${userSubscription?.current_period_end 
            ? `${isCanceled ? 'Endet' : 'N√§chste Rechnung'}: <strong style="color:#fff">${new Date(userSubscription.current_period_end).toLocaleDateString('de-DE')}</strong>` 
            : ''}
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-secondary" style="padding:7px 12px;font-size:11px" onclick="openBillingPortal()">Zahlung</button>
          <button class="btn btn-secondary" style="padding:7px 12px;font-size:11px" onclick="setBillingTab('plans', true)">Wechseln</button>
          ${!isCanceled && !hasScheduledChange ? `<button class="btn" style="padding:7px 12px;font-size:11px;background:transparent;color:#ef4444;border:1px solid #ef444420" onclick="confirmCancelSubscription()">K√ºndigen</button>` : ''}
        </div>
      </div>
    </div>
    
    <!-- Features Grid with Tooltips -->
    <div style="margin-top:14px">
      <div style="font-size:12px;font-weight:600;color:#71717a;margin-bottom:10px">Enthaltene Features</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px">
        ${featureBoxes}
      </div>
    </div>
  `;
}

function getFeaturesList(planId) {
  const features = {
    'takeoff': [
      'Dashboard & Objektverwaltung',
      'Buchungen & Kalender',
      'Basis-Analytics',
      'E-Mail Benachrichtigungen',
      'Property-Statistiken',
      'Support per E-Mail'
    ],
    'cruise': [
      'Alles aus Takeoff',
      'Smart Replies (Hybrid)',
      'Review-Antworten (Hybrid)',
      'Auto-Pricing (Hybrid)',
      'Event & Saison-Analyse',
      'Erweiterte KPIs',
      'Priority Support'
    ],
    'autopilot': [
      'Alles aus Cruise',
      'Vollautomatische Replies',
      'Auto-Pricing (Autonom)',
      'Priorisierte KI-Modelle',
      'Early-Access Features',
      'Partner-Netzwerk',
      '24/7 Support'
    ],
    'enterprise': [
      'Alles aus Autopilot',
      'Multi-Account / Mandanten',
      'White-Label Option',
      'API-Zugang',
      'Dedizierter Account Manager',
      'Custom Integrationen',
      'SLA Garantie'
    ]
  };
  return features[planId] || features['takeoff'];
}

// Invoices Tab - Compact
function renderInvoicesTab() {
  // Auto-load invoices when tab is opened
  setTimeout(() => {
    if (!cachedInvoices) {
      loadInvoices();
    } else {
      // Show cached data immediately, refresh in background
      const container = document.getElementById('invoices-list');
      if (container) {
        renderInvoicesList(container, cachedInvoices);
        // Refresh in background
        loadInvoicesBackground();
      }
    }
  }, 100);
  
  return `
    <div class="card" style="background:linear-gradient(135deg,#131316,#18181b);padding:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <div style="font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px">
          <span style="font-size:20px">üßæ</span> Rechnungen
        </div>
        <button class="btn btn-secondary" style="padding:6px 12px;font-size:11px" onclick="cachedInvoices=null;loadInvoices()">
          üîÑ Aktualisieren
        </button>
      </div>
      <div id="invoices-list">
        ${cachedInvoices ? '' : `
        <div style="text-align:center;padding:30px 15px">
          <div style="font-size:24px;margin-bottom:10px">‚è≥</div>
          <div style="font-size:13px;color:#71717a">Rechnungen werden geladen...</div>
        </div>
        `}
      </div>
    </div>
    
    <div class="card" style="margin-top:12px;background:linear-gradient(135deg,#131316,#18181b);padding:16px">
      <div style="font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px">
        <span style="font-size:18px">üí≥</span> Zahlungsmethode
      </div>
      <div style="background:#18181b;padding:14px;border-radius:8px;border:1px solid #27272a">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
          <div style="width:36px;height:36px;background:#3b82f612;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px">üí≥</div>
          <div>
            <div style="font-weight:600;font-size:12px">Stripe Zahlungsabwicklung</div>
            <div style="font-size:10px;color:#71717a">Kreditkarte, SEPA, etc.</div>
          </div>
        </div>
        <button class="btn btn-secondary" style="padding:8px 16px;font-size:11px;width:100%" onclick="openBillingPortal()">
          üí≥ Zahlungsportal √∂ffnen
        </button>
      </div>
    </div>
  `;
}

// Background refresh for invoices
async function loadInvoicesBackground() {
  try {
    const session = await db.auth.getSession();
    const token = session?.data?.session?.access_token;
    if (!token) return;
    
    const response = await fetch(`${STRIPE_BILLING_URL}?action=list-invoices&limit=3`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const data = await response.json();
    if (data.invoices) {
      cachedInvoices = data.invoices;
      const container = document.getElementById('invoices-list');
      if (container) renderInvoicesList(container, cachedInvoices);
    }
  } catch (e) {
    console.log('Background invoice refresh failed:', e);
  }
}

// Usage Tab
function renderUsageTab() {
  const propertyCount = properties.filter(p => p.active !== false).length;
  const currentPlan = getCurrentPlan();
  const planPrices = {
    'takeoff': { base: 89.99, property: 12.99 },
    'cruise': { base: 129.99, property: 6.99 },
    'autopilot': { base: 179.99, property: 2.99 }
  };
  const prices = planPrices[currentPlan] || { base: 0, property: 0 };
  const propertyCost = (propertyCount * prices.property).toFixed(2);
  const currentMonth = new Date().toLocaleDateString('de-DE', {month: 'long', year: 'numeric'});
  
  // Calculate next billing date
  const nextBilling = userSubscription?.current_period_end 
    ? new Date(userSubscription.current_period_end).toLocaleDateString('de-DE', {day: 'numeric', month: 'long'})
    : '‚Äî';
  
  // Mock AI stats (in production these would come from actual tracking)
  const aiStats = {
    smartReplies: parseInt(localStorage.getItem('ai_smart_replies_count') || '0'),
    reviewReplies: parseInt(localStorage.getItem('ai_review_replies_count') || '0'),
    priceOptimizations: parseInt(localStorage.getItem('ai_price_optimizations_count') || '0')
  };
  const totalAiRequests = aiStats.smartReplies + aiStats.reviewReplies + aiStats.priceOptimizations;
  
  // Calculate automation percentage (based on settings)
  let automationScore = 0;
  if (automationSettings.smartRepliesMode === 'auto') automationScore += 33;
  else if (automationSettings.smartRepliesMode === 'hybrid') automationScore += 20;
  if (automationSettings.reviewRepliesMode === 'auto') automationScore += 33;
  else if (automationSettings.reviewRepliesMode === 'hybrid') automationScore += 20;
  if (automationSettings.autoPricingMode === 'auto') automationScore += 34;
  else if (automationSettings.autoPricingMode === 'hybrid') automationScore += 20;
  
  return `
    <div class="card" style="background:linear-gradient(135deg,#131316,#18181b);margin-bottom:20px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:28px">
        <div>
          <div style="font-size:20px;font-weight:700;display:flex;align-items:center;gap:12px">
            <span style="font-size:28px">üìä</span> Nutzungs√ºbersicht
          </div>
          <div style="font-size:13px;color:#71717a;margin-top:4px">${currentMonth}</div>
        </div>
        <button class="btn btn-secondary" style="padding:8px 16px;font-size:12px" onclick="syncPropertyUsage().then(() => { showToast('‚úÖ Nutzung synchronisiert'); loadSubscription(); renderPage(); })">
          üîÑ Sync
        </button>
      </div>
      
      <!-- Main Stats Grid -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px">
        <!-- Properties -->
        <div style="background:linear-gradient(135deg,#3b82f610,#3b82f605);padding:24px;border-radius:16px;border:1px solid #3b82f625">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
            <div style="width:40px;height:40px;background:#3b82f620;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">üè†</div>
            <div style="font-size:13px;color:#71717a">Objekte</div>
          </div>
          <div style="font-size:36px;font-weight:800;color:#fff;margin-bottom:4px">${propertyCount}</div>
          <div style="font-size:12px;color:#3b82f6">aktiv</div>
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid #3b82f615">
            <div style="font-size:20px;font-weight:700;color:#3b82f6">‚Ç¨${propertyCost}</div>
            <div style="font-size:11px;color:#71717a">monatlich</div>
          </div>
        </div>
        
        <!-- AI Requests -->
        <div style="background:linear-gradient(135deg,#8b5cf610,#8b5cf605);padding:24px;border-radius:16px;border:1px solid #8b5cf625">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
            <div style="width:40px;height:40px;background:#8b5cf620;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">üß†</div>
            <div style="font-size:13px;color:#71717a">KI-Anfragen</div>
          </div>
          <div style="font-size:36px;font-weight:800;color:#fff;margin-bottom:4px">${totalAiRequests}</div>
          <div style="font-size:12px;color:#8b5cf6">diesen Monat</div>
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid #8b5cf615;display:flex;gap:12px">
            <div style="text-align:center;flex:1">
              <div style="font-size:14px;font-weight:600;color:#fff">${aiStats.smartReplies}</div>
              <div style="font-size:9px;color:#71717a">Replies</div>
            </div>
            <div style="text-align:center;flex:1">
              <div style="font-size:14px;font-weight:600;color:#fff">${aiStats.reviewReplies}</div>
              <div style="font-size:9px;color:#71717a">Reviews</div>
            </div>
            <div style="text-align:center;flex:1">
              <div style="font-size:14px;font-weight:600;color:#fff">${aiStats.priceOptimizations}</div>
              <div style="font-size:9px;color:#71717a">Preise</div>
            </div>
          </div>
        </div>
        
        <!-- Automation Score -->
        <div style="background:linear-gradient(135deg,#22c55e10,#22c55e05);padding:24px;border-radius:16px;border:1px solid #22c55e25">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
            <div style="width:40px;height:40px;background:#22c55e20;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">‚ö°</div>
            <div style="font-size:13px;color:#71717a">Automatisiert</div>
          </div>
          <div style="font-size:36px;font-weight:800;color:#fff;margin-bottom:4px">${automationScore}%</div>
          <div style="font-size:12px;color:#22c55e">${automationScore >= 80 ? 'Vollautomatisch' : automationScore >= 40 ? 'Hybrid' : 'Manuell'}</div>
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid #22c55e15">
            <div style="background:#27272a;border-radius:4px;height:6px;overflow:hidden">
              <div style="background:linear-gradient(90deg,#22c55e,#3b82f6);height:100%;width:${automationScore}%;transition:width 0.3s"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Billing Info Bar -->
      <div style="background:#18181b;border:1px solid #27272a;border-radius:12px;padding:16px 20px;display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;align-items:center;gap:16px">
          <div style="width:36px;height:36px;background:#f9731620;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px">üìÖ</div>
          <div>
            <div style="font-size:13px;font-weight:600">N√§chste Abrechnung</div>
            <div style="font-size:12px;color:#71717a">${nextBilling}</div>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-size:11px;color:#71717a">Gesch√§tzte Summe</div>
          <div style="font-size:18px;font-weight:700;color:#f97316">‚Ç¨${(prices.base + (propertyCount * prices.property)).toFixed(2)}</div>
        </div>
      </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="card" style="background:linear-gradient(135deg,#131316,#18181b)">
      <div style="font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px">
        <span style="font-size:20px">‚öôÔ∏è</span> Schnellaktionen
      </div>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
        <button class="btn btn-secondary" style="padding:16px;display:flex;align-items:center;gap:12px;justify-content:flex-start" onclick="setPage('properties')">
          <span style="font-size:20px">üè†</span>
          <div style="text-align:left">
            <div style="font-weight:600;font-size:13px">Objekte verwalten</div>
            <div style="font-size:11px;color:#71717a">${propertyCount} aktiv</div>
          </div>
        </button>
        <button class="btn btn-secondary" style="padding:16px;display:flex;align-items:center;gap:12px;justify-content:flex-start" onclick="setPage('automation')">
          <span style="font-size:20px">üß†</span>
          <div style="text-align:left">
            <div style="font-weight:600;font-size:13px">Automation</div>
            <div style="font-size:11px;color:#71717a">${automationScore}% automatisiert</div>
          </div>
        </button>
        <button class="btn btn-secondary" style="padding:16px;display:flex;align-items:center;gap:12px;justify-content:flex-start" onclick="setBillingTab('invoices')">
          <span style="font-size:20px">üìÑ</span>
          <div style="text-align:left">
            <div style="font-weight:600;font-size:13px">Rechnungen</div>
            <div style="font-size:11px;color:#71717a">Verlauf ansehen</div>
          </div>
        </button>
      </div>
    </div>
  `;
}

function renderPlanCards() {
  const plans = [
    {
      id: 'takeoff',
      name: 'Takeoff',
      emoji: 'üõ´',
      tagline: 'Professioneller Einstieg',
      basePrice: 89.99,
      propertyPrice: 12.99,
      recommended: '1-5 Properties',
      popular: false,
      features: [
        'Dashboard & Objektverwaltung',
        'Buchungen & Kalender',
        'Basis-Analytics',
        'E-Mail Benachrichtigungen',
        'Property-Statistiken',
        'Support per E-Mail'
      ],
      automation: 'Manuell'
    },
    {
      id: 'cruise',
      name: 'Cruise',
      emoji: '‚úàÔ∏è',
      tagline: 'Intelligenter Co-Pilot',
      basePrice: 129.99,
      propertyPrice: 6.99,
      recommended: '5-15 Properties',
      popular: true,
      features: [
        'Alles aus Takeoff',
        'Smart Replies (Hybrid)',
        'Review-Antworten (Hybrid)',
        'Auto-Pricing (Hybrid)',
        'Event & Saison-Analyse',
        'Erweiterte KPIs'
      ],
      automation: 'Hybrid'
    },
    {
      id: 'autopilot',
      name: 'Autopilot',
      emoji: 'üöÄ',
      tagline: 'Maximale Automatisierung',
      basePrice: 179.99,
      propertyPrice: 2.99,
      recommended: '15+ Properties',
      popular: false,
      features: [
        'Alles aus Cruise',
        'Vollautomatische Replies',
        'Auto-Pricing (Autonom)',
        'Priorisierte KI-Modelle',
        'Early-Access Features',
        'Partner-Netzwerk'
      ],
      automation: 'Vollautomatisch'
    },
    {
      id: 'enterprise',
      name: 'Enterprise',
      emoji: 'üè¢',
      tagline: 'F√ºr Agenturen & Hotels',
      basePrice: null,
      propertyPrice: null,
      recommended: '50+ Properties',
      popular: false,
      features: [
        'Alles aus Autopilot',
        'Multi-Account / Mandanten',
        'White-Label Option',
        'API-Zugang',
        'Dedizierter Support',
        'Custom Integrationen'
      ],
      automation: 'Enterprise'
    }
  ];
  
  const currentPlanId = userSubscription?.plan_id;
  const subscriptionStatus = userSubscription?.status;
  const actualPropertyCount = properties.filter(p => p.active !== false).length;
  const displayPropertyCount = 15; // Fixed display count for price comparison
  
  // status === 'canceled' means FULLY canceled, no active plan
  const isFullyCanceled = subscriptionStatus === 'canceled';
  const hasActivePlan = !isFullyCanceled && (subscriptionStatus === 'active' || subscriptionStatus === 'trialing' || userSubscription?.cancel_at_period_end);
  
  return plans.map(plan => {
    const isCurrentPlan = hasActivePlan && plan.id === currentPlanId;
    const monthlyTotal = plan.basePrice ? (plan.basePrice + (plan.propertyPrice * displayPropertyCount)).toFixed(2) : null;
    
    // Gradient colors for each plan
    const planColors = {
      'takeoff': { primary: '#3b82f6', gradient: '#3b82f608' },
      'cruise': { primary: '#f97316', gradient: '#f9731608' },
      'autopilot': { primary: '#8b5cf6', gradient: '#8b5cf608' },
      'enterprise': { primary: '#71717a', gradient: '#71717a08' }
    };
    const colors = planColors[plan.id] || planColors['takeoff'];
    
    // Cruise plan gets elevated styling when not current plan
    const isCruise = plan.id === 'cruise';
    const cruiseElevation = isCruise && !isCurrentPlan;
    
    return `
      <div class="plan-card" style="
        padding:16px;
        border-radius:8px;
        background:linear-gradient(135deg,#131316,${isCurrentPlan ? '#22c55e08' : colors.gradient});
        border:1px solid ${isCurrentPlan ? '#22c55e40' : plan.popular ? '#f9731660' : '#27272a'};
        position:relative;
        transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        ${cruiseElevation ? 'transform:translateY(-6px);box-shadow:0 12px 28px -6px rgba(249,115,22,0.25);z-index:5;' : ''}
      " onmouseover="this.style.transform='translateY(-10px)';this.style.boxShadow='0 16px 32px -8px ${colors.primary}30';this.style.borderColor='${colors.primary}'" 
         onmouseout="this.style.transform='${cruiseElevation ? 'translateY(-6px)' : 'translateY(0)'}';this.style.boxShadow='${cruiseElevation ? '0 12px 28px -6px rgba(249,115,22,0.25)' : 'none'}';this.style.borderColor='${isCurrentPlan ? '#22c55e40' : plan.popular ? '#f9731660' : '#27272a'}'">
        
        ${isCurrentPlan ? `<div style="position:absolute;top:-8px;left:50%;transform:translateX(-50%)">
          <span style="background:#22c55e;color:#fff;font-size:9px;font-weight:700;padding:4px 10px;border-radius:4px">‚úì AKTUELL</span>
        </div>` : (plan.popular ? `<div style="position:absolute;top:-8px;left:50%;transform:translateX(-50%)">
          <span style="background:#f97316;color:#fff;font-size:9px;font-weight:700;padding:4px 10px;border-radius:4px">‚≠ê BELIEBT</span>
        </div>` : '')}
        
        <!-- Header -->
        <div style="text-align:center;margin-bottom:12px;padding-top:${plan.popular || isCurrentPlan ? '6px' : '0'}">
          <div style="font-size:32px;margin-bottom:6px">${plan.emoji}</div>
          <div style="font-size:16px;font-weight:700">${plan.name}</div>
          <div style="font-size:11px;color:#71717a">${plan.tagline}</div>
        </div>
        
        <!-- Price -->
        <div style="text-align:center;margin-bottom:12px;padding:12px;background:#18181b;border-radius:6px;border:1px solid #27272a">
          ${plan.basePrice ? `
            <div style="font-size:24px;font-weight:800">‚Ç¨${plan.basePrice}</div>
            <div style="font-size:10px;color:#71717a">+ ‚Ç¨${plan.propertyPrice}/Property</div>
            <div style="font-size:12px;color:${colors.primary};font-weight:600;margin-top:6px">= ‚Ç¨${monthlyTotal} bei 15</div>
          ` : `
            <div style="font-size:18px;font-weight:700">Auf Anfrage</div>
          `}
        </div>
        
        <!-- Features (top 4 only) -->
        <div style="margin-bottom:12px">
          ${plan.features.slice(0, 4).map(f => `
            <div style="display:flex;align-items:center;gap:6px;padding:4px 0;font-size:11px;color:#a1a1aa">
              <span style="color:${colors.primary};font-size:10px">‚úì</span>
              <span>${f}</span>
            </div>
          `).join('')}
        </div>
        
        <!-- Button -->
        ${isCurrentPlan ? `
          <button class="btn" style="width:100%;padding:8px;font-size:11px;background:#22c55e15;color:#22c55e;border:1px solid #22c55e30" disabled>‚úì Aktuell</button>
        ` : plan.id === 'enterprise' ? `
          <button class="btn btn-secondary" style="width:100%;padding:8px;font-size:11px" onclick="contactEnterprise()">Kontakt</button>
        ` : `
          <button class="btn" style="width:100%;padding:8px;font-size:11px;background:${colors.primary};color:#fff;border:none" onclick="selectPlan('${plan.id}')">
            ${currentPlanId ? 'Wechseln' : 'W√§hlen'}
          </button>
        `}
      </div>
    `;
  }).join('');
}

function showPlanSelection() {
  const propertyCount = properties.filter(p => p.active !== false).length;
  const subscriptionStatus = userSubscription?.status;
  const hasActiveSubscription = subscriptionStatus === 'active' || 
                                subscriptionStatus === 'trialing' || 
                                userSubscription?.cancel_at_period_end;
  
  showModal(`
    <div style="max-width:1000px">
      <div class="modal-title">üöÄ Plan ausw√§hlen</div>
      <p style="color:#a1a1aa;margin-bottom:24px">
        W√§hle den passenden Plan f√ºr dein Business. Du hast aktuell <strong>${propertyCount} aktive Properties</strong>.
      </p>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px">
        ${renderPlanCards()}
      </div>
      
      ${!hasActiveSubscription ? `
        <div style="margin-top:24px;padding:16px;background:linear-gradient(135deg,#18181b,#1f1f23);border-radius:12px;font-size:13px;color:#a1a1aa;border:1px solid #27272a">
          <strong style="color:#fff">üí° Hinweis:</strong> Alle Pl√§ne beinhalten eine 30-Tage Geld-zur√ºck-Garantie. 
          Du kannst jederzeit upgraden, downgraden oder k√ºndigen.
        </div>
      ` : `
        <div style="margin-top:24px;padding:16px;background:linear-gradient(135deg,#18181b,#1f1f23);border-radius:12px;font-size:13px;color:#a1a1aa;border:1px solid #27272a">
          <strong style="color:#fff">üí° Hinweis:</strong> Bei einem Planwechsel wird anteilig abgerechnet. 
          Du kannst jederzeit upgraden, downgraden oder k√ºndigen.
        </div>
      `}
    </div>
  `);
}

async function selectPlan(planId) {
  hideModal();
  showToast('‚è≥ Checkout wird vorbereitet...');
  
  const propertyCount = getActiveProperties().length;
  
  try {
    const session = await db.auth.getSession();
    const token = session?.data?.session?.access_token;
    
    if (!token) {
      showToast('‚ùå Bitte melde dich erneut an');
      return;
    }
    
    const response = await fetch(`${STRIPE_BILLING_URL}?action=create-checkout`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({
        planId: planId,
        propertyCount: Math.max(propertyCount, 1)
      })
    });
    
    const data = await response.json();
    
    console.log('Checkout/Update response:', data);
    
    if (data.type === 'checkout' && data.url) {
      // New subscription - redirect to Stripe Checkout
      window.location.href = data.url;
    } else if (data.type === 'scheduled' && data.success) {
      // DOWNGRADE: Plan change scheduled for end of period (legacy)
      showToast('üìÖ ' + data.message);
      hideModal();
      
      // Store scheduled change info
      scheduledPlanChange = {
        newPlanId: data.newPlanId,
        newPlanName: data.newPlanId.charAt(0).toUpperCase() + data.newPlanId.slice(1),
        effectiveDate: data.effectiveDate,
        currentPlanId: data.currentPlanId
      };
      
      // Reload subscription data from server
      await loadSubscription();
      
      // Switch to current plan tab to show the scheduled change
      setBillingTab('current', true);
      renderUser();
      renderPage();
      
    } else if (data.type === 'downgraded' && data.success) {
      // DOWNGRADE: Stripe prices changed, DB shows pending until next period
      showToast('üìÖ ' + data.message);
      hideModal();
      
      // Store scheduled change info - user keeps current features until effectiveDate
      scheduledPlanChange = {
        newPlanId: data.newPlanId,
        newPlanName: data.newPlanId.charAt(0).toUpperCase() + data.newPlanId.slice(1),
        effectiveDate: data.effectiveDate,
        currentPlanId: data.currentPlanId
      };
      
      // Reload subscription data from server
      await loadSubscription();
      
      // Switch to current plan tab to show the scheduled change
      setBillingTab('current', true);
      renderUser();
      renderPage();
      
    } else if (data.type === 'upgraded' && data.success) {
      // UPGRADE: Plan changed immediately
      showToast('üöÄ ' + data.message);
      hideModal();
      
      // Clear any scheduled change (upgrade is immediate)
      scheduledPlanChange = null;
      
      // Reload subscription data from server
      await loadSubscription();
      renderUser();
      renderPage();
      
      // Switch to current plan tab
      setBillingTab('current', true);
      
    } else if (data.type === 'updated' && data.success) {
      // Plan was updated - reload from Stripe via API to get verified status
      showToast('Plan wird aktualisiert...');
      hideModal();
      
      // IMPORTANT: Don't set userSubscription locally - always get from Stripe
      await loadSubscription();
      renderUser();
      renderPage();
      
      showToast('Plan aktualisiert');
      
    } else if (data.type === 'info') {
      showToast('‚ÑπÔ∏è ' + data.message);
    } else if (data.type === 'contact') {
      showToast('üìß ' + data.message);
    } else if (data.error) {
      showToast('‚ùå ' + data.error);
      console.error('Checkout error response:', data);
    }
  } catch (e) {
    console.error('Checkout error:', e);
    showToast('‚ùå Fehler beim Starten des Checkouts');
  }
}

async function openBillingPortal() {
  showToast('‚è≥ Portal wird ge√∂ffnet...');
  
  try {
    const session = await db.auth.getSession();
    const token = session?.data?.session?.access_token;
    
    const response = await fetch(`${STRIPE_BILLING_URL}?action=create-portal`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      }
    });
    
    const data = await response.json();
    
    if (data.url) {
      window.location.href = data.url;
    } else {
      showToast('‚ùå Fehler beim √ñffnen des Portals');
    }
  } catch (e) {
    console.error('Portal error:', e);
    showToast('‚ùå Fehler beim √ñffnen des Portals');
  }
}

function confirmCancelSubscription() {
  // Get current plan and determine next higher plan
  // Only use userSubscription (Stripe-verified)
  const currentPlanId = userSubscription?.plan_id;
  
  if (!currentPlanId) {
    showToast('Kein aktives Abo gefunden');
    return;
  }
  
  const planHierarchy = ['takeoff', 'cruise', 'autopilot', 'enterprise'];
  const planNames = { takeoff: 'Takeoff', cruise: 'Cruise', autopilot: 'Autopilot', enterprise: 'Enterprise' };
  
  const currentIndex = planHierarchy.indexOf(currentPlanId);
  const nextPlanId = currentIndex >= 0 && currentIndex < planHierarchy.length - 1 
    ? planHierarchy[currentIndex + 1] 
    : null;
  
  // Check if user has already used the upgrade trial offer
  // They get this offer only ONCE
  const hasUsedUpgradeTrial = userSubscription?.upgrade_trial_used || 
                              userSubscription?.upgrade_trial_ended ||
                              userSubscription?.upgrade_trial_original_plan;
  
  // If there's a higher plan available AND user hasn't used trial yet, offer upgrade trial
  if (nextPlanId && nextPlanId !== 'enterprise' && !hasUsedUpgradeTrial) {
    showModal(`
      <div style="text-align:center;padding:20px">
        <div style="font-size:32px;margin-bottom:16px">‚è∏Ô∏è</div>
        <div style="font-size:18px;font-weight:700;margin-bottom:8px">Bevor du gehst...</div>
        <div style="color:#a1a1aa;margin-bottom:20px;line-height:1.6">
          Teste <strong style="color:#f97316">${planNames[nextPlanId]}</strong> f√ºr 2 Monate 
          zum Preis deines aktuellen Plans, bevor du k√ºndigst.
        </div>
        <div style="background:#18181b;border-radius:6px;padding:16px;margin-bottom:20px;text-align:left">
          <div style="font-size:12px;color:#71717a;margin-bottom:8px">Was du bekommst:</div>
          <div style="font-size:13px;color:#fff">
            ${nextPlanId === 'cruise' ? '‚Ä¢ Hybrid-Modus f√ºr Smart Replies<br>‚Ä¢ Event-Analyse<br>‚Ä¢ Erweiterte KPIs' : 
              nextPlanId === 'autopilot' ? '‚Ä¢ Vollautomatische Antworten<br>‚Ä¢ Priorisierte KI<br>‚Ä¢ Early-Access Features' : ''}
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <button class="btn btn-primary" style="width:100%" onclick="startUpgradeTrial('${nextPlanId}')">
            ${planNames[nextPlanId]} kostenlos testen
          </button>
          <button class="btn btn-secondary" style="width:100%;color:#71717a" onclick="showFinalCancelConfirm()">
            Trotzdem k√ºndigen
          </button>
        </div>
      </div>
    `);
  } else {
    // No upgrade available OR user already used trial, show final cancel confirm directly
    showFinalCancelConfirm();
  }
}

function showFinalCancelConfirm() {
  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:32px;margin-bottom:16px">‚ö†Ô∏è</div>
      <div style="font-size:18px;font-weight:700;margin-bottom:8px">Abo k√ºndigen?</div>
      <div style="color:#a1a1aa;margin-bottom:24px">
        Du kannst PilotStay bis zum Ende deiner aktuellen Abrechnungsperiode weiter nutzen.
      </div>
      <div style="display:flex;gap:12px">
        <button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Abbrechen</button>
        <button class="btn" style="flex:1;background:#ef4444;color:#fff;border:none" onclick="cancelSubscription()">K√ºndigen</button>
      </div>
    </div>
  `);
}

async function startUpgradeTrial(newPlanId) {
  hideModal();
  showToast('Upgrade-Test wird eingerichtet...');
  
  try {
    const session = await db.auth.getSession();
    const token = session?.data?.session?.access_token;
    
    if (!token) {
      showToast('Bitte melde dich erneut an');
      return;
    }
    
    const response = await fetch(`${STRIPE_BILLING_URL}?action=start-upgrade-trial`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({
        newPlanId: newPlanId,
        trialMonths: 2
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Upgrade-Test aktiviert');
      await loadSubscription();
      renderPage();
    } else {
      showToast(data.error || 'Fehler beim Aktivieren');
    }
  } catch (e) {
    console.error('Upgrade trial error:', e);
    showToast('Fehler beim Aktivieren');
  }
}

async function cancelSubscription() {
  hideModal();
  showToast('Wird gek√ºndigt...');
  
  try {
    const session = await db.auth.getSession();
    const token = session?.data?.session?.access_token;
    
    if (!token) {
      showToast('Bitte melde dich erneut an');
      return;
    }
    
    const response = await fetch(`${STRIPE_BILLING_URL}?action=cancel-subscription`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Abo wird zum Periodenende gek√ºndigt');
      await loadSubscription();
      renderPage();
    } else if (data.error === 'Invalid token') {
      // Token expired, try to refresh
      showToast('Session wird erneuert...');
      const { data: refreshData, error: refreshError } = await db.auth.refreshSession();
      if (refreshError || !refreshData?.session) {
        showToast('Bitte melde dich erneut an');
        return;
      }
      // Retry with new token
      const retryResponse = await fetch(`${STRIPE_BILLING_URL}?action=cancel-subscription`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + refreshData.session.access_token
        }
      });
      const retryData = await retryResponse.json();
      if (retryData.success) {
        showToast('Abo wird zum Periodenende gek√ºndigt');
        await loadSubscription();
        renderPage();
      } else {
        showToast(retryData.error || 'Fehler bei der K√ºndigung');
      }
    } else {
      showToast(data.error || 'Fehler bei der K√ºndigung');
    }
  } catch (e) {
    console.error('Cancel error:', e);
    showToast('Fehler bei der K√ºndigung');
  }
}

// Sync property count to Stripe for metered billing
async function syncPropertyUsage() {
  try {
    const session = await db.auth.getSession();
    const token = session?.data?.session?.access_token;
    
    if (!token || !userSubscription?.stripe_subscription_id) {
      console.log('No active subscription, skipping property sync');
      return;
    }
    
    const response = await fetch(`${STRIPE_BILLING_URL}?action=sync-property-count`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      }
    });
    
    const data = await response.json();
    
    if (data.synced) {
      console.log(`Property usage synced: ${data.propertyCount} properties`);
    } else {
      console.warn('Property sync failed:', data.message);
    }
  } catch (e) {
    console.error('Property sync error:', e);
  }
}

// Reactivate canceled subscription
async function reactivateSubscription() {
  showToast('‚è≥ Abo wird reaktiviert...');
  
  try {
    const session = await db.auth.getSession();
    const token = session?.data?.session?.access_token;
    
    if (!token) {
      showToast('‚ùå Bitte melde dich erneut an');
      return;
    }
    
    const response = await fetch(`${STRIPE_BILLING_URL}?action=reactivate-subscription`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('‚úÖ Abo erfolgreich reaktiviert!');
      await loadSubscription();
      renderPage();
    } else {
      showToast('‚ùå ' + (data.error || 'Fehler beim Reaktivieren'));
    }
  } catch (e) {
    console.error('Reactivate error:', e);
    showToast('‚ùå Fehler beim Reaktivieren');
  }
}

// Cache for invoices
let cachedInvoices = null;

async function loadInvoices(loadAll = false) {
  const container = document.getElementById('invoices-list');
  if (!container) return;
  
  // Use cached invoices if available (and not loading all)
  if (cachedInvoices && !loadAll) {
    renderInvoicesList(container, cachedInvoices.slice(0, 3), cachedInvoices.length > 3);
    return;
  }
  
  container.innerHTML = '<div style="text-align:center;color:#71717a;padding:20px">Laden...</div>';
  
  try {
    const session = await db.auth.getSession();
    const token = session?.data?.session?.access_token;
    
    const limit = loadAll ? 20 : 3;
    const response = await fetch(`${STRIPE_BILLING_URL}?action=get-invoices&limit=${limit}`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    
    const data = await response.json();
    cachedInvoices = data.invoices || [];
    
    if (loadAll) {
      renderInvoicesList(container, cachedInvoices, false);
    } else {
      renderInvoicesList(container, cachedInvoices.slice(0, 3), cachedInvoices.length > 3);
    }
  } catch (e) {
    console.error('Load invoices error:', e);
    container.innerHTML = '<div style="text-align:center;color:#ef4444;padding:20px">Fehler beim Laden</div>';
  }
}

function renderInvoicesList(container, invoices, hasMore = false) {
  if (invoices && invoices.length > 0) {
    container.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:8px">
        ${invoices.map(inv => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#18181b;border-radius:8px">
            <div>
              <div style="font-weight:600">${inv.number || 'Rechnung'}</div>
              <div style="font-size:12px;color:#71717a">${new Date(inv.date * 1000).toLocaleDateString('de-DE')}</div>
            </div>
            <div style="display:flex;align-items:center;gap:12px">
              <span style="font-weight:600">‚Ç¨${(inv.amount / 100).toFixed(2)}</span>
              <span class="tag tag-${inv.status === 'paid' ? 'green' : 'orange'}">${inv.status === 'paid' ? 'Bezahlt' : inv.status}</span>
              ${inv.pdf ? `<a href="${inv.pdf}" target="_blank" class="btn btn-sm btn-secondary">PDF</a>` : ''}
            </div>
          </div>
        `).join('')}
      </div>
      ${hasMore ? `
        <button class="btn btn-secondary" style="width:100%;margin-top:12px;font-size:12px" onclick="loadInvoices(true)">
          üìÑ Weitere Rechnungen anzeigen
        </button>
      ` : ''}
    `;
  } else {
    container.innerHTML = '<div style="text-align:center;color:#71717a;padding:20px">Keine Rechnungen vorhanden</div>';
  }
}

async function loadSubscription() {
  try {
    const session = await db.auth.getSession();
    const token = session?.data?.session?.access_token;
    
    if (!token) return;
    
    const response = await fetch(`${STRIPE_BILLING_URL}?action=get-subscription`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    
    const data = await response.json();
    userSubscription = data.subscription;
    
    console.log('Subscription loaded:', userSubscription);
    
    // Check for scheduled plan change
    if (userSubscription?.pending_plan_id && userSubscription?.pending_change_date) {
      const planNames = { takeoff: 'Takeoff', cruise: 'Cruise', autopilot: 'Autopilot', enterprise: 'Enterprise' };
      scheduledPlanChange = {
        newPlanId: userSubscription.pending_plan_id,
        newPlanName: planNames[userSubscription.pending_plan_id] || userSubscription.pending_plan_id,
        effectiveDate: userSubscription.pending_change_date,
        currentPlanId: userSubscription.plan_id
      };
    } else {
      scheduledPlanChange = null;
    }
    
    // Check if upgrade trial just ended - show "Did it help?" modal
    if (userSubscription?.upgrade_trial_ended && !localStorage.getItem('upgrade_trial_feedback_shown_' + user?.id)) {
      setTimeout(() => {
        showUpgradeTrialEndedModal();
      }, 1000);
    }
    
    // IMPORTANT: Don't assume active status if there's no real subscription record
    // Only trust userSubscription from the API which checks Stripe
    
    // Update user plan display in sidebar
    renderUser();
    
    // Also refresh profile to get latest data
    if (user?.id) {
      const { data: updatedProfile } = await db.from('profiles').select('*').eq('id', user.id).single();
      if (updatedProfile) {
        profile = updatedProfile;
      }
    }
  } catch (e) {
    console.error('Load subscription error:', e);
  }
}

// Show modal after upgrade trial ends
function showUpgradeTrialEndedModal() {
  const planNames = { takeoff: 'Takeoff', cruise: 'Cruise', autopilot: 'Autopilot', enterprise: 'Enterprise' };
  const currentPlan = userSubscription?.plan_id;
  const planHierarchy = ['takeoff', 'cruise', 'autopilot'];
  const currentIndex = planHierarchy.indexOf(currentPlan);
  const nextPlanId = currentIndex >= 0 && currentIndex < planHierarchy.length - 1 ? planHierarchy[currentIndex + 1] : null;
  
  if (!nextPlanId) return;
  
  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:48px;margin-bottom:16px">‚≠ê</div>
      <div style="font-size:18px;font-weight:700;margin-bottom:8px">Dein Upgrade-Test ist beendet</div>
      <div style="color:#a1a1aa;margin-bottom:20px;line-height:1.6">
        Haben dir die zus√§tzlichen <strong style="color:#f97316">${planNames[nextPlanId]}</strong>-Features im Alltag geholfen?
      </div>
      <div style="background:#18181b;border-radius:6px;padding:16px;margin-bottom:20px">
        <div style="font-size:14px;color:#fff;margin-bottom:12px">
          Jetzt dauerhaft upgraden und alle Vorteile behalten:
        </div>
        <div style="font-size:13px;color:#a1a1aa;text-align:left">
          ${nextPlanId === 'cruise' ? '‚úì Hybrid-Modus f√ºr Smart Replies<br>‚úì Event-Analyse<br>‚úì Erweiterte KPIs' : 
            nextPlanId === 'autopilot' ? '‚úì Vollautomatische Antworten<br>‚úì Priorisierte KI<br>‚úì Early-Access Features' : ''}
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <button class="btn btn-primary" style="width:100%" onclick="hideModal(); selectPlan('${nextPlanId}')">
          Jetzt auf ${planNames[nextPlanId]} upgraden
        </button>
        <button class="btn btn-secondary" style="width:100%;color:#71717a" onclick="dismissUpgradeTrialFeedback()">
          Nein danke, ich bleibe bei ${planNames[currentPlan]}
        </button>
      </div>
    </div>
  `);
}

function dismissUpgradeTrialFeedback() {
  // Mark as shown so we don't show again
  localStorage.setItem('upgrade_trial_feedback_shown_' + user?.id, 'true');
  
  // Clear the flag in database
  clearUpgradeTrialEndedFlag();
  
  hideModal();
}

async function clearUpgradeTrialEndedFlag() {
  try {
    const session = await db.auth.getSession();
    const token = session?.data?.session?.access_token;
    if (!token) return;
    
    await fetch(`${STRIPE_BILLING_URL}?action=clear-upgrade-trial-ended`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      }
    });
  } catch (e) {
    console.error('Error clearing upgrade trial flag:', e);
  }
}

function contactEnterprise() {
  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:48px;margin-bottom:16px">üè¢</div>
      <div style="font-size:18px;font-weight:700;margin-bottom:8px">Enterprise-Anfrage</div>
      <div style="color:#a1a1aa;margin-bottom:24px">
        F√ºr Agenturen, Hotelketten und gro√üe Property-Manager erstellen wir individuelle Angebote.
      </div>
      <div style="background:#18181b;padding:16px;border-radius:10px;margin-bottom:20px;text-align:left">
        <div style="font-size:13px;margin-bottom:8px"><strong>Kontaktiere uns:</strong></div>
        <div style="font-size:13px;color:#a1a1aa">üìß enterprise@pilotstay.app</div>
        <div style="font-size:13px;color:#a1a1aa">üìû +49 123 456789</div>
      </div>
      <button class="btn btn-primary" onclick="hideModal()">Verstanden</button>
    </div>
  `);
}

// Check for checkout success on page load
async function checkCheckoutResult() {
  const urlParams = new URLSearchParams(window.location.search);
  const checkout = urlParams.get('checkout');
  const sessionId = urlParams.get('session_id');
  
  if (checkout === 'success') {
    // Clean URL immediately
    window.history.replaceState({}, '', window.location.pathname);
    
    showToast('üéâ Willkommen bei PilotStay!');
    
    // Wait a moment for webhook to process, then reload subscription
    // Try multiple times as webhook might take a few seconds
    let retries = 0;
    const maxRetries = 5;
    
    const checkSubscription = async () => {
      await loadSubscription();
      
      if (userSubscription?.status && userSubscription.status !== 'none') {
        showToast('‚úÖ Dein Abo ist jetzt aktiv!');
        renderPage();
        return true;
      }
      
      retries++;
      if (retries < maxRetries) {
        showToast(`‚è≥ Aktiviere Abo... (${retries}/${maxRetries})`);
        setTimeout(checkSubscription, 2000); // Wait 2 seconds between retries
      } else {
        showToast('‚ö†Ô∏è Abo-Status wird geladen. Bitte Seite in 30 Sekunden neu laden.');
      }
      return false;
    };
    
    // Start checking after 1 second
    setTimeout(checkSubscription, 1000);
    
  } else if (checkout === 'canceled') {
    showToast('‚ÑπÔ∏è Checkout abgebrochen');
    window.history.replaceState({}, '', window.location.pathname);
  }
}

function confirmLogout() {
  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:48px;margin-bottom:16px">üëã</div>
      <div style="font-size:18px;font-weight:700;margin-bottom:8px">Wirklich abmelden?</div>
      <div style="color:#a1a1aa;margin-bottom:24px">Du kannst dich jederzeit wieder anmelden.</div>
      <div style="display:flex;gap:12px">
        <button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Abbrechen</button>
        <button class="btn btn-primary" onclick="doLogout()" style="flex:1">Abmelden</button>
      </div>
    </div>
  `);
}

async function doLogout() {
  await db.auth.signOut();
  window.location.href = 'auth.html';
}

// =====================
// MODALS
// =====================
function showModal(html) {
  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('modal').style.display = 'flex';
}

function hideModal() {
  document.getElementById('modal').style.display = 'none';
}

function showAddProp() {
  showModal('<div class="modal-title">üè† Neues Objekt</div><div style="margin-bottom:16px"><label class="label">Name *</label><input class="input" id="p-name" placeholder="z.B. Gem√ºtliche Wohnung"></div><div class="grid-2" style="gap:12px;margin-bottom:16px"><div><label class="label">Stadt</label><input class="input" id="p-city" placeholder="Berlin"></div><div><label class="label">PLZ</label><input class="input" id="p-zip" placeholder="10115"></div></div><div class="grid-2" style="gap:12px;margin-bottom:16px"><div><label class="label">Schlafzimmer</label><input class="input" type="number" id="p-bed" value="1" min="1"></div><div><label class="label">Max G√§ste</label><input class="input" type="number" id="p-guests" value="2" min="1"></div></div><div style="margin-bottom:20px"><label class="label">Preis/Nacht (‚Ç¨)</label><input class="input" type="number" id="p-price" placeholder="80"></div><div style="display:flex;gap:12px"><button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Abbrechen</button><button class="btn btn-primary" onclick="addProp()" style="flex:1">‚úì Anlegen</button></div>');
}

async function addProp() {
  const name = document.getElementById('p-name').value.trim();
  if (!name) { alert('Bitte Namen eingeben'); return; }
  const {data, error} = await db.from('properties').insert({host_id:user.id, name, city:document.getElementById('p-city').value.trim(), zip:document.getElementById('p-zip').value.trim(), bedrooms:parseInt(document.getElementById('p-bed').value)||1, max_guests:parseInt(document.getElementById('p-guests').value)||2, base_price:parseFloat(document.getElementById('p-price').value)||null, property_type:'apartment', active:true}).select().single();
  if (error) alert('Fehler: ' + error.message);
  else { 
    properties.unshift(data); 
    hideModal(); 
    renderPage(); 
    // Sync property count to Stripe
    await syncPropertyUsage();
  }
}

function showAddBook() {
  if (!properties.length) { alert('Bitte erst Objekt anlegen'); return; }
  showModal('<div class="modal-title">üìÖ Neue Buchung</div><div style="margin-bottom:16px"><label class="label">Objekt *</label><select class="input" id="b-prop">' + properties.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('') + '</select></div><div style="margin-bottom:16px"><label class="label">Gast *</label><input class="input" id="b-guest" placeholder="Max Mustermann"></div><div class="grid-2" style="gap:12px;margin-bottom:16px"><div><label class="label">Check-in</label><input class="input" type="date" id="b-in"></div><div><label class="label">Check-out</label><input class="input" type="date" id="b-out"></div></div><div style="margin-bottom:20px"><label class="label">Preis (‚Ç¨)</label><input class="input" type="number" id="b-price" placeholder="350"></div><div style="display:flex;gap:12px"><button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Abbrechen</button><button class="btn btn-primary" onclick="addBook()" style="flex:1">‚úì Speichern</button></div>');
}

async function addBook() {
  const guest = document.getElementById('b-guest').value.trim();
  const ci = document.getElementById('b-in').value;
  const co = document.getElementById('b-out').value;
  if (!guest || !ci || !co) { alert('Bitte alle Felder ausf√ºllen'); return; }
  const {data, error} = await db.from('bookings').insert({host_id:user.id, property_id:document.getElementById('b-prop').value, guest_name:guest, check_in:ci, check_out:co, total_price:parseFloat(document.getElementById('b-price').value)||0, status:'confirmed', source:'manual'}).select('*,properties(name)').single();
  if (error) alert('Fehler: ' + error.message);
  else { bookings.unshift(data); hideModal(); renderPage(); }
}

// =====================
// EDIT & DELETE FUNCTIONS
// =====================

function editProperty(id) {
  const p = properties.find(prop => prop.id === id);
  if (!p) return;
  
  showModal(`
    <div class="modal-title">‚úèÔ∏è Objekt bearbeiten</div>
    <div style="margin-bottom:16px">
      <label class="label">Name *</label>
      <input class="input" id="ep-name" value="${p.name || ''}" placeholder="z.B. Gem√ºtliche Wohnung">
    </div>
    <div class="grid-2" style="gap:12px;margin-bottom:16px">
      <div><label class="label">Stadt</label><input class="input" id="ep-city" value="${p.city || ''}" placeholder="Berlin"></div>
      <div><label class="label">PLZ</label><input class="input" id="ep-zip" value="${p.zip || ''}" placeholder="10115"></div>
    </div>
    <div class="grid-2" style="gap:12px;margin-bottom:16px">
      <div><label class="label">Schlafzimmer</label><input class="input" type="number" id="ep-bed" value="${p.bedrooms || 1}" min="1"></div>
      <div><label class="label">Max G√§ste</label><input class="input" type="number" id="ep-guests" value="${p.max_guests || 2}" min="1"></div>
    </div>
    <div style="margin-bottom:20px">
      <label class="label">Preis/Nacht (‚Ç¨)</label>
      <input class="input" type="number" id="ep-price" value="${p.base_price || ''}" placeholder="80">
    </div>
    <div style="display:flex;gap:12px">
      <button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Abbrechen</button>
      <button class="btn btn-primary" onclick="updateProperty('${id}')" style="flex:1">‚úì Speichern</button>
    </div>
  `);
}

async function updateProperty(id) {
  const name = document.getElementById('ep-name').value.trim();
  if (!name) { alert('Bitte Namen eingeben'); return; }
  
  const updateData = {
    name,
    city: document.getElementById('ep-city').value.trim(),
    zip: document.getElementById('ep-zip').value.trim(),
    bedrooms: parseInt(document.getElementById('ep-bed').value) || 1,
    max_guests: parseInt(document.getElementById('ep-guests').value) || 2,
    base_price: parseFloat(document.getElementById('ep-price').value) || null
  };
  
  const {error} = await db.from('properties').update(updateData).eq('id', id);
  
  if (error) {
    alert('Fehler: ' + error.message);
  } else {
    // Update local data
    const idx = properties.findIndex(p => p.id === id);
    if (idx !== -1) properties[idx] = {...properties[idx], ...updateData};
    hideModal();
    showToast('‚úÖ Objekt aktualisiert');
    renderPage();
  }
}

async function deleteProperty(id) {
  const p = properties.find(prop => prop.id === id);
  if (!p) return;
  
  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:48px;margin-bottom:16px">üóëÔ∏è</div>
      <div style="font-size:18px;font-weight:700;margin-bottom:8px">Objekt l√∂schen?</div>
      <div style="color:#a1a1aa;margin-bottom:8px">"${p.name}"</div>
      <div style="color:#ef4444;font-size:12px;margin-bottom:24px">
        ‚ö†Ô∏è Alle zugeh√∂rigen Buchungen werden ebenfalls gel√∂scht!
      </div>
      <div style="display:flex;gap:12px">
        <button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Abbrechen</button>
        <button class="btn btn-primary" onclick="confirmDeleteProperty('${id}')" style="flex:1;background:#ef4444">üóëÔ∏è L√∂schen</button>
      </div>
    </div>
  `);
}

async function confirmDeleteProperty(id) {
  // First delete related bookings
  await db.from('bookings').delete().eq('property_id', id);
  
  // Then delete property
  const {error} = await db.from('properties').delete().eq('id', id);
  
  if (error) {
    alert('Fehler: ' + error.message);
  } else {
    // Remove from local data
    properties = properties.filter(p => p.id !== id);
    bookings = bookings.filter(b => b.property_id !== id);
    hideModal();
    showToast('‚úÖ Objekt gel√∂scht');
    renderPage();
    // Sync property count to Stripe
    await syncPropertyUsage();
  }
}

function editBooking(id) {
  const b = bookings.find(book => book.id === id);
  if (!b) return;
  
  showModal(`
    <div class="modal-title">‚úèÔ∏è Buchung bearbeiten</div>
    <div style="margin-bottom:16px">
      <label class="label">Objekt *</label>
      <select class="input" id="eb-prop">
        ${properties.map(p => `<option value="${p.id}" ${p.id === b.property_id ? 'selected' : ''}>${p.name}</option>`).join('')}
      </select>
    </div>
    <div style="margin-bottom:16px">
      <label class="label">Gast *</label>
      <input class="input" id="eb-guest" value="${b.guest_name || ''}" placeholder="Max Mustermann">
    </div>
    <div class="grid-2" style="gap:12px;margin-bottom:16px">
      <div><label class="label">Check-in</label><input class="input" type="date" id="eb-in" value="${b.check_in || ''}"></div>
      <div><label class="label">Check-out</label><input class="input" type="date" id="eb-out" value="${b.check_out || ''}"></div>
    </div>
    <div class="grid-2" style="gap:12px;margin-bottom:16px">
      <div><label class="label">Preis (‚Ç¨)</label><input class="input" type="number" id="eb-price" value="${b.total_price || ''}" placeholder="350"></div>
      <div>
        <label class="label">Status</label>
        <select class="input" id="eb-status">
          <option value="confirmed" ${b.status === 'confirmed' ? 'selected' : ''}>Best√§tigt</option>
          <option value="cancelled" ${b.status === 'cancelled' ? 'selected' : ''}>Storniert</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:12px">
      <button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Abbrechen</button>
      <button class="btn btn-primary" onclick="updateBooking('${id}')" style="flex:1">‚úì Speichern</button>
    </div>
  `);
}

async function updateBooking(id) {
  const guest = document.getElementById('eb-guest').value.trim();
  const ci = document.getElementById('eb-in').value;
  const co = document.getElementById('eb-out').value;
  
  if (!guest || !ci || !co) { alert('Bitte alle Felder ausf√ºllen'); return; }
  
  const updateData = {
    property_id: document.getElementById('eb-prop').value,
    guest_name: guest,
    check_in: ci,
    check_out: co,
    total_price: parseFloat(document.getElementById('eb-price').value) || 0,
    status: document.getElementById('eb-status').value
  };
  
  const {error} = await db.from('bookings').update(updateData).eq('id', id);
  
  if (error) {
    alert('Fehler: ' + error.message);
  } else {
    // Update local data
    const idx = bookings.findIndex(b => b.id === id);
    if (idx !== -1) {
      bookings[idx] = {...bookings[idx], ...updateData};
      // Update property name reference
      const prop = properties.find(p => p.id === updateData.property_id);
      if (prop) bookings[idx].properties = {name: prop.name};
    }
    hideModal();
    showToast('‚úÖ Buchung aktualisiert');
    renderPage();
  }
}

async function deleteBooking(id) {
  const b = bookings.find(book => book.id === id);
  if (!b) return;
  
  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:48px;margin-bottom:16px">üóëÔ∏è</div>
      <div style="font-size:18px;font-weight:700;margin-bottom:8px">Buchung l√∂schen?</div>
      <div style="color:#a1a1aa;margin-bottom:8px">Gast: ${b.guest_name}</div>
      <div style="color:#71717a;font-size:12px;margin-bottom:24px">
        ${fmtDate(b.check_in)} - ${fmtDate(b.check_out)} ¬∑ ‚Ç¨${b.total_price || 0}
      </div>
      <div style="display:flex;gap:12px">
        <button class="btn btn-secondary" onclick="hideModal()" style="flex:1">Abbrechen</button>
        <button class="btn btn-primary" onclick="confirmDeleteBooking('${id}')" style="flex:1;background:#ef4444">üóëÔ∏è L√∂schen</button>
      </div>
    </div>
  `);
}

async function confirmDeleteBooking(id) {
  const {error} = await db.from('bookings').delete().eq('id', id);
  
  if (error) {
    alert('Fehler: ' + error.message);
  } else {
    // Remove from local data
    bookings = bookings.filter(b => b.id !== id);
    hideModal();
    showToast('‚úÖ Buchung gel√∂scht');
    renderPage();
  }
}

async function saveProfile() {
  const updateData = {
    first_name: document.getElementById('s-fn')?.value?.trim() || null,
    last_name: document.getElementById('s-ln')?.value?.trim() || null,
    phone: document.getElementById('s-ph')?.value?.trim() || null,
    // Adresse
    street: document.getElementById('s-street')?.value?.trim() || null,
    zip: document.getElementById('s-zip')?.value?.trim() || null,
    city: document.getElementById('s-city')?.value?.trim() || null,
    country: document.getElementById('s-country')?.value || 'DE',
    // Unternehmen
    company_name: document.getElementById('s-company')?.value?.trim() || null,
    vat_id: document.getElementById('s-vat')?.value?.trim() || null,
    tax_number: document.getElementById('s-tax')?.value?.trim() || null,
    // Zahlung
    iban: document.getElementById('s-iban')?.value?.trim() || null,
    account_holder: document.getElementById('s-holder')?.value?.trim() || null
  };
  
  const {error} = await db.from('profiles').update(updateData).eq('id', user.id);
  
  if (error) {
    console.error('Profile save error:', error);
    showToast('‚ùå Fehler beim Speichern');
  } else { 
    const {data} = await db.from('profiles').select('*').eq('id', user.id).single(); 
    profile = data; 
    renderUser();
    showToast('‚úÖ Profil gespeichert');
  }
}

// =====================
// HELPERS
// =====================
function fmtDate(d) {
  return d ? new Date(d).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'}) : '-';
}

// =====================
// EVENTS
// =====================
function bindEvents() {
  document.querySelectorAll('.nav-item').forEach(i => i.onclick = () => setPage(i.dataset.page));
  document.getElementById('logout-btn').onclick = async () => { await db.auth.signOut(); window.location.href = 'auth.html'; };
  document.getElementById('modal').onclick = e => { if (e.target.id === 'modal') hideModal(); };
}

// =====================
// START
// =====================
init();
</script>
</body>
</html>
