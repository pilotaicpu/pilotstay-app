<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PilotStay – Login</title>
  <style>
    :root{
      --bg:#07090d;
      --panel:#0f1219;
      --panel2:#111624;
      --text:#e8ecf5;
      --muted:#9aa3b2;
      --border:rgba(255,255,255,.08);
      --shadow:0 20px 60px rgba(0,0,0,.55);
      --accent:#ff7a18;
      --accent2:#ff9a4a;
      --danger:#ff4d4d;
      --ok:#39d98a;
      --radius:18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background: radial-gradient(1200px 800px at 50% 40%, rgba(255,122,24,.10), transparent 60%),
                  radial-gradient(900px 600px at 20% 10%, rgba(76,141,255,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--font);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .card{
      width:min(460px, 92vw);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .header{
      padding:26px 26px 14px 26px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:44px;height:44px;
      display:grid;place-items:center;
      border-radius:14px;
      background: rgba(255,122,24,.14);
      border:1px solid rgba(255,122,24,.25);
    }
    .logo svg{opacity:.95}
    h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .sub{
      margin:0;
      font-size:12.5px;
      color:var(--muted);
      text-align:center;
    }
    .tabs{
      display:flex;
      gap:8px;
      padding:0 18px 14px 18px;
      justify-content:center;
    }
    .tab{
      appearance:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      color:var(--muted);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      transition:.15s ease;
    }
    .tab.active{
      border-color: rgba(255,122,24,.35);
      background: rgba(255,122,24,.14);
      color:var(--text);
    }
    .content{
      padding:0 26px 24px 26px;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:12px 0 6px;
    }
    input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    input:focus{
      border-color: rgba(255,122,24,.38);
      box-shadow:0 0 0 4px rgba(255,122,24,.10);
    }
    .row{display:flex; gap:10px}
    .row > *{flex:1}
    .btn{
      width:100%;
      margin-top:16px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(255,122,24,.35);
      background: linear-gradient(180deg, rgba(255,122,24,.95), rgba(255,122,24,.82));
      color:#111;
      font-weight:800;
      cursor:pointer;
      transition:.12s ease;
    }
    .btn:hover{filter:brightness(1.03)}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .link{
      background:none;border:none;color:var(--accent2);
      cursor:pointer;font-weight:700;padding:0;
      text-decoration:none;
    }
    .hint{
      margin-top:12px;
      font-size:12px;color:var(--muted);
      text-align:center;
    }
    .msg{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      font-size:13px;
      display:none;
      white-space:pre-wrap;
    }
    .msg.err{border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.08)}
    .msg.ok{border-color: rgba(57,217,138,.35); background: rgba(57,217,138,.08)}
    .config{
      margin-top:14px;
      padding:14px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.20);
      display:none;
    }
    .configHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .badge{
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:6px 10px;border-radius:999px;
      background: rgba(255,255,255,.02);
    }
    .mini{
      font-size:12px;color:var(--muted);line-height:1.35;
    }
    .btnGhost{
      width:100%;
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      color:var(--text);
      font-weight:700;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <div class="logo" aria-hidden="true">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
          <path d="M2.7 12.7c4.2 1.1 7.8 2 9.6 2.3 1.9.3 2.5-.1 3.3-1 1.7-1.9 4-6.6 5.5-9.5.3-.6-.3-1.2-.9-.9-2.9 1.5-7.6 3.8-9.5 5.5-.9.8-1.3 1.4-1 3.3.3 1.8 1.2 5.4 2.3 9.6.1.5-.4.9-.8.7-1.9-.9-5.4-2.6-7.4-4.1-.8-.6-1.2-1.6-1-2.6.4-1.7 1.1-4.1 1.9-6.5.1-.4.5-.6.9-.5z" fill="rgba(255,255,255,.92)"/>
        </svg>
      </div>
      <h1>PilotStay</h1>
      <p class="sub" id="subtitle">Einloggen oder registrieren, um das Dashboard zu öffnen.</p>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabLogin" type="button">Login</button>
      <button class="tab" id="tabRegister" type="button">Registrieren</button>
    </div>

    <div class="content">
      <div class="config" id="configBox">
        <div class="configHead">
          <div class="badge">Supabase Konfiguration fehlt</div>
          <button class="link" id="toggleConfig" type="button">Schließen</button>
        </div>
        <div class="mini">
          Für das Login braucht das Frontend die <b>SUPABASE_URL</b> und den <b>ANON KEY</b>.
          Diese Werte werden lokal im Browser gespeichert (LocalStorage) – du musst sie pro Gerät nur einmal eintragen.
        </div>
        <label>SUPABASE_URL</label>
        <input id="cfgUrl" placeholder="https://xxxxx.supabase.co" />
        <label>SUPABASE_ANON_KEY</label>
        <input id="cfgKey" placeholder="eyJhbGciOi..." />
        <button class="btnGhost" id="saveConfig" type="button">Konfiguration speichern</button>
      </div>

      <label>E-Mail</label>
      <input id="email" autocomplete="email" />

      <label>Passwort</label>
      <input id="password" type="password" autocomplete="current-password" />

      <div id="registerExtras" style="display:none">
        <label>Passwort wiederholen</label>
        <input id="password2" type="password" autocomplete="new-password" />
      </div>

      <label>org_id (optional)</label>
      <input id="orgId" placeholder="uuid" />

      <button class="btn" id="submit" type="button">Einloggen</button>

      <div class="msg" id="msg"></div>

      <div class="hint">
        <button class="link" id="openConfig" type="button">Supabase Settings</button>
        <span style="opacity:.55">•</span>
        <a class="link" href="./host-dashboard.html" id="toDashboard">Zum Dashboard</a>
      </div>
    </div>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2.49.1";

  const LS_URL_KEY = "PILOTSTAY_SUPABASE_URL";
  const LS_ANON_KEY = "PILOTSTAY_SUPABASE_ANON_KEY";
  const LS_ORG_KEY  = "PILOTSTAY_ORG_ID";
  const LS_JWT_KEY  = "ps_jwt";

  const $ = (id) => document.getElementById(id);

  const tabLogin = $("tabLogin");
  const tabRegister = $("tabRegister");
  const registerExtras = $("registerExtras");
  const submitBtn = $("submit");
  const msg = $("msg");
  const subtitle = $("subtitle");

  const configBox = $("configBox");
  const openConfig = $("openConfig");
  const toggleConfig = $("toggleConfig");
  const saveConfig = $("saveConfig");
  const cfgUrl = $("cfgUrl");
  const cfgKey = $("cfgKey");

  function showMsg(text, kind){
    msg.style.display = "block";
    msg.className = "msg " + (kind || "");
    msg.textContent = text;
  }
  function clearMsg(){
    msg.style.display = "none";
    msg.textContent = "";
    msg.className = "msg";
  }

  function getConfig(){
    const url = (localStorage.getItem(LS_URL_KEY) || "").trim();
    const key = (localStorage.getItem(LS_ANON_KEY) || "").trim();
    return { url, key };
  }
  function requireConfig(){
    const { url, key } = getConfig();
    if (!url || !key){
      cfgUrl.value = url;
      cfgKey.value = key;
      configBox.style.display = "block";
      showMsg("Konfiguration fehlt: Öffne „Supabase Settings“ und speichere URL + ANON KEY.", "err");
      return null;
    }
    return { url, key };
  }

  function setMode(mode){
    const isRegister = mode === "register";
    tabLogin.classList.toggle("active", !isRegister);
    tabRegister.classList.toggle("active", isRegister);
    registerExtras.style.display = isRegister ? "block" : "none";
    submitBtn.textContent = isRegister ? "Registrieren" : "Einloggen";
    subtitle.textContent = isRegister
      ? "Registriere dich (Business Account). Danach kannst du dich einloggen."
      : "Einloggen oder registrieren, um das Dashboard zu öffnen.";
    clearMsg();
  }

  tabLogin.addEventListener("click", () => setMode("login"));
  tabRegister.addEventListener("click", () => setMode("register"));

  openConfig.addEventListener("click", () => {
    const { url, key } = getConfig();
    cfgUrl.value = url;
    cfgKey.value = key;
    configBox.style.display = configBox.style.display === "block" ? "none" : "block";
    clearMsg();
  });
  toggleConfig.addEventListener("click", () => { configBox.style.display = "none"; });

  saveConfig.addEventListener("click", () => {
    const url = (cfgUrl.value || "").trim();
    const key = (cfgKey.value || "").trim();
    if (!url || !key) return showMsg("Bitte SUPABASE_URL und SUPABASE_ANON_KEY eintragen.", "err");
    localStorage.setItem(LS_URL_KEY, url);
    localStorage.setItem(LS_ANON_KEY, key);
    configBox.style.display = "none";
    showMsg("Konfiguration gespeichert. Du kannst dich jetzt einloggen.", "ok");
  });

  // Prefill org_id if stored
  const orgStored = (localStorage.getItem(LS_ORG_KEY) || "").trim();
  if (orgStored) $("orgId").value = orgStored;

  function getRedirectTarget(){
    const u = new URL(window.location.href);
    const r = (u.searchParams.get("redirect") || "").trim();
    if (r) return r;
    return "./host-dashboard.html";
  }

  async function onSubmit(){
    clearMsg();
    const mode = tabRegister.classList.contains("active") ? "register" : "login";

    const cfg = requireConfig();
    if (!cfg) return;

    const email = ($("email").value || "").trim();
    const password = $("password").value || "";
    const password2 = $("password2").value || "";
    const orgId = ($("orgId").value || "").trim();

    if (!email || !password) return showMsg("Bitte E-Mail und Passwort eingeben.", "err");
    if (mode === "register" && password.length < 6) return showMsg("Passwort muss mindestens 6 Zeichen haben.", "err");
    if (mode === "register" && password !== password2) return showMsg("Passwörter stimmen nicht überein.", "err");

    if (orgId) localStorage.setItem(LS_ORG_KEY, orgId);

    submitBtn.disabled = true;
    submitBtn.textContent = mode === "register" ? "Registriere..." : "Logge ein...";

    try{
      const sb = createClient(cfg.url, cfg.key);

      if (mode === "register"){
        const { data, error } = await sb.auth.signUp({ email, password });
        if (error) throw error;

        // If email confirmations enabled, session can be null
        if (data?.session?.access_token){
          localStorage.setItem(LS_JWT_KEY, data.session.access_token);
          showMsg("Registrierung erfolgreich. Du bist eingeloggt – weiterleiten…", "ok");
          window.location.href = getRedirectTarget();
        } else {
          showMsg("Registrierung erfolgreich. Bitte bestätige ggf. deine E-Mail und logge dich danach ein.", "ok");
          setMode("login");
        }
        return;
      }

      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) throw error;

      const token = data?.session?.access_token;
      if (!token) throw new Error("Kein JWT erhalten (Supabase Session fehlt).");

      localStorage.setItem(LS_JWT_KEY, token);
      showMsg("Login erfolgreich – weiterleiten…", "ok");
      window.location.href = getRedirectTarget();

    }catch(e){
      const m = (e?.message || String(e));
      showMsg("Login fehlgeschlagen: " + m, "err");
    }finally{
      submitBtn.disabled = false;
      submitBtn.textContent = mode === "register" ? "Registrieren" : "Einloggen";
    }
  }

  submitBtn.addEventListener("click", onSubmit);

  // Allow enter
  ["email","password","password2","orgId"].forEach(id=>{
    $(id).addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") onSubmit(); });
  });

  // If already logged in, offer redirect (do NOT auto-redirect -> prevents loops)
  const existing = (localStorage.getItem(LS_JWT_KEY) || "").trim();
  if (existing){
    showMsg("Du bist bereits eingeloggt. Du kannst direkt zum Dashboard.", "ok");
  }
</script>
</body>
</html>
