<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>PilotStay - Login</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#09090b;color:#fafafa;min-height:100vh;display:flex;align-items:center;justify-content:center}
.container{width:100%;max-width:420px;padding:24px}
.logo{text-align:center;margin-bottom:32px}
.logo-icon{font-size:48px;margin-bottom:8px}
.logo-text{font-size:24px;font-weight:700;background:linear-gradient(135deg,#f97316,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-sub{font-size:12px;color:#71717a;margin-top:4px}
.card{background:#131316;border:1px solid #27272a;border-radius:16px;padding:32px}
.tabs{display:flex;gap:8px;margin-bottom:24px}
.tab{flex:1;padding:12px;background:#18181b;border:1px solid #27272a;border-radius:8px;color:#71717a;font-size:13px;font-weight:600;cursor:pointer;text-align:center;transition:all .2s}
.tab.active{background:#f9731620;border-color:#f97316;color:#f97316}
.tab:hover:not(.active){background:#1f1f23}
.role-select{display:flex;gap:12px;margin-bottom:24px}
.role-btn{flex:1;padding:20px 16px;background:#18181b;border:2px solid #27272a;border-radius:12px;cursor:pointer;text-align:center;transition:all .2s}
.role-btn:hover{border-color:#3f3f46}
.role-btn.active{border-color:#22c55e;background:#22c55e10}
.role-btn.host.active{border-color:#f97316;background:#f9731610}
.role-btn.partner.active{border-color:#22c55e;background:#22c55e10}
.role-icon{font-size:28px;margin-bottom:8px}
.role-title{font-weight:600;font-size:14px;margin-bottom:4px}
.role-desc{font-size:11px;color:#71717a}
.form-group{margin-bottom:16px}
.label{display:block;font-size:12px;color:#a1a1aa;margin-bottom:6px}
.input{width:100%;padding:14px 16px;background:#18181b;border:1px solid #27272a;border-radius:10px;color:#fafafa;font-size:14px;transition:all .2s}
.input:focus{outline:none;border-color:#f97316}
.input::placeholder{color:#52525b}
.btn{width:100%;padding:14px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
.btn:hover{transform:scale(1.01)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-primary{background:linear-gradient(135deg,#f97316,#fb923c);color:#fff}
.btn-primary.partner{background:linear-gradient(135deg,#22c55e,#16a34a)}
.divider{display:flex;align-items:center;gap:16px;margin:20px 0;color:#52525b;font-size:12px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:#27272a}
.link{color:#f97316;text-decoration:none;font-size:13px}
.link:hover{text-decoration:underline}
.error{background:#ef444420;border:1px solid #ef4444;color:#fca5a5;padding:12px;border-radius:8px;font-size:13px;margin-bottom:16px;display:none}
.error.show{display:block}
.success{background:#22c55e20;border:1px solid #22c55e;color:#86efac;padding:12px;border-radius:8px;font-size:13px;margin-bottom:16px;display:none}
.success.show{display:block}
.footer{text-align:center;margin-top:24px;font-size:12px;color:#52525b}
.loading{display:inline-block;width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite;margin-right:8px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
.check-email{text-align:center;padding:20px 0}
.check-email-icon{font-size:48px;margin-bottom:16px}
.check-email h3{font-size:18px;margin-bottom:8px}
.check-email p{color:#71717a;font-size:13px}
</style>
</head>
<body>
<div class="container">
  <div class="logo">
    <div class="logo-icon">üöÄ</div>
    <div class="logo-text">PilotStay</div>
    <div class="logo-sub">Die Plattform f√ºr Airbnb-Hosts & Partner</div>
  </div>
  
  <div class="card">
    <div id="auth-content">
      <div class="tabs">
        <div class="tab active" data-tab="login">Anmelden</div>
        <div class="tab" data-tab="signup">Registrieren</div>
      </div>
      
      <div id="error-msg" class="error"></div>
      <div id="success-msg" class="success"></div>
      
      <div id="role-selection" style="display:none">
        <div class="label">Ich bin...</div>
        <div class="role-select">
          <div class="role-btn host active" data-role="host">
            <div class="role-icon">üè†</div>
            <div class="role-title">Host</div>
            <div class="role-desc">Vermieter von Ferienwohnungen</div>
          </div>
          <div class="role-btn partner" data-role="partner">
            <div class="role-icon">ü§ù</div>
            <div class="role-title">Partner</div>
            <div class="role-desc">Reinigung & Services</div>
          </div>
        </div>
      </div>
      
      <form id="auth-form">
        <div class="form-group" id="name-group" style="display:none">
          <label class="label">Name</label>
          <input type="text" class="input" id="name" placeholder="Max Mustermann">
        </div>
        
        <div class="form-group">
          <label class="label">E-Mail</label>
          <input type="email" class="input" id="email" placeholder="name@beispiel.de" required>
        </div>
        
        <div class="form-group">
          <label class="label">Passwort</label>
          <input type="password" class="input" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
        </div>
        
        <button type="submit" class="btn btn-primary" id="submit-btn">
          Anmelden
        </button>
      </form>
      
      <div class="divider">oder</div>
      
      <p style="text-align:center">
        <span id="switch-text">Noch kein Account?</span>
        <a href="#" class="link" id="switch-link">Jetzt registrieren</a>
      </p>
    </div>
    
    <div id="check-email" class="check-email" style="display:none">
      <div class="check-email-icon">üìß</div>
      <h3>Best√§tige deine E-Mail</h3>
      <p>Wir haben dir einen Link an <strong id="confirm-email"></strong> gesendet. Klicke darauf um dein Konto zu aktivieren.</p>
      <br>
      <a href="#" class="link" onclick="location.reload()">Zur√ºck zum Login</a>
    </div>
  </div>
  
  <div class="footer">
    <p>¬© 2025 PilotStay ‚Ä¢ <a href="#" class="link">Datenschutz</a> ‚Ä¢ <a href="#" class="link">AGB</a></p>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://uamlcodalgibboftvhqp.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhbWxjb2RhbGdpYmJvZnR2aHFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTUyNDIsImV4cCI6MjA4Mzg5MTI0Mn0.t7OwT2MjL1CVdQTQAOaA1HwowFpaZsVZcqjTFHuTL1w';

const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let mode = 'login';
let role = 'host';
let loading = false;

const tabs = document.querySelectorAll('.tab');
const roleSelection = document.getElementById('role-selection');
const roleBtns = document.querySelectorAll('.role-btn');
const nameGroup = document.getElementById('name-group');
const form = document.getElementById('auth-form');
const submitBtn = document.getElementById('submit-btn');
const switchText = document.getElementById('switch-text');
const switchLink = document.getElementById('switch-link');
const errorMsg = document.getElementById('error-msg');
const successMsg = document.getElementById('success-msg');
const authContent = document.getElementById('auth-content');
const checkEmail = document.getElementById('check-email');
const confirmEmail = document.getElementById('confirm-email');

async function checkSession() {
  const { data: { session } } = await db.auth.getSession();
  if (session) {
    const { data: profile } = await db.from('profiles').select('role').eq('id', session.user.id).single();
    if (profile) {
      redirectToDashboard(profile.role);
    }
  }
}

function redirectToDashboard(userRole) {
  switch(userRole) {
    case 'host': window.location.href = 'host-dashboard.html'; break;
    case 'partner': window.location.href = 'partner-dashboard.html'; break;
    case 'admin': window.location.href = 'admin-dashboard.html'; break;
    default: window.location.href = 'host-dashboard.html';
  }
}

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    mode = tab.dataset.tab;
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    updateUI();
  });
});

roleBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    role = btn.dataset.role;
    roleBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    updateButtonStyle();
  });
});

switchLink.addEventListener('click', (e) => {
  e.preventDefault();
  mode = mode === 'login' ? 'signup' : 'login';
  tabs.forEach(t => t.classList.toggle('active'));
  updateUI();
});

function updateUI() {
  hideMessages();
  if (mode === 'signup') {
    roleSelection.style.display = 'block';
    nameGroup.style.display = 'block';
    submitBtn.textContent = 'Registrieren';
    switchText.textContent = 'Bereits registriert?';
    switchLink.textContent = 'Anmelden';
  } else {
    roleSelection.style.display = 'none';
    nameGroup.style.display = 'none';
    submitBtn.textContent = 'Anmelden';
    switchText.textContent = 'Noch kein Account?';
    switchLink.textContent = 'Jetzt registrieren';
  }
  updateButtonStyle();
}

function updateButtonStyle() {
  submitBtn.classList.remove('partner');
  if (mode === 'signup' && role === 'partner') {
    submitBtn.classList.add('partner');
  }
}

function showError(msg) {
  errorMsg.textContent = msg;
  errorMsg.classList.add('show');
  successMsg.classList.remove('show');
}

function showSuccess(msg) {
  successMsg.textContent = msg;
  successMsg.classList.add('show');
  errorMsg.classList.remove('show');
}

function hideMessages() {
  errorMsg.classList.remove('show');
  successMsg.classList.remove('show');
}

function setLoading(isLoading) {
  loading = isLoading;
  submitBtn.disabled = isLoading;
  submitBtn.innerHTML = isLoading 
    ? '<span class="loading"></span>Bitte warten...'
    : (mode === 'login' ? 'Anmelden' : 'Registrieren');
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (loading) return;
  
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const name = document.getElementById('name').value.trim();
  
  hideMessages();
  setLoading(true);
  
  try {
    if (mode === 'signup') {
      const { data, error } = await db.auth.signUp({
        email,
        password,
        options: {
          data: {
            role: role,
            first_name: name.split(' ')[0] || '',
            last_name: name.split(' ').slice(1).join(' ') || ''
          }
        }
      });
      
      if (error) throw error;
      
      authContent.style.display = 'none';
      checkEmail.style.display = 'block';
      confirmEmail.textContent = email;
      
    } else {
      const { data, error } = await db.auth.signInWithPassword({ email, password });
      
      if (error) throw error;
      
      const { data: profile } = await db.from('profiles').select('role').eq('id', data.user.id).single();
      
      showSuccess('Erfolgreich angemeldet! Weiterleitung...');
      
      setTimeout(() => {
        redirectToDashboard(profile?.role || 'host');
      }, 1000);
    }
    
  } catch (error) {
    console.error('Auth error:', error);
    let msg = error.message;
    if (msg.includes('Invalid login')) msg = 'E-Mail oder Passwort falsch';
    if (msg.includes('Email not confirmed')) msg = 'Bitte best√§tige zuerst deine E-Mail';
    if (msg.includes('User already registered')) msg = 'Diese E-Mail ist bereits registriert';
    if (msg.includes('Password should be')) msg = 'Passwort muss mindestens 6 Zeichen haben';
    showError(msg);
  } finally {
    setLoading(false);
  }
});

checkSession();
</script>
</body>
</html>
